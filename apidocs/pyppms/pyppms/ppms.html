<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 13.1.1"/>
    <title>pyppms.ppms API documentation</title>
            <link rel="icon" href="https://imcf.one/images/raeppli-code.png"/>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#49483e}.pdoc-code{background:#272822; color:#f8f8f2}.pdoc-code .c{color:#75715e}.pdoc-code .err{color:#960050; background-color:#1e0010}.pdoc-code .esc{color:#f8f8f2}.pdoc-code .g{color:#f8f8f2}.pdoc-code .k{color:#66d9ef}.pdoc-code .l{color:#ae81ff}.pdoc-code .n{color:#f8f8f2}.pdoc-code .o{color:#f92672}.pdoc-code .x{color:#f8f8f2}.pdoc-code .p{color:#f8f8f2}.pdoc-code .ch{color:#75715e}.pdoc-code .cm{color:#75715e}.pdoc-code .cp{color:#75715e}.pdoc-code .cpf{color:#75715e}.pdoc-code .c1{color:#75715e}.pdoc-code .cs{color:#75715e}.pdoc-code .gd{color:#f92672}.pdoc-code .ge{color:#f8f8f2; font-style:italic}.pdoc-code .gr{color:#f8f8f2}.pdoc-code .gh{color:#f8f8f2}.pdoc-code .gi{color:#a6e22e}.pdoc-code .go{color:#66d9ef}.pdoc-code .gp{color:#f92672; font-weight:bold}.pdoc-code .gs{color:#f8f8f2; font-weight:bold}.pdoc-code .gu{color:#75715e}.pdoc-code .gt{color:#f8f8f2}.pdoc-code .kc{color:#66d9ef}.pdoc-code .kd{color:#66d9ef}.pdoc-code .kn{color:#f92672}.pdoc-code .kp{color:#66d9ef}.pdoc-code .kr{color:#66d9ef}.pdoc-code .kt{color:#66d9ef}.pdoc-code .ld{color:#e6db74}.pdoc-code .m{color:#ae81ff}.pdoc-code .s{color:#e6db74}.pdoc-code .na{color:#a6e22e}.pdoc-code .nb{color:#f8f8f2}.pdoc-code .nc{color:#a6e22e}.pdoc-code .no{color:#66d9ef}.pdoc-code .nd{color:#a6e22e}.pdoc-code .ni{color:#f8f8f2}.pdoc-code .ne{color:#a6e22e}.pdoc-code .nf{color:#a6e22e}.pdoc-code .nl{color:#f8f8f2}.pdoc-code .nn{color:#f8f8f2}.pdoc-code .nx{color:#a6e22e}.pdoc-code .py{color:#f8f8f2}.pdoc-code .nt{color:#f92672}.pdoc-code .nv{color:#f8f8f2}.pdoc-code .ow{color:#f92672}.pdoc-code .w{color:#f8f8f2}.pdoc-code .mb{color:#ae81ff}.pdoc-code .mf{color:#ae81ff}.pdoc-code .mh{color:#ae81ff}.pdoc-code .mi{color:#ae81ff}.pdoc-code .mo{color:#ae81ff}.pdoc-code .sa{color:#e6db74}.pdoc-code .sb{color:#e6db74}.pdoc-code .sc{color:#e6db74}.pdoc-code .dl{color:#e6db74}.pdoc-code .sd{color:#e6db74}.pdoc-code .s2{color:#e6db74}.pdoc-code .se{color:#ae81ff}.pdoc-code .sh{color:#e6db74}.pdoc-code .si{color:#e6db74}.pdoc-code .sx{color:#e6db74}.pdoc-code .sr{color:#e6db74}.pdoc-code .s1{color:#e6db74}.pdoc-code .ss{color:#e6db74}.pdoc-code .bp{color:#f8f8f2}.pdoc-code .fm{color:#a6e22e}.pdoc-code .vc{color:#f8f8f2}.pdoc-code .vg{color:#f8f8f2}.pdoc-code .vi{color:#f8f8f2}.pdoc-code .vm{color:#f8f8f2}</style>
    <style>/*! theme.css */:root{--pdoc-background:#212529;}.pdoc{--text:#f7f7f7;--muted:#9d9d9d;--link:#58a6ff;--link-hover:#3989ff;--code:#333;--active:#555;--accent:#343434;--accent2:#555;--nav-hover:rgba(0, 0, 0, 0.1);--name:#77C1FF;--def:#0cdd0c;--annotation:#00c037;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent }nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .pdoc-alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:1rem center;margin-bottom:1rem;}.pdoc .pdoc-alert > *:last-child{margin-bottom:0;}.pdoc .pdoc-alert-note {color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--code);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../pyppms.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;pyppms</a>

<a href="https://imcf.one/apidocs/">            <img src="https://imcf.one/images/raeppli.png" class="logo" alt="project logo"/>
</a>
            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="class" href="#PpmsConnection">PpmsConnection</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#PpmsConnection.__init__">PpmsConnection</a>
                        </li>
                        <li>
                                <a class="variable" href="#PpmsConnection.last_served_from_cache">last_served_from_cache</a>
                        </li>
                        <li>
                                <a class="function" href="#PpmsConnection.request">request</a>
                        </li>
                        <li>
                                <a class="function" href="#PpmsConnection.flush_cache">flush_cache</a>
                        </li>
                        <li>
                                <a class="function" href="#PpmsConnection.get_admins">get_admins</a>
                        </li>
                        <li>
                                <a class="function" href="#PpmsConnection.get_booking">get_booking</a>
                        </li>
                        <li>
                                <a class="function" href="#PpmsConnection.get_current_booking">get_current_booking</a>
                        </li>
                        <li>
                                <a class="function" href="#PpmsConnection.get_group">get_group</a>
                        </li>
                        <li>
                                <a class="function" href="#PpmsConnection.get_group_users">get_group_users</a>
                        </li>
                        <li>
                                <a class="function" href="#PpmsConnection.get_groups">get_groups</a>
                        </li>
                        <li>
                                <a class="function" href="#PpmsConnection.get_next_booking">get_next_booking</a>
                        </li>
                        <li>
                                <a class="function" href="#PpmsConnection.get_running_sheet">get_running_sheet</a>
                        </li>
                        <li>
                                <a class="function" href="#PpmsConnection.get_systems">get_systems</a>
                        </li>
                        <li>
                                <a class="function" href="#PpmsConnection.get_systems_matching">get_systems_matching</a>
                        </li>
                        <li>
                                <a class="function" href="#PpmsConnection.get_user">get_user</a>
                        </li>
                        <li>
                                <a class="function" href="#PpmsConnection.get_user_dict">get_user_dict</a>
                        </li>
                        <li>
                                <a class="function" href="#PpmsConnection.get_user_experience">get_user_experience</a>
                        </li>
                        <li>
                                <a class="function" href="#PpmsConnection.get_user_ids">get_user_ids</a>
                        </li>
                        <li>
                                <a class="function" href="#PpmsConnection.get_users">get_users</a>
                        </li>
                        <li>
                                <a class="function" href="#PpmsConnection.get_users_emails">get_users_emails</a>
                        </li>
                        <li>
                                <a class="function" href="#PpmsConnection.get_users_with_access_to_system">get_users_with_access_to_system</a>
                        </li>
                        <li>
                                <a class="function" href="#PpmsConnection.give_user_access_to_system">give_user_access_to_system</a>
                        </li>
                        <li>
                                <a class="function" href="#PpmsConnection.new_user">new_user</a>
                        </li>
                        <li>
                                <a class="function" href="#PpmsConnection.remove_user_access_from_system">remove_user_access_from_system</a>
                        </li>
                        <li>
                                <a class="function" href="#PpmsConnection.set_system_booking_permissions">set_system_booking_permissions</a>
                        </li>
                        <li>
                                <a class="function" href="#PpmsConnection.update_systems">update_systems</a>
                        </li>
                        <li>
                                <a class="function" href="#PpmsConnection.update_users">update_users</a>
                        </li>
                        <li>
                                <a class="function" href="#PpmsConnection.user_exists">user_exists</a>
                        </li>
                </ul>

            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
<a href="./../pyppms.html">pyppms</a><wbr>.ppms    </h1>

                        <div class="docstring"><p>Core connection module for the PUMAPI communication.</p>
</div>

                        <input id="mod-ppms-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-ppms-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">   1</span></a><span class="sd">&quot;&quot;&quot;Core connection module for the PUMAPI communication.&quot;&quot;&quot;</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">   2</span></a>
</span><span id="L-3"><a href="#L-3"><span class="linenos">   3</span></a><span class="c1"># pylint: disable-msg=dangerous-default-value</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">   4</span></a>
</span><span id="L-5"><a href="#L-5"><span class="linenos">   5</span></a><span class="c1"># NOTE: the &quot;pyppms&quot; package is simply a wrapper for the existing API, so we can&#39;t make</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos">   6</span></a><span class="c1">#       any design decisions here - hence it is pointless to complain about the number</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">   7</span></a><span class="c1">#       of instance attributes, public methods or other stuff:</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">   8</span></a><span class="c1"># pylint: disable-msg=too-many-instance-attributes</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos">   9</span></a><span class="c1"># pylint: disable-msg=too-many-public-methods</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos">  10</span></a>
</span><span id="L-11"><a href="#L-11"><span class="linenos">  11</span></a><span class="kn">import</span> <span class="nn">os</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos">  12</span></a><span class="kn">import</span> <span class="nn">os.path</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos">  13</span></a><span class="kn">import</span> <span class="nn">shutil</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos">  14</span></a><span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="nb">open</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos">  15</span></a>
</span><span id="L-16"><a href="#L-16"><span class="linenos">  16</span></a><span class="kn">import</span> <span class="nn">requests</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos">  17</span></a><span class="kn">from</span> <span class="nn">loguru</span> <span class="kn">import</span> <span class="n">logger</span> <span class="k">as</span> <span class="n">log</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos">  18</span></a>
</span><span id="L-19"><a href="#L-19"><span class="linenos">  19</span></a><span class="kn">from</span> <span class="nn">.common</span> <span class="kn">import</span> <span class="n">dict_from_single_response</span><span class="p">,</span> <span class="n">parse_multiline_response</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos">  20</span></a><span class="kn">from</span> <span class="nn">.user</span> <span class="kn">import</span> <span class="n">PpmsUser</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos">  21</span></a><span class="kn">from</span> <span class="nn">.system</span> <span class="kn">import</span> <span class="n">PpmsSystem</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos">  22</span></a><span class="kn">from</span> <span class="nn">.booking</span> <span class="kn">import</span> <span class="n">PpmsBooking</span>
</span><span id="L-23"><a href="#L-23"><span class="linenos">  23</span></a><span class="kn">from</span> <span class="nn">.exceptions</span> <span class="kn">import</span> <span class="n">NoDataError</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos">  24</span></a>
</span><span id="L-25"><a href="#L-25"><span class="linenos">  25</span></a>
</span><span id="L-26"><a href="#L-26"><span class="linenos">  26</span></a><span class="k">class</span> <span class="nc">PpmsConnection</span><span class="p">:</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos">  27</span></a>
</span><span id="L-28"><a href="#L-28"><span class="linenos">  28</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Connection object to communicate with a PPMS instance.</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos">  29</span></a>
</span><span id="L-30"><a href="#L-30"><span class="linenos">  30</span></a><span class="sd">    Attributes</span>
</span><span id="L-31"><a href="#L-31"><span class="linenos">  31</span></a><span class="sd">    ----------</span>
</span><span id="L-32"><a href="#L-32"><span class="linenos">  32</span></a><span class="sd">    url : str</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos">  33</span></a><span class="sd">        The URL of the PUMAPI instance.</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos">  34</span></a><span class="sd">    api_key : str</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos">  35</span></a><span class="sd">        The API key used for authenticating against the PUMAPI.</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos">  36</span></a><span class="sd">    timeout : float</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos">  37</span></a><span class="sd">        The timeout value used in the ``requests.post`` calls.</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos">  38</span></a><span class="sd">    cache_path : str</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos">  39</span></a><span class="sd">        A path to a local directory used for caching responses.</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos">  40</span></a><span class="sd">    cache_users_only : bool</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos">  41</span></a><span class="sd">        Flag indicating that only PPMS user details will be stored in the</span>
</span><span id="L-42"><a href="#L-42"><span class="linenos">  42</span></a><span class="sd">        on-disk cache, nothing else.</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos">  43</span></a><span class="sd">    last_served_from_cache : bool</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos">  44</span></a><span class="sd">        Indicates if the last request was served from the cache or on-line.</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos">  45</span></a><span class="sd">    users : dict</span>
</span><span id="L-46"><a href="#L-46"><span class="linenos">  46</span></a><span class="sd">        A dict with usernames as keys, mapping to the related</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos">  47</span></a><span class="sd">        :py:class:`pyppms.user.PpmsUser` object, serves as a cache during the object&#39;s</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos">  48</span></a><span class="sd">        lifetime (can be empty if no calls to :py:meth:`get_user()` have been done yet).</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos">  49</span></a><span class="sd">    fullname_mapping : dict</span>
</span><span id="L-50"><a href="#L-50"><span class="linenos">  50</span></a><span class="sd">        A dict mapping a user&#39;s *fullname* (&quot;``&lt;LASTNAME&gt; &lt;FIRSTNAME&gt;``&quot;) to the</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos">  51</span></a><span class="sd">        corresponding username. Entries are filled in dynamically by the</span>
</span><span id="L-52"><a href="#L-52"><span class="linenos">  52</span></a><span class="sd">        :py:meth:`get_user()` method.</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos">  53</span></a><span class="sd">    systems</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos">  54</span></a><span class="sd">        A dict with system IDs as keys, mapping to the related</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos">  55</span></a><span class="sd">        :py:class:`pyppms.system.PpmsSystem` object. Serves as a cache during the</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos">  56</span></a><span class="sd">        object&#39;s lifetime (can be empty if no calls to the :py:meth:`get_systems()` have</span>
</span><span id="L-57"><a href="#L-57"><span class="linenos">  57</span></a><span class="sd">        been done yet).</span>
</span><span id="L-58"><a href="#L-58"><span class="linenos">  58</span></a><span class="sd">    status : dict</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos">  59</span></a><span class="sd">        A dict with keys ``auth_state``, ``auth_response`` and</span>
</span><span id="L-60"><a href="#L-60"><span class="linenos">  60</span></a><span class="sd">        ``auth_httpstatus``</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos">  61</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos">  62</span></a>
</span><span id="L-63"><a href="#L-63"><span class="linenos">  63</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">api_key</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">cache_users_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos">  64</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Constructor for the PPMS connection object.</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos">  65</span></a>
</span><span id="L-66"><a href="#L-66"><span class="linenos">  66</span></a><span class="sd">        Open a connection to the PUMAPI defined in `url` and try to authenticate</span>
</span><span id="L-67"><a href="#L-67"><span class="linenos">  67</span></a><span class="sd">        against it using the given API key (or use cache-only mode if key is an</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos">  68</span></a><span class="sd">        empty string). If an optional path to a caching location is specified,</span>
</span><span id="L-69"><a href="#L-69"><span class="linenos">  69</span></a><span class="sd">        responses will be read from that location unless no matching file can be</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos">  70</span></a><span class="sd">        found there, in which case an on-line request will be done (with the</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos">  71</span></a><span class="sd">        response being saved to the cache path).</span>
</span><span id="L-72"><a href="#L-72"><span class="linenos">  72</span></a>
</span><span id="L-73"><a href="#L-73"><span class="linenos">  73</span></a><span class="sd">        Parameters</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos">  74</span></a><span class="sd">        ----------</span>
</span><span id="L-75"><a href="#L-75"><span class="linenos">  75</span></a><span class="sd">        url : str</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos">  76</span></a><span class="sd">            The URL of the PUMAPI to connect to.</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos">  77</span></a><span class="sd">        api_key : str</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos">  78</span></a><span class="sd">            The API key to use for authenticating against the PUMAPI. If</span>
</span><span id="L-79"><a href="#L-79"><span class="linenos">  79</span></a><span class="sd">            specified as &#39;&#39; authentication will be skipped and the connection is</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos">  80</span></a><span class="sd">            running in cache-only (local) mode.</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos">  81</span></a><span class="sd">        timeout : float, optional</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos">  82</span></a><span class="sd">            How many seconds to wait for the PUMAPI server to send a response</span>
</span><span id="L-83"><a href="#L-83"><span class="linenos">  83</span></a><span class="sd">            before giving up, by default 10.</span>
</span><span id="L-84"><a href="#L-84"><span class="linenos">  84</span></a><span class="sd">        cache : str, optional</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos">  85</span></a><span class="sd">            A path to a local directory for caching responses from PUMAPI in</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos">  86</span></a><span class="sd">            individual text files. Useful for testing and for speeding up</span>
</span><span id="L-87"><a href="#L-87"><span class="linenos">  87</span></a><span class="sd">            slow requests like &#39;getusers&#39;. By default empty, which will result</span>
</span><span id="L-88"><a href="#L-88"><span class="linenos">  88</span></a><span class="sd">            in no caching being done.</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos">  89</span></a><span class="sd">        cache_users_only : bool, optional</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos">  90</span></a><span class="sd">            If set to `True`, only `getuser` requests will be cached on disk.</span>
</span><span id="L-91"><a href="#L-91"><span class="linenos">  91</span></a><span class="sd">            This can be used in to speed up the slow requests (through the</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos">  92</span></a><span class="sd">            cache), while everything else will be handled through online</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos">  93</span></a><span class="sd">            requests. By default `False`.</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos">  94</span></a>
</span><span id="L-95"><a href="#L-95"><span class="linenos">  95</span></a><span class="sd">        Raises</span>
</span><span id="L-96"><a href="#L-96"><span class="linenos">  96</span></a><span class="sd">        ------</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos">  97</span></a><span class="sd">        requests.exceptions.ConnectionError</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos">  98</span></a><span class="sd">            Raised in case authentication fails.</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos">  99</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-100"><a href="#L-100"><span class="linenos"> 100</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">url</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos"> 101</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">api_key</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos"> 102</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span>
</span><span id="L-103"><a href="#L-103"><span class="linenos"> 103</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">users</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos"> 104</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fullname_mapping</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos"> 105</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">systems</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-106"><a href="#L-106"><span class="linenos"> 106</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos"> 107</span></a>            <span class="s2">&quot;auth_state&quot;</span><span class="p">:</span> <span class="s2">&quot;NOT_TRIED&quot;</span><span class="p">,</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos"> 108</span></a>            <span class="s2">&quot;auth_response&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos"> 109</span></a>            <span class="s2">&quot;auth_httpstatus&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
</span><span id="L-110"><a href="#L-110"><span class="linenos"> 110</span></a>        <span class="p">}</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos"> 111</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cache_path</span> <span class="o">=</span> <span class="n">cache</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos"> 112</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cache_users_only</span> <span class="o">=</span> <span class="n">cache_users_only</span>
</span><span id="L-113"><a href="#L-113"><span class="linenos"> 113</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">last_served_from_cache</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos"> 114</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Indicates if the last request was served from the cache or on-line.&quot;&quot;&quot;</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos"> 115</span></a>
</span><span id="L-116"><a href="#L-116"><span class="linenos"> 116</span></a>        <span class="c1"># run in cache-only mode (e.g. for testing or off-line usage) if no API</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos"> 117</span></a>        <span class="c1"># key has been specified, skip authentication then:</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos"> 118</span></a>        <span class="k">if</span> <span class="n">api_key</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos"> 119</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">__authenticate</span><span class="p">()</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos"> 120</span></a>        <span class="k">elif</span> <span class="n">cache</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
</span><span id="L-121"><a href="#L-121"><span class="linenos"> 121</span></a>            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos"> 122</span></a>                <span class="s2">&quot;Neither API key nor cache path given, at least one is required!&quot;</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos"> 123</span></a>            <span class="p">)</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos"> 124</span></a>
</span><span id="L-125"><a href="#L-125"><span class="linenos"> 125</span></a>    <span class="k">def</span> <span class="nf">__authenticate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-126"><a href="#L-126"><span class="linenos"> 126</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Try to authenticate to PPMS using the `auth` request.</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos"> 127</span></a>
</span><span id="L-128"><a href="#L-128"><span class="linenos"> 128</span></a><span class="sd">        Raises</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos"> 129</span></a><span class="sd">        ------</span>
</span><span id="L-130"><a href="#L-130"><span class="linenos"> 130</span></a><span class="sd">        requests.exceptions.ConnectionError</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos"> 131</span></a><span class="sd">            Raised in case authentication failed for any reason.</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos"> 132</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-133"><a href="#L-133"><span class="linenos"> 133</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span>
</span><span id="L-134"><a href="#L-134"><span class="linenos"> 134</span></a>            <span class="s2">&quot;Attempting authentication against </span><span class="si">{}</span><span class="s2"> with key [</span><span class="si">{}</span><span class="s2">...</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="p">,</span>
</span><span id="L-135"><a href="#L-135"><span class="linenos"> 135</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span>
</span><span id="L-136"><a href="#L-136"><span class="linenos"> 136</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">api_key</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span>
</span><span id="L-137"><a href="#L-137"><span class="linenos"> 137</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">api_key</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:],</span>
</span><span id="L-138"><a href="#L-138"><span class="linenos"> 138</span></a>        <span class="p">)</span>
</span><span id="L-139"><a href="#L-139"><span class="linenos"> 139</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s2">&quot;auth_state&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;attempting&quot;</span>
</span><span id="L-140"><a href="#L-140"><span class="linenos"> 140</span></a>        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;auth&quot;</span><span class="p">)</span>
</span><span id="L-141"><a href="#L-141"><span class="linenos"> 141</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Authenticate response: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-142"><a href="#L-142"><span class="linenos"> 142</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s2">&quot;auth_response&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos"> 143</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s2">&quot;auth_httpstatus&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span>
</span><span id="L-144"><a href="#L-144"><span class="linenos"> 144</span></a>
</span><span id="L-145"><a href="#L-145"><span class="linenos"> 145</span></a>        <span class="c1"># NOTE: an unauthorized request has already been caught be the request() method</span>
</span><span id="L-146"><a href="#L-146"><span class="linenos"> 146</span></a>        <span class="c1"># above. Our legacy code was additionally testing for &#39;error&#39; in the response</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos"> 147</span></a>        <span class="c1"># text - however, it is unclear if PUMAPI ever returns this:</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos"> 148</span></a>        <span class="k">if</span> <span class="s2">&quot;error&quot;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
</span><span id="L-149"><a href="#L-149"><span class="linenos"> 149</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s2">&quot;auth_state&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;FAILED-ERROR&quot;</span>
</span><span id="L-150"><a href="#L-150"><span class="linenos"> 150</span></a>            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Authentication failed with an error: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-151"><a href="#L-151"><span class="linenos"> 151</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="L-152"><a href="#L-152"><span class="linenos"> 152</span></a>            <span class="k">raise</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ConnectionError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="L-153"><a href="#L-153"><span class="linenos"> 153</span></a>
</span><span id="L-154"><a href="#L-154"><span class="linenos"> 154</span></a>        <span class="n">status_ok</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">codes</span><span class="o">.</span><span class="n">ok</span>  <span class="c1"># pylint: disable-msg=no-member</span>
</span><span id="L-155"><a href="#L-155"><span class="linenos"> 155</span></a>
</span><span id="L-156"><a href="#L-156"><span class="linenos"> 156</span></a>        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="n">status_ok</span><span class="p">:</span>
</span><span id="L-157"><a href="#L-157"><span class="linenos"> 157</span></a>            <span class="c1"># NOTE: branch excluded from coverage as we don&#39;t have a known way</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos"> 158</span></a>            <span class="c1"># to produce such a response from the API</span>
</span><span id="L-159"><a href="#L-159"><span class="linenos"> 159</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="L-160"><a href="#L-160"><span class="linenos"> 160</span></a>                <span class="s2">&quot;Unexpected combination of response [</span><span class="si">{}</span><span class="s2">] and status code [</span><span class="si">{}</span><span class="s2">], it&#39;s &quot;</span>
</span><span id="L-161"><a href="#L-161"><span class="linenos"> 161</span></a>                <span class="s2">&quot;unclear if authentication succeeded (assuming it didn&#39;t)&quot;</span><span class="p">,</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos"> 162</span></a>                <span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span>
</span><span id="L-163"><a href="#L-163"><span class="linenos"> 163</span></a>                <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">,</span>
</span><span id="L-164"><a href="#L-164"><span class="linenos"> 164</span></a>            <span class="p">)</span>
</span><span id="L-165"><a href="#L-165"><span class="linenos"> 165</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s2">&quot;auth_state&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;FAILED-UNKNOWN&quot;</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos"> 166</span></a>
</span><span id="L-167"><a href="#L-167"><span class="linenos"> 167</span></a>            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-168"><a href="#L-168"><span class="linenos"> 168</span></a>                <span class="sa">f</span><span class="s2">&quot;Authenticating against </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="si">}</span><span class="s2"> with key &quot;</span>
</span><span id="L-169"><a href="#L-169"><span class="linenos"> 169</span></a>                <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">api_key</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">...</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">api_key</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span><span class="si">}</span><span class="s2">] FAILED!&quot;</span>
</span><span id="L-170"><a href="#L-170"><span class="linenos"> 170</span></a>            <span class="p">)</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos"> 171</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="L-172"><a href="#L-172"><span class="linenos"> 172</span></a>            <span class="k">raise</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ConnectionError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="L-173"><a href="#L-173"><span class="linenos"> 173</span></a>
</span><span id="L-174"><a href="#L-174"><span class="linenos"> 174</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span>
</span><span id="L-175"><a href="#L-175"><span class="linenos"> 175</span></a>            <span class="s2">&quot;Authentication succeeded, response=[</span><span class="si">{}</span><span class="s2">], http_status=[</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="p">,</span>
</span><span id="L-176"><a href="#L-176"><span class="linenos"> 176</span></a>            <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">,</span>
</span><span id="L-177"><a href="#L-177"><span class="linenos"> 177</span></a>            <span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span>
</span><span id="L-178"><a href="#L-178"><span class="linenos"> 178</span></a>        <span class="p">)</span>
</span><span id="L-179"><a href="#L-179"><span class="linenos"> 179</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s2">&quot;auth_state&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;good&quot;</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos"> 180</span></a>
</span><span id="L-181"><a href="#L-181"><span class="linenos"> 181</span></a>    <span class="k">def</span> <span class="nf">request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="p">{},</span> <span class="n">skip_cache</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-182"><a href="#L-182"><span class="linenos"> 182</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Generic method to submit a request to PPMS and return the result.</span>
</span><span id="L-183"><a href="#L-183"><span class="linenos"> 183</span></a>
</span><span id="L-184"><a href="#L-184"><span class="linenos"> 184</span></a><span class="sd">        This convenience method deals with adding the API key to a given</span>
</span><span id="L-185"><a href="#L-185"><span class="linenos"> 185</span></a><span class="sd">        request, submitting it to the PUMAPI and checking the response for some</span>
</span><span id="L-186"><a href="#L-186"><span class="linenos"> 186</span></a><span class="sd">        specific keywords indicating an error.</span>
</span><span id="L-187"><a href="#L-187"><span class="linenos"> 187</span></a>
</span><span id="L-188"><a href="#L-188"><span class="linenos"> 188</span></a><span class="sd">        Parameters</span>
</span><span id="L-189"><a href="#L-189"><span class="linenos"> 189</span></a><span class="sd">        ----------</span>
</span><span id="L-190"><a href="#L-190"><span class="linenos"> 190</span></a><span class="sd">        action : str</span>
</span><span id="L-191"><a href="#L-191"><span class="linenos"> 191</span></a><span class="sd">            The command to be submitted to the PUMAPI.</span>
</span><span id="L-192"><a href="#L-192"><span class="linenos"> 192</span></a><span class="sd">        parameters : dict, optional</span>
</span><span id="L-193"><a href="#L-193"><span class="linenos"> 193</span></a><span class="sd">            A dictionary with additional parameters to be submitted with the</span>
</span><span id="L-194"><a href="#L-194"><span class="linenos"> 194</span></a><span class="sd">            request.</span>
</span><span id="L-195"><a href="#L-195"><span class="linenos"> 195</span></a><span class="sd">        skip_cache : bool, optional</span>
</span><span id="L-196"><a href="#L-196"><span class="linenos"> 196</span></a><span class="sd">            If set to True the request will NOT be served from the local cache,</span>
</span><span id="L-197"><a href="#L-197"><span class="linenos"> 197</span></a><span class="sd">            independent whether a matching response file exists there, by</span>
</span><span id="L-198"><a href="#L-198"><span class="linenos"> 198</span></a><span class="sd">            default False.</span>
</span><span id="L-199"><a href="#L-199"><span class="linenos"> 199</span></a>
</span><span id="L-200"><a href="#L-200"><span class="linenos"> 200</span></a><span class="sd">        Returns</span>
</span><span id="L-201"><a href="#L-201"><span class="linenos"> 201</span></a><span class="sd">        -------</span>
</span><span id="L-202"><a href="#L-202"><span class="linenos"> 202</span></a><span class="sd">        requests.Response</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos"> 203</span></a><span class="sd">            The response object created by posting the request.</span>
</span><span id="L-204"><a href="#L-204"><span class="linenos"> 204</span></a>
</span><span id="L-205"><a href="#L-205"><span class="linenos"> 205</span></a><span class="sd">        Raises</span>
</span><span id="L-206"><a href="#L-206"><span class="linenos"> 206</span></a><span class="sd">        ------</span>
</span><span id="L-207"><a href="#L-207"><span class="linenos"> 207</span></a><span class="sd">        requests.exceptions.ConnectionError</span>
</span><span id="L-208"><a href="#L-208"><span class="linenos"> 208</span></a><span class="sd">            Raised in case the request is not authorized.</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos"> 209</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-210"><a href="#L-210"><span class="linenos"> 210</span></a>        <span class="n">req_data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">action</span><span class="p">,</span> <span class="s2">&quot;apikey&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">api_key</span><span class="p">}</span>
</span><span id="L-211"><a href="#L-211"><span class="linenos"> 211</span></a>        <span class="n">req_data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span>
</span><span id="L-212"><a href="#L-212"><span class="linenos"> 212</span></a>        <span class="c1"># log.debug(&quot;Request parameters: {}&quot;, parameters)</span>
</span><span id="L-213"><a href="#L-213"><span class="linenos"> 213</span></a>
</span><span id="L-214"><a href="#L-214"><span class="linenos"> 214</span></a>        <span class="n">response</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-215"><a href="#L-215"><span class="linenos"> 215</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-216"><a href="#L-216"><span class="linenos"> 216</span></a>            <span class="k">if</span> <span class="n">skip_cache</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
</span><span id="L-217"><a href="#L-217"><span class="linenos"> 217</span></a>                <span class="k">raise</span> <span class="ne">LookupError</span><span class="p">(</span><span class="s2">&quot;Skipping the cache has been requested&quot;</span><span class="p">)</span>
</span><span id="L-218"><a href="#L-218"><span class="linenos"> 218</span></a>            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__intercept_read</span><span class="p">(</span><span class="n">req_data</span><span class="p">)</span>
</span><span id="L-219"><a href="#L-219"><span class="linenos"> 219</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">last_served_from_cache</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-220"><a href="#L-220"><span class="linenos"> 220</span></a>        <span class="k">except</span> <span class="ne">LookupError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos"> 221</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Doing an on-line request: </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-222"><a href="#L-222"><span class="linenos"> 222</span></a>            <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">req_data</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>
</span><span id="L-223"><a href="#L-223"><span class="linenos"> 223</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">last_served_from_cache</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos"> 224</span></a>
</span><span id="L-225"><a href="#L-225"><span class="linenos"> 225</span></a>        <span class="c1"># store the response if it hasn&#39;t been read from the cache before:</span>
</span><span id="L-226"><a href="#L-226"><span class="linenos"> 226</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_served_from_cache</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
</span><span id="L-227"><a href="#L-227"><span class="linenos"> 227</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">__intercept_store</span><span class="p">(</span><span class="n">req_data</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>
</span><span id="L-228"><a href="#L-228"><span class="linenos"> 228</span></a>
</span><span id="L-229"><a href="#L-229"><span class="linenos"> 229</span></a>        <span class="c1"># NOTE: the HTTP status code returned is always `200` even if</span>
</span><span id="L-230"><a href="#L-230"><span class="linenos"> 230</span></a>        <span class="c1"># authentication failed, so we need to check the actual response *TEXT*</span>
</span><span id="L-231"><a href="#L-231"><span class="linenos"> 231</span></a>        <span class="c1"># to figure out if we have succeeded:</span>
</span><span id="L-232"><a href="#L-232"><span class="linenos"> 232</span></a>        <span class="k">if</span> <span class="s2">&quot;request not authorized&quot;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
</span><span id="L-233"><a href="#L-233"><span class="linenos"> 233</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s2">&quot;auth_state&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;FAILED&quot;</span>
</span><span id="L-234"><a href="#L-234"><span class="linenos"> 234</span></a>            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Not authorized to run action `</span><span class="si">{</span><span class="n">req_data</span><span class="p">[</span><span class="s1">&#39;action&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">`&quot;</span>
</span><span id="L-235"><a href="#L-235"><span class="linenos"> 235</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="L-236"><a href="#L-236"><span class="linenos"> 236</span></a>            <span class="k">raise</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ConnectionError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="L-237"><a href="#L-237"><span class="linenos"> 237</span></a>
</span><span id="L-238"><a href="#L-238"><span class="linenos"> 238</span></a>        <span class="k">return</span> <span class="n">response</span>
</span><span id="L-239"><a href="#L-239"><span class="linenos"> 239</span></a>
</span><span id="L-240"><a href="#L-240"><span class="linenos"> 240</span></a>    <span class="k">def</span> <span class="nf">__interception_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req_data</span><span class="p">,</span> <span class="n">create_dir</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-241"><a href="#L-241"><span class="linenos"> 241</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Derive the path for a local cache file from a request&#39;s parameters.</span>
</span><span id="L-242"><a href="#L-242"><span class="linenos"> 242</span></a>
</span><span id="L-243"><a href="#L-243"><span class="linenos"> 243</span></a><span class="sd">        Parameters</span>
</span><span id="L-244"><a href="#L-244"><span class="linenos"> 244</span></a><span class="sd">        ----------</span>
</span><span id="L-245"><a href="#L-245"><span class="linenos"> 245</span></a><span class="sd">        req_data : dict</span>
</span><span id="L-246"><a href="#L-246"><span class="linenos"> 246</span></a><span class="sd">            The request&#39;s parameters, used to derive the name of the cache file.</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos"> 247</span></a><span class="sd">        create_dir : bool, optional</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos"> 248</span></a><span class="sd">            If set to True the cache directory will be created if necessary.</span>
</span><span id="L-249"><a href="#L-249"><span class="linenos"> 249</span></a><span class="sd">            Useful when adding responses to the cache. By default False.</span>
</span><span id="L-250"><a href="#L-250"><span class="linenos"> 250</span></a>
</span><span id="L-251"><a href="#L-251"><span class="linenos"> 251</span></a><span class="sd">        Returns</span>
</span><span id="L-252"><a href="#L-252"><span class="linenos"> 252</span></a><span class="sd">        -------</span>
</span><span id="L-253"><a href="#L-253"><span class="linenos"> 253</span></a><span class="sd">        str</span>
</span><span id="L-254"><a href="#L-254"><span class="linenos"> 254</span></a><span class="sd">            The full path to a file name identified by all parameters of the</span>
</span><span id="L-255"><a href="#L-255"><span class="linenos"> 255</span></a><span class="sd">            request (except credentials like &#39;apikey&#39;).</span>
</span><span id="L-256"><a href="#L-256"><span class="linenos"> 256</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-257"><a href="#L-257"><span class="linenos"> 257</span></a>        <span class="n">action</span> <span class="o">=</span> <span class="n">req_data</span><span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">]</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos"> 258</span></a>
</span><span id="L-259"><a href="#L-259"><span class="linenos"> 259</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_users_only</span> <span class="ow">and</span> <span class="n">action</span> <span class="o">!=</span> <span class="s2">&quot;getuser&quot;</span><span class="p">:</span>
</span><span id="L-260"><a href="#L-260"><span class="linenos"> 260</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;NOT caching &#39;</span><span class="si">{</span><span class="n">action</span><span class="si">}</span><span class="s2">&#39; (cache_users_only is set)&quot;</span><span class="p">)</span>
</span><span id="L-261"><a href="#L-261"><span class="linenos"> 261</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="L-262"><a href="#L-262"><span class="linenos"> 262</span></a>
</span><span id="L-263"><a href="#L-263"><span class="linenos"> 263</span></a>        <span class="n">intercept_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_path</span><span class="p">,</span> <span class="n">action</span><span class="p">)</span>
</span><span id="L-264"><a href="#L-264"><span class="linenos"> 264</span></a>        <span class="k">if</span> <span class="n">create_dir</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">intercept_dir</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
</span><span id="L-265"><a href="#L-265"><span class="linenos"> 265</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="L-266"><a href="#L-266"><span class="linenos"> 266</span></a>                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">intercept_dir</span><span class="p">)</span>
</span><span id="L-267"><a href="#L-267"><span class="linenos"> 267</span></a>                <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Created dir to store response: </span><span class="si">{</span><span class="n">intercept_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-268"><a href="#L-268"><span class="linenos"> 268</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>  <span class="c1"># pylint: disable-msg=broad-except</span>
</span><span id="L-269"><a href="#L-269"><span class="linenos"> 269</span></a>                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed creating [</span><span class="si">{</span><span class="n">intercept_dir</span><span class="si">}</span><span class="s2">]: </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-270"><a href="#L-270"><span class="linenos"> 270</span></a>                <span class="k">return</span> <span class="kc">None</span>
</span><span id="L-271"><a href="#L-271"><span class="linenos"> 271</span></a>
</span><span id="L-272"><a href="#L-272"><span class="linenos"> 272</span></a>        <span class="n">signature</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="L-273"><a href="#L-273"><span class="linenos"> 273</span></a>        <span class="c1"># different python versions are returning dict items in different order, so</span>
</span><span id="L-274"><a href="#L-274"><span class="linenos"> 274</span></a>        <span class="c1"># simply iterating over them will not always produce the same result - hence we</span>
</span><span id="L-275"><a href="#L-275"><span class="linenos"> 275</span></a>        <span class="c1"># build up a sorted list of keys first and use that one then:</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos"> 276</span></a>        <span class="n">keylist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">req_data</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="L-277"><a href="#L-277"><span class="linenos"> 277</span></a>        <span class="n">keylist</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
</span><span id="L-278"><a href="#L-278"><span class="linenos"> 278</span></a>        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keylist</span><span class="p">:</span>
</span><span id="L-279"><a href="#L-279"><span class="linenos"> 279</span></a>            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">,</span> <span class="s2">&quot;apikey&quot;</span><span class="p">]:</span>
</span><span id="L-280"><a href="#L-280"><span class="linenos"> 280</span></a>                <span class="k">continue</span>
</span><span id="L-281"><a href="#L-281"><span class="linenos"> 281</span></a>            <span class="n">signature</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;__</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">--</span><span class="si">{</span><span class="n">req_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-282"><a href="#L-282"><span class="linenos"> 282</span></a>        <span class="k">if</span> <span class="n">signature</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
</span><span id="L-283"><a href="#L-283"><span class="linenos"> 283</span></a>            <span class="n">signature</span> <span class="o">=</span> <span class="s2">&quot;__response&quot;</span>
</span><span id="L-284"><a href="#L-284"><span class="linenos"> 284</span></a>        <span class="n">signature</span> <span class="o">=</span> <span class="n">signature</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span> <span class="o">+</span> <span class="s2">&quot;.txt&quot;</span>
</span><span id="L-285"><a href="#L-285"><span class="linenos"> 285</span></a>        <span class="n">intercept_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">intercept_dir</span><span class="p">,</span> <span class="n">signature</span><span class="p">)</span>
</span><span id="L-286"><a href="#L-286"><span class="linenos"> 286</span></a>        <span class="k">return</span> <span class="n">intercept_file</span>
</span><span id="L-287"><a href="#L-287"><span class="linenos"> 287</span></a>
</span><span id="L-288"><a href="#L-288"><span class="linenos"> 288</span></a>    <span class="k">def</span> <span class="nf">__intercept_read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req_data</span><span class="p">):</span>
</span><span id="L-289"><a href="#L-289"><span class="linenos"> 289</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Try to read a cached response from a local file.</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos"> 290</span></a>
</span><span id="L-291"><a href="#L-291"><span class="linenos"> 291</span></a><span class="sd">        Parameters</span>
</span><span id="L-292"><a href="#L-292"><span class="linenos"> 292</span></a><span class="sd">        ----------</span>
</span><span id="L-293"><a href="#L-293"><span class="linenos"> 293</span></a><span class="sd">        req_data : dict</span>
</span><span id="L-294"><a href="#L-294"><span class="linenos"> 294</span></a><span class="sd">            The request&#39;s parameters, used to derive the name of the cache file.</span>
</span><span id="L-295"><a href="#L-295"><span class="linenos"> 295</span></a>
</span><span id="L-296"><a href="#L-296"><span class="linenos"> 296</span></a><span class="sd">        Returns</span>
</span><span id="L-297"><a href="#L-297"><span class="linenos"> 297</span></a><span class="sd">        -------</span>
</span><span id="L-298"><a href="#L-298"><span class="linenos"> 298</span></a><span class="sd">        PseudoResponse</span>
</span><span id="L-299"><a href="#L-299"><span class="linenos"> 299</span></a><span class="sd">            The response text read from the cache file wrapped in a</span>
</span><span id="L-300"><a href="#L-300"><span class="linenos"> 300</span></a><span class="sd">            PseudoResponse object, or None in case no matching file was found in</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos"> 301</span></a><span class="sd">            the local cache.</span>
</span><span id="L-302"><a href="#L-302"><span class="linenos"> 302</span></a>
</span><span id="L-303"><a href="#L-303"><span class="linenos"> 303</span></a><span class="sd">        Raises</span>
</span><span id="L-304"><a href="#L-304"><span class="linenos"> 304</span></a><span class="sd">        ------</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos"> 305</span></a><span class="sd">        LookupError</span>
</span><span id="L-306"><a href="#L-306"><span class="linenos"> 306</span></a><span class="sd">            Raised in case no cache path has been set or no cache file matching</span>
</span><span id="L-307"><a href="#L-307"><span class="linenos"> 307</span></a><span class="sd">            the request parameters could be found in the cache.</span>
</span><span id="L-308"><a href="#L-308"><span class="linenos"> 308</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-309"><a href="#L-309"><span class="linenos"> 309</span></a>
</span><span id="L-310"><a href="#L-310"><span class="linenos"> 310</span></a>        <span class="c1"># pylint: disable-msg=too-few-public-methods</span>
</span><span id="L-311"><a href="#L-311"><span class="linenos"> 311</span></a>        <span class="k">class</span> <span class="nc">PseudoResponse</span><span class="p">:</span>
</span><span id="L-312"><a href="#L-312"><span class="linenos"> 312</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;Dummy response object with attribs &#39;text&#39; and &#39;status_code&#39;.&quot;&quot;&quot;</span>
</span><span id="L-313"><a href="#L-313"><span class="linenos"> 313</span></a>
</span><span id="L-314"><a href="#L-314"><span class="linenos"> 314</span></a>            <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">status_code</span><span class="p">):</span>
</span><span id="L-315"><a href="#L-315"><span class="linenos"> 315</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">text</span>
</span><span id="L-316"><a href="#L-316"><span class="linenos"> 316</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">status_code</span><span class="p">)</span>
</span><span id="L-317"><a href="#L-317"><span class="linenos"> 317</span></a>
</span><span id="L-318"><a href="#L-318"><span class="linenos"> 318</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_path</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
</span><span id="L-319"><a href="#L-319"><span class="linenos"> 319</span></a>            <span class="k">raise</span> <span class="ne">LookupError</span><span class="p">(</span><span class="s2">&quot;No cache path configured&quot;</span><span class="p">)</span>
</span><span id="L-320"><a href="#L-320"><span class="linenos"> 320</span></a>
</span><span id="L-321"><a href="#L-321"><span class="linenos"> 321</span></a>        <span class="n">intercept_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__interception_path</span><span class="p">(</span><span class="n">req_data</span><span class="p">,</span> <span class="n">create_dir</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-322"><a href="#L-322"><span class="linenos"> 322</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">intercept_file</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">intercept_file</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
</span><span id="L-323"><a href="#L-323"><span class="linenos"> 323</span></a>            <span class="k">raise</span> <span class="ne">LookupError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No cache hit for [</span><span class="si">{</span><span class="n">intercept_file</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
</span><span id="L-324"><a href="#L-324"><span class="linenos"> 324</span></a>
</span><span id="L-325"><a href="#L-325"><span class="linenos"> 325</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">intercept_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">infile</span><span class="p">:</span>
</span><span id="L-326"><a href="#L-326"><span class="linenos"> 326</span></a>            <span class="n">text</span> <span class="o">=</span> <span class="n">infile</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span><span id="L-327"><a href="#L-327"><span class="linenos"> 327</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
</span><span id="L-328"><a href="#L-328"><span class="linenos"> 328</span></a>            <span class="s2">&quot;Read intercepted response text from [</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="p">,</span>
</span><span id="L-329"><a href="#L-329"><span class="linenos"> 329</span></a>            <span class="n">intercept_file</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_path</span><span class="p">))</span> <span class="p">:],</span>
</span><span id="L-330"><a href="#L-330"><span class="linenos"> 330</span></a>        <span class="p">)</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos"> 331</span></a>
</span><span id="L-332"><a href="#L-332"><span class="linenos"> 332</span></a>        <span class="n">status_code</span> <span class="o">=</span> <span class="mi">200</span>
</span><span id="L-333"><a href="#L-333"><span class="linenos"> 333</span></a>        <span class="n">status_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">intercept_file</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_status-code.txt&quot;</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos"> 334</span></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">status_file</span><span class="p">):</span>
</span><span id="L-335"><a href="#L-335"><span class="linenos"> 335</span></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">status_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">infile</span><span class="p">:</span>
</span><span id="L-336"><a href="#L-336"><span class="linenos"> 336</span></a>                <span class="n">status_code</span> <span class="o">=</span> <span class="n">infile</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span><span id="L-337"><a href="#L-337"><span class="linenos"> 337</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Read intercepted response status code from [</span><span class="si">{</span><span class="n">status_file</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
</span><span id="L-338"><a href="#L-338"><span class="linenos"> 338</span></a>        <span class="k">return</span> <span class="n">PseudoResponse</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">status_code</span><span class="p">)</span>
</span><span id="L-339"><a href="#L-339"><span class="linenos"> 339</span></a>
</span><span id="L-340"><a href="#L-340"><span class="linenos"> 340</span></a>    <span class="k">def</span> <span class="nf">__intercept_store</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req_data</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
</span><span id="L-341"><a href="#L-341"><span class="linenos"> 341</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Store the response in a local cache file named after the request.</span>
</span><span id="L-342"><a href="#L-342"><span class="linenos"> 342</span></a>
</span><span id="L-343"><a href="#L-343"><span class="linenos"> 343</span></a><span class="sd">        Parameters</span>
</span><span id="L-344"><a href="#L-344"><span class="linenos"> 344</span></a><span class="sd">        ----------</span>
</span><span id="L-345"><a href="#L-345"><span class="linenos"> 345</span></a><span class="sd">        req_data : dict</span>
</span><span id="L-346"><a href="#L-346"><span class="linenos"> 346</span></a><span class="sd">            The request&#39;s parameters, used to derive the name of the cache file</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos"> 347</span></a><span class="sd">            so it can be matched later when running the same request again.</span>
</span><span id="L-348"><a href="#L-348"><span class="linenos"> 348</span></a><span class="sd">        response : requests.Response</span>
</span><span id="L-349"><a href="#L-349"><span class="linenos"> 349</span></a><span class="sd">            The response object to store in the local cache.</span>
</span><span id="L-350"><a href="#L-350"><span class="linenos"> 350</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-351"><a href="#L-351"><span class="linenos"> 351</span></a>        <span class="c1"># NOTE: this method is excluded from coverage measurements as it can only be</span>
</span><span id="L-352"><a href="#L-352"><span class="linenos"> 352</span></a>        <span class="c1"># triggered when testing in online mode with at least one request not being</span>
</span><span id="L-353"><a href="#L-353"><span class="linenos"> 353</span></a>        <span class="c1"># served from the cache (which is orthogonal to off-line testing)</span>
</span><span id="L-354"><a href="#L-354"><span class="linenos"> 354</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_path</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
</span><span id="L-355"><a href="#L-355"><span class="linenos"> 355</span></a>            <span class="k">return</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos"> 356</span></a>
</span><span id="L-357"><a href="#L-357"><span class="linenos"> 357</span></a>        <span class="n">intercept_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__interception_path</span><span class="p">(</span><span class="n">req_data</span><span class="p">,</span> <span class="n">create_dir</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-358"><a href="#L-358"><span class="linenos"> 358</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">intercept_file</span><span class="p">:</span>
</span><span id="L-359"><a href="#L-359"><span class="linenos"> 359</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s2">&quot;Not storing intercepted results in cache.&quot;</span><span class="p">)</span>
</span><span id="L-360"><a href="#L-360"><span class="linenos"> 360</span></a>            <span class="k">return</span>
</span><span id="L-361"><a href="#L-361"><span class="linenos"> 361</span></a>
</span><span id="L-362"><a href="#L-362"><span class="linenos"> 362</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-363"><a href="#L-363"><span class="linenos"> 363</span></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">intercept_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outfile</span><span class="p">:</span>
</span><span id="L-364"><a href="#L-364"><span class="linenos"> 364</span></a>                <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</span><span id="L-365"><a href="#L-365"><span class="linenos"> 365</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
</span><span id="L-366"><a href="#L-366"><span class="linenos"> 366</span></a>                <span class="s2">&quot;Wrote response text to [</span><span class="si">{}</span><span class="s2">] (</span><span class="si">{}</span><span class="s2"> lines)&quot;</span><span class="p">,</span>
</span><span id="L-367"><a href="#L-367"><span class="linenos"> 367</span></a>                <span class="n">intercept_file</span><span class="p">,</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos"> 368</span></a>                <span class="nb">len</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()),</span>
</span><span id="L-369"><a href="#L-369"><span class="linenos"> 369</span></a>            <span class="p">)</span>
</span><span id="L-370"><a href="#L-370"><span class="linenos"> 370</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>  <span class="c1"># pylint: disable-msg=broad-except</span>
</span><span id="L-371"><a href="#L-371"><span class="linenos"> 371</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Storing response text in [</span><span class="si">{}</span><span class="s2">] failed: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">intercept_file</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
</span><span id="L-372"><a href="#L-372"><span class="linenos"> 372</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Response text was:</span><span class="se">\n</span><span class="s2">--------</span><span class="se">\n</span><span class="si">{}</span><span class="se">\n</span><span class="s2">--------&quot;</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</span><span id="L-373"><a href="#L-373"><span class="linenos"> 373</span></a>
</span><span id="L-374"><a href="#L-374"><span class="linenos"> 374</span></a>    <span class="k">def</span> <span class="nf">flush_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keep_users</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-375"><a href="#L-375"><span class="linenos"> 375</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Flush the PyPPMS on-disk cache.</span>
</span><span id="L-376"><a href="#L-376"><span class="linenos"> 376</span></a>
</span><span id="L-377"><a href="#L-377"><span class="linenos"> 377</span></a><span class="sd">        Optionally flushes everything *except* the `getuser` cache if the</span>
</span><span id="L-378"><a href="#L-378"><span class="linenos"> 378</span></a><span class="sd">        `keep_users` flag is set to `True`, as this is clearly the most</span>
</span><span id="L-379"><a href="#L-379"><span class="linenos"> 379</span></a><span class="sd">        time-consuming operation when fetching data from PUMAPI and therefore</span>
</span><span id="L-380"><a href="#L-380"><span class="linenos"> 380</span></a><span class="sd">        might want to be retained.</span>
</span><span id="L-381"><a href="#L-381"><span class="linenos"> 381</span></a>
</span><span id="L-382"><a href="#L-382"><span class="linenos"> 382</span></a><span class="sd">        Please note that the `getusers` cache (plural, including the `s` suffix)</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos"> 383</span></a><span class="sd">        will be flushed no matter what, as this is simply a list of user IDs</span>
</span><span id="L-384"><a href="#L-384"><span class="linenos"> 384</span></a><span class="sd">        that can be fetched with a single request. In consequence this means</span>
</span><span id="L-385"><a href="#L-385"><span class="linenos"> 385</span></a><span class="sd">        that using the `keep_users` flag will allow you to have reasonably fast</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos"> 386</span></a><span class="sd">        reaction times while still getting information on *new* users live from</span>
</span><span id="L-387"><a href="#L-387"><span class="linenos"> 387</span></a><span class="sd">        PUMAPI at the only cost of possibly having outdated information on</span>
</span><span id="L-388"><a href="#L-388"><span class="linenos"> 388</span></a><span class="sd">        *existing* users.</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos"> 389</span></a>
</span><span id="L-390"><a href="#L-390"><span class="linenos"> 390</span></a><span class="sd">        Parameters</span>
</span><span id="L-391"><a href="#L-391"><span class="linenos"> 391</span></a><span class="sd">        ----------</span>
</span><span id="L-392"><a href="#L-392"><span class="linenos"> 392</span></a><span class="sd">        keep_users : bool, optional</span>
</span><span id="L-393"><a href="#L-393"><span class="linenos"> 393</span></a><span class="sd">            If set to `True` the `getuser` sub-directory in the cache location</span>
</span><span id="L-394"><a href="#L-394"><span class="linenos"> 394</span></a><span class="sd">            will be kept, by default `False`.</span>
</span><span id="L-395"><a href="#L-395"><span class="linenos"> 395</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-396"><a href="#L-396"><span class="linenos"> 396</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_path</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
</span><span id="L-397"><a href="#L-397"><span class="linenos"> 397</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;No cache path configured, not flushing!&quot;</span><span class="p">)</span>
</span><span id="L-398"><a href="#L-398"><span class="linenos"> 398</span></a>            <span class="k">return</span>
</span><span id="L-399"><a href="#L-399"><span class="linenos"> 399</span></a>
</span><span id="L-400"><a href="#L-400"><span class="linenos"> 400</span></a>        <span class="n">dirs_to_remove</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_path</span><span class="p">]</span>  <span class="c1"># by default remove the entire cache dir</span>
</span><span id="L-401"><a href="#L-401"><span class="linenos"> 401</span></a>        <span class="n">keep_msg</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="L-402"><a href="#L-402"><span class="linenos"> 402</span></a>        <span class="k">if</span> <span class="n">keep_users</span><span class="p">:</span>
</span><span id="L-403"><a href="#L-403"><span class="linenos"> 403</span></a>            <span class="n">keep_msg</span> <span class="o">=</span> <span class="s2">&quot; (keeping user details dirs)&quot;</span>
</span><span id="L-404"><a href="#L-404"><span class="linenos"> 404</span></a>            <span class="n">dirs_to_remove</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-405"><a href="#L-405"><span class="linenos"> 405</span></a>            <span class="n">cache_dirs</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_path</span><span class="p">)</span>
</span><span id="L-406"><a href="#L-406"><span class="linenos"> 406</span></a>            <span class="k">for</span> <span class="n">subdir</span> <span class="ow">in</span> <span class="n">cache_dirs</span><span class="p">:</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos"> 407</span></a>                <span class="k">if</span> <span class="n">subdir</span> <span class="o">==</span> <span class="s2">&quot;getuser&quot;</span><span class="p">:</span>
</span><span id="L-408"><a href="#L-408"><span class="linenos"> 408</span></a>                    <span class="k">continue</span>
</span><span id="L-409"><a href="#L-409"><span class="linenos"> 409</span></a>                <span class="n">dirs_to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_path</span><span class="p">,</span> <span class="n">subdir</span><span class="p">))</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos"> 410</span></a>
</span><span id="L-411"><a href="#L-411"><span class="linenos"> 411</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Flushing the on-disk cache at [</span><span class="si">{}</span><span class="s2">] </span><span class="si">{}</span><span class="s2">...&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_path</span><span class="p">,</span> <span class="n">keep_msg</span><span class="p">)</span>
</span><span id="L-412"><a href="#L-412"><span class="linenos"> 412</span></a>        <span class="k">for</span> <span class="n">directory</span> <span class="ow">in</span> <span class="n">dirs_to_remove</span><span class="p">:</span>
</span><span id="L-413"><a href="#L-413"><span class="linenos"> 413</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="L-414"><a href="#L-414"><span class="linenos"> 414</span></a>                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
</span><span id="L-415"><a href="#L-415"><span class="linenos"> 415</span></a>                <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s2">&quot;Removed directory [</span><span class="si">{}</span><span class="s2">].&quot;</span><span class="p">,</span> <span class="n">directory</span><span class="p">)</span>
</span><span id="L-416"><a href="#L-416"><span class="linenos"> 416</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>  <span class="c1"># pylint: disable-msg=broad-except</span>
</span><span id="L-417"><a href="#L-417"><span class="linenos"> 417</span></a>                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Removing the cache at [</span><span class="si">{}</span><span class="s2">] failed: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">directory</span><span class="p">,</span> <span class="n">ex</span><span class="p">)</span>
</span><span id="L-418"><a href="#L-418"><span class="linenos"> 418</span></a>
</span><span id="L-419"><a href="#L-419"><span class="linenos"> 419</span></a>    <span class="k">def</span> <span class="nf">get_admins</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-420"><a href="#L-420"><span class="linenos"> 420</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get all PPMS administrator users.</span>
</span><span id="L-421"><a href="#L-421"><span class="linenos"> 421</span></a>
</span><span id="L-422"><a href="#L-422"><span class="linenos"> 422</span></a><span class="sd">        Returns</span>
</span><span id="L-423"><a href="#L-423"><span class="linenos"> 423</span></a><span class="sd">        -------</span>
</span><span id="L-424"><a href="#L-424"><span class="linenos"> 424</span></a><span class="sd">        list(pyppms.user.PpmsUser)</span>
</span><span id="L-425"><a href="#L-425"><span class="linenos"> 425</span></a><span class="sd">            A list with PpmsUser objects that are PPMS administrators.</span>
</span><span id="L-426"><a href="#L-426"><span class="linenos"> 426</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-427"><a href="#L-427"><span class="linenos"> 427</span></a>        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;getadmins&quot;</span><span class="p">)</span>
</span><span id="L-428"><a href="#L-428"><span class="linenos"> 428</span></a>
</span><span id="L-429"><a href="#L-429"><span class="linenos"> 429</span></a>        <span class="n">admins</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
</span><span id="L-430"><a href="#L-430"><span class="linenos"> 430</span></a>        <span class="n">users</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-431"><a href="#L-431"><span class="linenos"> 431</span></a>        <span class="k">for</span> <span class="n">username</span> <span class="ow">in</span> <span class="n">admins</span><span class="p">:</span>
</span><span id="L-432"><a href="#L-432"><span class="linenos"> 432</span></a>            <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
</span><span id="L-433"><a href="#L-433"><span class="linenos"> 433</span></a>            <span class="n">users</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</span><span id="L-434"><a href="#L-434"><span class="linenos"> 434</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> admins in the PPMS database: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">admins</span><span class="p">),</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">admins</span><span class="p">))</span>
</span><span id="L-435"><a href="#L-435"><span class="linenos"> 435</span></a>        <span class="k">return</span> <span class="n">users</span>
</span><span id="L-436"><a href="#L-436"><span class="linenos"> 436</span></a>
</span><span id="L-437"><a href="#L-437"><span class="linenos"> 437</span></a>    <span class="k">def</span> <span class="nf">get_booking</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">system_id</span><span class="p">,</span> <span class="n">booking_type</span><span class="o">=</span><span class="s2">&quot;get&quot;</span><span class="p">):</span>
</span><span id="L-438"><a href="#L-438"><span class="linenos"> 438</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the current or next booking of a system.</span>
</span><span id="L-439"><a href="#L-439"><span class="linenos"> 439</span></a>
</span><span id="L-440"><a href="#L-440"><span class="linenos"> 440</span></a><span class="sd">        WARNING: if the next booking is requested but it is too far in the future,</span>
</span><span id="L-441"><a href="#L-441"><span class="linenos"> 441</span></a><span class="sd">        PUMAPI silently ignores it - the response is identical to a system that has no</span>
</span><span id="L-442"><a href="#L-442"><span class="linenos"> 442</span></a><span class="sd">        future bookings and there is no error reported either. Currently it is unclear</span>
</span><span id="L-443"><a href="#L-443"><span class="linenos"> 443</span></a><span class="sd">        where the cutoff is (e.g. lookups for a booking that is two years from now still</span>
</span><span id="L-444"><a href="#L-444"><span class="linenos"> 444</span></a><span class="sd">        work fine, but a booking in about 10 years is silently skipped).</span>
</span><span id="L-445"><a href="#L-445"><span class="linenos"> 445</span></a>
</span><span id="L-446"><a href="#L-446"><span class="linenos"> 446</span></a><span class="sd">        Parameters</span>
</span><span id="L-447"><a href="#L-447"><span class="linenos"> 447</span></a><span class="sd">        ----------</span>
</span><span id="L-448"><a href="#L-448"><span class="linenos"> 448</span></a><span class="sd">        system_id : int or int-like</span>
</span><span id="L-449"><a href="#L-449"><span class="linenos"> 449</span></a><span class="sd">            The ID of the system in PPMS.</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos"> 450</span></a><span class="sd">        booking_type : {&#39;get&#39;, &#39;next&#39;}, optional</span>
</span><span id="L-451"><a href="#L-451"><span class="linenos"> 451</span></a><span class="sd">            The type of booking to request, one of `get` (requesting the</span>
</span><span id="L-452"><a href="#L-452"><span class="linenos"> 452</span></a><span class="sd">            currently running booking) and `next` (requesting the next upcoming</span>
</span><span id="L-453"><a href="#L-453"><span class="linenos"> 453</span></a><span class="sd">            booking), by default `get`.</span>
</span><span id="L-454"><a href="#L-454"><span class="linenos"> 454</span></a><span class="sd">            NOTE: if `next` is requested the resulting booking object will **NOT** have</span>
</span><span id="L-455"><a href="#L-455"><span class="linenos"> 455</span></a><span class="sd">            an end time (`endtime` will be `None`) as PUMAPI doesn&#39;t provide one in that</span>
</span><span id="L-456"><a href="#L-456"><span class="linenos"> 456</span></a><span class="sd">            case!</span>
</span><span id="L-457"><a href="#L-457"><span class="linenos"> 457</span></a>
</span><span id="L-458"><a href="#L-458"><span class="linenos"> 458</span></a><span class="sd">        Returns</span>
</span><span id="L-459"><a href="#L-459"><span class="linenos"> 459</span></a><span class="sd">        -------</span>
</span><span id="L-460"><a href="#L-460"><span class="linenos"> 460</span></a><span class="sd">        pyppms.booking.PpmsBooking or None</span>
</span><span id="L-461"><a href="#L-461"><span class="linenos"> 461</span></a><span class="sd">            The booking object, or None if there is no booking for the system or the</span>
</span><span id="L-462"><a href="#L-462"><span class="linenos"> 462</span></a><span class="sd">            request is refused by PUMAPI (e.g. &quot;not authorized&quot;).</span>
</span><span id="L-463"><a href="#L-463"><span class="linenos"> 463</span></a>
</span><span id="L-464"><a href="#L-464"><span class="linenos"> 464</span></a><span class="sd">        Raises</span>
</span><span id="L-465"><a href="#L-465"><span class="linenos"> 465</span></a><span class="sd">        ------</span>
</span><span id="L-466"><a href="#L-466"><span class="linenos"> 466</span></a><span class="sd">        ValueError</span>
</span><span id="L-467"><a href="#L-467"><span class="linenos"> 467</span></a><span class="sd">            Raised if the specified `booking_type` is invalid.</span>
</span><span id="L-468"><a href="#L-468"><span class="linenos"> 468</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-469"><a href="#L-469"><span class="linenos"> 469</span></a>        <span class="n">valid</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;get&quot;</span><span class="p">,</span> <span class="s2">&quot;next&quot;</span><span class="p">]</span>
</span><span id="L-470"><a href="#L-470"><span class="linenos"> 470</span></a>        <span class="k">if</span> <span class="n">booking_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid</span><span class="p">:</span>
</span><span id="L-471"><a href="#L-471"><span class="linenos"> 471</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="L-472"><a href="#L-472"><span class="linenos"> 472</span></a>                <span class="sa">f</span><span class="s2">&quot;Value for &#39;booking_type&#39; (</span><span class="si">{</span><span class="n">booking_type</span><span class="si">}</span><span class="s2">) not in </span><span class="si">{</span><span class="n">valid</span><span class="si">}</span><span class="s2">!&quot;</span>
</span><span id="L-473"><a href="#L-473"><span class="linenos"> 473</span></a>            <span class="p">)</span>
</span><span id="L-474"><a href="#L-474"><span class="linenos"> 474</span></a>
</span><span id="L-475"><a href="#L-475"><span class="linenos"> 475</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-476"><a href="#L-476"><span class="linenos"> 476</span></a>            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">booking_type</span> <span class="o">+</span> <span class="s2">&quot;booking&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">system_id</span><span class="p">})</span>
</span><span id="L-477"><a href="#L-477"><span class="linenos"> 477</span></a>        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ConnectionError</span><span class="p">:</span>
</span><span id="L-478"><a href="#L-478"><span class="linenos"> 478</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Requesting booking status for system </span><span class="si">{}</span><span class="s2"> failed!&quot;</span><span class="p">,</span> <span class="n">system_id</span><span class="p">)</span>
</span><span id="L-479"><a href="#L-479"><span class="linenos"> 479</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="L-480"><a href="#L-480"><span class="linenos"> 480</span></a>
</span><span id="L-481"><a href="#L-481"><span class="linenos"> 481</span></a>        <span class="n">desc</span> <span class="o">=</span> <span class="s2">&quot;any future bookings&quot;</span>
</span><span id="L-482"><a href="#L-482"><span class="linenos"> 482</span></a>        <span class="k">if</span> <span class="n">booking_type</span> <span class="o">==</span> <span class="s2">&quot;get&quot;</span><span class="p">:</span>
</span><span id="L-483"><a href="#L-483"><span class="linenos"> 483</span></a>            <span class="n">desc</span> <span class="o">=</span> <span class="s2">&quot;a currently active booking&quot;</span>
</span><span id="L-484"><a href="#L-484"><span class="linenos"> 484</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
</span><span id="L-485"><a href="#L-485"><span class="linenos"> 485</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s2">&quot;System [</span><span class="si">{}</span><span class="s2">] doesn&#39;t have </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">system_id</span><span class="p">,</span> <span class="n">desc</span><span class="p">)</span>
</span><span id="L-486"><a href="#L-486"><span class="linenos"> 486</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="L-487"><a href="#L-487"><span class="linenos"> 487</span></a>
</span><span id="L-488"><a href="#L-488"><span class="linenos"> 488</span></a>        <span class="k">return</span> <span class="n">PpmsBooking</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">booking_type</span><span class="p">,</span> <span class="n">system_id</span><span class="p">)</span>
</span><span id="L-489"><a href="#L-489"><span class="linenos"> 489</span></a>
</span><span id="L-490"><a href="#L-490"><span class="linenos"> 490</span></a>    <span class="k">def</span> <span class="nf">get_current_booking</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">system_id</span><span class="p">):</span>
</span><span id="L-491"><a href="#L-491"><span class="linenos"> 491</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Wrapper for `get_booking()` with &#39;booking_type&#39; set to &#39;get&#39;.&quot;&quot;&quot;</span>
</span><span id="L-492"><a href="#L-492"><span class="linenos"> 492</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_booking</span><span class="p">(</span><span class="n">system_id</span><span class="p">,</span> <span class="s2">&quot;get&quot;</span><span class="p">)</span>
</span><span id="L-493"><a href="#L-493"><span class="linenos"> 493</span></a>
</span><span id="L-494"><a href="#L-494"><span class="linenos"> 494</span></a>    <span class="k">def</span> <span class="nf">get_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group_id</span><span class="p">):</span>
</span><span id="L-495"><a href="#L-495"><span class="linenos"> 495</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Fetch group details from PPMS and create a dict from them.</span>
</span><span id="L-496"><a href="#L-496"><span class="linenos"> 496</span></a>
</span><span id="L-497"><a href="#L-497"><span class="linenos"> 497</span></a><span class="sd">        Parameters</span>
</span><span id="L-498"><a href="#L-498"><span class="linenos"> 498</span></a><span class="sd">        ----------</span>
</span><span id="L-499"><a href="#L-499"><span class="linenos"> 499</span></a><span class="sd">        group_id : str</span>
</span><span id="L-500"><a href="#L-500"><span class="linenos"> 500</span></a><span class="sd">            The group&#39;s identifier in PPMS, called &#39;unitlogin&#39; there.</span>
</span><span id="L-501"><a href="#L-501"><span class="linenos"> 501</span></a>
</span><span id="L-502"><a href="#L-502"><span class="linenos"> 502</span></a><span class="sd">        Returns</span>
</span><span id="L-503"><a href="#L-503"><span class="linenos"> 503</span></a><span class="sd">        -------</span>
</span><span id="L-504"><a href="#L-504"><span class="linenos"> 504</span></a><span class="sd">        dict</span>
</span><span id="L-505"><a href="#L-505"><span class="linenos"> 505</span></a><span class="sd">            A dict with the group details, keys being derived from the header</span>
</span><span id="L-506"><a href="#L-506"><span class="linenos"> 506</span></a><span class="sd">            line of the PUMAPI response, values from the data line.</span>
</span><span id="L-507"><a href="#L-507"><span class="linenos"> 507</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-508"><a href="#L-508"><span class="linenos"> 508</span></a>        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;getgroup&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;unitlogin&quot;</span><span class="p">:</span> <span class="n">group_id</span><span class="p">})</span>
</span><span id="L-509"><a href="#L-509"><span class="linenos"> 509</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s2">&quot;Group details returned by PPMS (raw): </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</span><span id="L-510"><a href="#L-510"><span class="linenos"> 510</span></a>
</span><span id="L-511"><a href="#L-511"><span class="linenos"> 511</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
</span><span id="L-512"><a href="#L-512"><span class="linenos"> 512</span></a>            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Group [</span><span class="si">{</span><span class="n">group_id</span><span class="si">}</span><span class="s2">] is unknown to PPMS&quot;</span>
</span><span id="L-513"><a href="#L-513"><span class="linenos"> 513</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="L-514"><a href="#L-514"><span class="linenos"> 514</span></a>            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="L-515"><a href="#L-515"><span class="linenos"> 515</span></a>
</span><span id="L-516"><a href="#L-516"><span class="linenos"> 516</span></a>        <span class="n">details</span> <span class="o">=</span> <span class="n">dict_from_single_response</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</span><span id="L-517"><a href="#L-517"><span class="linenos"> 517</span></a>
</span><span id="L-518"><a href="#L-518"><span class="linenos"> 518</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s2">&quot;Details of group </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">group_id</span><span class="p">,</span> <span class="n">details</span><span class="p">)</span>
</span><span id="L-519"><a href="#L-519"><span class="linenos"> 519</span></a>        <span class="k">return</span> <span class="n">details</span>
</span><span id="L-520"><a href="#L-520"><span class="linenos"> 520</span></a>
</span><span id="L-521"><a href="#L-521"><span class="linenos"> 521</span></a>    <span class="k">def</span> <span class="nf">get_group_users</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unitlogin</span><span class="p">):</span>
</span><span id="L-522"><a href="#L-522"><span class="linenos"> 522</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get all members of a group in PPMS.</span>
</span><span id="L-523"><a href="#L-523"><span class="linenos"> 523</span></a>
</span><span id="L-524"><a href="#L-524"><span class="linenos"> 524</span></a><span class="sd">        Parameters</span>
</span><span id="L-525"><a href="#L-525"><span class="linenos"> 525</span></a><span class="sd">        ----------</span>
</span><span id="L-526"><a href="#L-526"><span class="linenos"> 526</span></a><span class="sd">        unitlogin : str</span>
</span><span id="L-527"><a href="#L-527"><span class="linenos"> 527</span></a><span class="sd">            The group&#39;s login (&quot;unique login or id&quot; in the PPMS web interface).</span>
</span><span id="L-528"><a href="#L-528"><span class="linenos"> 528</span></a>
</span><span id="L-529"><a href="#L-529"><span class="linenos"> 529</span></a><span class="sd">        Returns</span>
</span><span id="L-530"><a href="#L-530"><span class="linenos"> 530</span></a><span class="sd">        -------</span>
</span><span id="L-531"><a href="#L-531"><span class="linenos"> 531</span></a><span class="sd">        list(pyppms.user.PpmsUser)</span>
</span><span id="L-532"><a href="#L-532"><span class="linenos"> 532</span></a><span class="sd">            A list with PpmsUser objects that are members of this PPMS group.</span>
</span><span id="L-533"><a href="#L-533"><span class="linenos"> 533</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-534"><a href="#L-534"><span class="linenos"> 534</span></a>        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;getgroupusers&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;unitlogin&quot;</span><span class="p">:</span> <span class="n">unitlogin</span><span class="p">})</span>
</span><span id="L-535"><a href="#L-535"><span class="linenos"> 535</span></a>
</span><span id="L-536"><a href="#L-536"><span class="linenos"> 536</span></a>        <span class="n">members</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
</span><span id="L-537"><a href="#L-537"><span class="linenos"> 537</span></a>        <span class="n">users</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-538"><a href="#L-538"><span class="linenos"> 538</span></a>        <span class="k">for</span> <span class="n">username</span> <span class="ow">in</span> <span class="n">members</span><span class="p">:</span>
</span><span id="L-539"><a href="#L-539"><span class="linenos"> 539</span></a>            <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
</span><span id="L-540"><a href="#L-540"><span class="linenos"> 540</span></a>            <span class="n">users</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</span><span id="L-541"><a href="#L-541"><span class="linenos"> 541</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span>
</span><span id="L-542"><a href="#L-542"><span class="linenos"> 542</span></a>            <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> members in PPMS group [</span><span class="si">{}</span><span class="s2">]: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="L-543"><a href="#L-543"><span class="linenos"> 543</span></a>            <span class="nb">len</span><span class="p">(</span><span class="n">members</span><span class="p">),</span>
</span><span id="L-544"><a href="#L-544"><span class="linenos"> 544</span></a>            <span class="n">unitlogin</span><span class="p">,</span>
</span><span id="L-545"><a href="#L-545"><span class="linenos"> 545</span></a>            <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">members</span><span class="p">),</span>
</span><span id="L-546"><a href="#L-546"><span class="linenos"> 546</span></a>        <span class="p">)</span>
</span><span id="L-547"><a href="#L-547"><span class="linenos"> 547</span></a>        <span class="k">return</span> <span class="n">users</span>
</span><span id="L-548"><a href="#L-548"><span class="linenos"> 548</span></a>
</span><span id="L-549"><a href="#L-549"><span class="linenos"> 549</span></a>    <span class="k">def</span> <span class="nf">get_groups</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-550"><a href="#L-550"><span class="linenos"> 550</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get a list of all groups in PPMS.</span>
</span><span id="L-551"><a href="#L-551"><span class="linenos"> 551</span></a>
</span><span id="L-552"><a href="#L-552"><span class="linenos"> 552</span></a><span class="sd">        Returns</span>
</span><span id="L-553"><a href="#L-553"><span class="linenos"> 553</span></a><span class="sd">        -------</span>
</span><span id="L-554"><a href="#L-554"><span class="linenos"> 554</span></a><span class="sd">        list(str)</span>
</span><span id="L-555"><a href="#L-555"><span class="linenos"> 555</span></a><span class="sd">            A list with the group identifiers in PPMS.</span>
</span><span id="L-556"><a href="#L-556"><span class="linenos"> 556</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-557"><a href="#L-557"><span class="linenos"> 557</span></a>        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;getgroups&quot;</span><span class="p">)</span>
</span><span id="L-558"><a href="#L-558"><span class="linenos"> 558</span></a>
</span><span id="L-559"><a href="#L-559"><span class="linenos"> 559</span></a>        <span class="n">groups</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
</span><span id="L-560"><a href="#L-560"><span class="linenos"> 560</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> groups in the PPMS database: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">groups</span><span class="p">),</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">groups</span><span class="p">))</span>
</span><span id="L-561"><a href="#L-561"><span class="linenos"> 561</span></a>        <span class="k">return</span> <span class="n">groups</span>
</span><span id="L-562"><a href="#L-562"><span class="linenos"> 562</span></a>
</span><span id="L-563"><a href="#L-563"><span class="linenos"> 563</span></a>    <span class="k">def</span> <span class="nf">get_next_booking</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">system_id</span><span class="p">):</span>
</span><span id="L-564"><a href="#L-564"><span class="linenos"> 564</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Wrapper for `get_booking()` with &#39;booking_type&#39; set to &#39;next&#39;.&quot;&quot;&quot;</span>
</span><span id="L-565"><a href="#L-565"><span class="linenos"> 565</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_booking</span><span class="p">(</span><span class="n">system_id</span><span class="p">,</span> <span class="s2">&quot;next&quot;</span><span class="p">)</span>
</span><span id="L-566"><a href="#L-566"><span class="linenos"> 566</span></a>
</span><span id="L-567"><a href="#L-567"><span class="linenos"> 567</span></a>    <span class="k">def</span> <span class="nf">get_running_sheet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">core_facility_ref</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">ignore_uncached_users</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-568"><a href="#L-568"><span class="linenos"> 568</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the running sheet for a specific day on the given facility.</span>
</span><span id="L-569"><a href="#L-569"><span class="linenos"> 569</span></a>
</span><span id="L-570"><a href="#L-570"><span class="linenos"> 570</span></a><span class="sd">        The so-called &quot;running-sheet&quot; consists of all bookings / reservations of</span>
</span><span id="L-571"><a href="#L-571"><span class="linenos"> 571</span></a><span class="sd">        a facility on a specifc day.</span>
</span><span id="L-572"><a href="#L-572"><span class="linenos"> 572</span></a>
</span><span id="L-573"><a href="#L-573"><span class="linenos"> 573</span></a><span class="sd">        WARNING: PUMAPI doesn&#39;t return a proper unique user identifier with the</span>
</span><span id="L-574"><a href="#L-574"><span class="linenos"> 574</span></a><span class="sd">        &#39;getrunningsheet&#39; request, instead the so called &quot;full name&quot; is given to</span>
</span><span id="L-575"><a href="#L-575"><span class="linenos"> 575</span></a><span class="sd">        identify the user - unfortunately this can lead to ambiguities as</span>
</span><span id="L-576"><a href="#L-576"><span class="linenos"> 576</span></a><span class="sd">        multiple different accounts can have the same full name.</span>
</span><span id="L-577"><a href="#L-577"><span class="linenos"> 577</span></a>
</span><span id="L-578"><a href="#L-578"><span class="linenos"> 578</span></a><span class="sd">        Parameters</span>
</span><span id="L-579"><a href="#L-579"><span class="linenos"> 579</span></a><span class="sd">        ----------</span>
</span><span id="L-580"><a href="#L-580"><span class="linenos"> 580</span></a><span class="sd">        core_facility_ref : int or int-like</span>
</span><span id="L-581"><a href="#L-581"><span class="linenos"> 581</span></a><span class="sd">            The core facility ID for PPMS.</span>
</span><span id="L-582"><a href="#L-582"><span class="linenos"> 582</span></a><span class="sd">        date : datetime.datetime</span>
</span><span id="L-583"><a href="#L-583"><span class="linenos"> 583</span></a><span class="sd">            The date to request the running sheet for, e.g. ``datetime.now()`` or</span>
</span><span id="L-584"><a href="#L-584"><span class="linenos"> 584</span></a><span class="sd">            similar. Note that only the date part is relevant, time will be ignored.</span>
</span><span id="L-585"><a href="#L-585"><span class="linenos"> 585</span></a><span class="sd">        ignore_uncached_users : bool, optional</span>
</span><span id="L-586"><a href="#L-586"><span class="linenos"> 586</span></a><span class="sd">            If set to `True` any booking for a user that is not present in the instance</span>
</span><span id="L-587"><a href="#L-587"><span class="linenos"> 587</span></a><span class="sd">            attribute `fullname_mapping` will be ignored in the resulting list.</span>
</span><span id="L-588"><a href="#L-588"><span class="linenos"> 588</span></a>
</span><span id="L-589"><a href="#L-589"><span class="linenos"> 589</span></a><span class="sd">        Returns</span>
</span><span id="L-590"><a href="#L-590"><span class="linenos"> 590</span></a><span class="sd">        -------</span>
</span><span id="L-591"><a href="#L-591"><span class="linenos"> 591</span></a><span class="sd">        list(pyppms.booking.PpmsBooking)</span>
</span><span id="L-592"><a href="#L-592"><span class="linenos"> 592</span></a><span class="sd">            A list with `PpmsBooking` objects for the given day. Empty in case</span>
</span><span id="L-593"><a href="#L-593"><span class="linenos"> 593</span></a><span class="sd">            there are no bookings or parsing the response failed.</span>
</span><span id="L-594"><a href="#L-594"><span class="linenos"> 594</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-595"><a href="#L-595"><span class="linenos"> 595</span></a>        <span class="n">bookings</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-596"><a href="#L-596"><span class="linenos"> 596</span></a>        <span class="n">parameters</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-597"><a href="#L-597"><span class="linenos"> 597</span></a>            <span class="s2">&quot;plateformid&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">core_facility_ref</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="L-598"><a href="#L-598"><span class="linenos"> 598</span></a>            <span class="s2">&quot;day&quot;</span><span class="p">:</span> <span class="n">date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">),</span>
</span><span id="L-599"><a href="#L-599"><span class="linenos"> 599</span></a>        <span class="p">}</span>
</span><span id="L-600"><a href="#L-600"><span class="linenos"> 600</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s2">&quot;Requesting runningsheet for </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;day&quot;</span><span class="p">])</span>
</span><span id="L-601"><a href="#L-601"><span class="linenos"> 601</span></a>        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;getrunningsheet&quot;</span><span class="p">,</span> <span class="n">parameters</span><span class="p">)</span>
</span><span id="L-602"><a href="#L-602"><span class="linenos"> 602</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-603"><a href="#L-603"><span class="linenos"> 603</span></a>            <span class="n">entries</span> <span class="o">=</span> <span class="n">parse_multiline_response</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">graceful</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-604"><a href="#L-604"><span class="linenos"> 604</span></a>        <span class="k">except</span> <span class="n">NoDataError</span><span class="p">:</span>
</span><span id="L-605"><a href="#L-605"><span class="linenos"> 605</span></a>            <span class="c1"># in case no bookings exist the response will be empty!</span>
</span><span id="L-606"><a href="#L-606"><span class="linenos"> 606</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s2">&quot;Runningsheet for the given day was empty!&quot;</span><span class="p">)</span>
</span><span id="L-607"><a href="#L-607"><span class="linenos"> 607</span></a>            <span class="k">return</span> <span class="p">[]</span>
</span><span id="L-608"><a href="#L-608"><span class="linenos"> 608</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>  <span class="c1"># pylint: disable-msg=broad-except</span>
</span><span id="L-609"><a href="#L-609"><span class="linenos"> 609</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Parsing runningsheet details failed: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
</span><span id="L-610"><a href="#L-610"><span class="linenos"> 610</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s2">&quot;Runningsheet PUMPAI response was: &gt;&gt;&gt;</span><span class="si">{}</span><span class="s2">&lt;&lt;&lt;&quot;</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</span><span id="L-611"><a href="#L-611"><span class="linenos"> 611</span></a>            <span class="k">return</span> <span class="p">[]</span>
</span><span id="L-612"><a href="#L-612"><span class="linenos"> 612</span></a>
</span><span id="L-613"><a href="#L-613"><span class="linenos"> 613</span></a>        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
</span><span id="L-614"><a href="#L-614"><span class="linenos"> 614</span></a>            <span class="n">full</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;User&quot;</span><span class="p">]</span>
</span><span id="L-615"><a href="#L-615"><span class="linenos"> 615</span></a>            <span class="k">if</span> <span class="n">full</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fullname_mapping</span><span class="p">:</span>
</span><span id="L-616"><a href="#L-616"><span class="linenos"> 616</span></a>                <span class="k">if</span> <span class="n">ignore_uncached_users</span><span class="p">:</span>
</span><span id="L-617"><a href="#L-617"><span class="linenos"> 617</span></a>                    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Ignoring booking for uncached / unknown user [</span><span class="si">{</span><span class="n">full</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
</span><span id="L-618"><a href="#L-618"><span class="linenos"> 618</span></a>                    <span class="k">continue</span>
</span><span id="L-619"><a href="#L-619"><span class="linenos"> 619</span></a>
</span><span id="L-620"><a href="#L-620"><span class="linenos"> 620</span></a>                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Booking refers an uncached user (</span><span class="si">{</span><span class="n">full</span><span class="si">}</span><span class="s2">), updating users!&quot;</span><span class="p">)</span>
</span><span id="L-621"><a href="#L-621"><span class="linenos"> 621</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">update_users</span><span class="p">()</span>
</span><span id="L-622"><a href="#L-622"><span class="linenos"> 622</span></a>
</span><span id="L-623"><a href="#L-623"><span class="linenos"> 623</span></a>            <span class="k">if</span> <span class="n">full</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fullname_mapping</span><span class="p">:</span>
</span><span id="L-624"><a href="#L-624"><span class="linenos"> 624</span></a>                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;PPMS doesn&#39;t seem to know user [</span><span class="si">{}</span><span class="s2">], skipping&quot;</span><span class="p">,</span> <span class="n">full</span><span class="p">)</span>
</span><span id="L-625"><a href="#L-625"><span class="linenos"> 625</span></a>                <span class="k">continue</span>
</span><span id="L-626"><a href="#L-626"><span class="linenos"> 626</span></a>
</span><span id="L-627"><a href="#L-627"><span class="linenos"> 627</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span>
</span><span id="L-628"><a href="#L-628"><span class="linenos"> 628</span></a>                <span class="sa">f</span><span class="s2">&quot;Booking for user &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">fullname_mapping</span><span class="p">[</span><span class="n">full</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39; (</span><span class="si">{</span><span class="n">full</span><span class="si">}</span><span class="s2">) found&quot;</span>
</span><span id="L-629"><a href="#L-629"><span class="linenos"> 629</span></a>            <span class="p">)</span>
</span><span id="L-630"><a href="#L-630"><span class="linenos"> 630</span></a>            <span class="n">system_name</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;Object&quot;</span><span class="p">]</span>
</span><span id="L-631"><a href="#L-631"><span class="linenos"> 631</span></a>            <span class="n">system_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_systems_matching</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">system_name</span><span class="p">])</span>
</span><span id="L-632"><a href="#L-632"><span class="linenos"> 632</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">system_ids</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-633"><a href="#L-633"><span class="linenos"> 633</span></a>                <span class="c1"># NOTE: more than one result should not happen as PPMS doesn&#39;t allow for</span>
</span><span id="L-634"><a href="#L-634"><span class="linenos"> 634</span></a>                <span class="c1"># multiple systems having the same name - no result might happen though!</span>
</span><span id="L-635"><a href="#L-635"><span class="linenos"> 635</span></a>                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Ignoring booking for unknown system [</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="n">system_name</span><span class="p">)</span>
</span><span id="L-636"><a href="#L-636"><span class="linenos"> 636</span></a>                <span class="k">continue</span>
</span><span id="L-637"><a href="#L-637"><span class="linenos"> 637</span></a>
</span><span id="L-638"><a href="#L-638"><span class="linenos"> 638</span></a>            <span class="n">booking</span> <span class="o">=</span> <span class="n">PpmsBooking</span><span class="o">.</span><span class="n">from_runningsheet</span><span class="p">(</span>
</span><span id="L-639"><a href="#L-639"><span class="linenos"> 639</span></a>                <span class="n">entry</span><span class="p">,</span>
</span><span id="L-640"><a href="#L-640"><span class="linenos"> 640</span></a>                <span class="n">system_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span><span id="L-641"><a href="#L-641"><span class="linenos"> 641</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">fullname_mapping</span><span class="p">[</span><span class="n">full</span><span class="p">],</span>
</span><span id="L-642"><a href="#L-642"><span class="linenos"> 642</span></a>                <span class="n">date</span><span class="p">,</span>
</span><span id="L-643"><a href="#L-643"><span class="linenos"> 643</span></a>            <span class="p">)</span>
</span><span id="L-644"><a href="#L-644"><span class="linenos"> 644</span></a>            <span class="n">bookings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">booking</span><span class="p">)</span>
</span><span id="L-645"><a href="#L-645"><span class="linenos"> 645</span></a>
</span><span id="L-646"><a href="#L-646"><span class="linenos"> 646</span></a>        <span class="k">return</span> <span class="n">bookings</span>
</span><span id="L-647"><a href="#L-647"><span class="linenos"> 647</span></a>
</span><span id="L-648"><a href="#L-648"><span class="linenos"> 648</span></a>    <span class="k">def</span> <span class="nf">get_systems</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force_refresh</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-649"><a href="#L-649"><span class="linenos"> 649</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get a dict with all systems in PPMS.</span>
</span><span id="L-650"><a href="#L-650"><span class="linenos"> 650</span></a>
</span><span id="L-651"><a href="#L-651"><span class="linenos"> 651</span></a><span class="sd">        Parameters</span>
</span><span id="L-652"><a href="#L-652"><span class="linenos"> 652</span></a><span class="sd">        ----------</span>
</span><span id="L-653"><a href="#L-653"><span class="linenos"> 653</span></a><span class="sd">        force_refresh : bool, optional</span>
</span><span id="L-654"><a href="#L-654"><span class="linenos"> 654</span></a><span class="sd">            If `True` the list of systems will be refreshed even if the object&#39;s</span>
</span><span id="L-655"><a href="#L-655"><span class="linenos"> 655</span></a><span class="sd">            attribute `self.systems` is non-empty, by default `False`. Please</span>
</span><span id="L-656"><a href="#L-656"><span class="linenos"> 656</span></a><span class="sd">            note that this will NOT skip the on-disk cache in case that exists!</span>
</span><span id="L-657"><a href="#L-657"><span class="linenos"> 657</span></a>
</span><span id="L-658"><a href="#L-658"><span class="linenos"> 658</span></a><span class="sd">        Returns</span>
</span><span id="L-659"><a href="#L-659"><span class="linenos"> 659</span></a><span class="sd">        -------</span>
</span><span id="L-660"><a href="#L-660"><span class="linenos"> 660</span></a><span class="sd">        dict(pyppms.system.PpmsSystem)</span>
</span><span id="L-661"><a href="#L-661"><span class="linenos"> 661</span></a><span class="sd">            A dict with `PpmsSystem` objects parsed from the PUMAPI response where</span>
</span><span id="L-662"><a href="#L-662"><span class="linenos"> 662</span></a><span class="sd">            the system ID (int) is used as the dict&#39;s key. If parsing a system</span>
</span><span id="L-663"><a href="#L-663"><span class="linenos"> 663</span></a><span class="sd">            fails for any reason, the system is skipped entirely.</span>
</span><span id="L-664"><a href="#L-664"><span class="linenos"> 664</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-665"><a href="#L-665"><span class="linenos"> 665</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">systems</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">force_refresh</span><span class="p">:</span>
</span><span id="L-666"><a href="#L-666"><span class="linenos"> 666</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s2">&quot;Using cached details for </span><span class="si">{}</span><span class="s2"> systems&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">systems</span><span class="p">))</span>
</span><span id="L-667"><a href="#L-667"><span class="linenos"> 667</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-668"><a href="#L-668"><span class="linenos"> 668</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">update_systems</span><span class="p">()</span>
</span><span id="L-669"><a href="#L-669"><span class="linenos"> 669</span></a>
</span><span id="L-670"><a href="#L-670"><span class="linenos"> 670</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">systems</span>
</span><span id="L-671"><a href="#L-671"><span class="linenos"> 671</span></a>
</span><span id="L-672"><a href="#L-672"><span class="linenos"> 672</span></a>    <span class="k">def</span> <span class="nf">get_systems_matching</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">localisation</span><span class="p">,</span> <span class="n">name_contains</span><span class="p">):</span>
</span><span id="L-673"><a href="#L-673"><span class="linenos"> 673</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Query PPMS for systems with a specific location and name.</span>
</span><span id="L-674"><a href="#L-674"><span class="linenos"> 674</span></a>
</span><span id="L-675"><a href="#L-675"><span class="linenos"> 675</span></a><span class="sd">        This method assembles a list of PPMS system IDs whose &quot;localisation&quot;</span>
</span><span id="L-676"><a href="#L-676"><span class="linenos"> 676</span></a><span class="sd">        (room) field matches a given string and where the system name contains</span>
</span><span id="L-677"><a href="#L-677"><span class="linenos"> 677</span></a><span class="sd">        at least one of the strings given as the `name_contains` parameter.</span>
</span><span id="L-678"><a href="#L-678"><span class="linenos"> 678</span></a>
</span><span id="L-679"><a href="#L-679"><span class="linenos"> 679</span></a><span class="sd">        Parameters</span>
</span><span id="L-680"><a href="#L-680"><span class="linenos"> 680</span></a><span class="sd">        ----------</span>
</span><span id="L-681"><a href="#L-681"><span class="linenos"> 681</span></a><span class="sd">        localisation : str</span>
</span><span id="L-682"><a href="#L-682"><span class="linenos"> 682</span></a><span class="sd">            A string that the system&#39;s &quot;localisation&quot; (i.e. the &quot;Room&quot; field in</span>
</span><span id="L-683"><a href="#L-683"><span class="linenos"> 683</span></a><span class="sd">            the PPMS web interface) has to match. Can be an empty string which</span>
</span><span id="L-684"><a href="#L-684"><span class="linenos"> 684</span></a><span class="sd">            will result in no filtering being done on the &quot;Room&quot; attribute.</span>
</span><span id="L-685"><a href="#L-685"><span class="linenos"> 685</span></a><span class="sd">        name_contains : list(str)</span>
</span><span id="L-686"><a href="#L-686"><span class="linenos"> 686</span></a><span class="sd">            A list of valid names (categories) of which the system&#39;s name has to</span>
</span><span id="L-687"><a href="#L-687"><span class="linenos"> 687</span></a><span class="sd">            match at least one for being included. Supply an empty list for</span>
</span><span id="L-688"><a href="#L-688"><span class="linenos"> 688</span></a><span class="sd">            skipping this filter.</span>
</span><span id="L-689"><a href="#L-689"><span class="linenos"> 689</span></a>
</span><span id="L-690"><a href="#L-690"><span class="linenos"> 690</span></a><span class="sd">        Returns</span>
</span><span id="L-691"><a href="#L-691"><span class="linenos"> 691</span></a><span class="sd">        -------</span>
</span><span id="L-692"><a href="#L-692"><span class="linenos"> 692</span></a><span class="sd">        list(int)</span>
</span><span id="L-693"><a href="#L-693"><span class="linenos"> 693</span></a><span class="sd">            A list with PPMS system IDs matching all of the given criteria.</span>
</span><span id="L-694"><a href="#L-694"><span class="linenos"> 694</span></a>
</span><span id="L-695"><a href="#L-695"><span class="linenos"> 695</span></a><span class="sd">        Raises</span>
</span><span id="L-696"><a href="#L-696"><span class="linenos"> 696</span></a><span class="sd">        ------</span>
</span><span id="L-697"><a href="#L-697"><span class="linenos"> 697</span></a><span class="sd">        TypeError</span>
</span><span id="L-698"><a href="#L-698"><span class="linenos"> 698</span></a><span class="sd">            Raised in case the `name_contains` parameter is of type `str` (it</span>
</span><span id="L-699"><a href="#L-699"><span class="linenos"> 699</span></a><span class="sd">            needs to be `list(str)` instead).</span>
</span><span id="L-700"><a href="#L-700"><span class="linenos"> 700</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-701"><a href="#L-701"><span class="linenos"> 701</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name_contains</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="L-702"><a href="#L-702"><span class="linenos"> 702</span></a>            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;`name_contains` must be a list of str, not str!&quot;</span><span class="p">)</span>
</span><span id="L-703"><a href="#L-703"><span class="linenos"> 703</span></a>
</span><span id="L-704"><a href="#L-704"><span class="linenos"> 704</span></a>        <span class="n">loc</span> <span class="o">=</span> <span class="n">localisation</span>
</span><span id="L-705"><a href="#L-705"><span class="linenos"> 705</span></a>        <span class="n">loc_desc</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;with location matching [</span><span class="si">{</span><span class="n">localisation</span><span class="si">}</span><span class="s2">]&quot;</span>
</span><span id="L-706"><a href="#L-706"><span class="linenos"> 706</span></a>        <span class="k">if</span> <span class="n">localisation</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
</span><span id="L-707"><a href="#L-707"><span class="linenos"> 707</span></a>            <span class="n">loc_desc</span> <span class="o">=</span> <span class="s2">&quot;(no location filter given)&quot;</span>
</span><span id="L-708"><a href="#L-708"><span class="linenos"> 708</span></a>
</span><span id="L-709"><a href="#L-709"><span class="linenos"> 709</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span>
</span><span id="L-710"><a href="#L-710"><span class="linenos"> 710</span></a>            <span class="s2">&quot;Querying PPMS for systems </span><span class="si">{}</span><span class="s2">, name matching any of </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="L-711"><a href="#L-711"><span class="linenos"> 711</span></a>            <span class="n">loc_desc</span><span class="p">,</span>
</span><span id="L-712"><a href="#L-712"><span class="linenos"> 712</span></a>            <span class="n">name_contains</span><span class="p">,</span>
</span><span id="L-713"><a href="#L-713"><span class="linenos"> 713</span></a>        <span class="p">)</span>
</span><span id="L-714"><a href="#L-714"><span class="linenos"> 714</span></a>        <span class="n">system_ids</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-715"><a href="#L-715"><span class="linenos"> 715</span></a>        <span class="n">systems</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_systems</span><span class="p">()</span>
</span><span id="L-716"><a href="#L-716"><span class="linenos"> 716</span></a>        <span class="k">for</span> <span class="n">sys_id</span><span class="p">,</span> <span class="n">system</span> <span class="ow">in</span> <span class="n">systems</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-717"><a href="#L-717"><span class="linenos"> 717</span></a>            <span class="k">if</span> <span class="n">loc</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">system</span><span class="o">.</span><span class="n">localisation</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
</span><span id="L-718"><a href="#L-718"><span class="linenos"> 718</span></a>                <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span>
</span><span id="L-719"><a href="#L-719"><span class="linenos"> 719</span></a>                    <span class="s2">&quot;System [</span><span class="si">{}</span><span class="s2">] location (</span><span class="si">{}</span><span class="s2">) is NOT matching (</span><span class="si">{}</span><span class="s2">), ignoring&quot;</span><span class="p">,</span>
</span><span id="L-720"><a href="#L-720"><span class="linenos"> 720</span></a>                    <span class="n">system</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
</span><span id="L-721"><a href="#L-721"><span class="linenos"> 721</span></a>                    <span class="n">system</span><span class="o">.</span><span class="n">localisation</span><span class="p">,</span>
</span><span id="L-722"><a href="#L-722"><span class="linenos"> 722</span></a>                    <span class="n">loc</span><span class="p">,</span>
</span><span id="L-723"><a href="#L-723"><span class="linenos"> 723</span></a>                <span class="p">)</span>
</span><span id="L-724"><a href="#L-724"><span class="linenos"> 724</span></a>                <span class="k">continue</span>
</span><span id="L-725"><a href="#L-725"><span class="linenos"> 725</span></a>
</span><span id="L-726"><a href="#L-726"><span class="linenos"> 726</span></a>            <span class="c1"># log.trace(&#39;System [{}] is matching location [{}], checking if &#39;</span>
</span><span id="L-727"><a href="#L-727"><span class="linenos"> 727</span></a>            <span class="c1">#           &#39;the name is matching any of the valid pattern {}&#39;,</span>
</span><span id="L-728"><a href="#L-728"><span class="linenos"> 728</span></a>            <span class="c1">#           system.name, loc, name_contains)</span>
</span><span id="L-729"><a href="#L-729"><span class="linenos"> 729</span></a>            <span class="k">for</span> <span class="n">valid_name</span> <span class="ow">in</span> <span class="n">name_contains</span><span class="p">:</span>
</span><span id="L-730"><a href="#L-730"><span class="linenos"> 730</span></a>                <span class="k">if</span> <span class="n">valid_name</span> <span class="ow">in</span> <span class="n">system</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
</span><span id="L-731"><a href="#L-731"><span class="linenos"> 731</span></a>                    <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s2">&quot;System [</span><span class="si">{}</span><span class="s2">] matches all criteria&quot;</span><span class="p">,</span> <span class="n">system</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</span><span id="L-732"><a href="#L-732"><span class="linenos"> 732</span></a>                    <span class="n">system_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sys_id</span><span class="p">)</span>
</span><span id="L-733"><a href="#L-733"><span class="linenos"> 733</span></a>                    <span class="k">break</span>
</span><span id="L-734"><a href="#L-734"><span class="linenos"> 734</span></a>
</span><span id="L-735"><a href="#L-735"><span class="linenos"> 735</span></a>            <span class="c1"># if sys_id not in system_ids:</span>
</span><span id="L-736"><a href="#L-736"><span class="linenos"> 736</span></a>            <span class="c1">#     log.trace(&#39;System [{}] does NOT match a valid name: {}&#39;,</span>
</span><span id="L-737"><a href="#L-737"><span class="linenos"> 737</span></a>            <span class="c1">#               system.name, name_contains)</span>
</span><span id="L-738"><a href="#L-738"><span class="linenos"> 738</span></a>
</span><span id="L-739"><a href="#L-739"><span class="linenos"> 739</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s2">&quot;Found </span><span class="si">{}</span><span class="s2"> bookable systems </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">system_ids</span><span class="p">),</span> <span class="n">loc_desc</span><span class="p">)</span>
</span><span id="L-740"><a href="#L-740"><span class="linenos"> 740</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s2">&quot;IDs of matching bookable systems </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">loc_desc</span><span class="p">,</span> <span class="n">system_ids</span><span class="p">)</span>
</span><span id="L-741"><a href="#L-741"><span class="linenos"> 741</span></a>        <span class="k">return</span> <span class="n">system_ids</span>
</span><span id="L-742"><a href="#L-742"><span class="linenos"> 742</span></a>
</span><span id="L-743"><a href="#L-743"><span class="linenos"> 743</span></a>    <span class="k">def</span> <span class="nf">get_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">login_name</span><span class="p">,</span> <span class="n">skip_cache</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-744"><a href="#L-744"><span class="linenos"> 744</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Fetch user details from PPMS and create a PpmsUser object from it.</span>
</span><span id="L-745"><a href="#L-745"><span class="linenos"> 745</span></a>
</span><span id="L-746"><a href="#L-746"><span class="linenos"> 746</span></a><span class="sd">        Parameters</span>
</span><span id="L-747"><a href="#L-747"><span class="linenos"> 747</span></a><span class="sd">        ----------</span>
</span><span id="L-748"><a href="#L-748"><span class="linenos"> 748</span></a><span class="sd">        login_name : str</span>
</span><span id="L-749"><a href="#L-749"><span class="linenos"> 749</span></a><span class="sd">            The user&#39;s PPMS login name.</span>
</span><span id="L-750"><a href="#L-750"><span class="linenos"> 750</span></a><span class="sd">        skip_cache : bool, optional</span>
</span><span id="L-751"><a href="#L-751"><span class="linenos"> 751</span></a><span class="sd">            Passed as-is to the :py:meth:`request()` method</span>
</span><span id="L-752"><a href="#L-752"><span class="linenos"> 752</span></a>
</span><span id="L-753"><a href="#L-753"><span class="linenos"> 753</span></a><span class="sd">        Returns</span>
</span><span id="L-754"><a href="#L-754"><span class="linenos"> 754</span></a><span class="sd">        -------</span>
</span><span id="L-755"><a href="#L-755"><span class="linenos"> 755</span></a><span class="sd">        pyppms.user.PpmsUser</span>
</span><span id="L-756"><a href="#L-756"><span class="linenos"> 756</span></a><span class="sd">            The user object created from the PUMAPI response. The object will be</span>
</span><span id="L-757"><a href="#L-757"><span class="linenos"> 757</span></a><span class="sd">            additionally stored in the self.users dict using the login_name as</span>
</span><span id="L-758"><a href="#L-758"><span class="linenos"> 758</span></a><span class="sd">            the dict&#39;s key.</span>
</span><span id="L-759"><a href="#L-759"><span class="linenos"> 759</span></a>
</span><span id="L-760"><a href="#L-760"><span class="linenos"> 760</span></a><span class="sd">        Raises</span>
</span><span id="L-761"><a href="#L-761"><span class="linenos"> 761</span></a><span class="sd">        ------</span>
</span><span id="L-762"><a href="#L-762"><span class="linenos"> 762</span></a><span class="sd">        KeyError</span>
</span><span id="L-763"><a href="#L-763"><span class="linenos"> 763</span></a><span class="sd">            Raised if the user doesn&#39;t exist in PPMS.</span>
</span><span id="L-764"><a href="#L-764"><span class="linenos"> 764</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-765"><a href="#L-765"><span class="linenos"> 765</span></a>        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;getuser&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;login&quot;</span><span class="p">:</span> <span class="n">login_name</span><span class="p">},</span> <span class="n">skip_cache</span><span class="o">=</span><span class="n">skip_cache</span><span class="p">)</span>
</span><span id="L-766"><a href="#L-766"><span class="linenos"> 766</span></a>
</span><span id="L-767"><a href="#L-767"><span class="linenos"> 767</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
</span><span id="L-768"><a href="#L-768"><span class="linenos"> 768</span></a>            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;User [</span><span class="si">{</span><span class="n">login_name</span><span class="si">}</span><span class="s2">] is unknown to PPMS&quot;</span>
</span><span id="L-769"><a href="#L-769"><span class="linenos"> 769</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="L-770"><a href="#L-770"><span class="linenos"> 770</span></a>            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="L-771"><a href="#L-771"><span class="linenos"> 771</span></a>
</span><span id="L-772"><a href="#L-772"><span class="linenos"> 772</span></a>        <span class="n">user</span> <span class="o">=</span> <span class="n">PpmsUser</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</span><span id="L-773"><a href="#L-773"><span class="linenos"> 773</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="p">[</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">]</span> <span class="o">=</span> <span class="n">user</span>  <span class="c1"># update / add to the cached user objs</span>
</span><span id="L-774"><a href="#L-774"><span class="linenos"> 774</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fullname_mapping</span><span class="p">[</span><span class="n">user</span><span class="o">.</span><span class="n">fullname</span><span class="p">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span>
</span><span id="L-775"><a href="#L-775"><span class="linenos"> 775</span></a>        <span class="k">return</span> <span class="n">user</span>
</span><span id="L-776"><a href="#L-776"><span class="linenos"> 776</span></a>
</span><span id="L-777"><a href="#L-777"><span class="linenos"> 777</span></a>    <span class="k">def</span> <span class="nf">get_user_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">login_name</span><span class="p">,</span> <span class="n">skip_cache</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-778"><a href="#L-778"><span class="linenos"> 778</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get details on a given user from PPMS.</span>
</span><span id="L-779"><a href="#L-779"><span class="linenos"> 779</span></a>
</span><span id="L-780"><a href="#L-780"><span class="linenos"> 780</span></a><span class="sd">        Parameters</span>
</span><span id="L-781"><a href="#L-781"><span class="linenos"> 781</span></a><span class="sd">        ----------</span>
</span><span id="L-782"><a href="#L-782"><span class="linenos"> 782</span></a><span class="sd">        login_name : str</span>
</span><span id="L-783"><a href="#L-783"><span class="linenos"> 783</span></a><span class="sd">            The PPMS account / login name of the user to query.</span>
</span><span id="L-784"><a href="#L-784"><span class="linenos"> 784</span></a><span class="sd">        skip_cache : bool, optional</span>
</span><span id="L-785"><a href="#L-785"><span class="linenos"> 785</span></a><span class="sd">            Passed as-is to the :py:meth:`request()` method</span>
</span><span id="L-786"><a href="#L-786"><span class="linenos"> 786</span></a>
</span><span id="L-787"><a href="#L-787"><span class="linenos"> 787</span></a><span class="sd">        Returns</span>
</span><span id="L-788"><a href="#L-788"><span class="linenos"> 788</span></a><span class="sd">        -------</span>
</span><span id="L-789"><a href="#L-789"><span class="linenos"> 789</span></a><span class="sd">        dict</span>
</span><span id="L-790"><a href="#L-790"><span class="linenos"> 790</span></a><span class="sd">            A dict with the user details returned by the PUMAPI.</span>
</span><span id="L-791"><a href="#L-791"><span class="linenos"> 791</span></a>
</span><span id="L-792"><a href="#L-792"><span class="linenos"> 792</span></a><span class="sd">        Example</span>
</span><span id="L-793"><a href="#L-793"><span class="linenos"> 793</span></a><span class="sd">        -------</span>
</span><span id="L-794"><a href="#L-794"><span class="linenos"> 794</span></a><span class="sd">        &gt;&gt;&gt; conn.get_user_dict(&#39;pyppms&#39;)</span>
</span><span id="L-795"><a href="#L-795"><span class="linenos"> 795</span></a><span class="sd">        ... {</span>
</span><span id="L-796"><a href="#L-796"><span class="linenos"> 796</span></a><span class="sd">        ...     u&#39;active&#39;: True,</span>
</span><span id="L-797"><a href="#L-797"><span class="linenos"> 797</span></a><span class="sd">        ...     u&#39;affiliation&#39;: u&#39;&#39;,</span>
</span><span id="L-798"><a href="#L-798"><span class="linenos"> 798</span></a><span class="sd">        ...     u&#39;bcode&#39;: u&#39;&#39;,</span>
</span><span id="L-799"><a href="#L-799"><span class="linenos"> 799</span></a><span class="sd">        ...     u&#39;email&#39;: u&#39;pyppms@python-facility.example&#39;,</span>
</span><span id="L-800"><a href="#L-800"><span class="linenos"> 800</span></a><span class="sd">        ...     u&#39;fname&#39;: u&#39;PumAPI&#39;,</span>
</span><span id="L-801"><a href="#L-801"><span class="linenos"> 801</span></a><span class="sd">        ...     u&#39;lname&#39;: u&#39;Python&#39;,</span>
</span><span id="L-802"><a href="#L-802"><span class="linenos"> 802</span></a><span class="sd">        ...     u&#39;login&#39;: u&#39;pyppms&#39;,</span>
</span><span id="L-803"><a href="#L-803"><span class="linenos"> 803</span></a><span class="sd">        ...     u&#39;mustchbcode&#39;: False,</span>
</span><span id="L-804"><a href="#L-804"><span class="linenos"> 804</span></a><span class="sd">        ...     u&#39;mustchpwd&#39;: False&#39;,</span>
</span><span id="L-805"><a href="#L-805"><span class="linenos"> 805</span></a><span class="sd">        ...     u&#39;phone&#39;: u&#39;+98 (76) 54 3210&#39;,</span>
</span><span id="L-806"><a href="#L-806"><span class="linenos"> 806</span></a><span class="sd">        ...     u&#39;unitlogin&#39;: u&#39;pyppms&#39;</span>
</span><span id="L-807"><a href="#L-807"><span class="linenos"> 807</span></a><span class="sd">        ... }</span>
</span><span id="L-808"><a href="#L-808"><span class="linenos"> 808</span></a>
</span><span id="L-809"><a href="#L-809"><span class="linenos"> 809</span></a><span class="sd">        Raises</span>
</span><span id="L-810"><a href="#L-810"><span class="linenos"> 810</span></a><span class="sd">        ------</span>
</span><span id="L-811"><a href="#L-811"><span class="linenos"> 811</span></a><span class="sd">        KeyError</span>
</span><span id="L-812"><a href="#L-812"><span class="linenos"> 812</span></a><span class="sd">            Raised in case the user account is unknown to PPMS.</span>
</span><span id="L-813"><a href="#L-813"><span class="linenos"> 813</span></a><span class="sd">        ValueError</span>
</span><span id="L-814"><a href="#L-814"><span class="linenos"> 814</span></a><span class="sd">            Raised if the user details can&#39;t be parsed from the PUMAPI response.</span>
</span><span id="L-815"><a href="#L-815"><span class="linenos"> 815</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-816"><a href="#L-816"><span class="linenos"> 816</span></a>        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;getuser&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;login&quot;</span><span class="p">:</span> <span class="n">login_name</span><span class="p">},</span> <span class="n">skip_cache</span><span class="o">=</span><span class="n">skip_cache</span><span class="p">)</span>
</span><span id="L-817"><a href="#L-817"><span class="linenos"> 817</span></a>
</span><span id="L-818"><a href="#L-818"><span class="linenos"> 818</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
</span><span id="L-819"><a href="#L-819"><span class="linenos"> 819</span></a>            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;User [</span><span class="si">{</span><span class="n">login_name</span><span class="si">}</span><span class="s2">] is unknown to PPMS&quot;</span>
</span><span id="L-820"><a href="#L-820"><span class="linenos"> 820</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="L-821"><a href="#L-821"><span class="linenos"> 821</span></a>            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="L-822"><a href="#L-822"><span class="linenos"> 822</span></a>
</span><span id="L-823"><a href="#L-823"><span class="linenos"> 823</span></a>        <span class="c1"># EXAMPLE:</span>
</span><span id="L-824"><a href="#L-824"><span class="linenos"> 824</span></a>        <span class="c1"># response.text = (</span>
</span><span id="L-825"><a href="#L-825"><span class="linenos"> 825</span></a>        <span class="c1">#     u&#39;login,lname,fname,email,&#39;</span>
</span><span id="L-826"><a href="#L-826"><span class="linenos"> 826</span></a>        <span class="c1">#     u&#39;phone,bcode,affiliation,unitlogin,mustchpwd,mustchbcode,&#39;</span>
</span><span id="L-827"><a href="#L-827"><span class="linenos"> 827</span></a>        <span class="c1">#     u&#39;active\r\n&#39;</span>
</span><span id="L-828"><a href="#L-828"><span class="linenos"> 828</span></a>        <span class="c1">#     u&#39;&quot;pyppms&quot;,&quot;Python&quot;,&quot;PumAPI&quot;,&quot;pyppms@python-facility.example&quot;,&#39;</span>
</span><span id="L-829"><a href="#L-829"><span class="linenos"> 829</span></a>        <span class="c1">#     u&#39;&quot;+98 (76) 54 3210&quot;,&quot;&quot;,&quot;&quot;,&quot;pyppms&quot;,false,false,&#39;</span>
</span><span id="L-830"><a href="#L-830"><span class="linenos"> 830</span></a>        <span class="c1">#     u&#39;true\r\n&#39;</span>
</span><span id="L-831"><a href="#L-831"><span class="linenos"> 831</span></a>        <span class="c1"># )</span>
</span><span id="L-832"><a href="#L-832"><span class="linenos"> 832</span></a>        <span class="n">details</span> <span class="o">=</span> <span class="n">dict_from_single_response</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</span><span id="L-833"><a href="#L-833"><span class="linenos"> 833</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s2">&quot;Details for user [</span><span class="si">{}</span><span class="s2">]: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">login_name</span><span class="p">,</span> <span class="n">details</span><span class="p">)</span>
</span><span id="L-834"><a href="#L-834"><span class="linenos"> 834</span></a>        <span class="k">return</span> <span class="n">details</span>
</span><span id="L-835"><a href="#L-835"><span class="linenos"> 835</span></a>
</span><span id="L-836"><a href="#L-836"><span class="linenos"> 836</span></a>    <span class="k">def</span> <span class="nf">get_user_experience</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">login</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">system_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-837"><a href="#L-837"><span class="linenos"> 837</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get user experience (&quot;User rights&quot;) from PPMS.</span>
</span><span id="L-838"><a href="#L-838"><span class="linenos"> 838</span></a>
</span><span id="L-839"><a href="#L-839"><span class="linenos"> 839</span></a><span class="sd">        Parameters</span>
</span><span id="L-840"><a href="#L-840"><span class="linenos"> 840</span></a><span class="sd">        ----------</span>
</span><span id="L-841"><a href="#L-841"><span class="linenos"> 841</span></a><span class="sd">        login : str, optional</span>
</span><span id="L-842"><a href="#L-842"><span class="linenos"> 842</span></a><span class="sd">            An optional login name to request the experience / permissions for,</span>
</span><span id="L-843"><a href="#L-843"><span class="linenos"> 843</span></a><span class="sd">            by default None</span>
</span><span id="L-844"><a href="#L-844"><span class="linenos"> 844</span></a><span class="sd">        system_id : int, optional</span>
</span><span id="L-845"><a href="#L-845"><span class="linenos"> 845</span></a><span class="sd">            An optional system ID to request the experience / permissions for,</span>
</span><span id="L-846"><a href="#L-846"><span class="linenos"> 846</span></a><span class="sd">            by default None</span>
</span><span id="L-847"><a href="#L-847"><span class="linenos"> 847</span></a>
</span><span id="L-848"><a href="#L-848"><span class="linenos"> 848</span></a><span class="sd">        Returns</span>
</span><span id="L-849"><a href="#L-849"><span class="linenos"> 849</span></a><span class="sd">        -------</span>
</span><span id="L-850"><a href="#L-850"><span class="linenos"> 850</span></a><span class="sd">        list(dict)</span>
</span><span id="L-851"><a href="#L-851"><span class="linenos"> 851</span></a><span class="sd">            A list with dicts parsed from the user experience response.</span>
</span><span id="L-852"><a href="#L-852"><span class="linenos"> 852</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-853"><a href="#L-853"><span class="linenos"> 853</span></a>        <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-854"><a href="#L-854"><span class="linenos"> 854</span></a>        <span class="k">if</span> <span class="n">login</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-855"><a href="#L-855"><span class="linenos"> 855</span></a>            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;login&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">login</span>
</span><span id="L-856"><a href="#L-856"><span class="linenos"> 856</span></a>        <span class="k">if</span> <span class="n">system_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-857"><a href="#L-857"><span class="linenos"> 857</span></a>            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">system_id</span>
</span><span id="L-858"><a href="#L-858"><span class="linenos"> 858</span></a>        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;getuserexp&quot;</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
</span><span id="L-859"><a href="#L-859"><span class="linenos"> 859</span></a>
</span><span id="L-860"><a href="#L-860"><span class="linenos"> 860</span></a>        <span class="n">parsed</span> <span class="o">=</span> <span class="n">parse_multiline_response</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</span><span id="L-861"><a href="#L-861"><span class="linenos"> 861</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span>
</span><span id="L-862"><a href="#L-862"><span class="linenos"> 862</span></a>            <span class="s2">&quot;Received </span><span class="si">{}</span><span class="s2"> experience entries for filters [user:</span><span class="si">{}</span><span class="s2">] and [id:</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="p">,</span>
</span><span id="L-863"><a href="#L-863"><span class="linenos"> 863</span></a>            <span class="nb">len</span><span class="p">(</span><span class="n">parsed</span><span class="p">),</span>
</span><span id="L-864"><a href="#L-864"><span class="linenos"> 864</span></a>            <span class="n">login</span><span class="p">,</span>
</span><span id="L-865"><a href="#L-865"><span class="linenos"> 865</span></a>            <span class="n">system_id</span><span class="p">,</span>
</span><span id="L-866"><a href="#L-866"><span class="linenos"> 866</span></a>        <span class="p">)</span>
</span><span id="L-867"><a href="#L-867"><span class="linenos"> 867</span></a>        <span class="k">return</span> <span class="n">parsed</span>
</span><span id="L-868"><a href="#L-868"><span class="linenos"> 868</span></a>
</span><span id="L-869"><a href="#L-869"><span class="linenos"> 869</span></a>    <span class="k">def</span> <span class="nf">get_user_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-870"><a href="#L-870"><span class="linenos"> 870</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get a list with all user IDs in the PPMS system.</span>
</span><span id="L-871"><a href="#L-871"><span class="linenos"> 871</span></a>
</span><span id="L-872"><a href="#L-872"><span class="linenos"> 872</span></a><span class="sd">        Parameters</span>
</span><span id="L-873"><a href="#L-873"><span class="linenos"> 873</span></a><span class="sd">        ----------</span>
</span><span id="L-874"><a href="#L-874"><span class="linenos"> 874</span></a><span class="sd">        active : bool, optional</span>
</span><span id="L-875"><a href="#L-875"><span class="linenos"> 875</span></a><span class="sd">            Request only users marked as active in PPMS, by default False.</span>
</span><span id="L-876"><a href="#L-876"><span class="linenos"> 876</span></a><span class="sd">            NOTE: &quot;active&quot; is a tri-state parameter in PPMS: &quot;true&quot;, &quot;false&quot;</span>
</span><span id="L-877"><a href="#L-877"><span class="linenos"> 877</span></a><span class="sd">            or empty!</span>
</span><span id="L-878"><a href="#L-878"><span class="linenos"> 878</span></a>
</span><span id="L-879"><a href="#L-879"><span class="linenos"> 879</span></a><span class="sd">        Returns</span>
</span><span id="L-880"><a href="#L-880"><span class="linenos"> 880</span></a><span class="sd">        -------</span>
</span><span id="L-881"><a href="#L-881"><span class="linenos"> 881</span></a><span class="sd">        list</span>
</span><span id="L-882"><a href="#L-882"><span class="linenos"> 882</span></a><span class="sd">            A list of all (or active-only) user IDs in PPMS.</span>
</span><span id="L-883"><a href="#L-883"><span class="linenos"> 883</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-884"><a href="#L-884"><span class="linenos"> 884</span></a>        <span class="c1"># TODO: describe format of returned list and / or give an example!</span>
</span><span id="L-885"><a href="#L-885"><span class="linenos"> 885</span></a>        <span class="n">parameters</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-886"><a href="#L-886"><span class="linenos"> 886</span></a>        <span class="k">if</span> <span class="n">active</span><span class="p">:</span>
</span><span id="L-887"><a href="#L-887"><span class="linenos"> 887</span></a>            <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;active&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;true&quot;</span>
</span><span id="L-888"><a href="#L-888"><span class="linenos"> 888</span></a>
</span><span id="L-889"><a href="#L-889"><span class="linenos"> 889</span></a>        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;getusers&quot;</span><span class="p">,</span> <span class="n">parameters</span><span class="p">)</span>
</span><span id="L-890"><a href="#L-890"><span class="linenos"> 890</span></a>
</span><span id="L-891"><a href="#L-891"><span class="linenos"> 891</span></a>        <span class="n">users</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
</span><span id="L-892"><a href="#L-892"><span class="linenos"> 892</span></a>        <span class="n">active_desc</span> <span class="o">=</span> <span class="s2">&quot;active &quot;</span> <span class="k">if</span> <span class="n">active</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
</span><span id="L-893"><a href="#L-893"><span class="linenos"> 893</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">users in the PPMS database&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">users</span><span class="p">),</span> <span class="n">active_desc</span><span class="p">)</span>
</span><span id="L-894"><a href="#L-894"><span class="linenos"> 894</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">users</span><span class="p">))</span>
</span><span id="L-895"><a href="#L-895"><span class="linenos"> 895</span></a>        <span class="k">return</span> <span class="n">users</span>
</span><span id="L-896"><a href="#L-896"><span class="linenos"> 896</span></a>
</span><span id="L-897"><a href="#L-897"><span class="linenos"> 897</span></a>    <span class="k">def</span> <span class="nf">get_users</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force_refresh</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">active_only</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="L-898"><a href="#L-898"><span class="linenos"> 898</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get user objects for all (or cached) PPMS users.</span>
</span><span id="L-899"><a href="#L-899"><span class="linenos"> 899</span></a>
</span><span id="L-900"><a href="#L-900"><span class="linenos"> 900</span></a><span class="sd">        Parameters</span>
</span><span id="L-901"><a href="#L-901"><span class="linenos"> 901</span></a><span class="sd">        ----------</span>
</span><span id="L-902"><a href="#L-902"><span class="linenos"> 902</span></a><span class="sd">        force_refresh : bool, optional</span>
</span><span id="L-903"><a href="#L-903"><span class="linenos"> 903</span></a><span class="sd">            Re-request information from PPMS even if user details have been</span>
</span><span id="L-904"><a href="#L-904"><span class="linenos"> 904</span></a><span class="sd">            cached locally before, by default False.</span>
</span><span id="L-905"><a href="#L-905"><span class="linenos"> 905</span></a><span class="sd">        active_only : bool, optional</span>
</span><span id="L-906"><a href="#L-906"><span class="linenos"> 906</span></a><span class="sd">            If set to `False` also &quot;inactive&quot; users will be fetched from PPMS,</span>
</span><span id="L-907"><a href="#L-907"><span class="linenos"> 907</span></a><span class="sd">            by default `True`.</span>
</span><span id="L-908"><a href="#L-908"><span class="linenos"> 908</span></a>
</span><span id="L-909"><a href="#L-909"><span class="linenos"> 909</span></a><span class="sd">        Returns</span>
</span><span id="L-910"><a href="#L-910"><span class="linenos"> 910</span></a><span class="sd">        -------</span>
</span><span id="L-911"><a href="#L-911"><span class="linenos"> 911</span></a><span class="sd">        dict(pyppms.user.PpmsUser)</span>
</span><span id="L-912"><a href="#L-912"><span class="linenos"> 912</span></a><span class="sd">            A dict of PpmsUser objects with the username (login) as key.</span>
</span><span id="L-913"><a href="#L-913"><span class="linenos"> 913</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-914"><a href="#L-914"><span class="linenos"> 914</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">users</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">force_refresh</span><span class="p">:</span>
</span><span id="L-915"><a href="#L-915"><span class="linenos"> 915</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s2">&quot;Using cached details for </span><span class="si">{}</span><span class="s2"> users&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="p">))</span>
</span><span id="L-916"><a href="#L-916"><span class="linenos"> 916</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-917"><a href="#L-917"><span class="linenos"> 917</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">update_users</span><span class="p">(</span><span class="n">active_only</span><span class="o">=</span><span class="n">active_only</span><span class="p">)</span>
</span><span id="L-918"><a href="#L-918"><span class="linenos"> 918</span></a>
</span><span id="L-919"><a href="#L-919"><span class="linenos"> 919</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">users</span>
</span><span id="L-920"><a href="#L-920"><span class="linenos"> 920</span></a>
</span><span id="L-921"><a href="#L-921"><span class="linenos"> 921</span></a>    <span class="k">def</span> <span class="nf">get_users_emails</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">users</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-922"><a href="#L-922"><span class="linenos"> 922</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get a list of user email addresses. WARNING - very slow!</span>
</span><span id="L-923"><a href="#L-923"><span class="linenos"> 923</span></a>
</span><span id="L-924"><a href="#L-924"><span class="linenos"> 924</span></a><span class="sd">        Parameters</span>
</span><span id="L-925"><a href="#L-925"><span class="linenos"> 925</span></a><span class="sd">        ----------</span>
</span><span id="L-926"><a href="#L-926"><span class="linenos"> 926</span></a><span class="sd">        users : list(str), optional</span>
</span><span id="L-927"><a href="#L-927"><span class="linenos"> 927</span></a><span class="sd">            A list of login names to retrieve the email addresses for, if</span>
</span><span id="L-928"><a href="#L-928"><span class="linenos"> 928</span></a><span class="sd">            omitted addresses for all (or active ones) will be requested.</span>
</span><span id="L-929"><a href="#L-929"><span class="linenos"> 929</span></a><span class="sd">        active : bool, optional</span>
</span><span id="L-930"><a href="#L-930"><span class="linenos"> 930</span></a><span class="sd">            Request only addresses of users marked as active in PPMS, by default</span>
</span><span id="L-931"><a href="#L-931"><span class="linenos"> 931</span></a><span class="sd">            False. Will be ignored if a list of usernames is given explicitly.</span>
</span><span id="L-932"><a href="#L-932"><span class="linenos"> 932</span></a>
</span><span id="L-933"><a href="#L-933"><span class="linenos"> 933</span></a><span class="sd">        Returns</span>
</span><span id="L-934"><a href="#L-934"><span class="linenos"> 934</span></a><span class="sd">        -------</span>
</span><span id="L-935"><a href="#L-935"><span class="linenos"> 935</span></a><span class="sd">        list(str)</span>
</span><span id="L-936"><a href="#L-936"><span class="linenos"> 936</span></a><span class="sd">            Email addresses of the users requested.</span>
</span><span id="L-937"><a href="#L-937"><span class="linenos"> 937</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-938"><a href="#L-938"><span class="linenos"> 938</span></a>        <span class="n">emails</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-939"><a href="#L-939"><span class="linenos"> 939</span></a>        <span class="k">if</span> <span class="n">users</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-940"><a href="#L-940"><span class="linenos"> 940</span></a>            <span class="n">users</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_ids</span><span class="p">(</span><span class="n">active</span><span class="o">=</span><span class="n">active</span><span class="p">)</span>
</span><span id="L-941"><a href="#L-941"><span class="linenos"> 941</span></a>        <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">users</span><span class="p">:</span>
</span><span id="L-942"><a href="#L-942"><span class="linenos"> 942</span></a>            <span class="n">email</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_dict</span><span class="p">(</span><span class="n">user</span><span class="p">)[</span><span class="s2">&quot;email&quot;</span><span class="p">]</span>
</span><span id="L-943"><a href="#L-943"><span class="linenos"> 943</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">email</span><span class="p">:</span>
</span><span id="L-944"><a href="#L-944"><span class="linenos"> 944</span></a>                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;--- WARNING: no email for user [</span><span class="si">{}</span><span class="s2">]! ---&quot;</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
</span><span id="L-945"><a href="#L-945"><span class="linenos"> 945</span></a>                <span class="k">continue</span>
</span><span id="L-946"><a href="#L-946"><span class="linenos"> 946</span></a>            <span class="c1"># log.trace(&quot;{}: {}&quot;, user, email)</span>
</span><span id="L-947"><a href="#L-947"><span class="linenos"> 947</span></a>            <span class="n">emails</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
</span><span id="L-948"><a href="#L-948"><span class="linenos"> 948</span></a>
</span><span id="L-949"><a href="#L-949"><span class="linenos"> 949</span></a>        <span class="k">return</span> <span class="n">emails</span>
</span><span id="L-950"><a href="#L-950"><span class="linenos"> 950</span></a>
</span><span id="L-951"><a href="#L-951"><span class="linenos"> 951</span></a>    <span class="k">def</span> <span class="nf">get_users_with_access_to_system</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">system_id</span><span class="p">):</span>
</span><span id="L-952"><a href="#L-952"><span class="linenos"> 952</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get a list of usernames allowed to book the system with the given ID.</span>
</span><span id="L-953"><a href="#L-953"><span class="linenos"> 953</span></a>
</span><span id="L-954"><a href="#L-954"><span class="linenos"> 954</span></a><span class="sd">        Parameters</span>
</span><span id="L-955"><a href="#L-955"><span class="linenos"> 955</span></a><span class="sd">        ----------</span>
</span><span id="L-956"><a href="#L-956"><span class="linenos"> 956</span></a><span class="sd">        system_id : int or int-like</span>
</span><span id="L-957"><a href="#L-957"><span class="linenos"> 957</span></a><span class="sd">            The ID of the system to query permitted users for.</span>
</span><span id="L-958"><a href="#L-958"><span class="linenos"> 958</span></a>
</span><span id="L-959"><a href="#L-959"><span class="linenos"> 959</span></a><span class="sd">        Returns</span>
</span><span id="L-960"><a href="#L-960"><span class="linenos"> 960</span></a><span class="sd">        -------</span>
</span><span id="L-961"><a href="#L-961"><span class="linenos"> 961</span></a><span class="sd">        list(str)</span>
</span><span id="L-962"><a href="#L-962"><span class="linenos"> 962</span></a><span class="sd">            A list of usernames (&#39;login&#39;) with permissions to book the system</span>
</span><span id="L-963"><a href="#L-963"><span class="linenos"> 963</span></a><span class="sd">            with the given ID in PPMS.</span>
</span><span id="L-964"><a href="#L-964"><span class="linenos"> 964</span></a>
</span><span id="L-965"><a href="#L-965"><span class="linenos"> 965</span></a><span class="sd">        Raises</span>
</span><span id="L-966"><a href="#L-966"><span class="linenos"> 966</span></a><span class="sd">        ------</span>
</span><span id="L-967"><a href="#L-967"><span class="linenos"> 967</span></a><span class="sd">        ValueError</span>
</span><span id="L-968"><a href="#L-968"><span class="linenos"> 968</span></a><span class="sd">            Raised in case parsing the response failes for any reason.</span>
</span><span id="L-969"><a href="#L-969"><span class="linenos"> 969</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-970"><a href="#L-970"><span class="linenos"> 970</span></a>        <span class="n">users</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-971"><a href="#L-971"><span class="linenos"> 971</span></a>
</span><span id="L-972"><a href="#L-972"><span class="linenos"> 972</span></a>        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;getsysrights&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">system_id</span><span class="p">})</span>
</span><span id="L-973"><a href="#L-973"><span class="linenos"> 973</span></a>        <span class="c1"># this response has a unique format, so parse it directly here:</span>
</span><span id="L-974"><a href="#L-974"><span class="linenos"> 974</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-975"><a href="#L-975"><span class="linenos"> 975</span></a>            <span class="n">lines</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
</span><span id="L-976"><a href="#L-976"><span class="linenos"> 976</span></a>            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
</span><span id="L-977"><a href="#L-977"><span class="linenos"> 977</span></a>                <span class="n">permission</span><span class="p">,</span> <span class="n">username</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
</span><span id="L-978"><a href="#L-978"><span class="linenos"> 978</span></a>                <span class="k">if</span> <span class="n">permission</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;D&quot;</span><span class="p">:</span>
</span><span id="L-979"><a href="#L-979"><span class="linenos"> 979</span></a>                    <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span>
</span><span id="L-980"><a href="#L-980"><span class="linenos"> 980</span></a>                        <span class="s2">&quot;User [</span><span class="si">{}</span><span class="s2">] is deactivated for booking system [</span><span class="si">{}</span><span class="s2">], skipping&quot;</span><span class="p">,</span>
</span><span id="L-981"><a href="#L-981"><span class="linenos"> 981</span></a>                        <span class="n">username</span><span class="p">,</span>
</span><span id="L-982"><a href="#L-982"><span class="linenos"> 982</span></a>                        <span class="n">system_id</span><span class="p">,</span>
</span><span id="L-983"><a href="#L-983"><span class="linenos"> 983</span></a>                    <span class="p">)</span>
</span><span id="L-984"><a href="#L-984"><span class="linenos"> 984</span></a>                    <span class="k">continue</span>
</span><span id="L-985"><a href="#L-985"><span class="linenos"> 985</span></a>
</span><span id="L-986"><a href="#L-986"><span class="linenos"> 986</span></a>                <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span>
</span><span id="L-987"><a href="#L-987"><span class="linenos"> 987</span></a>                    <span class="s2">&quot;User [</span><span class="si">{}</span><span class="s2">] has permission to book system [</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">system_id</span>
</span><span id="L-988"><a href="#L-988"><span class="linenos"> 988</span></a>                <span class="p">)</span>
</span><span id="L-989"><a href="#L-989"><span class="linenos"> 989</span></a>                <span class="n">users</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
</span><span id="L-990"><a href="#L-990"><span class="linenos"> 990</span></a>
</span><span id="L-991"><a href="#L-991"><span class="linenos"> 991</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
</span><span id="L-992"><a href="#L-992"><span class="linenos"> 992</span></a>            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-993"><a href="#L-993"><span class="linenos"> 993</span></a>                <span class="sa">f</span><span class="s2">&quot;Unable to parse data returned by PUMAPI: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2"> - &quot;</span>
</span><span id="L-994"><a href="#L-994"><span class="linenos"> 994</span></a>                <span class="sa">f</span><span class="s2">&quot;ERROR: </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-995"><a href="#L-995"><span class="linenos"> 995</span></a>            <span class="p">)</span>
</span><span id="L-996"><a href="#L-996"><span class="linenos"> 996</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="L-997"><a href="#L-997"><span class="linenos"> 997</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">err</span>
</span><span id="L-998"><a href="#L-998"><span class="linenos"> 998</span></a>
</span><span id="L-999"><a href="#L-999"><span class="linenos"> 999</span></a>        <span class="k">return</span> <span class="n">users</span>
</span><span id="L-1000"><a href="#L-1000"><span class="linenos">1000</span></a>
</span><span id="L-1001"><a href="#L-1001"><span class="linenos">1001</span></a>    <span class="k">def</span> <span class="nf">give_user_access_to_system</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">system_id</span><span class="p">):</span>
</span><span id="L-1002"><a href="#L-1002"><span class="linenos">1002</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Add permissions for a user to book a given system in PPMS.</span>
</span><span id="L-1003"><a href="#L-1003"><span class="linenos">1003</span></a>
</span><span id="L-1004"><a href="#L-1004"><span class="linenos">1004</span></a><span class="sd">        Parameters</span>
</span><span id="L-1005"><a href="#L-1005"><span class="linenos">1005</span></a><span class="sd">        ----------</span>
</span><span id="L-1006"><a href="#L-1006"><span class="linenos">1006</span></a><span class="sd">        username : str</span>
</span><span id="L-1007"><a href="#L-1007"><span class="linenos">1007</span></a><span class="sd">            The username (&#39;login&#39;) to allow for booking the system.</span>
</span><span id="L-1008"><a href="#L-1008"><span class="linenos">1008</span></a><span class="sd">        system_id : int or int-like</span>
</span><span id="L-1009"><a href="#L-1009"><span class="linenos">1009</span></a><span class="sd">            The ID of the system to add the permission for.</span>
</span><span id="L-1010"><a href="#L-1010"><span class="linenos">1010</span></a>
</span><span id="L-1011"><a href="#L-1011"><span class="linenos">1011</span></a><span class="sd">        Returns</span>
</span><span id="L-1012"><a href="#L-1012"><span class="linenos">1012</span></a><span class="sd">        -------</span>
</span><span id="L-1013"><a href="#L-1013"><span class="linenos">1013</span></a><span class="sd">        bool</span>
</span><span id="L-1014"><a href="#L-1014"><span class="linenos">1014</span></a><span class="sd">            True in case the given username now has the permissions to book the</span>
</span><span id="L-1015"><a href="#L-1015"><span class="linenos">1015</span></a><span class="sd">            system with the specified ID (or if the user already had them</span>
</span><span id="L-1016"><a href="#L-1016"><span class="linenos">1016</span></a><span class="sd">            before), False otherwise.</span>
</span><span id="L-1017"><a href="#L-1017"><span class="linenos">1017</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1018"><a href="#L-1018"><span class="linenos">1018</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_system_booking_permissions</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">system_id</span><span class="p">,</span> <span class="s2">&quot;A&quot;</span><span class="p">)</span>
</span><span id="L-1019"><a href="#L-1019"><span class="linenos">1019</span></a>
</span><span id="L-1020"><a href="#L-1020"><span class="linenos">1020</span></a>    <span class="k">def</span> <span class="nf">new_user</span><span class="p">(</span>  <span class="c1"># pylint: disable-msg=too-many-arguments</span>
</span><span id="L-1021"><a href="#L-1021"><span class="linenos">1021</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">login</span><span class="p">,</span> <span class="n">lname</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">ppms_group</span><span class="p">,</span> <span class="n">phone</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="kc">None</span>
</span><span id="L-1022"><a href="#L-1022"><span class="linenos">1022</span></a>    <span class="p">):</span>
</span><span id="L-1023"><a href="#L-1023"><span class="linenos">1023</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a new user in PPMS.</span>
</span><span id="L-1024"><a href="#L-1024"><span class="linenos">1024</span></a>
</span><span id="L-1025"><a href="#L-1025"><span class="linenos">1025</span></a><span class="sd">        The method is asking PPMS to create a new user account with the given details.</span>
</span><span id="L-1026"><a href="#L-1026"><span class="linenos">1026</span></a><span class="sd">        In case an account with that login name already exists, it will log a warning</span>
</span><span id="L-1027"><a href="#L-1027"><span class="linenos">1027</span></a><span class="sd">        and return without sending any further requests to PPMS.</span>
</span><span id="L-1028"><a href="#L-1028"><span class="linenos">1028</span></a>
</span><span id="L-1029"><a href="#L-1029"><span class="linenos">1029</span></a><span class="sd">        Parameters</span>
</span><span id="L-1030"><a href="#L-1030"><span class="linenos">1030</span></a><span class="sd">        ----------</span>
</span><span id="L-1031"><a href="#L-1031"><span class="linenos">1031</span></a><span class="sd">        login : str</span>
</span><span id="L-1032"><a href="#L-1032"><span class="linenos">1032</span></a><span class="sd">            The unique identifier for the user.</span>
</span><span id="L-1033"><a href="#L-1033"><span class="linenos">1033</span></a><span class="sd">        lname : str</span>
</span><span id="L-1034"><a href="#L-1034"><span class="linenos">1034</span></a><span class="sd">            The last name of the user.</span>
</span><span id="L-1035"><a href="#L-1035"><span class="linenos">1035</span></a><span class="sd">        fname : str</span>
</span><span id="L-1036"><a href="#L-1036"><span class="linenos">1036</span></a><span class="sd">            The first name of the user.</span>
</span><span id="L-1037"><a href="#L-1037"><span class="linenos">1037</span></a><span class="sd">        email : str</span>
</span><span id="L-1038"><a href="#L-1038"><span class="linenos">1038</span></a><span class="sd">            The email address of the user.</span>
</span><span id="L-1039"><a href="#L-1039"><span class="linenos">1039</span></a><span class="sd">        ppms_group : str</span>
</span><span id="L-1040"><a href="#L-1040"><span class="linenos">1040</span></a><span class="sd">            The unique identifier of the primary group of the new user. A new group will</span>
</span><span id="L-1041"><a href="#L-1041"><span class="linenos">1041</span></a><span class="sd">            be created if no group with the given name exists.</span>
</span><span id="L-1042"><a href="#L-1042"><span class="linenos">1042</span></a><span class="sd">        phone : str, optional</span>
</span><span id="L-1043"><a href="#L-1043"><span class="linenos">1043</span></a><span class="sd">            The phone number of the user.</span>
</span><span id="L-1044"><a href="#L-1044"><span class="linenos">1044</span></a><span class="sd">        password : str, optional</span>
</span><span id="L-1045"><a href="#L-1045"><span class="linenos">1045</span></a><span class="sd">            The password for the user. If no password is set the user will not be able</span>
</span><span id="L-1046"><a href="#L-1046"><span class="linenos">1046</span></a><span class="sd">            to log on to PPMS.</span>
</span><span id="L-1047"><a href="#L-1047"><span class="linenos">1047</span></a>
</span><span id="L-1048"><a href="#L-1048"><span class="linenos">1048</span></a><span class="sd">        Raises</span>
</span><span id="L-1049"><a href="#L-1049"><span class="linenos">1049</span></a><span class="sd">        ------</span>
</span><span id="L-1050"><a href="#L-1050"><span class="linenos">1050</span></a><span class="sd">        RuntimeError</span>
</span><span id="L-1051"><a href="#L-1051"><span class="linenos">1051</span></a><span class="sd">            Will be raised in case creating the user fails.</span>
</span><span id="L-1052"><a href="#L-1052"><span class="linenos">1052</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1053"><a href="#L-1053"><span class="linenos">1053</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_exists</span><span class="p">(</span><span class="n">login</span><span class="p">):</span>
</span><span id="L-1054"><a href="#L-1054"><span class="linenos">1054</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;NOT creating user [</span><span class="si">{}</span><span class="s2">] as it already exists!&quot;</span><span class="p">,</span> <span class="n">login</span><span class="p">)</span>
</span><span id="L-1055"><a href="#L-1055"><span class="linenos">1055</span></a>            <span class="k">return</span>
</span><span id="L-1056"><a href="#L-1056"><span class="linenos">1056</span></a>
</span><span id="L-1057"><a href="#L-1057"><span class="linenos">1057</span></a>        <span class="n">req_data</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-1058"><a href="#L-1058"><span class="linenos">1058</span></a>            <span class="s2">&quot;login&quot;</span><span class="p">:</span> <span class="n">login</span><span class="p">,</span>
</span><span id="L-1059"><a href="#L-1059"><span class="linenos">1059</span></a>            <span class="s2">&quot;lname&quot;</span><span class="p">:</span> <span class="n">lname</span><span class="p">,</span>
</span><span id="L-1060"><a href="#L-1060"><span class="linenos">1060</span></a>            <span class="s2">&quot;fname&quot;</span><span class="p">:</span> <span class="n">fname</span><span class="p">,</span>
</span><span id="L-1061"><a href="#L-1061"><span class="linenos">1061</span></a>            <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="n">email</span><span class="p">,</span>
</span><span id="L-1062"><a href="#L-1062"><span class="linenos">1062</span></a>            <span class="s2">&quot;unitlogin&quot;</span><span class="p">:</span> <span class="n">ppms_group</span><span class="p">,</span>
</span><span id="L-1063"><a href="#L-1063"><span class="linenos">1063</span></a>        <span class="p">}</span>
</span><span id="L-1064"><a href="#L-1064"><span class="linenos">1064</span></a>        <span class="k">if</span> <span class="n">phone</span><span class="p">:</span>
</span><span id="L-1065"><a href="#L-1065"><span class="linenos">1065</span></a>            <span class="n">req_data</span><span class="p">[</span><span class="s2">&quot;phone&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">phone</span>
</span><span id="L-1066"><a href="#L-1066"><span class="linenos">1066</span></a>        <span class="k">if</span> <span class="n">password</span><span class="p">:</span>
</span><span id="L-1067"><a href="#L-1067"><span class="linenos">1067</span></a>            <span class="n">req_data</span><span class="p">[</span><span class="s2">&quot;pwd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">password</span>
</span><span id="L-1068"><a href="#L-1068"><span class="linenos">1068</span></a>
</span><span id="L-1069"><a href="#L-1069"><span class="linenos">1069</span></a>        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;newuser&quot;</span><span class="p">,</span> <span class="n">req_data</span><span class="p">)</span>
</span><span id="L-1070"><a href="#L-1070"><span class="linenos">1070</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;OK newuser&quot;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
</span><span id="L-1071"><a href="#L-1071"><span class="linenos">1071</span></a>            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Creating new user failed: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-1072"><a href="#L-1072"><span class="linenos">1072</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="L-1073"><a href="#L-1073"><span class="linenos">1073</span></a>            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="L-1074"><a href="#L-1074"><span class="linenos">1074</span></a>
</span><span id="L-1075"><a href="#L-1075"><span class="linenos">1075</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Created user [</span><span class="si">{}</span><span class="s2">] in PPMS.&quot;</span><span class="p">,</span> <span class="n">login</span><span class="p">)</span>
</span><span id="L-1076"><a href="#L-1076"><span class="linenos">1076</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s2">&quot;Response was: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</span><span id="L-1077"><a href="#L-1077"><span class="linenos">1077</span></a>
</span><span id="L-1078"><a href="#L-1078"><span class="linenos">1078</span></a>    <span class="k">def</span> <span class="nf">remove_user_access_from_system</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">system_id</span><span class="p">):</span>
</span><span id="L-1079"><a href="#L-1079"><span class="linenos">1079</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Remove permissions for a user to book a given system in PPMS.</span>
</span><span id="L-1080"><a href="#L-1080"><span class="linenos">1080</span></a>
</span><span id="L-1081"><a href="#L-1081"><span class="linenos">1081</span></a><span class="sd">        Parameters</span>
</span><span id="L-1082"><a href="#L-1082"><span class="linenos">1082</span></a><span class="sd">        ----------</span>
</span><span id="L-1083"><a href="#L-1083"><span class="linenos">1083</span></a><span class="sd">        username : str</span>
</span><span id="L-1084"><a href="#L-1084"><span class="linenos">1084</span></a><span class="sd">            The username (&#39;login&#39;) to remove booking permissions on the system.</span>
</span><span id="L-1085"><a href="#L-1085"><span class="linenos">1085</span></a><span class="sd">        system_id : int or int-like</span>
</span><span id="L-1086"><a href="#L-1086"><span class="linenos">1086</span></a><span class="sd">            The ID of the system to modify the permission for.</span>
</span><span id="L-1087"><a href="#L-1087"><span class="linenos">1087</span></a>
</span><span id="L-1088"><a href="#L-1088"><span class="linenos">1088</span></a><span class="sd">        Returns</span>
</span><span id="L-1089"><a href="#L-1089"><span class="linenos">1089</span></a><span class="sd">        -------</span>
</span><span id="L-1090"><a href="#L-1090"><span class="linenos">1090</span></a><span class="sd">        bool</span>
</span><span id="L-1091"><a href="#L-1091"><span class="linenos">1091</span></a><span class="sd">            True in case the given username now has the permissions to book the</span>
</span><span id="L-1092"><a href="#L-1092"><span class="linenos">1092</span></a><span class="sd">            system with the specified ID (or if the user already had them</span>
</span><span id="L-1093"><a href="#L-1093"><span class="linenos">1093</span></a><span class="sd">            before), False otherwise.</span>
</span><span id="L-1094"><a href="#L-1094"><span class="linenos">1094</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1095"><a href="#L-1095"><span class="linenos">1095</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_system_booking_permissions</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">system_id</span><span class="p">,</span> <span class="s2">&quot;D&quot;</span><span class="p">)</span>
</span><span id="L-1096"><a href="#L-1096"><span class="linenos">1096</span></a>
</span><span id="L-1097"><a href="#L-1097"><span class="linenos">1097</span></a>    <span class="k">def</span> <span class="nf">set_system_booking_permissions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">login</span><span class="p">,</span> <span class="n">system_id</span><span class="p">,</span> <span class="n">permission</span><span class="p">):</span>
</span><span id="L-1098"><a href="#L-1098"><span class="linenos">1098</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Set permissions for a user on a given system in PPMS.</span>
</span><span id="L-1099"><a href="#L-1099"><span class="linenos">1099</span></a>
</span><span id="L-1100"><a href="#L-1100"><span class="linenos">1100</span></a><span class="sd">        Parameters</span>
</span><span id="L-1101"><a href="#L-1101"><span class="linenos">1101</span></a><span class="sd">        ----------</span>
</span><span id="L-1102"><a href="#L-1102"><span class="linenos">1102</span></a><span class="sd">        username : str</span>
</span><span id="L-1103"><a href="#L-1103"><span class="linenos">1103</span></a><span class="sd">            The username (&#39;login&#39;) to allow for booking the system.</span>
</span><span id="L-1104"><a href="#L-1104"><span class="linenos">1104</span></a><span class="sd">        system_id : int or int-like</span>
</span><span id="L-1105"><a href="#L-1105"><span class="linenos">1105</span></a><span class="sd">            The ID of the system to add the permission for.</span>
</span><span id="L-1106"><a href="#L-1106"><span class="linenos">1106</span></a><span class="sd">        permission : {&#39;D&#39;, &#39;A&#39;, &#39;N&#39;, &#39;S&#39;}</span>
</span><span id="L-1107"><a href="#L-1107"><span class="linenos">1107</span></a><span class="sd">            The permission level to set for the user, one of:</span>
</span><span id="L-1108"><a href="#L-1108"><span class="linenos">1108</span></a><span class="sd">              - ``D`` : deactivated</span>
</span><span id="L-1109"><a href="#L-1109"><span class="linenos">1109</span></a><span class="sd">              - ``A`` : autonomous</span>
</span><span id="L-1110"><a href="#L-1110"><span class="linenos">1110</span></a><span class="sd">              - ``N`` : novice</span>
</span><span id="L-1111"><a href="#L-1111"><span class="linenos">1111</span></a><span class="sd">              - ``S`` : superuser</span>
</span><span id="L-1112"><a href="#L-1112"><span class="linenos">1112</span></a>
</span><span id="L-1113"><a href="#L-1113"><span class="linenos">1113</span></a><span class="sd">        Returns</span>
</span><span id="L-1114"><a href="#L-1114"><span class="linenos">1114</span></a><span class="sd">        -------</span>
</span><span id="L-1115"><a href="#L-1115"><span class="linenos">1115</span></a><span class="sd">        bool</span>
</span><span id="L-1116"><a href="#L-1116"><span class="linenos">1116</span></a><span class="sd">            True in case setting permissions for the given username on the</span>
</span><span id="L-1117"><a href="#L-1117"><span class="linenos">1117</span></a><span class="sd">            system with the specified ID succeeded (or if the user already had</span>
</span><span id="L-1118"><a href="#L-1118"><span class="linenos">1118</span></a><span class="sd">            those permissions before), False otherwise.</span>
</span><span id="L-1119"><a href="#L-1119"><span class="linenos">1119</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1120"><a href="#L-1120"><span class="linenos">1120</span></a>
</span><span id="L-1121"><a href="#L-1121"><span class="linenos">1121</span></a>        <span class="k">def</span> <span class="nf">permission_name</span><span class="p">(</span><span class="n">shortname</span><span class="p">):</span>
</span><span id="L-1122"><a href="#L-1122"><span class="linenos">1122</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;Closure to validate a permission level and return its long name.</span>
</span><span id="L-1123"><a href="#L-1123"><span class="linenos">1123</span></a>
</span><span id="L-1124"><a href="#L-1124"><span class="linenos">1124</span></a><span class="sd">            Parameters</span>
</span><span id="L-1125"><a href="#L-1125"><span class="linenos">1125</span></a><span class="sd">            ----------</span>
</span><span id="L-1126"><a href="#L-1126"><span class="linenos">1126</span></a><span class="sd">            shortname : str</span>
</span><span id="L-1127"><a href="#L-1127"><span class="linenos">1127</span></a><span class="sd">                A single character defining the permission level.</span>
</span><span id="L-1128"><a href="#L-1128"><span class="linenos">1128</span></a>
</span><span id="L-1129"><a href="#L-1129"><span class="linenos">1129</span></a><span class="sd">            Returns</span>
</span><span id="L-1130"><a href="#L-1130"><span class="linenos">1130</span></a><span class="sd">            -------</span>
</span><span id="L-1131"><a href="#L-1131"><span class="linenos">1131</span></a><span class="sd">            str</span>
</span><span id="L-1132"><a href="#L-1132"><span class="linenos">1132</span></a><span class="sd">                The long (human-readable) name of the permission level.</span>
</span><span id="L-1133"><a href="#L-1133"><span class="linenos">1133</span></a>
</span><span id="L-1134"><a href="#L-1134"><span class="linenos">1134</span></a><span class="sd">            Raises</span>
</span><span id="L-1135"><a href="#L-1135"><span class="linenos">1135</span></a><span class="sd">            ------</span>
</span><span id="L-1136"><a href="#L-1136"><span class="linenos">1136</span></a><span class="sd">            KeyError</span>
</span><span id="L-1137"><a href="#L-1137"><span class="linenos">1137</span></a><span class="sd">                Raised in case an invalid permission level was given.</span>
</span><span id="L-1138"><a href="#L-1138"><span class="linenos">1138</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="L-1139"><a href="#L-1139"><span class="linenos">1139</span></a>            <span class="n">mapping</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-1140"><a href="#L-1140"><span class="linenos">1140</span></a>                <span class="s2">&quot;D&quot;</span><span class="p">:</span> <span class="s2">&quot;deactivated&quot;</span><span class="p">,</span>
</span><span id="L-1141"><a href="#L-1141"><span class="linenos">1141</span></a>                <span class="s2">&quot;A&quot;</span><span class="p">:</span> <span class="s2">&quot;autonomous&quot;</span><span class="p">,</span>
</span><span id="L-1142"><a href="#L-1142"><span class="linenos">1142</span></a>                <span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="s2">&quot;novice&quot;</span><span class="p">,</span>
</span><span id="L-1143"><a href="#L-1143"><span class="linenos">1143</span></a>                <span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="s2">&quot;superuser&quot;</span><span class="p">,</span>
</span><span id="L-1144"><a href="#L-1144"><span class="linenos">1144</span></a>            <span class="p">}</span>
</span><span id="L-1145"><a href="#L-1145"><span class="linenos">1145</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="L-1146"><a href="#L-1146"><span class="linenos">1146</span></a>                <span class="k">return</span> <span class="n">mapping</span><span class="p">[</span><span class="n">shortname</span><span class="p">]</span>
</span><span id="L-1147"><a href="#L-1147"><span class="linenos">1147</span></a>            <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
</span><span id="L-1148"><a href="#L-1148"><span class="linenos">1148</span></a>                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid permission [</span><span class="si">{</span><span class="n">shortname</span><span class="si">}</span><span class="s2">] given&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">err</span>
</span><span id="L-1149"><a href="#L-1149"><span class="linenos">1149</span></a>
</span><span id="L-1150"><a href="#L-1150"><span class="linenos">1150</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
</span><span id="L-1151"><a href="#L-1151"><span class="linenos">1151</span></a>            <span class="s2">&quot;Setting permission level [</span><span class="si">{}</span><span class="s2">] for user [</span><span class="si">{}</span><span class="s2">] on system [</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="p">,</span>
</span><span id="L-1152"><a href="#L-1152"><span class="linenos">1152</span></a>            <span class="n">permission_name</span><span class="p">(</span><span class="n">permission</span><span class="p">),</span>
</span><span id="L-1153"><a href="#L-1153"><span class="linenos">1153</span></a>            <span class="n">login</span><span class="p">,</span>
</span><span id="L-1154"><a href="#L-1154"><span class="linenos">1154</span></a>            <span class="n">system_id</span><span class="p">,</span>
</span><span id="L-1155"><a href="#L-1155"><span class="linenos">1155</span></a>        <span class="p">)</span>
</span><span id="L-1156"><a href="#L-1156"><span class="linenos">1156</span></a>
</span><span id="L-1157"><a href="#L-1157"><span class="linenos">1157</span></a>        <span class="n">parameters</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">system_id</span><span class="p">,</span> <span class="s2">&quot;login&quot;</span><span class="p">:</span> <span class="n">login</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">permission</span><span class="p">}</span>
</span><span id="L-1158"><a href="#L-1158"><span class="linenos">1158</span></a>        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;setright&quot;</span><span class="p">,</span> <span class="n">parameters</span><span class="p">)</span>
</span><span id="L-1159"><a href="#L-1159"><span class="linenos">1159</span></a>
</span><span id="L-1160"><a href="#L-1160"><span class="linenos">1160</span></a>        <span class="c1"># NOTE: the &#39;setright&#39; action will accept ANY permission type and return &#39;done&#39;</span>
</span><span id="L-1161"><a href="#L-1161"><span class="linenos">1161</span></a>        <span class="c1"># on the request, so there is no way to check from the response if setting the</span>
</span><span id="L-1162"><a href="#L-1162"><span class="linenos">1162</span></a>        <span class="c1"># permission really worked!!</span>
</span><span id="L-1163"><a href="#L-1163"><span class="linenos">1163</span></a>        <span class="c1"># log.trace(&#39;Request returned text: {}&#39;, response.text)</span>
</span><span id="L-1164"><a href="#L-1164"><span class="linenos">1164</span></a>        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;done&quot;</span><span class="p">:</span>
</span><span id="L-1165"><a href="#L-1165"><span class="linenos">1165</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span>
</span><span id="L-1166"><a href="#L-1166"><span class="linenos">1166</span></a>                <span class="s2">&quot;User [</span><span class="si">{}</span><span class="s2">] now has permission level [</span><span class="si">{}</span><span class="s2">] on system [</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="p">,</span>
</span><span id="L-1167"><a href="#L-1167"><span class="linenos">1167</span></a>                <span class="n">login</span><span class="p">,</span>
</span><span id="L-1168"><a href="#L-1168"><span class="linenos">1168</span></a>                <span class="n">permission_name</span><span class="p">(</span><span class="n">permission</span><span class="p">),</span>
</span><span id="L-1169"><a href="#L-1169"><span class="linenos">1169</span></a>                <span class="n">system_id</span><span class="p">,</span>
</span><span id="L-1170"><a href="#L-1170"><span class="linenos">1170</span></a>            <span class="p">)</span>
</span><span id="L-1171"><a href="#L-1171"><span class="linenos">1171</span></a>            <span class="k">return</span> <span class="kc">True</span>
</span><span id="L-1172"><a href="#L-1172"><span class="linenos">1172</span></a>
</span><span id="L-1173"><a href="#L-1173"><span class="linenos">1173</span></a>        <span class="k">if</span> <span class="s2">&quot;invalid user&quot;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
</span><span id="L-1174"><a href="#L-1174"><span class="linenos">1174</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;User [</span><span class="si">{}</span><span class="s2">] doesn&#39;t seem to exist in PPMS&quot;</span><span class="p">,</span> <span class="n">login</span><span class="p">)</span>
</span><span id="L-1175"><a href="#L-1175"><span class="linenos">1175</span></a>        <span class="k">elif</span> <span class="s2">&quot;system right not authorized&quot;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
</span><span id="L-1176"><a href="#L-1176"><span class="linenos">1176</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
</span><span id="L-1177"><a href="#L-1177"><span class="linenos">1177</span></a>                <span class="s2">&quot;Unable to set permissions for system </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">system_id</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span>
</span><span id="L-1178"><a href="#L-1178"><span class="linenos">1178</span></a>            <span class="p">)</span>
</span><span id="L-1179"><a href="#L-1179"><span class="linenos">1179</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1180"><a href="#L-1180"><span class="linenos">1180</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Unexpected response, assuming request failed: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</span><span id="L-1181"><a href="#L-1181"><span class="linenos">1181</span></a>
</span><span id="L-1182"><a href="#L-1182"><span class="linenos">1182</span></a>        <span class="k">return</span> <span class="kc">False</span>
</span><span id="L-1183"><a href="#L-1183"><span class="linenos">1183</span></a>
</span><span id="L-1184"><a href="#L-1184"><span class="linenos">1184</span></a>    <span class="k">def</span> <span class="nf">update_systems</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1185"><a href="#L-1185"><span class="linenos">1185</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Update cached details for all bookable systems from PPMS.</span>
</span><span id="L-1186"><a href="#L-1186"><span class="linenos">1186</span></a>
</span><span id="L-1187"><a href="#L-1187"><span class="linenos">1187</span></a><span class="sd">        Get the details on all bookable systems from PPMS and store them in the local</span>
</span><span id="L-1188"><a href="#L-1188"><span class="linenos">1188</span></a><span class="sd">        cache. If parsing the PUMAPI response for a system fails for any reason, the</span>
</span><span id="L-1189"><a href="#L-1189"><span class="linenos">1189</span></a><span class="sd">        system is skipped entirely.</span>
</span><span id="L-1190"><a href="#L-1190"><span class="linenos">1190</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1191"><a href="#L-1191"><span class="linenos">1191</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s2">&quot;Updating list of bookable systems...&quot;</span><span class="p">)</span>
</span><span id="L-1192"><a href="#L-1192"><span class="linenos">1192</span></a>        <span class="n">systems</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-1193"><a href="#L-1193"><span class="linenos">1193</span></a>        <span class="n">parse_fails</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-1194"><a href="#L-1194"><span class="linenos">1194</span></a>        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;getsystems&quot;</span><span class="p">)</span>
</span><span id="L-1195"><a href="#L-1195"><span class="linenos">1195</span></a>        <span class="n">details</span> <span class="o">=</span> <span class="n">parse_multiline_response</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">graceful</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-1196"><a href="#L-1196"><span class="linenos">1196</span></a>        <span class="k">for</span> <span class="n">detail</span> <span class="ow">in</span> <span class="n">details</span><span class="p">:</span>
</span><span id="L-1197"><a href="#L-1197"><span class="linenos">1197</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="L-1198"><a href="#L-1198"><span class="linenos">1198</span></a>                <span class="n">system</span> <span class="o">=</span> <span class="n">PpmsSystem</span><span class="p">(</span><span class="n">detail</span><span class="p">)</span>
</span><span id="L-1199"><a href="#L-1199"><span class="linenos">1199</span></a>            <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
</span><span id="L-1200"><a href="#L-1200"><span class="linenos">1200</span></a>                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error processing `getsystems` response: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
</span><span id="L-1201"><a href="#L-1201"><span class="linenos">1201</span></a>                <span class="n">parse_fails</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-1202"><a href="#L-1202"><span class="linenos">1202</span></a>                <span class="k">continue</span>
</span><span id="L-1203"><a href="#L-1203"><span class="linenos">1203</span></a>
</span><span id="L-1204"><a href="#L-1204"><span class="linenos">1204</span></a>            <span class="n">systems</span><span class="p">[</span><span class="n">system</span><span class="o">.</span><span class="n">system_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">system</span>
</span><span id="L-1205"><a href="#L-1205"><span class="linenos">1205</span></a>
</span><span id="L-1206"><a href="#L-1206"><span class="linenos">1206</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span>
</span><span id="L-1207"><a href="#L-1207"><span class="linenos">1207</span></a>            <span class="s2">&quot;Updated </span><span class="si">{}</span><span class="s2"> bookable systems from PPMS (</span><span class="si">{}</span><span class="s2"> systems failed parsing)&quot;</span><span class="p">,</span>
</span><span id="L-1208"><a href="#L-1208"><span class="linenos">1208</span></a>            <span class="nb">len</span><span class="p">(</span><span class="n">systems</span><span class="p">),</span>
</span><span id="L-1209"><a href="#L-1209"><span class="linenos">1209</span></a>            <span class="n">parse_fails</span><span class="p">,</span>
</span><span id="L-1210"><a href="#L-1210"><span class="linenos">1210</span></a>        <span class="p">)</span>
</span><span id="L-1211"><a href="#L-1211"><span class="linenos">1211</span></a>
</span><span id="L-1212"><a href="#L-1212"><span class="linenos">1212</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">systems</span> <span class="o">=</span> <span class="n">systems</span>
</span><span id="L-1213"><a href="#L-1213"><span class="linenos">1213</span></a>
</span><span id="L-1214"><a href="#L-1214"><span class="linenos">1214</span></a>    <span class="k">def</span> <span class="nf">update_users</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_ids</span><span class="o">=</span><span class="p">[],</span> <span class="n">active_only</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="L-1215"><a href="#L-1215"><span class="linenos">1215</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Update cached details for a list of users from PPMS.</span>
</span><span id="L-1216"><a href="#L-1216"><span class="linenos">1216</span></a>
</span><span id="L-1217"><a href="#L-1217"><span class="linenos">1217</span></a><span class="sd">        Get the user details on a list of users (or all active ones) from PPMS and store</span>
</span><span id="L-1218"><a href="#L-1218"><span class="linenos">1218</span></a><span class="sd">        them in the object&#39;s `users` dict. As a side effect, this will also fill the</span>
</span><span id="L-1219"><a href="#L-1219"><span class="linenos">1219</span></a><span class="sd">        cache directory in case the object&#39;s `cache_path` attribute is set.</span>
</span><span id="L-1220"><a href="#L-1220"><span class="linenos">1220</span></a>
</span><span id="L-1221"><a href="#L-1221"><span class="linenos">1221</span></a><span class="sd">        WARNING - very slow, especially when the PPMS instance has many users!</span>
</span><span id="L-1222"><a href="#L-1222"><span class="linenos">1222</span></a>
</span><span id="L-1223"><a href="#L-1223"><span class="linenos">1223</span></a><span class="sd">        Parameters</span>
</span><span id="L-1224"><a href="#L-1224"><span class="linenos">1224</span></a><span class="sd">        ----------</span>
</span><span id="L-1225"><a href="#L-1225"><span class="linenos">1225</span></a><span class="sd">        user_ids : list(str), optional</span>
</span><span id="L-1226"><a href="#L-1226"><span class="linenos">1226</span></a><span class="sd">            A list of user IDs (login names) to request the cache for, by</span>
</span><span id="L-1227"><a href="#L-1227"><span class="linenos">1227</span></a><span class="sd">            default [] which will result in all *active* users to be requested.</span>
</span><span id="L-1228"><a href="#L-1228"><span class="linenos">1228</span></a><span class="sd">        active_only : bool, optional</span>
</span><span id="L-1229"><a href="#L-1229"><span class="linenos">1229</span></a><span class="sd">            If set to `False` also &quot;inactive&quot; users will be fetched from PPMS,</span>
</span><span id="L-1230"><a href="#L-1230"><span class="linenos">1230</span></a><span class="sd">            by default `True`.</span>
</span><span id="L-1231"><a href="#L-1231"><span class="linenos">1231</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1232"><a href="#L-1232"><span class="linenos">1232</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">user_ids</span><span class="p">:</span>
</span><span id="L-1233"><a href="#L-1233"><span class="linenos">1233</span></a>            <span class="n">user_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_ids</span><span class="p">(</span><span class="n">active</span><span class="o">=</span><span class="n">active_only</span><span class="p">)</span>
</span><span id="L-1234"><a href="#L-1234"><span class="linenos">1234</span></a>
</span><span id="L-1235"><a href="#L-1235"><span class="linenos">1235</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s2">&quot;Updating details on </span><span class="si">{}</span><span class="s2"> users&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">user_ids</span><span class="p">))</span>
</span><span id="L-1236"><a href="#L-1236"><span class="linenos">1236</span></a>        <span class="k">for</span> <span class="n">user_id</span> <span class="ow">in</span> <span class="n">user_ids</span><span class="p">:</span>
</span><span id="L-1237"><a href="#L-1237"><span class="linenos">1237</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">skip_cache</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1238"><a href="#L-1238"><span class="linenos">1238</span></a>
</span><span id="L-1239"><a href="#L-1239"><span class="linenos">1239</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Collected details on </span><span class="si">{}</span><span class="s2"> users&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="p">))</span>
</span><span id="L-1240"><a href="#L-1240"><span class="linenos">1240</span></a>
</span><span id="L-1241"><a href="#L-1241"><span class="linenos">1241</span></a>    <span class="k">def</span> <span class="nf">user_exists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">login</span><span class="p">):</span>
</span><span id="L-1242"><a href="#L-1242"><span class="linenos">1242</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if an account with the given login name already exists in PPMS.</span>
</span><span id="L-1243"><a href="#L-1243"><span class="linenos">1243</span></a>
</span><span id="L-1244"><a href="#L-1244"><span class="linenos">1244</span></a><span class="sd">        Parameters</span>
</span><span id="L-1245"><a href="#L-1245"><span class="linenos">1245</span></a><span class="sd">        ----------</span>
</span><span id="L-1246"><a href="#L-1246"><span class="linenos">1246</span></a><span class="sd">        login : str</span>
</span><span id="L-1247"><a href="#L-1247"><span class="linenos">1247</span></a><span class="sd">            The login name to check for.</span>
</span><span id="L-1248"><a href="#L-1248"><span class="linenos">1248</span></a>
</span><span id="L-1249"><a href="#L-1249"><span class="linenos">1249</span></a><span class="sd">        Returns</span>
</span><span id="L-1250"><a href="#L-1250"><span class="linenos">1250</span></a><span class="sd">        -------</span>
</span><span id="L-1251"><a href="#L-1251"><span class="linenos">1251</span></a><span class="sd">        bool</span>
</span><span id="L-1252"><a href="#L-1252"><span class="linenos">1252</span></a><span class="sd">            True in case an account with that name exists in PPMS, false otherwise.</span>
</span><span id="L-1253"><a href="#L-1253"><span class="linenos">1253</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1254"><a href="#L-1254"><span class="linenos">1254</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-1255"><a href="#L-1255"><span class="linenos">1255</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="n">login</span><span class="p">)</span>
</span><span id="L-1256"><a href="#L-1256"><span class="linenos">1256</span></a>            <span class="k">return</span> <span class="kc">True</span>
</span><span id="L-1257"><a href="#L-1257"><span class="linenos">1257</span></a>        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
</span><span id="L-1258"><a href="#L-1258"><span class="linenos">1258</span></a>            <span class="k">return</span> <span class="kc">False</span>
</span></pre></div>


            </section>
                <section id="PpmsConnection">
                            <input id="PpmsConnection-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">PpmsConnection</span>:

                <label class="view-source-button" for="PpmsConnection-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PpmsConnection"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PpmsConnection-27"><a href="#PpmsConnection-27"><span class="linenos">  27</span></a><span class="k">class</span> <span class="nc">PpmsConnection</span><span class="p">:</span>
</span><span id="PpmsConnection-28"><a href="#PpmsConnection-28"><span class="linenos">  28</span></a>
</span><span id="PpmsConnection-29"><a href="#PpmsConnection-29"><span class="linenos">  29</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Connection object to communicate with a PPMS instance.</span>
</span><span id="PpmsConnection-30"><a href="#PpmsConnection-30"><span class="linenos">  30</span></a>
</span><span id="PpmsConnection-31"><a href="#PpmsConnection-31"><span class="linenos">  31</span></a><span class="sd">    Attributes</span>
</span><span id="PpmsConnection-32"><a href="#PpmsConnection-32"><span class="linenos">  32</span></a><span class="sd">    ----------</span>
</span><span id="PpmsConnection-33"><a href="#PpmsConnection-33"><span class="linenos">  33</span></a><span class="sd">    url : str</span>
</span><span id="PpmsConnection-34"><a href="#PpmsConnection-34"><span class="linenos">  34</span></a><span class="sd">        The URL of the PUMAPI instance.</span>
</span><span id="PpmsConnection-35"><a href="#PpmsConnection-35"><span class="linenos">  35</span></a><span class="sd">    api_key : str</span>
</span><span id="PpmsConnection-36"><a href="#PpmsConnection-36"><span class="linenos">  36</span></a><span class="sd">        The API key used for authenticating against the PUMAPI.</span>
</span><span id="PpmsConnection-37"><a href="#PpmsConnection-37"><span class="linenos">  37</span></a><span class="sd">    timeout : float</span>
</span><span id="PpmsConnection-38"><a href="#PpmsConnection-38"><span class="linenos">  38</span></a><span class="sd">        The timeout value used in the ``requests.post`` calls.</span>
</span><span id="PpmsConnection-39"><a href="#PpmsConnection-39"><span class="linenos">  39</span></a><span class="sd">    cache_path : str</span>
</span><span id="PpmsConnection-40"><a href="#PpmsConnection-40"><span class="linenos">  40</span></a><span class="sd">        A path to a local directory used for caching responses.</span>
</span><span id="PpmsConnection-41"><a href="#PpmsConnection-41"><span class="linenos">  41</span></a><span class="sd">    cache_users_only : bool</span>
</span><span id="PpmsConnection-42"><a href="#PpmsConnection-42"><span class="linenos">  42</span></a><span class="sd">        Flag indicating that only PPMS user details will be stored in the</span>
</span><span id="PpmsConnection-43"><a href="#PpmsConnection-43"><span class="linenos">  43</span></a><span class="sd">        on-disk cache, nothing else.</span>
</span><span id="PpmsConnection-44"><a href="#PpmsConnection-44"><span class="linenos">  44</span></a><span class="sd">    last_served_from_cache : bool</span>
</span><span id="PpmsConnection-45"><a href="#PpmsConnection-45"><span class="linenos">  45</span></a><span class="sd">        Indicates if the last request was served from the cache or on-line.</span>
</span><span id="PpmsConnection-46"><a href="#PpmsConnection-46"><span class="linenos">  46</span></a><span class="sd">    users : dict</span>
</span><span id="PpmsConnection-47"><a href="#PpmsConnection-47"><span class="linenos">  47</span></a><span class="sd">        A dict with usernames as keys, mapping to the related</span>
</span><span id="PpmsConnection-48"><a href="#PpmsConnection-48"><span class="linenos">  48</span></a><span class="sd">        :py:class:`pyppms.user.PpmsUser` object, serves as a cache during the object&#39;s</span>
</span><span id="PpmsConnection-49"><a href="#PpmsConnection-49"><span class="linenos">  49</span></a><span class="sd">        lifetime (can be empty if no calls to :py:meth:`get_user()` have been done yet).</span>
</span><span id="PpmsConnection-50"><a href="#PpmsConnection-50"><span class="linenos">  50</span></a><span class="sd">    fullname_mapping : dict</span>
</span><span id="PpmsConnection-51"><a href="#PpmsConnection-51"><span class="linenos">  51</span></a><span class="sd">        A dict mapping a user&#39;s *fullname* (&quot;``&lt;LASTNAME&gt; &lt;FIRSTNAME&gt;``&quot;) to the</span>
</span><span id="PpmsConnection-52"><a href="#PpmsConnection-52"><span class="linenos">  52</span></a><span class="sd">        corresponding username. Entries are filled in dynamically by the</span>
</span><span id="PpmsConnection-53"><a href="#PpmsConnection-53"><span class="linenos">  53</span></a><span class="sd">        :py:meth:`get_user()` method.</span>
</span><span id="PpmsConnection-54"><a href="#PpmsConnection-54"><span class="linenos">  54</span></a><span class="sd">    systems</span>
</span><span id="PpmsConnection-55"><a href="#PpmsConnection-55"><span class="linenos">  55</span></a><span class="sd">        A dict with system IDs as keys, mapping to the related</span>
</span><span id="PpmsConnection-56"><a href="#PpmsConnection-56"><span class="linenos">  56</span></a><span class="sd">        :py:class:`pyppms.system.PpmsSystem` object. Serves as a cache during the</span>
</span><span id="PpmsConnection-57"><a href="#PpmsConnection-57"><span class="linenos">  57</span></a><span class="sd">        object&#39;s lifetime (can be empty if no calls to the :py:meth:`get_systems()` have</span>
</span><span id="PpmsConnection-58"><a href="#PpmsConnection-58"><span class="linenos">  58</span></a><span class="sd">        been done yet).</span>
</span><span id="PpmsConnection-59"><a href="#PpmsConnection-59"><span class="linenos">  59</span></a><span class="sd">    status : dict</span>
</span><span id="PpmsConnection-60"><a href="#PpmsConnection-60"><span class="linenos">  60</span></a><span class="sd">        A dict with keys ``auth_state``, ``auth_response`` and</span>
</span><span id="PpmsConnection-61"><a href="#PpmsConnection-61"><span class="linenos">  61</span></a><span class="sd">        ``auth_httpstatus``</span>
</span><span id="PpmsConnection-62"><a href="#PpmsConnection-62"><span class="linenos">  62</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="PpmsConnection-63"><a href="#PpmsConnection-63"><span class="linenos">  63</span></a>
</span><span id="PpmsConnection-64"><a href="#PpmsConnection-64"><span class="linenos">  64</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">api_key</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">cache_users_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="PpmsConnection-65"><a href="#PpmsConnection-65"><span class="linenos">  65</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Constructor for the PPMS connection object.</span>
</span><span id="PpmsConnection-66"><a href="#PpmsConnection-66"><span class="linenos">  66</span></a>
</span><span id="PpmsConnection-67"><a href="#PpmsConnection-67"><span class="linenos">  67</span></a><span class="sd">        Open a connection to the PUMAPI defined in `url` and try to authenticate</span>
</span><span id="PpmsConnection-68"><a href="#PpmsConnection-68"><span class="linenos">  68</span></a><span class="sd">        against it using the given API key (or use cache-only mode if key is an</span>
</span><span id="PpmsConnection-69"><a href="#PpmsConnection-69"><span class="linenos">  69</span></a><span class="sd">        empty string). If an optional path to a caching location is specified,</span>
</span><span id="PpmsConnection-70"><a href="#PpmsConnection-70"><span class="linenos">  70</span></a><span class="sd">        responses will be read from that location unless no matching file can be</span>
</span><span id="PpmsConnection-71"><a href="#PpmsConnection-71"><span class="linenos">  71</span></a><span class="sd">        found there, in which case an on-line request will be done (with the</span>
</span><span id="PpmsConnection-72"><a href="#PpmsConnection-72"><span class="linenos">  72</span></a><span class="sd">        response being saved to the cache path).</span>
</span><span id="PpmsConnection-73"><a href="#PpmsConnection-73"><span class="linenos">  73</span></a>
</span><span id="PpmsConnection-74"><a href="#PpmsConnection-74"><span class="linenos">  74</span></a><span class="sd">        Parameters</span>
</span><span id="PpmsConnection-75"><a href="#PpmsConnection-75"><span class="linenos">  75</span></a><span class="sd">        ----------</span>
</span><span id="PpmsConnection-76"><a href="#PpmsConnection-76"><span class="linenos">  76</span></a><span class="sd">        url : str</span>
</span><span id="PpmsConnection-77"><a href="#PpmsConnection-77"><span class="linenos">  77</span></a><span class="sd">            The URL of the PUMAPI to connect to.</span>
</span><span id="PpmsConnection-78"><a href="#PpmsConnection-78"><span class="linenos">  78</span></a><span class="sd">        api_key : str</span>
</span><span id="PpmsConnection-79"><a href="#PpmsConnection-79"><span class="linenos">  79</span></a><span class="sd">            The API key to use for authenticating against the PUMAPI. If</span>
</span><span id="PpmsConnection-80"><a href="#PpmsConnection-80"><span class="linenos">  80</span></a><span class="sd">            specified as &#39;&#39; authentication will be skipped and the connection is</span>
</span><span id="PpmsConnection-81"><a href="#PpmsConnection-81"><span class="linenos">  81</span></a><span class="sd">            running in cache-only (local) mode.</span>
</span><span id="PpmsConnection-82"><a href="#PpmsConnection-82"><span class="linenos">  82</span></a><span class="sd">        timeout : float, optional</span>
</span><span id="PpmsConnection-83"><a href="#PpmsConnection-83"><span class="linenos">  83</span></a><span class="sd">            How many seconds to wait for the PUMAPI server to send a response</span>
</span><span id="PpmsConnection-84"><a href="#PpmsConnection-84"><span class="linenos">  84</span></a><span class="sd">            before giving up, by default 10.</span>
</span><span id="PpmsConnection-85"><a href="#PpmsConnection-85"><span class="linenos">  85</span></a><span class="sd">        cache : str, optional</span>
</span><span id="PpmsConnection-86"><a href="#PpmsConnection-86"><span class="linenos">  86</span></a><span class="sd">            A path to a local directory for caching responses from PUMAPI in</span>
</span><span id="PpmsConnection-87"><a href="#PpmsConnection-87"><span class="linenos">  87</span></a><span class="sd">            individual text files. Useful for testing and for speeding up</span>
</span><span id="PpmsConnection-88"><a href="#PpmsConnection-88"><span class="linenos">  88</span></a><span class="sd">            slow requests like &#39;getusers&#39;. By default empty, which will result</span>
</span><span id="PpmsConnection-89"><a href="#PpmsConnection-89"><span class="linenos">  89</span></a><span class="sd">            in no caching being done.</span>
</span><span id="PpmsConnection-90"><a href="#PpmsConnection-90"><span class="linenos">  90</span></a><span class="sd">        cache_users_only : bool, optional</span>
</span><span id="PpmsConnection-91"><a href="#PpmsConnection-91"><span class="linenos">  91</span></a><span class="sd">            If set to `True`, only `getuser` requests will be cached on disk.</span>
</span><span id="PpmsConnection-92"><a href="#PpmsConnection-92"><span class="linenos">  92</span></a><span class="sd">            This can be used in to speed up the slow requests (through the</span>
</span><span id="PpmsConnection-93"><a href="#PpmsConnection-93"><span class="linenos">  93</span></a><span class="sd">            cache), while everything else will be handled through online</span>
</span><span id="PpmsConnection-94"><a href="#PpmsConnection-94"><span class="linenos">  94</span></a><span class="sd">            requests. By default `False`.</span>
</span><span id="PpmsConnection-95"><a href="#PpmsConnection-95"><span class="linenos">  95</span></a>
</span><span id="PpmsConnection-96"><a href="#PpmsConnection-96"><span class="linenos">  96</span></a><span class="sd">        Raises</span>
</span><span id="PpmsConnection-97"><a href="#PpmsConnection-97"><span class="linenos">  97</span></a><span class="sd">        ------</span>
</span><span id="PpmsConnection-98"><a href="#PpmsConnection-98"><span class="linenos">  98</span></a><span class="sd">        requests.exceptions.ConnectionError</span>
</span><span id="PpmsConnection-99"><a href="#PpmsConnection-99"><span class="linenos">  99</span></a><span class="sd">            Raised in case authentication fails.</span>
</span><span id="PpmsConnection-100"><a href="#PpmsConnection-100"><span class="linenos"> 100</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PpmsConnection-101"><a href="#PpmsConnection-101"><span class="linenos"> 101</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">url</span>
</span><span id="PpmsConnection-102"><a href="#PpmsConnection-102"><span class="linenos"> 102</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">api_key</span>
</span><span id="PpmsConnection-103"><a href="#PpmsConnection-103"><span class="linenos"> 103</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span>
</span><span id="PpmsConnection-104"><a href="#PpmsConnection-104"><span class="linenos"> 104</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">users</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="PpmsConnection-105"><a href="#PpmsConnection-105"><span class="linenos"> 105</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fullname_mapping</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="PpmsConnection-106"><a href="#PpmsConnection-106"><span class="linenos"> 106</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">systems</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="PpmsConnection-107"><a href="#PpmsConnection-107"><span class="linenos"> 107</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="PpmsConnection-108"><a href="#PpmsConnection-108"><span class="linenos"> 108</span></a>            <span class="s2">&quot;auth_state&quot;</span><span class="p">:</span> <span class="s2">&quot;NOT_TRIED&quot;</span><span class="p">,</span>
</span><span id="PpmsConnection-109"><a href="#PpmsConnection-109"><span class="linenos"> 109</span></a>            <span class="s2">&quot;auth_response&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="PpmsConnection-110"><a href="#PpmsConnection-110"><span class="linenos"> 110</span></a>            <span class="s2">&quot;auth_httpstatus&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
</span><span id="PpmsConnection-111"><a href="#PpmsConnection-111"><span class="linenos"> 111</span></a>        <span class="p">}</span>
</span><span id="PpmsConnection-112"><a href="#PpmsConnection-112"><span class="linenos"> 112</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cache_path</span> <span class="o">=</span> <span class="n">cache</span>
</span><span id="PpmsConnection-113"><a href="#PpmsConnection-113"><span class="linenos"> 113</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cache_users_only</span> <span class="o">=</span> <span class="n">cache_users_only</span>
</span><span id="PpmsConnection-114"><a href="#PpmsConnection-114"><span class="linenos"> 114</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">last_served_from_cache</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="PpmsConnection-115"><a href="#PpmsConnection-115"><span class="linenos"> 115</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Indicates if the last request was served from the cache or on-line.&quot;&quot;&quot;</span>
</span><span id="PpmsConnection-116"><a href="#PpmsConnection-116"><span class="linenos"> 116</span></a>
</span><span id="PpmsConnection-117"><a href="#PpmsConnection-117"><span class="linenos"> 117</span></a>        <span class="c1"># run in cache-only mode (e.g. for testing or off-line usage) if no API</span>
</span><span id="PpmsConnection-118"><a href="#PpmsConnection-118"><span class="linenos"> 118</span></a>        <span class="c1"># key has been specified, skip authentication then:</span>
</span><span id="PpmsConnection-119"><a href="#PpmsConnection-119"><span class="linenos"> 119</span></a>        <span class="k">if</span> <span class="n">api_key</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
</span><span id="PpmsConnection-120"><a href="#PpmsConnection-120"><span class="linenos"> 120</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">__authenticate</span><span class="p">()</span>
</span><span id="PpmsConnection-121"><a href="#PpmsConnection-121"><span class="linenos"> 121</span></a>        <span class="k">elif</span> <span class="n">cache</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
</span><span id="PpmsConnection-122"><a href="#PpmsConnection-122"><span class="linenos"> 122</span></a>            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
</span><span id="PpmsConnection-123"><a href="#PpmsConnection-123"><span class="linenos"> 123</span></a>                <span class="s2">&quot;Neither API key nor cache path given, at least one is required!&quot;</span>
</span><span id="PpmsConnection-124"><a href="#PpmsConnection-124"><span class="linenos"> 124</span></a>            <span class="p">)</span>
</span><span id="PpmsConnection-125"><a href="#PpmsConnection-125"><span class="linenos"> 125</span></a>
</span><span id="PpmsConnection-126"><a href="#PpmsConnection-126"><span class="linenos"> 126</span></a>    <span class="k">def</span> <span class="nf">__authenticate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="PpmsConnection-127"><a href="#PpmsConnection-127"><span class="linenos"> 127</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Try to authenticate to PPMS using the `auth` request.</span>
</span><span id="PpmsConnection-128"><a href="#PpmsConnection-128"><span class="linenos"> 128</span></a>
</span><span id="PpmsConnection-129"><a href="#PpmsConnection-129"><span class="linenos"> 129</span></a><span class="sd">        Raises</span>
</span><span id="PpmsConnection-130"><a href="#PpmsConnection-130"><span class="linenos"> 130</span></a><span class="sd">        ------</span>
</span><span id="PpmsConnection-131"><a href="#PpmsConnection-131"><span class="linenos"> 131</span></a><span class="sd">        requests.exceptions.ConnectionError</span>
</span><span id="PpmsConnection-132"><a href="#PpmsConnection-132"><span class="linenos"> 132</span></a><span class="sd">            Raised in case authentication failed for any reason.</span>
</span><span id="PpmsConnection-133"><a href="#PpmsConnection-133"><span class="linenos"> 133</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PpmsConnection-134"><a href="#PpmsConnection-134"><span class="linenos"> 134</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span>
</span><span id="PpmsConnection-135"><a href="#PpmsConnection-135"><span class="linenos"> 135</span></a>            <span class="s2">&quot;Attempting authentication against </span><span class="si">{}</span><span class="s2"> with key [</span><span class="si">{}</span><span class="s2">...</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="p">,</span>
</span><span id="PpmsConnection-136"><a href="#PpmsConnection-136"><span class="linenos"> 136</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span>
</span><span id="PpmsConnection-137"><a href="#PpmsConnection-137"><span class="linenos"> 137</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">api_key</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span>
</span><span id="PpmsConnection-138"><a href="#PpmsConnection-138"><span class="linenos"> 138</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">api_key</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:],</span>
</span><span id="PpmsConnection-139"><a href="#PpmsConnection-139"><span class="linenos"> 139</span></a>        <span class="p">)</span>
</span><span id="PpmsConnection-140"><a href="#PpmsConnection-140"><span class="linenos"> 140</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s2">&quot;auth_state&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;attempting&quot;</span>
</span><span id="PpmsConnection-141"><a href="#PpmsConnection-141"><span class="linenos"> 141</span></a>        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;auth&quot;</span><span class="p">)</span>
</span><span id="PpmsConnection-142"><a href="#PpmsConnection-142"><span class="linenos"> 142</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Authenticate response: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="PpmsConnection-143"><a href="#PpmsConnection-143"><span class="linenos"> 143</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s2">&quot;auth_response&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span>
</span><span id="PpmsConnection-144"><a href="#PpmsConnection-144"><span class="linenos"> 144</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s2">&quot;auth_httpstatus&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span>
</span><span id="PpmsConnection-145"><a href="#PpmsConnection-145"><span class="linenos"> 145</span></a>
</span><span id="PpmsConnection-146"><a href="#PpmsConnection-146"><span class="linenos"> 146</span></a>        <span class="c1"># NOTE: an unauthorized request has already been caught be the request() method</span>
</span><span id="PpmsConnection-147"><a href="#PpmsConnection-147"><span class="linenos"> 147</span></a>        <span class="c1"># above. Our legacy code was additionally testing for &#39;error&#39; in the response</span>
</span><span id="PpmsConnection-148"><a href="#PpmsConnection-148"><span class="linenos"> 148</span></a>        <span class="c1"># text - however, it is unclear if PUMAPI ever returns this:</span>
</span><span id="PpmsConnection-149"><a href="#PpmsConnection-149"><span class="linenos"> 149</span></a>        <span class="k">if</span> <span class="s2">&quot;error&quot;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
</span><span id="PpmsConnection-150"><a href="#PpmsConnection-150"><span class="linenos"> 150</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s2">&quot;auth_state&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;FAILED-ERROR&quot;</span>
</span><span id="PpmsConnection-151"><a href="#PpmsConnection-151"><span class="linenos"> 151</span></a>            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Authentication failed with an error: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="PpmsConnection-152"><a href="#PpmsConnection-152"><span class="linenos"> 152</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="PpmsConnection-153"><a href="#PpmsConnection-153"><span class="linenos"> 153</span></a>            <span class="k">raise</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ConnectionError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="PpmsConnection-154"><a href="#PpmsConnection-154"><span class="linenos"> 154</span></a>
</span><span id="PpmsConnection-155"><a href="#PpmsConnection-155"><span class="linenos"> 155</span></a>        <span class="n">status_ok</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">codes</span><span class="o">.</span><span class="n">ok</span>  <span class="c1"># pylint: disable-msg=no-member</span>
</span><span id="PpmsConnection-156"><a href="#PpmsConnection-156"><span class="linenos"> 156</span></a>
</span><span id="PpmsConnection-157"><a href="#PpmsConnection-157"><span class="linenos"> 157</span></a>        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="n">status_ok</span><span class="p">:</span>
</span><span id="PpmsConnection-158"><a href="#PpmsConnection-158"><span class="linenos"> 158</span></a>            <span class="c1"># NOTE: branch excluded from coverage as we don&#39;t have a known way</span>
</span><span id="PpmsConnection-159"><a href="#PpmsConnection-159"><span class="linenos"> 159</span></a>            <span class="c1"># to produce such a response from the API</span>
</span><span id="PpmsConnection-160"><a href="#PpmsConnection-160"><span class="linenos"> 160</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="PpmsConnection-161"><a href="#PpmsConnection-161"><span class="linenos"> 161</span></a>                <span class="s2">&quot;Unexpected combination of response [</span><span class="si">{}</span><span class="s2">] and status code [</span><span class="si">{}</span><span class="s2">], it&#39;s &quot;</span>
</span><span id="PpmsConnection-162"><a href="#PpmsConnection-162"><span class="linenos"> 162</span></a>                <span class="s2">&quot;unclear if authentication succeeded (assuming it didn&#39;t)&quot;</span><span class="p">,</span>
</span><span id="PpmsConnection-163"><a href="#PpmsConnection-163"><span class="linenos"> 163</span></a>                <span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span>
</span><span id="PpmsConnection-164"><a href="#PpmsConnection-164"><span class="linenos"> 164</span></a>                <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">,</span>
</span><span id="PpmsConnection-165"><a href="#PpmsConnection-165"><span class="linenos"> 165</span></a>            <span class="p">)</span>
</span><span id="PpmsConnection-166"><a href="#PpmsConnection-166"><span class="linenos"> 166</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s2">&quot;auth_state&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;FAILED-UNKNOWN&quot;</span>
</span><span id="PpmsConnection-167"><a href="#PpmsConnection-167"><span class="linenos"> 167</span></a>
</span><span id="PpmsConnection-168"><a href="#PpmsConnection-168"><span class="linenos"> 168</span></a>            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="PpmsConnection-169"><a href="#PpmsConnection-169"><span class="linenos"> 169</span></a>                <span class="sa">f</span><span class="s2">&quot;Authenticating against </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="si">}</span><span class="s2"> with key &quot;</span>
</span><span id="PpmsConnection-170"><a href="#PpmsConnection-170"><span class="linenos"> 170</span></a>                <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">api_key</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">...</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">api_key</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span><span class="si">}</span><span class="s2">] FAILED!&quot;</span>
</span><span id="PpmsConnection-171"><a href="#PpmsConnection-171"><span class="linenos"> 171</span></a>            <span class="p">)</span>
</span><span id="PpmsConnection-172"><a href="#PpmsConnection-172"><span class="linenos"> 172</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="PpmsConnection-173"><a href="#PpmsConnection-173"><span class="linenos"> 173</span></a>            <span class="k">raise</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ConnectionError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="PpmsConnection-174"><a href="#PpmsConnection-174"><span class="linenos"> 174</span></a>
</span><span id="PpmsConnection-175"><a href="#PpmsConnection-175"><span class="linenos"> 175</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span>
</span><span id="PpmsConnection-176"><a href="#PpmsConnection-176"><span class="linenos"> 176</span></a>            <span class="s2">&quot;Authentication succeeded, response=[</span><span class="si">{}</span><span class="s2">], http_status=[</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="p">,</span>
</span><span id="PpmsConnection-177"><a href="#PpmsConnection-177"><span class="linenos"> 177</span></a>            <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">,</span>
</span><span id="PpmsConnection-178"><a href="#PpmsConnection-178"><span class="linenos"> 178</span></a>            <span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span>
</span><span id="PpmsConnection-179"><a href="#PpmsConnection-179"><span class="linenos"> 179</span></a>        <span class="p">)</span>
</span><span id="PpmsConnection-180"><a href="#PpmsConnection-180"><span class="linenos"> 180</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s2">&quot;auth_state&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;good&quot;</span>
</span><span id="PpmsConnection-181"><a href="#PpmsConnection-181"><span class="linenos"> 181</span></a>
</span><span id="PpmsConnection-182"><a href="#PpmsConnection-182"><span class="linenos"> 182</span></a>    <span class="k">def</span> <span class="nf">request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="p">{},</span> <span class="n">skip_cache</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="PpmsConnection-183"><a href="#PpmsConnection-183"><span class="linenos"> 183</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Generic method to submit a request to PPMS and return the result.</span>
</span><span id="PpmsConnection-184"><a href="#PpmsConnection-184"><span class="linenos"> 184</span></a>
</span><span id="PpmsConnection-185"><a href="#PpmsConnection-185"><span class="linenos"> 185</span></a><span class="sd">        This convenience method deals with adding the API key to a given</span>
</span><span id="PpmsConnection-186"><a href="#PpmsConnection-186"><span class="linenos"> 186</span></a><span class="sd">        request, submitting it to the PUMAPI and checking the response for some</span>
</span><span id="PpmsConnection-187"><a href="#PpmsConnection-187"><span class="linenos"> 187</span></a><span class="sd">        specific keywords indicating an error.</span>
</span><span id="PpmsConnection-188"><a href="#PpmsConnection-188"><span class="linenos"> 188</span></a>
</span><span id="PpmsConnection-189"><a href="#PpmsConnection-189"><span class="linenos"> 189</span></a><span class="sd">        Parameters</span>
</span><span id="PpmsConnection-190"><a href="#PpmsConnection-190"><span class="linenos"> 190</span></a><span class="sd">        ----------</span>
</span><span id="PpmsConnection-191"><a href="#PpmsConnection-191"><span class="linenos"> 191</span></a><span class="sd">        action : str</span>
</span><span id="PpmsConnection-192"><a href="#PpmsConnection-192"><span class="linenos"> 192</span></a><span class="sd">            The command to be submitted to the PUMAPI.</span>
</span><span id="PpmsConnection-193"><a href="#PpmsConnection-193"><span class="linenos"> 193</span></a><span class="sd">        parameters : dict, optional</span>
</span><span id="PpmsConnection-194"><a href="#PpmsConnection-194"><span class="linenos"> 194</span></a><span class="sd">            A dictionary with additional parameters to be submitted with the</span>
</span><span id="PpmsConnection-195"><a href="#PpmsConnection-195"><span class="linenos"> 195</span></a><span class="sd">            request.</span>
</span><span id="PpmsConnection-196"><a href="#PpmsConnection-196"><span class="linenos"> 196</span></a><span class="sd">        skip_cache : bool, optional</span>
</span><span id="PpmsConnection-197"><a href="#PpmsConnection-197"><span class="linenos"> 197</span></a><span class="sd">            If set to True the request will NOT be served from the local cache,</span>
</span><span id="PpmsConnection-198"><a href="#PpmsConnection-198"><span class="linenos"> 198</span></a><span class="sd">            independent whether a matching response file exists there, by</span>
</span><span id="PpmsConnection-199"><a href="#PpmsConnection-199"><span class="linenos"> 199</span></a><span class="sd">            default False.</span>
</span><span id="PpmsConnection-200"><a href="#PpmsConnection-200"><span class="linenos"> 200</span></a>
</span><span id="PpmsConnection-201"><a href="#PpmsConnection-201"><span class="linenos"> 201</span></a><span class="sd">        Returns</span>
</span><span id="PpmsConnection-202"><a href="#PpmsConnection-202"><span class="linenos"> 202</span></a><span class="sd">        -------</span>
</span><span id="PpmsConnection-203"><a href="#PpmsConnection-203"><span class="linenos"> 203</span></a><span class="sd">        requests.Response</span>
</span><span id="PpmsConnection-204"><a href="#PpmsConnection-204"><span class="linenos"> 204</span></a><span class="sd">            The response object created by posting the request.</span>
</span><span id="PpmsConnection-205"><a href="#PpmsConnection-205"><span class="linenos"> 205</span></a>
</span><span id="PpmsConnection-206"><a href="#PpmsConnection-206"><span class="linenos"> 206</span></a><span class="sd">        Raises</span>
</span><span id="PpmsConnection-207"><a href="#PpmsConnection-207"><span class="linenos"> 207</span></a><span class="sd">        ------</span>
</span><span id="PpmsConnection-208"><a href="#PpmsConnection-208"><span class="linenos"> 208</span></a><span class="sd">        requests.exceptions.ConnectionError</span>
</span><span id="PpmsConnection-209"><a href="#PpmsConnection-209"><span class="linenos"> 209</span></a><span class="sd">            Raised in case the request is not authorized.</span>
</span><span id="PpmsConnection-210"><a href="#PpmsConnection-210"><span class="linenos"> 210</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PpmsConnection-211"><a href="#PpmsConnection-211"><span class="linenos"> 211</span></a>        <span class="n">req_data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">action</span><span class="p">,</span> <span class="s2">&quot;apikey&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">api_key</span><span class="p">}</span>
</span><span id="PpmsConnection-212"><a href="#PpmsConnection-212"><span class="linenos"> 212</span></a>        <span class="n">req_data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span>
</span><span id="PpmsConnection-213"><a href="#PpmsConnection-213"><span class="linenos"> 213</span></a>        <span class="c1"># log.debug(&quot;Request parameters: {}&quot;, parameters)</span>
</span><span id="PpmsConnection-214"><a href="#PpmsConnection-214"><span class="linenos"> 214</span></a>
</span><span id="PpmsConnection-215"><a href="#PpmsConnection-215"><span class="linenos"> 215</span></a>        <span class="n">response</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="PpmsConnection-216"><a href="#PpmsConnection-216"><span class="linenos"> 216</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="PpmsConnection-217"><a href="#PpmsConnection-217"><span class="linenos"> 217</span></a>            <span class="k">if</span> <span class="n">skip_cache</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
</span><span id="PpmsConnection-218"><a href="#PpmsConnection-218"><span class="linenos"> 218</span></a>                <span class="k">raise</span> <span class="ne">LookupError</span><span class="p">(</span><span class="s2">&quot;Skipping the cache has been requested&quot;</span><span class="p">)</span>
</span><span id="PpmsConnection-219"><a href="#PpmsConnection-219"><span class="linenos"> 219</span></a>            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__intercept_read</span><span class="p">(</span><span class="n">req_data</span><span class="p">)</span>
</span><span id="PpmsConnection-220"><a href="#PpmsConnection-220"><span class="linenos"> 220</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">last_served_from_cache</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="PpmsConnection-221"><a href="#PpmsConnection-221"><span class="linenos"> 221</span></a>        <span class="k">except</span> <span class="ne">LookupError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
</span><span id="PpmsConnection-222"><a href="#PpmsConnection-222"><span class="linenos"> 222</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Doing an on-line request: </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="PpmsConnection-223"><a href="#PpmsConnection-223"><span class="linenos"> 223</span></a>            <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">req_data</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>
</span><span id="PpmsConnection-224"><a href="#PpmsConnection-224"><span class="linenos"> 224</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">last_served_from_cache</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="PpmsConnection-225"><a href="#PpmsConnection-225"><span class="linenos"> 225</span></a>
</span><span id="PpmsConnection-226"><a href="#PpmsConnection-226"><span class="linenos"> 226</span></a>        <span class="c1"># store the response if it hasn&#39;t been read from the cache before:</span>
</span><span id="PpmsConnection-227"><a href="#PpmsConnection-227"><span class="linenos"> 227</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_served_from_cache</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
</span><span id="PpmsConnection-228"><a href="#PpmsConnection-228"><span class="linenos"> 228</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">__intercept_store</span><span class="p">(</span><span class="n">req_data</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>
</span><span id="PpmsConnection-229"><a href="#PpmsConnection-229"><span class="linenos"> 229</span></a>
</span><span id="PpmsConnection-230"><a href="#PpmsConnection-230"><span class="linenos"> 230</span></a>        <span class="c1"># NOTE: the HTTP status code returned is always `200` even if</span>
</span><span id="PpmsConnection-231"><a href="#PpmsConnection-231"><span class="linenos"> 231</span></a>        <span class="c1"># authentication failed, so we need to check the actual response *TEXT*</span>
</span><span id="PpmsConnection-232"><a href="#PpmsConnection-232"><span class="linenos"> 232</span></a>        <span class="c1"># to figure out if we have succeeded:</span>
</span><span id="PpmsConnection-233"><a href="#PpmsConnection-233"><span class="linenos"> 233</span></a>        <span class="k">if</span> <span class="s2">&quot;request not authorized&quot;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
</span><span id="PpmsConnection-234"><a href="#PpmsConnection-234"><span class="linenos"> 234</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s2">&quot;auth_state&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;FAILED&quot;</span>
</span><span id="PpmsConnection-235"><a href="#PpmsConnection-235"><span class="linenos"> 235</span></a>            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Not authorized to run action `</span><span class="si">{</span><span class="n">req_data</span><span class="p">[</span><span class="s1">&#39;action&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">`&quot;</span>
</span><span id="PpmsConnection-236"><a href="#PpmsConnection-236"><span class="linenos"> 236</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="PpmsConnection-237"><a href="#PpmsConnection-237"><span class="linenos"> 237</span></a>            <span class="k">raise</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ConnectionError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="PpmsConnection-238"><a href="#PpmsConnection-238"><span class="linenos"> 238</span></a>
</span><span id="PpmsConnection-239"><a href="#PpmsConnection-239"><span class="linenos"> 239</span></a>        <span class="k">return</span> <span class="n">response</span>
</span><span id="PpmsConnection-240"><a href="#PpmsConnection-240"><span class="linenos"> 240</span></a>
</span><span id="PpmsConnection-241"><a href="#PpmsConnection-241"><span class="linenos"> 241</span></a>    <span class="k">def</span> <span class="nf">__interception_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req_data</span><span class="p">,</span> <span class="n">create_dir</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="PpmsConnection-242"><a href="#PpmsConnection-242"><span class="linenos"> 242</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Derive the path for a local cache file from a request&#39;s parameters.</span>
</span><span id="PpmsConnection-243"><a href="#PpmsConnection-243"><span class="linenos"> 243</span></a>
</span><span id="PpmsConnection-244"><a href="#PpmsConnection-244"><span class="linenos"> 244</span></a><span class="sd">        Parameters</span>
</span><span id="PpmsConnection-245"><a href="#PpmsConnection-245"><span class="linenos"> 245</span></a><span class="sd">        ----------</span>
</span><span id="PpmsConnection-246"><a href="#PpmsConnection-246"><span class="linenos"> 246</span></a><span class="sd">        req_data : dict</span>
</span><span id="PpmsConnection-247"><a href="#PpmsConnection-247"><span class="linenos"> 247</span></a><span class="sd">            The request&#39;s parameters, used to derive the name of the cache file.</span>
</span><span id="PpmsConnection-248"><a href="#PpmsConnection-248"><span class="linenos"> 248</span></a><span class="sd">        create_dir : bool, optional</span>
</span><span id="PpmsConnection-249"><a href="#PpmsConnection-249"><span class="linenos"> 249</span></a><span class="sd">            If set to True the cache directory will be created if necessary.</span>
</span><span id="PpmsConnection-250"><a href="#PpmsConnection-250"><span class="linenos"> 250</span></a><span class="sd">            Useful when adding responses to the cache. By default False.</span>
</span><span id="PpmsConnection-251"><a href="#PpmsConnection-251"><span class="linenos"> 251</span></a>
</span><span id="PpmsConnection-252"><a href="#PpmsConnection-252"><span class="linenos"> 252</span></a><span class="sd">        Returns</span>
</span><span id="PpmsConnection-253"><a href="#PpmsConnection-253"><span class="linenos"> 253</span></a><span class="sd">        -------</span>
</span><span id="PpmsConnection-254"><a href="#PpmsConnection-254"><span class="linenos"> 254</span></a><span class="sd">        str</span>
</span><span id="PpmsConnection-255"><a href="#PpmsConnection-255"><span class="linenos"> 255</span></a><span class="sd">            The full path to a file name identified by all parameters of the</span>
</span><span id="PpmsConnection-256"><a href="#PpmsConnection-256"><span class="linenos"> 256</span></a><span class="sd">            request (except credentials like &#39;apikey&#39;).</span>
</span><span id="PpmsConnection-257"><a href="#PpmsConnection-257"><span class="linenos"> 257</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PpmsConnection-258"><a href="#PpmsConnection-258"><span class="linenos"> 258</span></a>        <span class="n">action</span> <span class="o">=</span> <span class="n">req_data</span><span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">]</span>
</span><span id="PpmsConnection-259"><a href="#PpmsConnection-259"><span class="linenos"> 259</span></a>
</span><span id="PpmsConnection-260"><a href="#PpmsConnection-260"><span class="linenos"> 260</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_users_only</span> <span class="ow">and</span> <span class="n">action</span> <span class="o">!=</span> <span class="s2">&quot;getuser&quot;</span><span class="p">:</span>
</span><span id="PpmsConnection-261"><a href="#PpmsConnection-261"><span class="linenos"> 261</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;NOT caching &#39;</span><span class="si">{</span><span class="n">action</span><span class="si">}</span><span class="s2">&#39; (cache_users_only is set)&quot;</span><span class="p">)</span>
</span><span id="PpmsConnection-262"><a href="#PpmsConnection-262"><span class="linenos"> 262</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="PpmsConnection-263"><a href="#PpmsConnection-263"><span class="linenos"> 263</span></a>
</span><span id="PpmsConnection-264"><a href="#PpmsConnection-264"><span class="linenos"> 264</span></a>        <span class="n">intercept_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_path</span><span class="p">,</span> <span class="n">action</span><span class="p">)</span>
</span><span id="PpmsConnection-265"><a href="#PpmsConnection-265"><span class="linenos"> 265</span></a>        <span class="k">if</span> <span class="n">create_dir</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">intercept_dir</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
</span><span id="PpmsConnection-266"><a href="#PpmsConnection-266"><span class="linenos"> 266</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="PpmsConnection-267"><a href="#PpmsConnection-267"><span class="linenos"> 267</span></a>                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">intercept_dir</span><span class="p">)</span>
</span><span id="PpmsConnection-268"><a href="#PpmsConnection-268"><span class="linenos"> 268</span></a>                <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Created dir to store response: </span><span class="si">{</span><span class="n">intercept_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="PpmsConnection-269"><a href="#PpmsConnection-269"><span class="linenos"> 269</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>  <span class="c1"># pylint: disable-msg=broad-except</span>
</span><span id="PpmsConnection-270"><a href="#PpmsConnection-270"><span class="linenos"> 270</span></a>                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed creating [</span><span class="si">{</span><span class="n">intercept_dir</span><span class="si">}</span><span class="s2">]: </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="PpmsConnection-271"><a href="#PpmsConnection-271"><span class="linenos"> 271</span></a>                <span class="k">return</span> <span class="kc">None</span>
</span><span id="PpmsConnection-272"><a href="#PpmsConnection-272"><span class="linenos"> 272</span></a>
</span><span id="PpmsConnection-273"><a href="#PpmsConnection-273"><span class="linenos"> 273</span></a>        <span class="n">signature</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="PpmsConnection-274"><a href="#PpmsConnection-274"><span class="linenos"> 274</span></a>        <span class="c1"># different python versions are returning dict items in different order, so</span>
</span><span id="PpmsConnection-275"><a href="#PpmsConnection-275"><span class="linenos"> 275</span></a>        <span class="c1"># simply iterating over them will not always produce the same result - hence we</span>
</span><span id="PpmsConnection-276"><a href="#PpmsConnection-276"><span class="linenos"> 276</span></a>        <span class="c1"># build up a sorted list of keys first and use that one then:</span>
</span><span id="PpmsConnection-277"><a href="#PpmsConnection-277"><span class="linenos"> 277</span></a>        <span class="n">keylist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">req_data</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="PpmsConnection-278"><a href="#PpmsConnection-278"><span class="linenos"> 278</span></a>        <span class="n">keylist</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
</span><span id="PpmsConnection-279"><a href="#PpmsConnection-279"><span class="linenos"> 279</span></a>        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keylist</span><span class="p">:</span>
</span><span id="PpmsConnection-280"><a href="#PpmsConnection-280"><span class="linenos"> 280</span></a>            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">,</span> <span class="s2">&quot;apikey&quot;</span><span class="p">]:</span>
</span><span id="PpmsConnection-281"><a href="#PpmsConnection-281"><span class="linenos"> 281</span></a>                <span class="k">continue</span>
</span><span id="PpmsConnection-282"><a href="#PpmsConnection-282"><span class="linenos"> 282</span></a>            <span class="n">signature</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;__</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">--</span><span class="si">{</span><span class="n">req_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="PpmsConnection-283"><a href="#PpmsConnection-283"><span class="linenos"> 283</span></a>        <span class="k">if</span> <span class="n">signature</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
</span><span id="PpmsConnection-284"><a href="#PpmsConnection-284"><span class="linenos"> 284</span></a>            <span class="n">signature</span> <span class="o">=</span> <span class="s2">&quot;__response&quot;</span>
</span><span id="PpmsConnection-285"><a href="#PpmsConnection-285"><span class="linenos"> 285</span></a>        <span class="n">signature</span> <span class="o">=</span> <span class="n">signature</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span> <span class="o">+</span> <span class="s2">&quot;.txt&quot;</span>
</span><span id="PpmsConnection-286"><a href="#PpmsConnection-286"><span class="linenos"> 286</span></a>        <span class="n">intercept_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">intercept_dir</span><span class="p">,</span> <span class="n">signature</span><span class="p">)</span>
</span><span id="PpmsConnection-287"><a href="#PpmsConnection-287"><span class="linenos"> 287</span></a>        <span class="k">return</span> <span class="n">intercept_file</span>
</span><span id="PpmsConnection-288"><a href="#PpmsConnection-288"><span class="linenos"> 288</span></a>
</span><span id="PpmsConnection-289"><a href="#PpmsConnection-289"><span class="linenos"> 289</span></a>    <span class="k">def</span> <span class="nf">__intercept_read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req_data</span><span class="p">):</span>
</span><span id="PpmsConnection-290"><a href="#PpmsConnection-290"><span class="linenos"> 290</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Try to read a cached response from a local file.</span>
</span><span id="PpmsConnection-291"><a href="#PpmsConnection-291"><span class="linenos"> 291</span></a>
</span><span id="PpmsConnection-292"><a href="#PpmsConnection-292"><span class="linenos"> 292</span></a><span class="sd">        Parameters</span>
</span><span id="PpmsConnection-293"><a href="#PpmsConnection-293"><span class="linenos"> 293</span></a><span class="sd">        ----------</span>
</span><span id="PpmsConnection-294"><a href="#PpmsConnection-294"><span class="linenos"> 294</span></a><span class="sd">        req_data : dict</span>
</span><span id="PpmsConnection-295"><a href="#PpmsConnection-295"><span class="linenos"> 295</span></a><span class="sd">            The request&#39;s parameters, used to derive the name of the cache file.</span>
</span><span id="PpmsConnection-296"><a href="#PpmsConnection-296"><span class="linenos"> 296</span></a>
</span><span id="PpmsConnection-297"><a href="#PpmsConnection-297"><span class="linenos"> 297</span></a><span class="sd">        Returns</span>
</span><span id="PpmsConnection-298"><a href="#PpmsConnection-298"><span class="linenos"> 298</span></a><span class="sd">        -------</span>
</span><span id="PpmsConnection-299"><a href="#PpmsConnection-299"><span class="linenos"> 299</span></a><span class="sd">        PseudoResponse</span>
</span><span id="PpmsConnection-300"><a href="#PpmsConnection-300"><span class="linenos"> 300</span></a><span class="sd">            The response text read from the cache file wrapped in a</span>
</span><span id="PpmsConnection-301"><a href="#PpmsConnection-301"><span class="linenos"> 301</span></a><span class="sd">            PseudoResponse object, or None in case no matching file was found in</span>
</span><span id="PpmsConnection-302"><a href="#PpmsConnection-302"><span class="linenos"> 302</span></a><span class="sd">            the local cache.</span>
</span><span id="PpmsConnection-303"><a href="#PpmsConnection-303"><span class="linenos"> 303</span></a>
</span><span id="PpmsConnection-304"><a href="#PpmsConnection-304"><span class="linenos"> 304</span></a><span class="sd">        Raises</span>
</span><span id="PpmsConnection-305"><a href="#PpmsConnection-305"><span class="linenos"> 305</span></a><span class="sd">        ------</span>
</span><span id="PpmsConnection-306"><a href="#PpmsConnection-306"><span class="linenos"> 306</span></a><span class="sd">        LookupError</span>
</span><span id="PpmsConnection-307"><a href="#PpmsConnection-307"><span class="linenos"> 307</span></a><span class="sd">            Raised in case no cache path has been set or no cache file matching</span>
</span><span id="PpmsConnection-308"><a href="#PpmsConnection-308"><span class="linenos"> 308</span></a><span class="sd">            the request parameters could be found in the cache.</span>
</span><span id="PpmsConnection-309"><a href="#PpmsConnection-309"><span class="linenos"> 309</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PpmsConnection-310"><a href="#PpmsConnection-310"><span class="linenos"> 310</span></a>
</span><span id="PpmsConnection-311"><a href="#PpmsConnection-311"><span class="linenos"> 311</span></a>        <span class="c1"># pylint: disable-msg=too-few-public-methods</span>
</span><span id="PpmsConnection-312"><a href="#PpmsConnection-312"><span class="linenos"> 312</span></a>        <span class="k">class</span> <span class="nc">PseudoResponse</span><span class="p">:</span>
</span><span id="PpmsConnection-313"><a href="#PpmsConnection-313"><span class="linenos"> 313</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;Dummy response object with attribs &#39;text&#39; and &#39;status_code&#39;.&quot;&quot;&quot;</span>
</span><span id="PpmsConnection-314"><a href="#PpmsConnection-314"><span class="linenos"> 314</span></a>
</span><span id="PpmsConnection-315"><a href="#PpmsConnection-315"><span class="linenos"> 315</span></a>            <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">status_code</span><span class="p">):</span>
</span><span id="PpmsConnection-316"><a href="#PpmsConnection-316"><span class="linenos"> 316</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">text</span>
</span><span id="PpmsConnection-317"><a href="#PpmsConnection-317"><span class="linenos"> 317</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">status_code</span><span class="p">)</span>
</span><span id="PpmsConnection-318"><a href="#PpmsConnection-318"><span class="linenos"> 318</span></a>
</span><span id="PpmsConnection-319"><a href="#PpmsConnection-319"><span class="linenos"> 319</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_path</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
</span><span id="PpmsConnection-320"><a href="#PpmsConnection-320"><span class="linenos"> 320</span></a>            <span class="k">raise</span> <span class="ne">LookupError</span><span class="p">(</span><span class="s2">&quot;No cache path configured&quot;</span><span class="p">)</span>
</span><span id="PpmsConnection-321"><a href="#PpmsConnection-321"><span class="linenos"> 321</span></a>
</span><span id="PpmsConnection-322"><a href="#PpmsConnection-322"><span class="linenos"> 322</span></a>        <span class="n">intercept_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__interception_path</span><span class="p">(</span><span class="n">req_data</span><span class="p">,</span> <span class="n">create_dir</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="PpmsConnection-323"><a href="#PpmsConnection-323"><span class="linenos"> 323</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">intercept_file</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">intercept_file</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
</span><span id="PpmsConnection-324"><a href="#PpmsConnection-324"><span class="linenos"> 324</span></a>            <span class="k">raise</span> <span class="ne">LookupError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No cache hit for [</span><span class="si">{</span><span class="n">intercept_file</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
</span><span id="PpmsConnection-325"><a href="#PpmsConnection-325"><span class="linenos"> 325</span></a>
</span><span id="PpmsConnection-326"><a href="#PpmsConnection-326"><span class="linenos"> 326</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">intercept_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">infile</span><span class="p">:</span>
</span><span id="PpmsConnection-327"><a href="#PpmsConnection-327"><span class="linenos"> 327</span></a>            <span class="n">text</span> <span class="o">=</span> <span class="n">infile</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span><span id="PpmsConnection-328"><a href="#PpmsConnection-328"><span class="linenos"> 328</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
</span><span id="PpmsConnection-329"><a href="#PpmsConnection-329"><span class="linenos"> 329</span></a>            <span class="s2">&quot;Read intercepted response text from [</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="p">,</span>
</span><span id="PpmsConnection-330"><a href="#PpmsConnection-330"><span class="linenos"> 330</span></a>            <span class="n">intercept_file</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_path</span><span class="p">))</span> <span class="p">:],</span>
</span><span id="PpmsConnection-331"><a href="#PpmsConnection-331"><span class="linenos"> 331</span></a>        <span class="p">)</span>
</span><span id="PpmsConnection-332"><a href="#PpmsConnection-332"><span class="linenos"> 332</span></a>
</span><span id="PpmsConnection-333"><a href="#PpmsConnection-333"><span class="linenos"> 333</span></a>        <span class="n">status_code</span> <span class="o">=</span> <span class="mi">200</span>
</span><span id="PpmsConnection-334"><a href="#PpmsConnection-334"><span class="linenos"> 334</span></a>        <span class="n">status_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">intercept_file</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_status-code.txt&quot;</span>
</span><span id="PpmsConnection-335"><a href="#PpmsConnection-335"><span class="linenos"> 335</span></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">status_file</span><span class="p">):</span>
</span><span id="PpmsConnection-336"><a href="#PpmsConnection-336"><span class="linenos"> 336</span></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">status_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">infile</span><span class="p">:</span>
</span><span id="PpmsConnection-337"><a href="#PpmsConnection-337"><span class="linenos"> 337</span></a>                <span class="n">status_code</span> <span class="o">=</span> <span class="n">infile</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span><span id="PpmsConnection-338"><a href="#PpmsConnection-338"><span class="linenos"> 338</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Read intercepted response status code from [</span><span class="si">{</span><span class="n">status_file</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
</span><span id="PpmsConnection-339"><a href="#PpmsConnection-339"><span class="linenos"> 339</span></a>        <span class="k">return</span> <span class="n">PseudoResponse</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">status_code</span><span class="p">)</span>
</span><span id="PpmsConnection-340"><a href="#PpmsConnection-340"><span class="linenos"> 340</span></a>
</span><span id="PpmsConnection-341"><a href="#PpmsConnection-341"><span class="linenos"> 341</span></a>    <span class="k">def</span> <span class="nf">__intercept_store</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req_data</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
</span><span id="PpmsConnection-342"><a href="#PpmsConnection-342"><span class="linenos"> 342</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Store the response in a local cache file named after the request.</span>
</span><span id="PpmsConnection-343"><a href="#PpmsConnection-343"><span class="linenos"> 343</span></a>
</span><span id="PpmsConnection-344"><a href="#PpmsConnection-344"><span class="linenos"> 344</span></a><span class="sd">        Parameters</span>
</span><span id="PpmsConnection-345"><a href="#PpmsConnection-345"><span class="linenos"> 345</span></a><span class="sd">        ----------</span>
</span><span id="PpmsConnection-346"><a href="#PpmsConnection-346"><span class="linenos"> 346</span></a><span class="sd">        req_data : dict</span>
</span><span id="PpmsConnection-347"><a href="#PpmsConnection-347"><span class="linenos"> 347</span></a><span class="sd">            The request&#39;s parameters, used to derive the name of the cache file</span>
</span><span id="PpmsConnection-348"><a href="#PpmsConnection-348"><span class="linenos"> 348</span></a><span class="sd">            so it can be matched later when running the same request again.</span>
</span><span id="PpmsConnection-349"><a href="#PpmsConnection-349"><span class="linenos"> 349</span></a><span class="sd">        response : requests.Response</span>
</span><span id="PpmsConnection-350"><a href="#PpmsConnection-350"><span class="linenos"> 350</span></a><span class="sd">            The response object to store in the local cache.</span>
</span><span id="PpmsConnection-351"><a href="#PpmsConnection-351"><span class="linenos"> 351</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PpmsConnection-352"><a href="#PpmsConnection-352"><span class="linenos"> 352</span></a>        <span class="c1"># NOTE: this method is excluded from coverage measurements as it can only be</span>
</span><span id="PpmsConnection-353"><a href="#PpmsConnection-353"><span class="linenos"> 353</span></a>        <span class="c1"># triggered when testing in online mode with at least one request not being</span>
</span><span id="PpmsConnection-354"><a href="#PpmsConnection-354"><span class="linenos"> 354</span></a>        <span class="c1"># served from the cache (which is orthogonal to off-line testing)</span>
</span><span id="PpmsConnection-355"><a href="#PpmsConnection-355"><span class="linenos"> 355</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_path</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
</span><span id="PpmsConnection-356"><a href="#PpmsConnection-356"><span class="linenos"> 356</span></a>            <span class="k">return</span>
</span><span id="PpmsConnection-357"><a href="#PpmsConnection-357"><span class="linenos"> 357</span></a>
</span><span id="PpmsConnection-358"><a href="#PpmsConnection-358"><span class="linenos"> 358</span></a>        <span class="n">intercept_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__interception_path</span><span class="p">(</span><span class="n">req_data</span><span class="p">,</span> <span class="n">create_dir</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PpmsConnection-359"><a href="#PpmsConnection-359"><span class="linenos"> 359</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">intercept_file</span><span class="p">:</span>
</span><span id="PpmsConnection-360"><a href="#PpmsConnection-360"><span class="linenos"> 360</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s2">&quot;Not storing intercepted results in cache.&quot;</span><span class="p">)</span>
</span><span id="PpmsConnection-361"><a href="#PpmsConnection-361"><span class="linenos"> 361</span></a>            <span class="k">return</span>
</span><span id="PpmsConnection-362"><a href="#PpmsConnection-362"><span class="linenos"> 362</span></a>
</span><span id="PpmsConnection-363"><a href="#PpmsConnection-363"><span class="linenos"> 363</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="PpmsConnection-364"><a href="#PpmsConnection-364"><span class="linenos"> 364</span></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">intercept_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outfile</span><span class="p">:</span>
</span><span id="PpmsConnection-365"><a href="#PpmsConnection-365"><span class="linenos"> 365</span></a>                <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</span><span id="PpmsConnection-366"><a href="#PpmsConnection-366"><span class="linenos"> 366</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
</span><span id="PpmsConnection-367"><a href="#PpmsConnection-367"><span class="linenos"> 367</span></a>                <span class="s2">&quot;Wrote response text to [</span><span class="si">{}</span><span class="s2">] (</span><span class="si">{}</span><span class="s2"> lines)&quot;</span><span class="p">,</span>
</span><span id="PpmsConnection-368"><a href="#PpmsConnection-368"><span class="linenos"> 368</span></a>                <span class="n">intercept_file</span><span class="p">,</span>
</span><span id="PpmsConnection-369"><a href="#PpmsConnection-369"><span class="linenos"> 369</span></a>                <span class="nb">len</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()),</span>
</span><span id="PpmsConnection-370"><a href="#PpmsConnection-370"><span class="linenos"> 370</span></a>            <span class="p">)</span>
</span><span id="PpmsConnection-371"><a href="#PpmsConnection-371"><span class="linenos"> 371</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>  <span class="c1"># pylint: disable-msg=broad-except</span>
</span><span id="PpmsConnection-372"><a href="#PpmsConnection-372"><span class="linenos"> 372</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Storing response text in [</span><span class="si">{}</span><span class="s2">] failed: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">intercept_file</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
</span><span id="PpmsConnection-373"><a href="#PpmsConnection-373"><span class="linenos"> 373</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Response text was:</span><span class="se">\n</span><span class="s2">--------</span><span class="se">\n</span><span class="si">{}</span><span class="se">\n</span><span class="s2">--------&quot;</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</span><span id="PpmsConnection-374"><a href="#PpmsConnection-374"><span class="linenos"> 374</span></a>
</span><span id="PpmsConnection-375"><a href="#PpmsConnection-375"><span class="linenos"> 375</span></a>    <span class="k">def</span> <span class="nf">flush_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keep_users</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="PpmsConnection-376"><a href="#PpmsConnection-376"><span class="linenos"> 376</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Flush the PyPPMS on-disk cache.</span>
</span><span id="PpmsConnection-377"><a href="#PpmsConnection-377"><span class="linenos"> 377</span></a>
</span><span id="PpmsConnection-378"><a href="#PpmsConnection-378"><span class="linenos"> 378</span></a><span class="sd">        Optionally flushes everything *except* the `getuser` cache if the</span>
</span><span id="PpmsConnection-379"><a href="#PpmsConnection-379"><span class="linenos"> 379</span></a><span class="sd">        `keep_users` flag is set to `True`, as this is clearly the most</span>
</span><span id="PpmsConnection-380"><a href="#PpmsConnection-380"><span class="linenos"> 380</span></a><span class="sd">        time-consuming operation when fetching data from PUMAPI and therefore</span>
</span><span id="PpmsConnection-381"><a href="#PpmsConnection-381"><span class="linenos"> 381</span></a><span class="sd">        might want to be retained.</span>
</span><span id="PpmsConnection-382"><a href="#PpmsConnection-382"><span class="linenos"> 382</span></a>
</span><span id="PpmsConnection-383"><a href="#PpmsConnection-383"><span class="linenos"> 383</span></a><span class="sd">        Please note that the `getusers` cache (plural, including the `s` suffix)</span>
</span><span id="PpmsConnection-384"><a href="#PpmsConnection-384"><span class="linenos"> 384</span></a><span class="sd">        will be flushed no matter what, as this is simply a list of user IDs</span>
</span><span id="PpmsConnection-385"><a href="#PpmsConnection-385"><span class="linenos"> 385</span></a><span class="sd">        that can be fetched with a single request. In consequence this means</span>
</span><span id="PpmsConnection-386"><a href="#PpmsConnection-386"><span class="linenos"> 386</span></a><span class="sd">        that using the `keep_users` flag will allow you to have reasonably fast</span>
</span><span id="PpmsConnection-387"><a href="#PpmsConnection-387"><span class="linenos"> 387</span></a><span class="sd">        reaction times while still getting information on *new* users live from</span>
</span><span id="PpmsConnection-388"><a href="#PpmsConnection-388"><span class="linenos"> 388</span></a><span class="sd">        PUMAPI at the only cost of possibly having outdated information on</span>
</span><span id="PpmsConnection-389"><a href="#PpmsConnection-389"><span class="linenos"> 389</span></a><span class="sd">        *existing* users.</span>
</span><span id="PpmsConnection-390"><a href="#PpmsConnection-390"><span class="linenos"> 390</span></a>
</span><span id="PpmsConnection-391"><a href="#PpmsConnection-391"><span class="linenos"> 391</span></a><span class="sd">        Parameters</span>
</span><span id="PpmsConnection-392"><a href="#PpmsConnection-392"><span class="linenos"> 392</span></a><span class="sd">        ----------</span>
</span><span id="PpmsConnection-393"><a href="#PpmsConnection-393"><span class="linenos"> 393</span></a><span class="sd">        keep_users : bool, optional</span>
</span><span id="PpmsConnection-394"><a href="#PpmsConnection-394"><span class="linenos"> 394</span></a><span class="sd">            If set to `True` the `getuser` sub-directory in the cache location</span>
</span><span id="PpmsConnection-395"><a href="#PpmsConnection-395"><span class="linenos"> 395</span></a><span class="sd">            will be kept, by default `False`.</span>
</span><span id="PpmsConnection-396"><a href="#PpmsConnection-396"><span class="linenos"> 396</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PpmsConnection-397"><a href="#PpmsConnection-397"><span class="linenos"> 397</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_path</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
</span><span id="PpmsConnection-398"><a href="#PpmsConnection-398"><span class="linenos"> 398</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;No cache path configured, not flushing!&quot;</span><span class="p">)</span>
</span><span id="PpmsConnection-399"><a href="#PpmsConnection-399"><span class="linenos"> 399</span></a>            <span class="k">return</span>
</span><span id="PpmsConnection-400"><a href="#PpmsConnection-400"><span class="linenos"> 400</span></a>
</span><span id="PpmsConnection-401"><a href="#PpmsConnection-401"><span class="linenos"> 401</span></a>        <span class="n">dirs_to_remove</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_path</span><span class="p">]</span>  <span class="c1"># by default remove the entire cache dir</span>
</span><span id="PpmsConnection-402"><a href="#PpmsConnection-402"><span class="linenos"> 402</span></a>        <span class="n">keep_msg</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="PpmsConnection-403"><a href="#PpmsConnection-403"><span class="linenos"> 403</span></a>        <span class="k">if</span> <span class="n">keep_users</span><span class="p">:</span>
</span><span id="PpmsConnection-404"><a href="#PpmsConnection-404"><span class="linenos"> 404</span></a>            <span class="n">keep_msg</span> <span class="o">=</span> <span class="s2">&quot; (keeping user details dirs)&quot;</span>
</span><span id="PpmsConnection-405"><a href="#PpmsConnection-405"><span class="linenos"> 405</span></a>            <span class="n">dirs_to_remove</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="PpmsConnection-406"><a href="#PpmsConnection-406"><span class="linenos"> 406</span></a>            <span class="n">cache_dirs</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_path</span><span class="p">)</span>
</span><span id="PpmsConnection-407"><a href="#PpmsConnection-407"><span class="linenos"> 407</span></a>            <span class="k">for</span> <span class="n">subdir</span> <span class="ow">in</span> <span class="n">cache_dirs</span><span class="p">:</span>
</span><span id="PpmsConnection-408"><a href="#PpmsConnection-408"><span class="linenos"> 408</span></a>                <span class="k">if</span> <span class="n">subdir</span> <span class="o">==</span> <span class="s2">&quot;getuser&quot;</span><span class="p">:</span>
</span><span id="PpmsConnection-409"><a href="#PpmsConnection-409"><span class="linenos"> 409</span></a>                    <span class="k">continue</span>
</span><span id="PpmsConnection-410"><a href="#PpmsConnection-410"><span class="linenos"> 410</span></a>                <span class="n">dirs_to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_path</span><span class="p">,</span> <span class="n">subdir</span><span class="p">))</span>
</span><span id="PpmsConnection-411"><a href="#PpmsConnection-411"><span class="linenos"> 411</span></a>
</span><span id="PpmsConnection-412"><a href="#PpmsConnection-412"><span class="linenos"> 412</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Flushing the on-disk cache at [</span><span class="si">{}</span><span class="s2">] </span><span class="si">{}</span><span class="s2">...&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_path</span><span class="p">,</span> <span class="n">keep_msg</span><span class="p">)</span>
</span><span id="PpmsConnection-413"><a href="#PpmsConnection-413"><span class="linenos"> 413</span></a>        <span class="k">for</span> <span class="n">directory</span> <span class="ow">in</span> <span class="n">dirs_to_remove</span><span class="p">:</span>
</span><span id="PpmsConnection-414"><a href="#PpmsConnection-414"><span class="linenos"> 414</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="PpmsConnection-415"><a href="#PpmsConnection-415"><span class="linenos"> 415</span></a>                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
</span><span id="PpmsConnection-416"><a href="#PpmsConnection-416"><span class="linenos"> 416</span></a>                <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s2">&quot;Removed directory [</span><span class="si">{}</span><span class="s2">].&quot;</span><span class="p">,</span> <span class="n">directory</span><span class="p">)</span>
</span><span id="PpmsConnection-417"><a href="#PpmsConnection-417"><span class="linenos"> 417</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>  <span class="c1"># pylint: disable-msg=broad-except</span>
</span><span id="PpmsConnection-418"><a href="#PpmsConnection-418"><span class="linenos"> 418</span></a>                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Removing the cache at [</span><span class="si">{}</span><span class="s2">] failed: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">directory</span><span class="p">,</span> <span class="n">ex</span><span class="p">)</span>
</span><span id="PpmsConnection-419"><a href="#PpmsConnection-419"><span class="linenos"> 419</span></a>
</span><span id="PpmsConnection-420"><a href="#PpmsConnection-420"><span class="linenos"> 420</span></a>    <span class="k">def</span> <span class="nf">get_admins</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="PpmsConnection-421"><a href="#PpmsConnection-421"><span class="linenos"> 421</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get all PPMS administrator users.</span>
</span><span id="PpmsConnection-422"><a href="#PpmsConnection-422"><span class="linenos"> 422</span></a>
</span><span id="PpmsConnection-423"><a href="#PpmsConnection-423"><span class="linenos"> 423</span></a><span class="sd">        Returns</span>
</span><span id="PpmsConnection-424"><a href="#PpmsConnection-424"><span class="linenos"> 424</span></a><span class="sd">        -------</span>
</span><span id="PpmsConnection-425"><a href="#PpmsConnection-425"><span class="linenos"> 425</span></a><span class="sd">        list(pyppms.user.PpmsUser)</span>
</span><span id="PpmsConnection-426"><a href="#PpmsConnection-426"><span class="linenos"> 426</span></a><span class="sd">            A list with PpmsUser objects that are PPMS administrators.</span>
</span><span id="PpmsConnection-427"><a href="#PpmsConnection-427"><span class="linenos"> 427</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PpmsConnection-428"><a href="#PpmsConnection-428"><span class="linenos"> 428</span></a>        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;getadmins&quot;</span><span class="p">)</span>
</span><span id="PpmsConnection-429"><a href="#PpmsConnection-429"><span class="linenos"> 429</span></a>
</span><span id="PpmsConnection-430"><a href="#PpmsConnection-430"><span class="linenos"> 430</span></a>        <span class="n">admins</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
</span><span id="PpmsConnection-431"><a href="#PpmsConnection-431"><span class="linenos"> 431</span></a>        <span class="n">users</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="PpmsConnection-432"><a href="#PpmsConnection-432"><span class="linenos"> 432</span></a>        <span class="k">for</span> <span class="n">username</span> <span class="ow">in</span> <span class="n">admins</span><span class="p">:</span>
</span><span id="PpmsConnection-433"><a href="#PpmsConnection-433"><span class="linenos"> 433</span></a>            <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
</span><span id="PpmsConnection-434"><a href="#PpmsConnection-434"><span class="linenos"> 434</span></a>            <span class="n">users</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</span><span id="PpmsConnection-435"><a href="#PpmsConnection-435"><span class="linenos"> 435</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> admins in the PPMS database: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">admins</span><span class="p">),</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">admins</span><span class="p">))</span>
</span><span id="PpmsConnection-436"><a href="#PpmsConnection-436"><span class="linenos"> 436</span></a>        <span class="k">return</span> <span class="n">users</span>
</span><span id="PpmsConnection-437"><a href="#PpmsConnection-437"><span class="linenos"> 437</span></a>
</span><span id="PpmsConnection-438"><a href="#PpmsConnection-438"><span class="linenos"> 438</span></a>    <span class="k">def</span> <span class="nf">get_booking</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">system_id</span><span class="p">,</span> <span class="n">booking_type</span><span class="o">=</span><span class="s2">&quot;get&quot;</span><span class="p">):</span>
</span><span id="PpmsConnection-439"><a href="#PpmsConnection-439"><span class="linenos"> 439</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the current or next booking of a system.</span>
</span><span id="PpmsConnection-440"><a href="#PpmsConnection-440"><span class="linenos"> 440</span></a>
</span><span id="PpmsConnection-441"><a href="#PpmsConnection-441"><span class="linenos"> 441</span></a><span class="sd">        WARNING: if the next booking is requested but it is too far in the future,</span>
</span><span id="PpmsConnection-442"><a href="#PpmsConnection-442"><span class="linenos"> 442</span></a><span class="sd">        PUMAPI silently ignores it - the response is identical to a system that has no</span>
</span><span id="PpmsConnection-443"><a href="#PpmsConnection-443"><span class="linenos"> 443</span></a><span class="sd">        future bookings and there is no error reported either. Currently it is unclear</span>
</span><span id="PpmsConnection-444"><a href="#PpmsConnection-444"><span class="linenos"> 444</span></a><span class="sd">        where the cutoff is (e.g. lookups for a booking that is two years from now still</span>
</span><span id="PpmsConnection-445"><a href="#PpmsConnection-445"><span class="linenos"> 445</span></a><span class="sd">        work fine, but a booking in about 10 years is silently skipped).</span>
</span><span id="PpmsConnection-446"><a href="#PpmsConnection-446"><span class="linenos"> 446</span></a>
</span><span id="PpmsConnection-447"><a href="#PpmsConnection-447"><span class="linenos"> 447</span></a><span class="sd">        Parameters</span>
</span><span id="PpmsConnection-448"><a href="#PpmsConnection-448"><span class="linenos"> 448</span></a><span class="sd">        ----------</span>
</span><span id="PpmsConnection-449"><a href="#PpmsConnection-449"><span class="linenos"> 449</span></a><span class="sd">        system_id : int or int-like</span>
</span><span id="PpmsConnection-450"><a href="#PpmsConnection-450"><span class="linenos"> 450</span></a><span class="sd">            The ID of the system in PPMS.</span>
</span><span id="PpmsConnection-451"><a href="#PpmsConnection-451"><span class="linenos"> 451</span></a><span class="sd">        booking_type : {&#39;get&#39;, &#39;next&#39;}, optional</span>
</span><span id="PpmsConnection-452"><a href="#PpmsConnection-452"><span class="linenos"> 452</span></a><span class="sd">            The type of booking to request, one of `get` (requesting the</span>
</span><span id="PpmsConnection-453"><a href="#PpmsConnection-453"><span class="linenos"> 453</span></a><span class="sd">            currently running booking) and `next` (requesting the next upcoming</span>
</span><span id="PpmsConnection-454"><a href="#PpmsConnection-454"><span class="linenos"> 454</span></a><span class="sd">            booking), by default `get`.</span>
</span><span id="PpmsConnection-455"><a href="#PpmsConnection-455"><span class="linenos"> 455</span></a><span class="sd">            NOTE: if `next` is requested the resulting booking object will **NOT** have</span>
</span><span id="PpmsConnection-456"><a href="#PpmsConnection-456"><span class="linenos"> 456</span></a><span class="sd">            an end time (`endtime` will be `None`) as PUMAPI doesn&#39;t provide one in that</span>
</span><span id="PpmsConnection-457"><a href="#PpmsConnection-457"><span class="linenos"> 457</span></a><span class="sd">            case!</span>
</span><span id="PpmsConnection-458"><a href="#PpmsConnection-458"><span class="linenos"> 458</span></a>
</span><span id="PpmsConnection-459"><a href="#PpmsConnection-459"><span class="linenos"> 459</span></a><span class="sd">        Returns</span>
</span><span id="PpmsConnection-460"><a href="#PpmsConnection-460"><span class="linenos"> 460</span></a><span class="sd">        -------</span>
</span><span id="PpmsConnection-461"><a href="#PpmsConnection-461"><span class="linenos"> 461</span></a><span class="sd">        pyppms.booking.PpmsBooking or None</span>
</span><span id="PpmsConnection-462"><a href="#PpmsConnection-462"><span class="linenos"> 462</span></a><span class="sd">            The booking object, or None if there is no booking for the system or the</span>
</span><span id="PpmsConnection-463"><a href="#PpmsConnection-463"><span class="linenos"> 463</span></a><span class="sd">            request is refused by PUMAPI (e.g. &quot;not authorized&quot;).</span>
</span><span id="PpmsConnection-464"><a href="#PpmsConnection-464"><span class="linenos"> 464</span></a>
</span><span id="PpmsConnection-465"><a href="#PpmsConnection-465"><span class="linenos"> 465</span></a><span class="sd">        Raises</span>
</span><span id="PpmsConnection-466"><a href="#PpmsConnection-466"><span class="linenos"> 466</span></a><span class="sd">        ------</span>
</span><span id="PpmsConnection-467"><a href="#PpmsConnection-467"><span class="linenos"> 467</span></a><span class="sd">        ValueError</span>
</span><span id="PpmsConnection-468"><a href="#PpmsConnection-468"><span class="linenos"> 468</span></a><span class="sd">            Raised if the specified `booking_type` is invalid.</span>
</span><span id="PpmsConnection-469"><a href="#PpmsConnection-469"><span class="linenos"> 469</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PpmsConnection-470"><a href="#PpmsConnection-470"><span class="linenos"> 470</span></a>        <span class="n">valid</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;get&quot;</span><span class="p">,</span> <span class="s2">&quot;next&quot;</span><span class="p">]</span>
</span><span id="PpmsConnection-471"><a href="#PpmsConnection-471"><span class="linenos"> 471</span></a>        <span class="k">if</span> <span class="n">booking_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid</span><span class="p">:</span>
</span><span id="PpmsConnection-472"><a href="#PpmsConnection-472"><span class="linenos"> 472</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="PpmsConnection-473"><a href="#PpmsConnection-473"><span class="linenos"> 473</span></a>                <span class="sa">f</span><span class="s2">&quot;Value for &#39;booking_type&#39; (</span><span class="si">{</span><span class="n">booking_type</span><span class="si">}</span><span class="s2">) not in </span><span class="si">{</span><span class="n">valid</span><span class="si">}</span><span class="s2">!&quot;</span>
</span><span id="PpmsConnection-474"><a href="#PpmsConnection-474"><span class="linenos"> 474</span></a>            <span class="p">)</span>
</span><span id="PpmsConnection-475"><a href="#PpmsConnection-475"><span class="linenos"> 475</span></a>
</span><span id="PpmsConnection-476"><a href="#PpmsConnection-476"><span class="linenos"> 476</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="PpmsConnection-477"><a href="#PpmsConnection-477"><span class="linenos"> 477</span></a>            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">booking_type</span> <span class="o">+</span> <span class="s2">&quot;booking&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">system_id</span><span class="p">})</span>
</span><span id="PpmsConnection-478"><a href="#PpmsConnection-478"><span class="linenos"> 478</span></a>        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ConnectionError</span><span class="p">:</span>
</span><span id="PpmsConnection-479"><a href="#PpmsConnection-479"><span class="linenos"> 479</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Requesting booking status for system </span><span class="si">{}</span><span class="s2"> failed!&quot;</span><span class="p">,</span> <span class="n">system_id</span><span class="p">)</span>
</span><span id="PpmsConnection-480"><a href="#PpmsConnection-480"><span class="linenos"> 480</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="PpmsConnection-481"><a href="#PpmsConnection-481"><span class="linenos"> 481</span></a>
</span><span id="PpmsConnection-482"><a href="#PpmsConnection-482"><span class="linenos"> 482</span></a>        <span class="n">desc</span> <span class="o">=</span> <span class="s2">&quot;any future bookings&quot;</span>
</span><span id="PpmsConnection-483"><a href="#PpmsConnection-483"><span class="linenos"> 483</span></a>        <span class="k">if</span> <span class="n">booking_type</span> <span class="o">==</span> <span class="s2">&quot;get&quot;</span><span class="p">:</span>
</span><span id="PpmsConnection-484"><a href="#PpmsConnection-484"><span class="linenos"> 484</span></a>            <span class="n">desc</span> <span class="o">=</span> <span class="s2">&quot;a currently active booking&quot;</span>
</span><span id="PpmsConnection-485"><a href="#PpmsConnection-485"><span class="linenos"> 485</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
</span><span id="PpmsConnection-486"><a href="#PpmsConnection-486"><span class="linenos"> 486</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s2">&quot;System [</span><span class="si">{}</span><span class="s2">] doesn&#39;t have </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">system_id</span><span class="p">,</span> <span class="n">desc</span><span class="p">)</span>
</span><span id="PpmsConnection-487"><a href="#PpmsConnection-487"><span class="linenos"> 487</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="PpmsConnection-488"><a href="#PpmsConnection-488"><span class="linenos"> 488</span></a>
</span><span id="PpmsConnection-489"><a href="#PpmsConnection-489"><span class="linenos"> 489</span></a>        <span class="k">return</span> <span class="n">PpmsBooking</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">booking_type</span><span class="p">,</span> <span class="n">system_id</span><span class="p">)</span>
</span><span id="PpmsConnection-490"><a href="#PpmsConnection-490"><span class="linenos"> 490</span></a>
</span><span id="PpmsConnection-491"><a href="#PpmsConnection-491"><span class="linenos"> 491</span></a>    <span class="k">def</span> <span class="nf">get_current_booking</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">system_id</span><span class="p">):</span>
</span><span id="PpmsConnection-492"><a href="#PpmsConnection-492"><span class="linenos"> 492</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Wrapper for `get_booking()` with &#39;booking_type&#39; set to &#39;get&#39;.&quot;&quot;&quot;</span>
</span><span id="PpmsConnection-493"><a href="#PpmsConnection-493"><span class="linenos"> 493</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_booking</span><span class="p">(</span><span class="n">system_id</span><span class="p">,</span> <span class="s2">&quot;get&quot;</span><span class="p">)</span>
</span><span id="PpmsConnection-494"><a href="#PpmsConnection-494"><span class="linenos"> 494</span></a>
</span><span id="PpmsConnection-495"><a href="#PpmsConnection-495"><span class="linenos"> 495</span></a>    <span class="k">def</span> <span class="nf">get_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group_id</span><span class="p">):</span>
</span><span id="PpmsConnection-496"><a href="#PpmsConnection-496"><span class="linenos"> 496</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Fetch group details from PPMS and create a dict from them.</span>
</span><span id="PpmsConnection-497"><a href="#PpmsConnection-497"><span class="linenos"> 497</span></a>
</span><span id="PpmsConnection-498"><a href="#PpmsConnection-498"><span class="linenos"> 498</span></a><span class="sd">        Parameters</span>
</span><span id="PpmsConnection-499"><a href="#PpmsConnection-499"><span class="linenos"> 499</span></a><span class="sd">        ----------</span>
</span><span id="PpmsConnection-500"><a href="#PpmsConnection-500"><span class="linenos"> 500</span></a><span class="sd">        group_id : str</span>
</span><span id="PpmsConnection-501"><a href="#PpmsConnection-501"><span class="linenos"> 501</span></a><span class="sd">            The group&#39;s identifier in PPMS, called &#39;unitlogin&#39; there.</span>
</span><span id="PpmsConnection-502"><a href="#PpmsConnection-502"><span class="linenos"> 502</span></a>
</span><span id="PpmsConnection-503"><a href="#PpmsConnection-503"><span class="linenos"> 503</span></a><span class="sd">        Returns</span>
</span><span id="PpmsConnection-504"><a href="#PpmsConnection-504"><span class="linenos"> 504</span></a><span class="sd">        -------</span>
</span><span id="PpmsConnection-505"><a href="#PpmsConnection-505"><span class="linenos"> 505</span></a><span class="sd">        dict</span>
</span><span id="PpmsConnection-506"><a href="#PpmsConnection-506"><span class="linenos"> 506</span></a><span class="sd">            A dict with the group details, keys being derived from the header</span>
</span><span id="PpmsConnection-507"><a href="#PpmsConnection-507"><span class="linenos"> 507</span></a><span class="sd">            line of the PUMAPI response, values from the data line.</span>
</span><span id="PpmsConnection-508"><a href="#PpmsConnection-508"><span class="linenos"> 508</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PpmsConnection-509"><a href="#PpmsConnection-509"><span class="linenos"> 509</span></a>        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;getgroup&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;unitlogin&quot;</span><span class="p">:</span> <span class="n">group_id</span><span class="p">})</span>
</span><span id="PpmsConnection-510"><a href="#PpmsConnection-510"><span class="linenos"> 510</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s2">&quot;Group details returned by PPMS (raw): </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</span><span id="PpmsConnection-511"><a href="#PpmsConnection-511"><span class="linenos"> 511</span></a>
</span><span id="PpmsConnection-512"><a href="#PpmsConnection-512"><span class="linenos"> 512</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
</span><span id="PpmsConnection-513"><a href="#PpmsConnection-513"><span class="linenos"> 513</span></a>            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Group [</span><span class="si">{</span><span class="n">group_id</span><span class="si">}</span><span class="s2">] is unknown to PPMS&quot;</span>
</span><span id="PpmsConnection-514"><a href="#PpmsConnection-514"><span class="linenos"> 514</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="PpmsConnection-515"><a href="#PpmsConnection-515"><span class="linenos"> 515</span></a>            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="PpmsConnection-516"><a href="#PpmsConnection-516"><span class="linenos"> 516</span></a>
</span><span id="PpmsConnection-517"><a href="#PpmsConnection-517"><span class="linenos"> 517</span></a>        <span class="n">details</span> <span class="o">=</span> <span class="n">dict_from_single_response</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</span><span id="PpmsConnection-518"><a href="#PpmsConnection-518"><span class="linenos"> 518</span></a>
</span><span id="PpmsConnection-519"><a href="#PpmsConnection-519"><span class="linenos"> 519</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s2">&quot;Details of group </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">group_id</span><span class="p">,</span> <span class="n">details</span><span class="p">)</span>
</span><span id="PpmsConnection-520"><a href="#PpmsConnection-520"><span class="linenos"> 520</span></a>        <span class="k">return</span> <span class="n">details</span>
</span><span id="PpmsConnection-521"><a href="#PpmsConnection-521"><span class="linenos"> 521</span></a>
</span><span id="PpmsConnection-522"><a href="#PpmsConnection-522"><span class="linenos"> 522</span></a>    <span class="k">def</span> <span class="nf">get_group_users</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unitlogin</span><span class="p">):</span>
</span><span id="PpmsConnection-523"><a href="#PpmsConnection-523"><span class="linenos"> 523</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get all members of a group in PPMS.</span>
</span><span id="PpmsConnection-524"><a href="#PpmsConnection-524"><span class="linenos"> 524</span></a>
</span><span id="PpmsConnection-525"><a href="#PpmsConnection-525"><span class="linenos"> 525</span></a><span class="sd">        Parameters</span>
</span><span id="PpmsConnection-526"><a href="#PpmsConnection-526"><span class="linenos"> 526</span></a><span class="sd">        ----------</span>
</span><span id="PpmsConnection-527"><a href="#PpmsConnection-527"><span class="linenos"> 527</span></a><span class="sd">        unitlogin : str</span>
</span><span id="PpmsConnection-528"><a href="#PpmsConnection-528"><span class="linenos"> 528</span></a><span class="sd">            The group&#39;s login (&quot;unique login or id&quot; in the PPMS web interface).</span>
</span><span id="PpmsConnection-529"><a href="#PpmsConnection-529"><span class="linenos"> 529</span></a>
</span><span id="PpmsConnection-530"><a href="#PpmsConnection-530"><span class="linenos"> 530</span></a><span class="sd">        Returns</span>
</span><span id="PpmsConnection-531"><a href="#PpmsConnection-531"><span class="linenos"> 531</span></a><span class="sd">        -------</span>
</span><span id="PpmsConnection-532"><a href="#PpmsConnection-532"><span class="linenos"> 532</span></a><span class="sd">        list(pyppms.user.PpmsUser)</span>
</span><span id="PpmsConnection-533"><a href="#PpmsConnection-533"><span class="linenos"> 533</span></a><span class="sd">            A list with PpmsUser objects that are members of this PPMS group.</span>
</span><span id="PpmsConnection-534"><a href="#PpmsConnection-534"><span class="linenos"> 534</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PpmsConnection-535"><a href="#PpmsConnection-535"><span class="linenos"> 535</span></a>        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;getgroupusers&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;unitlogin&quot;</span><span class="p">:</span> <span class="n">unitlogin</span><span class="p">})</span>
</span><span id="PpmsConnection-536"><a href="#PpmsConnection-536"><span class="linenos"> 536</span></a>
</span><span id="PpmsConnection-537"><a href="#PpmsConnection-537"><span class="linenos"> 537</span></a>        <span class="n">members</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
</span><span id="PpmsConnection-538"><a href="#PpmsConnection-538"><span class="linenos"> 538</span></a>        <span class="n">users</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="PpmsConnection-539"><a href="#PpmsConnection-539"><span class="linenos"> 539</span></a>        <span class="k">for</span> <span class="n">username</span> <span class="ow">in</span> <span class="n">members</span><span class="p">:</span>
</span><span id="PpmsConnection-540"><a href="#PpmsConnection-540"><span class="linenos"> 540</span></a>            <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
</span><span id="PpmsConnection-541"><a href="#PpmsConnection-541"><span class="linenos"> 541</span></a>            <span class="n">users</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</span><span id="PpmsConnection-542"><a href="#PpmsConnection-542"><span class="linenos"> 542</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span>
</span><span id="PpmsConnection-543"><a href="#PpmsConnection-543"><span class="linenos"> 543</span></a>            <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> members in PPMS group [</span><span class="si">{}</span><span class="s2">]: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="PpmsConnection-544"><a href="#PpmsConnection-544"><span class="linenos"> 544</span></a>            <span class="nb">len</span><span class="p">(</span><span class="n">members</span><span class="p">),</span>
</span><span id="PpmsConnection-545"><a href="#PpmsConnection-545"><span class="linenos"> 545</span></a>            <span class="n">unitlogin</span><span class="p">,</span>
</span><span id="PpmsConnection-546"><a href="#PpmsConnection-546"><span class="linenos"> 546</span></a>            <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">members</span><span class="p">),</span>
</span><span id="PpmsConnection-547"><a href="#PpmsConnection-547"><span class="linenos"> 547</span></a>        <span class="p">)</span>
</span><span id="PpmsConnection-548"><a href="#PpmsConnection-548"><span class="linenos"> 548</span></a>        <span class="k">return</span> <span class="n">users</span>
</span><span id="PpmsConnection-549"><a href="#PpmsConnection-549"><span class="linenos"> 549</span></a>
</span><span id="PpmsConnection-550"><a href="#PpmsConnection-550"><span class="linenos"> 550</span></a>    <span class="k">def</span> <span class="nf">get_groups</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="PpmsConnection-551"><a href="#PpmsConnection-551"><span class="linenos"> 551</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get a list of all groups in PPMS.</span>
</span><span id="PpmsConnection-552"><a href="#PpmsConnection-552"><span class="linenos"> 552</span></a>
</span><span id="PpmsConnection-553"><a href="#PpmsConnection-553"><span class="linenos"> 553</span></a><span class="sd">        Returns</span>
</span><span id="PpmsConnection-554"><a href="#PpmsConnection-554"><span class="linenos"> 554</span></a><span class="sd">        -------</span>
</span><span id="PpmsConnection-555"><a href="#PpmsConnection-555"><span class="linenos"> 555</span></a><span class="sd">        list(str)</span>
</span><span id="PpmsConnection-556"><a href="#PpmsConnection-556"><span class="linenos"> 556</span></a><span class="sd">            A list with the group identifiers in PPMS.</span>
</span><span id="PpmsConnection-557"><a href="#PpmsConnection-557"><span class="linenos"> 557</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PpmsConnection-558"><a href="#PpmsConnection-558"><span class="linenos"> 558</span></a>        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;getgroups&quot;</span><span class="p">)</span>
</span><span id="PpmsConnection-559"><a href="#PpmsConnection-559"><span class="linenos"> 559</span></a>
</span><span id="PpmsConnection-560"><a href="#PpmsConnection-560"><span class="linenos"> 560</span></a>        <span class="n">groups</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
</span><span id="PpmsConnection-561"><a href="#PpmsConnection-561"><span class="linenos"> 561</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> groups in the PPMS database: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">groups</span><span class="p">),</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">groups</span><span class="p">))</span>
</span><span id="PpmsConnection-562"><a href="#PpmsConnection-562"><span class="linenos"> 562</span></a>        <span class="k">return</span> <span class="n">groups</span>
</span><span id="PpmsConnection-563"><a href="#PpmsConnection-563"><span class="linenos"> 563</span></a>
</span><span id="PpmsConnection-564"><a href="#PpmsConnection-564"><span class="linenos"> 564</span></a>    <span class="k">def</span> <span class="nf">get_next_booking</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">system_id</span><span class="p">):</span>
</span><span id="PpmsConnection-565"><a href="#PpmsConnection-565"><span class="linenos"> 565</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Wrapper for `get_booking()` with &#39;booking_type&#39; set to &#39;next&#39;.&quot;&quot;&quot;</span>
</span><span id="PpmsConnection-566"><a href="#PpmsConnection-566"><span class="linenos"> 566</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_booking</span><span class="p">(</span><span class="n">system_id</span><span class="p">,</span> <span class="s2">&quot;next&quot;</span><span class="p">)</span>
</span><span id="PpmsConnection-567"><a href="#PpmsConnection-567"><span class="linenos"> 567</span></a>
</span><span id="PpmsConnection-568"><a href="#PpmsConnection-568"><span class="linenos"> 568</span></a>    <span class="k">def</span> <span class="nf">get_running_sheet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">core_facility_ref</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">ignore_uncached_users</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="PpmsConnection-569"><a href="#PpmsConnection-569"><span class="linenos"> 569</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the running sheet for a specific day on the given facility.</span>
</span><span id="PpmsConnection-570"><a href="#PpmsConnection-570"><span class="linenos"> 570</span></a>
</span><span id="PpmsConnection-571"><a href="#PpmsConnection-571"><span class="linenos"> 571</span></a><span class="sd">        The so-called &quot;running-sheet&quot; consists of all bookings / reservations of</span>
</span><span id="PpmsConnection-572"><a href="#PpmsConnection-572"><span class="linenos"> 572</span></a><span class="sd">        a facility on a specifc day.</span>
</span><span id="PpmsConnection-573"><a href="#PpmsConnection-573"><span class="linenos"> 573</span></a>
</span><span id="PpmsConnection-574"><a href="#PpmsConnection-574"><span class="linenos"> 574</span></a><span class="sd">        WARNING: PUMAPI doesn&#39;t return a proper unique user identifier with the</span>
</span><span id="PpmsConnection-575"><a href="#PpmsConnection-575"><span class="linenos"> 575</span></a><span class="sd">        &#39;getrunningsheet&#39; request, instead the so called &quot;full name&quot; is given to</span>
</span><span id="PpmsConnection-576"><a href="#PpmsConnection-576"><span class="linenos"> 576</span></a><span class="sd">        identify the user - unfortunately this can lead to ambiguities as</span>
</span><span id="PpmsConnection-577"><a href="#PpmsConnection-577"><span class="linenos"> 577</span></a><span class="sd">        multiple different accounts can have the same full name.</span>
</span><span id="PpmsConnection-578"><a href="#PpmsConnection-578"><span class="linenos"> 578</span></a>
</span><span id="PpmsConnection-579"><a href="#PpmsConnection-579"><span class="linenos"> 579</span></a><span class="sd">        Parameters</span>
</span><span id="PpmsConnection-580"><a href="#PpmsConnection-580"><span class="linenos"> 580</span></a><span class="sd">        ----------</span>
</span><span id="PpmsConnection-581"><a href="#PpmsConnection-581"><span class="linenos"> 581</span></a><span class="sd">        core_facility_ref : int or int-like</span>
</span><span id="PpmsConnection-582"><a href="#PpmsConnection-582"><span class="linenos"> 582</span></a><span class="sd">            The core facility ID for PPMS.</span>
</span><span id="PpmsConnection-583"><a href="#PpmsConnection-583"><span class="linenos"> 583</span></a><span class="sd">        date : datetime.datetime</span>
</span><span id="PpmsConnection-584"><a href="#PpmsConnection-584"><span class="linenos"> 584</span></a><span class="sd">            The date to request the running sheet for, e.g. ``datetime.now()`` or</span>
</span><span id="PpmsConnection-585"><a href="#PpmsConnection-585"><span class="linenos"> 585</span></a><span class="sd">            similar. Note that only the date part is relevant, time will be ignored.</span>
</span><span id="PpmsConnection-586"><a href="#PpmsConnection-586"><span class="linenos"> 586</span></a><span class="sd">        ignore_uncached_users : bool, optional</span>
</span><span id="PpmsConnection-587"><a href="#PpmsConnection-587"><span class="linenos"> 587</span></a><span class="sd">            If set to `True` any booking for a user that is not present in the instance</span>
</span><span id="PpmsConnection-588"><a href="#PpmsConnection-588"><span class="linenos"> 588</span></a><span class="sd">            attribute `fullname_mapping` will be ignored in the resulting list.</span>
</span><span id="PpmsConnection-589"><a href="#PpmsConnection-589"><span class="linenos"> 589</span></a>
</span><span id="PpmsConnection-590"><a href="#PpmsConnection-590"><span class="linenos"> 590</span></a><span class="sd">        Returns</span>
</span><span id="PpmsConnection-591"><a href="#PpmsConnection-591"><span class="linenos"> 591</span></a><span class="sd">        -------</span>
</span><span id="PpmsConnection-592"><a href="#PpmsConnection-592"><span class="linenos"> 592</span></a><span class="sd">        list(pyppms.booking.PpmsBooking)</span>
</span><span id="PpmsConnection-593"><a href="#PpmsConnection-593"><span class="linenos"> 593</span></a><span class="sd">            A list with `PpmsBooking` objects for the given day. Empty in case</span>
</span><span id="PpmsConnection-594"><a href="#PpmsConnection-594"><span class="linenos"> 594</span></a><span class="sd">            there are no bookings or parsing the response failed.</span>
</span><span id="PpmsConnection-595"><a href="#PpmsConnection-595"><span class="linenos"> 595</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PpmsConnection-596"><a href="#PpmsConnection-596"><span class="linenos"> 596</span></a>        <span class="n">bookings</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="PpmsConnection-597"><a href="#PpmsConnection-597"><span class="linenos"> 597</span></a>        <span class="n">parameters</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="PpmsConnection-598"><a href="#PpmsConnection-598"><span class="linenos"> 598</span></a>            <span class="s2">&quot;plateformid&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">core_facility_ref</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="PpmsConnection-599"><a href="#PpmsConnection-599"><span class="linenos"> 599</span></a>            <span class="s2">&quot;day&quot;</span><span class="p">:</span> <span class="n">date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">),</span>
</span><span id="PpmsConnection-600"><a href="#PpmsConnection-600"><span class="linenos"> 600</span></a>        <span class="p">}</span>
</span><span id="PpmsConnection-601"><a href="#PpmsConnection-601"><span class="linenos"> 601</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s2">&quot;Requesting runningsheet for </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;day&quot;</span><span class="p">])</span>
</span><span id="PpmsConnection-602"><a href="#PpmsConnection-602"><span class="linenos"> 602</span></a>        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;getrunningsheet&quot;</span><span class="p">,</span> <span class="n">parameters</span><span class="p">)</span>
</span><span id="PpmsConnection-603"><a href="#PpmsConnection-603"><span class="linenos"> 603</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="PpmsConnection-604"><a href="#PpmsConnection-604"><span class="linenos"> 604</span></a>            <span class="n">entries</span> <span class="o">=</span> <span class="n">parse_multiline_response</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">graceful</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="PpmsConnection-605"><a href="#PpmsConnection-605"><span class="linenos"> 605</span></a>        <span class="k">except</span> <span class="n">NoDataError</span><span class="p">:</span>
</span><span id="PpmsConnection-606"><a href="#PpmsConnection-606"><span class="linenos"> 606</span></a>            <span class="c1"># in case no bookings exist the response will be empty!</span>
</span><span id="PpmsConnection-607"><a href="#PpmsConnection-607"><span class="linenos"> 607</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s2">&quot;Runningsheet for the given day was empty!&quot;</span><span class="p">)</span>
</span><span id="PpmsConnection-608"><a href="#PpmsConnection-608"><span class="linenos"> 608</span></a>            <span class="k">return</span> <span class="p">[]</span>
</span><span id="PpmsConnection-609"><a href="#PpmsConnection-609"><span class="linenos"> 609</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>  <span class="c1"># pylint: disable-msg=broad-except</span>
</span><span id="PpmsConnection-610"><a href="#PpmsConnection-610"><span class="linenos"> 610</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Parsing runningsheet details failed: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
</span><span id="PpmsConnection-611"><a href="#PpmsConnection-611"><span class="linenos"> 611</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s2">&quot;Runningsheet PUMPAI response was: &gt;&gt;&gt;</span><span class="si">{}</span><span class="s2">&lt;&lt;&lt;&quot;</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</span><span id="PpmsConnection-612"><a href="#PpmsConnection-612"><span class="linenos"> 612</span></a>            <span class="k">return</span> <span class="p">[]</span>
</span><span id="PpmsConnection-613"><a href="#PpmsConnection-613"><span class="linenos"> 613</span></a>
</span><span id="PpmsConnection-614"><a href="#PpmsConnection-614"><span class="linenos"> 614</span></a>        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
</span><span id="PpmsConnection-615"><a href="#PpmsConnection-615"><span class="linenos"> 615</span></a>            <span class="n">full</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;User&quot;</span><span class="p">]</span>
</span><span id="PpmsConnection-616"><a href="#PpmsConnection-616"><span class="linenos"> 616</span></a>            <span class="k">if</span> <span class="n">full</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fullname_mapping</span><span class="p">:</span>
</span><span id="PpmsConnection-617"><a href="#PpmsConnection-617"><span class="linenos"> 617</span></a>                <span class="k">if</span> <span class="n">ignore_uncached_users</span><span class="p">:</span>
</span><span id="PpmsConnection-618"><a href="#PpmsConnection-618"><span class="linenos"> 618</span></a>                    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Ignoring booking for uncached / unknown user [</span><span class="si">{</span><span class="n">full</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
</span><span id="PpmsConnection-619"><a href="#PpmsConnection-619"><span class="linenos"> 619</span></a>                    <span class="k">continue</span>
</span><span id="PpmsConnection-620"><a href="#PpmsConnection-620"><span class="linenos"> 620</span></a>
</span><span id="PpmsConnection-621"><a href="#PpmsConnection-621"><span class="linenos"> 621</span></a>                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Booking refers an uncached user (</span><span class="si">{</span><span class="n">full</span><span class="si">}</span><span class="s2">), updating users!&quot;</span><span class="p">)</span>
</span><span id="PpmsConnection-622"><a href="#PpmsConnection-622"><span class="linenos"> 622</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">update_users</span><span class="p">()</span>
</span><span id="PpmsConnection-623"><a href="#PpmsConnection-623"><span class="linenos"> 623</span></a>
</span><span id="PpmsConnection-624"><a href="#PpmsConnection-624"><span class="linenos"> 624</span></a>            <span class="k">if</span> <span class="n">full</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fullname_mapping</span><span class="p">:</span>
</span><span id="PpmsConnection-625"><a href="#PpmsConnection-625"><span class="linenos"> 625</span></a>                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;PPMS doesn&#39;t seem to know user [</span><span class="si">{}</span><span class="s2">], skipping&quot;</span><span class="p">,</span> <span class="n">full</span><span class="p">)</span>
</span><span id="PpmsConnection-626"><a href="#PpmsConnection-626"><span class="linenos"> 626</span></a>                <span class="k">continue</span>
</span><span id="PpmsConnection-627"><a href="#PpmsConnection-627"><span class="linenos"> 627</span></a>
</span><span id="PpmsConnection-628"><a href="#PpmsConnection-628"><span class="linenos"> 628</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span>
</span><span id="PpmsConnection-629"><a href="#PpmsConnection-629"><span class="linenos"> 629</span></a>                <span class="sa">f</span><span class="s2">&quot;Booking for user &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">fullname_mapping</span><span class="p">[</span><span class="n">full</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39; (</span><span class="si">{</span><span class="n">full</span><span class="si">}</span><span class="s2">) found&quot;</span>
</span><span id="PpmsConnection-630"><a href="#PpmsConnection-630"><span class="linenos"> 630</span></a>            <span class="p">)</span>
</span><span id="PpmsConnection-631"><a href="#PpmsConnection-631"><span class="linenos"> 631</span></a>            <span class="n">system_name</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;Object&quot;</span><span class="p">]</span>
</span><span id="PpmsConnection-632"><a href="#PpmsConnection-632"><span class="linenos"> 632</span></a>            <span class="n">system_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_systems_matching</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">system_name</span><span class="p">])</span>
</span><span id="PpmsConnection-633"><a href="#PpmsConnection-633"><span class="linenos"> 633</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">system_ids</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PpmsConnection-634"><a href="#PpmsConnection-634"><span class="linenos"> 634</span></a>                <span class="c1"># NOTE: more than one result should not happen as PPMS doesn&#39;t allow for</span>
</span><span id="PpmsConnection-635"><a href="#PpmsConnection-635"><span class="linenos"> 635</span></a>                <span class="c1"># multiple systems having the same name - no result might happen though!</span>
</span><span id="PpmsConnection-636"><a href="#PpmsConnection-636"><span class="linenos"> 636</span></a>                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Ignoring booking for unknown system [</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="n">system_name</span><span class="p">)</span>
</span><span id="PpmsConnection-637"><a href="#PpmsConnection-637"><span class="linenos"> 637</span></a>                <span class="k">continue</span>
</span><span id="PpmsConnection-638"><a href="#PpmsConnection-638"><span class="linenos"> 638</span></a>
</span><span id="PpmsConnection-639"><a href="#PpmsConnection-639"><span class="linenos"> 639</span></a>            <span class="n">booking</span> <span class="o">=</span> <span class="n">PpmsBooking</span><span class="o">.</span><span class="n">from_runningsheet</span><span class="p">(</span>
</span><span id="PpmsConnection-640"><a href="#PpmsConnection-640"><span class="linenos"> 640</span></a>                <span class="n">entry</span><span class="p">,</span>
</span><span id="PpmsConnection-641"><a href="#PpmsConnection-641"><span class="linenos"> 641</span></a>                <span class="n">system_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span><span id="PpmsConnection-642"><a href="#PpmsConnection-642"><span class="linenos"> 642</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">fullname_mapping</span><span class="p">[</span><span class="n">full</span><span class="p">],</span>
</span><span id="PpmsConnection-643"><a href="#PpmsConnection-643"><span class="linenos"> 643</span></a>                <span class="n">date</span><span class="p">,</span>
</span><span id="PpmsConnection-644"><a href="#PpmsConnection-644"><span class="linenos"> 644</span></a>            <span class="p">)</span>
</span><span id="PpmsConnection-645"><a href="#PpmsConnection-645"><span class="linenos"> 645</span></a>            <span class="n">bookings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">booking</span><span class="p">)</span>
</span><span id="PpmsConnection-646"><a href="#PpmsConnection-646"><span class="linenos"> 646</span></a>
</span><span id="PpmsConnection-647"><a href="#PpmsConnection-647"><span class="linenos"> 647</span></a>        <span class="k">return</span> <span class="n">bookings</span>
</span><span id="PpmsConnection-648"><a href="#PpmsConnection-648"><span class="linenos"> 648</span></a>
</span><span id="PpmsConnection-649"><a href="#PpmsConnection-649"><span class="linenos"> 649</span></a>    <span class="k">def</span> <span class="nf">get_systems</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force_refresh</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="PpmsConnection-650"><a href="#PpmsConnection-650"><span class="linenos"> 650</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get a dict with all systems in PPMS.</span>
</span><span id="PpmsConnection-651"><a href="#PpmsConnection-651"><span class="linenos"> 651</span></a>
</span><span id="PpmsConnection-652"><a href="#PpmsConnection-652"><span class="linenos"> 652</span></a><span class="sd">        Parameters</span>
</span><span id="PpmsConnection-653"><a href="#PpmsConnection-653"><span class="linenos"> 653</span></a><span class="sd">        ----------</span>
</span><span id="PpmsConnection-654"><a href="#PpmsConnection-654"><span class="linenos"> 654</span></a><span class="sd">        force_refresh : bool, optional</span>
</span><span id="PpmsConnection-655"><a href="#PpmsConnection-655"><span class="linenos"> 655</span></a><span class="sd">            If `True` the list of systems will be refreshed even if the object&#39;s</span>
</span><span id="PpmsConnection-656"><a href="#PpmsConnection-656"><span class="linenos"> 656</span></a><span class="sd">            attribute `self.systems` is non-empty, by default `False`. Please</span>
</span><span id="PpmsConnection-657"><a href="#PpmsConnection-657"><span class="linenos"> 657</span></a><span class="sd">            note that this will NOT skip the on-disk cache in case that exists!</span>
</span><span id="PpmsConnection-658"><a href="#PpmsConnection-658"><span class="linenos"> 658</span></a>
</span><span id="PpmsConnection-659"><a href="#PpmsConnection-659"><span class="linenos"> 659</span></a><span class="sd">        Returns</span>
</span><span id="PpmsConnection-660"><a href="#PpmsConnection-660"><span class="linenos"> 660</span></a><span class="sd">        -------</span>
</span><span id="PpmsConnection-661"><a href="#PpmsConnection-661"><span class="linenos"> 661</span></a><span class="sd">        dict(pyppms.system.PpmsSystem)</span>
</span><span id="PpmsConnection-662"><a href="#PpmsConnection-662"><span class="linenos"> 662</span></a><span class="sd">            A dict with `PpmsSystem` objects parsed from the PUMAPI response where</span>
</span><span id="PpmsConnection-663"><a href="#PpmsConnection-663"><span class="linenos"> 663</span></a><span class="sd">            the system ID (int) is used as the dict&#39;s key. If parsing a system</span>
</span><span id="PpmsConnection-664"><a href="#PpmsConnection-664"><span class="linenos"> 664</span></a><span class="sd">            fails for any reason, the system is skipped entirely.</span>
</span><span id="PpmsConnection-665"><a href="#PpmsConnection-665"><span class="linenos"> 665</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PpmsConnection-666"><a href="#PpmsConnection-666"><span class="linenos"> 666</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">systems</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">force_refresh</span><span class="p">:</span>
</span><span id="PpmsConnection-667"><a href="#PpmsConnection-667"><span class="linenos"> 667</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s2">&quot;Using cached details for </span><span class="si">{}</span><span class="s2"> systems&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">systems</span><span class="p">))</span>
</span><span id="PpmsConnection-668"><a href="#PpmsConnection-668"><span class="linenos"> 668</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="PpmsConnection-669"><a href="#PpmsConnection-669"><span class="linenos"> 669</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">update_systems</span><span class="p">()</span>
</span><span id="PpmsConnection-670"><a href="#PpmsConnection-670"><span class="linenos"> 670</span></a>
</span><span id="PpmsConnection-671"><a href="#PpmsConnection-671"><span class="linenos"> 671</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">systems</span>
</span><span id="PpmsConnection-672"><a href="#PpmsConnection-672"><span class="linenos"> 672</span></a>
</span><span id="PpmsConnection-673"><a href="#PpmsConnection-673"><span class="linenos"> 673</span></a>    <span class="k">def</span> <span class="nf">get_systems_matching</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">localisation</span><span class="p">,</span> <span class="n">name_contains</span><span class="p">):</span>
</span><span id="PpmsConnection-674"><a href="#PpmsConnection-674"><span class="linenos"> 674</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Query PPMS for systems with a specific location and name.</span>
</span><span id="PpmsConnection-675"><a href="#PpmsConnection-675"><span class="linenos"> 675</span></a>
</span><span id="PpmsConnection-676"><a href="#PpmsConnection-676"><span class="linenos"> 676</span></a><span class="sd">        This method assembles a list of PPMS system IDs whose &quot;localisation&quot;</span>
</span><span id="PpmsConnection-677"><a href="#PpmsConnection-677"><span class="linenos"> 677</span></a><span class="sd">        (room) field matches a given string and where the system name contains</span>
</span><span id="PpmsConnection-678"><a href="#PpmsConnection-678"><span class="linenos"> 678</span></a><span class="sd">        at least one of the strings given as the `name_contains` parameter.</span>
</span><span id="PpmsConnection-679"><a href="#PpmsConnection-679"><span class="linenos"> 679</span></a>
</span><span id="PpmsConnection-680"><a href="#PpmsConnection-680"><span class="linenos"> 680</span></a><span class="sd">        Parameters</span>
</span><span id="PpmsConnection-681"><a href="#PpmsConnection-681"><span class="linenos"> 681</span></a><span class="sd">        ----------</span>
</span><span id="PpmsConnection-682"><a href="#PpmsConnection-682"><span class="linenos"> 682</span></a><span class="sd">        localisation : str</span>
</span><span id="PpmsConnection-683"><a href="#PpmsConnection-683"><span class="linenos"> 683</span></a><span class="sd">            A string that the system&#39;s &quot;localisation&quot; (i.e. the &quot;Room&quot; field in</span>
</span><span id="PpmsConnection-684"><a href="#PpmsConnection-684"><span class="linenos"> 684</span></a><span class="sd">            the PPMS web interface) has to match. Can be an empty string which</span>
</span><span id="PpmsConnection-685"><a href="#PpmsConnection-685"><span class="linenos"> 685</span></a><span class="sd">            will result in no filtering being done on the &quot;Room&quot; attribute.</span>
</span><span id="PpmsConnection-686"><a href="#PpmsConnection-686"><span class="linenos"> 686</span></a><span class="sd">        name_contains : list(str)</span>
</span><span id="PpmsConnection-687"><a href="#PpmsConnection-687"><span class="linenos"> 687</span></a><span class="sd">            A list of valid names (categories) of which the system&#39;s name has to</span>
</span><span id="PpmsConnection-688"><a href="#PpmsConnection-688"><span class="linenos"> 688</span></a><span class="sd">            match at least one for being included. Supply an empty list for</span>
</span><span id="PpmsConnection-689"><a href="#PpmsConnection-689"><span class="linenos"> 689</span></a><span class="sd">            skipping this filter.</span>
</span><span id="PpmsConnection-690"><a href="#PpmsConnection-690"><span class="linenos"> 690</span></a>
</span><span id="PpmsConnection-691"><a href="#PpmsConnection-691"><span class="linenos"> 691</span></a><span class="sd">        Returns</span>
</span><span id="PpmsConnection-692"><a href="#PpmsConnection-692"><span class="linenos"> 692</span></a><span class="sd">        -------</span>
</span><span id="PpmsConnection-693"><a href="#PpmsConnection-693"><span class="linenos"> 693</span></a><span class="sd">        list(int)</span>
</span><span id="PpmsConnection-694"><a href="#PpmsConnection-694"><span class="linenos"> 694</span></a><span class="sd">            A list with PPMS system IDs matching all of the given criteria.</span>
</span><span id="PpmsConnection-695"><a href="#PpmsConnection-695"><span class="linenos"> 695</span></a>
</span><span id="PpmsConnection-696"><a href="#PpmsConnection-696"><span class="linenos"> 696</span></a><span class="sd">        Raises</span>
</span><span id="PpmsConnection-697"><a href="#PpmsConnection-697"><span class="linenos"> 697</span></a><span class="sd">        ------</span>
</span><span id="PpmsConnection-698"><a href="#PpmsConnection-698"><span class="linenos"> 698</span></a><span class="sd">        TypeError</span>
</span><span id="PpmsConnection-699"><a href="#PpmsConnection-699"><span class="linenos"> 699</span></a><span class="sd">            Raised in case the `name_contains` parameter is of type `str` (it</span>
</span><span id="PpmsConnection-700"><a href="#PpmsConnection-700"><span class="linenos"> 700</span></a><span class="sd">            needs to be `list(str)` instead).</span>
</span><span id="PpmsConnection-701"><a href="#PpmsConnection-701"><span class="linenos"> 701</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PpmsConnection-702"><a href="#PpmsConnection-702"><span class="linenos"> 702</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name_contains</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="PpmsConnection-703"><a href="#PpmsConnection-703"><span class="linenos"> 703</span></a>            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;`name_contains` must be a list of str, not str!&quot;</span><span class="p">)</span>
</span><span id="PpmsConnection-704"><a href="#PpmsConnection-704"><span class="linenos"> 704</span></a>
</span><span id="PpmsConnection-705"><a href="#PpmsConnection-705"><span class="linenos"> 705</span></a>        <span class="n">loc</span> <span class="o">=</span> <span class="n">localisation</span>
</span><span id="PpmsConnection-706"><a href="#PpmsConnection-706"><span class="linenos"> 706</span></a>        <span class="n">loc_desc</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;with location matching [</span><span class="si">{</span><span class="n">localisation</span><span class="si">}</span><span class="s2">]&quot;</span>
</span><span id="PpmsConnection-707"><a href="#PpmsConnection-707"><span class="linenos"> 707</span></a>        <span class="k">if</span> <span class="n">localisation</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
</span><span id="PpmsConnection-708"><a href="#PpmsConnection-708"><span class="linenos"> 708</span></a>            <span class="n">loc_desc</span> <span class="o">=</span> <span class="s2">&quot;(no location filter given)&quot;</span>
</span><span id="PpmsConnection-709"><a href="#PpmsConnection-709"><span class="linenos"> 709</span></a>
</span><span id="PpmsConnection-710"><a href="#PpmsConnection-710"><span class="linenos"> 710</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span>
</span><span id="PpmsConnection-711"><a href="#PpmsConnection-711"><span class="linenos"> 711</span></a>            <span class="s2">&quot;Querying PPMS for systems </span><span class="si">{}</span><span class="s2">, name matching any of </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="PpmsConnection-712"><a href="#PpmsConnection-712"><span class="linenos"> 712</span></a>            <span class="n">loc_desc</span><span class="p">,</span>
</span><span id="PpmsConnection-713"><a href="#PpmsConnection-713"><span class="linenos"> 713</span></a>            <span class="n">name_contains</span><span class="p">,</span>
</span><span id="PpmsConnection-714"><a href="#PpmsConnection-714"><span class="linenos"> 714</span></a>        <span class="p">)</span>
</span><span id="PpmsConnection-715"><a href="#PpmsConnection-715"><span class="linenos"> 715</span></a>        <span class="n">system_ids</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="PpmsConnection-716"><a href="#PpmsConnection-716"><span class="linenos"> 716</span></a>        <span class="n">systems</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_systems</span><span class="p">()</span>
</span><span id="PpmsConnection-717"><a href="#PpmsConnection-717"><span class="linenos"> 717</span></a>        <span class="k">for</span> <span class="n">sys_id</span><span class="p">,</span> <span class="n">system</span> <span class="ow">in</span> <span class="n">systems</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="PpmsConnection-718"><a href="#PpmsConnection-718"><span class="linenos"> 718</span></a>            <span class="k">if</span> <span class="n">loc</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">system</span><span class="o">.</span><span class="n">localisation</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
</span><span id="PpmsConnection-719"><a href="#PpmsConnection-719"><span class="linenos"> 719</span></a>                <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span>
</span><span id="PpmsConnection-720"><a href="#PpmsConnection-720"><span class="linenos"> 720</span></a>                    <span class="s2">&quot;System [</span><span class="si">{}</span><span class="s2">] location (</span><span class="si">{}</span><span class="s2">) is NOT matching (</span><span class="si">{}</span><span class="s2">), ignoring&quot;</span><span class="p">,</span>
</span><span id="PpmsConnection-721"><a href="#PpmsConnection-721"><span class="linenos"> 721</span></a>                    <span class="n">system</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
</span><span id="PpmsConnection-722"><a href="#PpmsConnection-722"><span class="linenos"> 722</span></a>                    <span class="n">system</span><span class="o">.</span><span class="n">localisation</span><span class="p">,</span>
</span><span id="PpmsConnection-723"><a href="#PpmsConnection-723"><span class="linenos"> 723</span></a>                    <span class="n">loc</span><span class="p">,</span>
</span><span id="PpmsConnection-724"><a href="#PpmsConnection-724"><span class="linenos"> 724</span></a>                <span class="p">)</span>
</span><span id="PpmsConnection-725"><a href="#PpmsConnection-725"><span class="linenos"> 725</span></a>                <span class="k">continue</span>
</span><span id="PpmsConnection-726"><a href="#PpmsConnection-726"><span class="linenos"> 726</span></a>
</span><span id="PpmsConnection-727"><a href="#PpmsConnection-727"><span class="linenos"> 727</span></a>            <span class="c1"># log.trace(&#39;System [{}] is matching location [{}], checking if &#39;</span>
</span><span id="PpmsConnection-728"><a href="#PpmsConnection-728"><span class="linenos"> 728</span></a>            <span class="c1">#           &#39;the name is matching any of the valid pattern {}&#39;,</span>
</span><span id="PpmsConnection-729"><a href="#PpmsConnection-729"><span class="linenos"> 729</span></a>            <span class="c1">#           system.name, loc, name_contains)</span>
</span><span id="PpmsConnection-730"><a href="#PpmsConnection-730"><span class="linenos"> 730</span></a>            <span class="k">for</span> <span class="n">valid_name</span> <span class="ow">in</span> <span class="n">name_contains</span><span class="p">:</span>
</span><span id="PpmsConnection-731"><a href="#PpmsConnection-731"><span class="linenos"> 731</span></a>                <span class="k">if</span> <span class="n">valid_name</span> <span class="ow">in</span> <span class="n">system</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
</span><span id="PpmsConnection-732"><a href="#PpmsConnection-732"><span class="linenos"> 732</span></a>                    <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s2">&quot;System [</span><span class="si">{}</span><span class="s2">] matches all criteria&quot;</span><span class="p">,</span> <span class="n">system</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</span><span id="PpmsConnection-733"><a href="#PpmsConnection-733"><span class="linenos"> 733</span></a>                    <span class="n">system_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sys_id</span><span class="p">)</span>
</span><span id="PpmsConnection-734"><a href="#PpmsConnection-734"><span class="linenos"> 734</span></a>                    <span class="k">break</span>
</span><span id="PpmsConnection-735"><a href="#PpmsConnection-735"><span class="linenos"> 735</span></a>
</span><span id="PpmsConnection-736"><a href="#PpmsConnection-736"><span class="linenos"> 736</span></a>            <span class="c1"># if sys_id not in system_ids:</span>
</span><span id="PpmsConnection-737"><a href="#PpmsConnection-737"><span class="linenos"> 737</span></a>            <span class="c1">#     log.trace(&#39;System [{}] does NOT match a valid name: {}&#39;,</span>
</span><span id="PpmsConnection-738"><a href="#PpmsConnection-738"><span class="linenos"> 738</span></a>            <span class="c1">#               system.name, name_contains)</span>
</span><span id="PpmsConnection-739"><a href="#PpmsConnection-739"><span class="linenos"> 739</span></a>
</span><span id="PpmsConnection-740"><a href="#PpmsConnection-740"><span class="linenos"> 740</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s2">&quot;Found </span><span class="si">{}</span><span class="s2"> bookable systems </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">system_ids</span><span class="p">),</span> <span class="n">loc_desc</span><span class="p">)</span>
</span><span id="PpmsConnection-741"><a href="#PpmsConnection-741"><span class="linenos"> 741</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s2">&quot;IDs of matching bookable systems </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">loc_desc</span><span class="p">,</span> <span class="n">system_ids</span><span class="p">)</span>
</span><span id="PpmsConnection-742"><a href="#PpmsConnection-742"><span class="linenos"> 742</span></a>        <span class="k">return</span> <span class="n">system_ids</span>
</span><span id="PpmsConnection-743"><a href="#PpmsConnection-743"><span class="linenos"> 743</span></a>
</span><span id="PpmsConnection-744"><a href="#PpmsConnection-744"><span class="linenos"> 744</span></a>    <span class="k">def</span> <span class="nf">get_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">login_name</span><span class="p">,</span> <span class="n">skip_cache</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="PpmsConnection-745"><a href="#PpmsConnection-745"><span class="linenos"> 745</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Fetch user details from PPMS and create a PpmsUser object from it.</span>
</span><span id="PpmsConnection-746"><a href="#PpmsConnection-746"><span class="linenos"> 746</span></a>
</span><span id="PpmsConnection-747"><a href="#PpmsConnection-747"><span class="linenos"> 747</span></a><span class="sd">        Parameters</span>
</span><span id="PpmsConnection-748"><a href="#PpmsConnection-748"><span class="linenos"> 748</span></a><span class="sd">        ----------</span>
</span><span id="PpmsConnection-749"><a href="#PpmsConnection-749"><span class="linenos"> 749</span></a><span class="sd">        login_name : str</span>
</span><span id="PpmsConnection-750"><a href="#PpmsConnection-750"><span class="linenos"> 750</span></a><span class="sd">            The user&#39;s PPMS login name.</span>
</span><span id="PpmsConnection-751"><a href="#PpmsConnection-751"><span class="linenos"> 751</span></a><span class="sd">        skip_cache : bool, optional</span>
</span><span id="PpmsConnection-752"><a href="#PpmsConnection-752"><span class="linenos"> 752</span></a><span class="sd">            Passed as-is to the :py:meth:`request()` method</span>
</span><span id="PpmsConnection-753"><a href="#PpmsConnection-753"><span class="linenos"> 753</span></a>
</span><span id="PpmsConnection-754"><a href="#PpmsConnection-754"><span class="linenos"> 754</span></a><span class="sd">        Returns</span>
</span><span id="PpmsConnection-755"><a href="#PpmsConnection-755"><span class="linenos"> 755</span></a><span class="sd">        -------</span>
</span><span id="PpmsConnection-756"><a href="#PpmsConnection-756"><span class="linenos"> 756</span></a><span class="sd">        pyppms.user.PpmsUser</span>
</span><span id="PpmsConnection-757"><a href="#PpmsConnection-757"><span class="linenos"> 757</span></a><span class="sd">            The user object created from the PUMAPI response. The object will be</span>
</span><span id="PpmsConnection-758"><a href="#PpmsConnection-758"><span class="linenos"> 758</span></a><span class="sd">            additionally stored in the self.users dict using the login_name as</span>
</span><span id="PpmsConnection-759"><a href="#PpmsConnection-759"><span class="linenos"> 759</span></a><span class="sd">            the dict&#39;s key.</span>
</span><span id="PpmsConnection-760"><a href="#PpmsConnection-760"><span class="linenos"> 760</span></a>
</span><span id="PpmsConnection-761"><a href="#PpmsConnection-761"><span class="linenos"> 761</span></a><span class="sd">        Raises</span>
</span><span id="PpmsConnection-762"><a href="#PpmsConnection-762"><span class="linenos"> 762</span></a><span class="sd">        ------</span>
</span><span id="PpmsConnection-763"><a href="#PpmsConnection-763"><span class="linenos"> 763</span></a><span class="sd">        KeyError</span>
</span><span id="PpmsConnection-764"><a href="#PpmsConnection-764"><span class="linenos"> 764</span></a><span class="sd">            Raised if the user doesn&#39;t exist in PPMS.</span>
</span><span id="PpmsConnection-765"><a href="#PpmsConnection-765"><span class="linenos"> 765</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PpmsConnection-766"><a href="#PpmsConnection-766"><span class="linenos"> 766</span></a>        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;getuser&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;login&quot;</span><span class="p">:</span> <span class="n">login_name</span><span class="p">},</span> <span class="n">skip_cache</span><span class="o">=</span><span class="n">skip_cache</span><span class="p">)</span>
</span><span id="PpmsConnection-767"><a href="#PpmsConnection-767"><span class="linenos"> 767</span></a>
</span><span id="PpmsConnection-768"><a href="#PpmsConnection-768"><span class="linenos"> 768</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
</span><span id="PpmsConnection-769"><a href="#PpmsConnection-769"><span class="linenos"> 769</span></a>            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;User [</span><span class="si">{</span><span class="n">login_name</span><span class="si">}</span><span class="s2">] is unknown to PPMS&quot;</span>
</span><span id="PpmsConnection-770"><a href="#PpmsConnection-770"><span class="linenos"> 770</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="PpmsConnection-771"><a href="#PpmsConnection-771"><span class="linenos"> 771</span></a>            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="PpmsConnection-772"><a href="#PpmsConnection-772"><span class="linenos"> 772</span></a>
</span><span id="PpmsConnection-773"><a href="#PpmsConnection-773"><span class="linenos"> 773</span></a>        <span class="n">user</span> <span class="o">=</span> <span class="n">PpmsUser</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</span><span id="PpmsConnection-774"><a href="#PpmsConnection-774"><span class="linenos"> 774</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="p">[</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">]</span> <span class="o">=</span> <span class="n">user</span>  <span class="c1"># update / add to the cached user objs</span>
</span><span id="PpmsConnection-775"><a href="#PpmsConnection-775"><span class="linenos"> 775</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fullname_mapping</span><span class="p">[</span><span class="n">user</span><span class="o">.</span><span class="n">fullname</span><span class="p">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span>
</span><span id="PpmsConnection-776"><a href="#PpmsConnection-776"><span class="linenos"> 776</span></a>        <span class="k">return</span> <span class="n">user</span>
</span><span id="PpmsConnection-777"><a href="#PpmsConnection-777"><span class="linenos"> 777</span></a>
</span><span id="PpmsConnection-778"><a href="#PpmsConnection-778"><span class="linenos"> 778</span></a>    <span class="k">def</span> <span class="nf">get_user_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">login_name</span><span class="p">,</span> <span class="n">skip_cache</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="PpmsConnection-779"><a href="#PpmsConnection-779"><span class="linenos"> 779</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get details on a given user from PPMS.</span>
</span><span id="PpmsConnection-780"><a href="#PpmsConnection-780"><span class="linenos"> 780</span></a>
</span><span id="PpmsConnection-781"><a href="#PpmsConnection-781"><span class="linenos"> 781</span></a><span class="sd">        Parameters</span>
</span><span id="PpmsConnection-782"><a href="#PpmsConnection-782"><span class="linenos"> 782</span></a><span class="sd">        ----------</span>
</span><span id="PpmsConnection-783"><a href="#PpmsConnection-783"><span class="linenos"> 783</span></a><span class="sd">        login_name : str</span>
</span><span id="PpmsConnection-784"><a href="#PpmsConnection-784"><span class="linenos"> 784</span></a><span class="sd">            The PPMS account / login name of the user to query.</span>
</span><span id="PpmsConnection-785"><a href="#PpmsConnection-785"><span class="linenos"> 785</span></a><span class="sd">        skip_cache : bool, optional</span>
</span><span id="PpmsConnection-786"><a href="#PpmsConnection-786"><span class="linenos"> 786</span></a><span class="sd">            Passed as-is to the :py:meth:`request()` method</span>
</span><span id="PpmsConnection-787"><a href="#PpmsConnection-787"><span class="linenos"> 787</span></a>
</span><span id="PpmsConnection-788"><a href="#PpmsConnection-788"><span class="linenos"> 788</span></a><span class="sd">        Returns</span>
</span><span id="PpmsConnection-789"><a href="#PpmsConnection-789"><span class="linenos"> 789</span></a><span class="sd">        -------</span>
</span><span id="PpmsConnection-790"><a href="#PpmsConnection-790"><span class="linenos"> 790</span></a><span class="sd">        dict</span>
</span><span id="PpmsConnection-791"><a href="#PpmsConnection-791"><span class="linenos"> 791</span></a><span class="sd">            A dict with the user details returned by the PUMAPI.</span>
</span><span id="PpmsConnection-792"><a href="#PpmsConnection-792"><span class="linenos"> 792</span></a>
</span><span id="PpmsConnection-793"><a href="#PpmsConnection-793"><span class="linenos"> 793</span></a><span class="sd">        Example</span>
</span><span id="PpmsConnection-794"><a href="#PpmsConnection-794"><span class="linenos"> 794</span></a><span class="sd">        -------</span>
</span><span id="PpmsConnection-795"><a href="#PpmsConnection-795"><span class="linenos"> 795</span></a><span class="sd">        &gt;&gt;&gt; conn.get_user_dict(&#39;pyppms&#39;)</span>
</span><span id="PpmsConnection-796"><a href="#PpmsConnection-796"><span class="linenos"> 796</span></a><span class="sd">        ... {</span>
</span><span id="PpmsConnection-797"><a href="#PpmsConnection-797"><span class="linenos"> 797</span></a><span class="sd">        ...     u&#39;active&#39;: True,</span>
</span><span id="PpmsConnection-798"><a href="#PpmsConnection-798"><span class="linenos"> 798</span></a><span class="sd">        ...     u&#39;affiliation&#39;: u&#39;&#39;,</span>
</span><span id="PpmsConnection-799"><a href="#PpmsConnection-799"><span class="linenos"> 799</span></a><span class="sd">        ...     u&#39;bcode&#39;: u&#39;&#39;,</span>
</span><span id="PpmsConnection-800"><a href="#PpmsConnection-800"><span class="linenos"> 800</span></a><span class="sd">        ...     u&#39;email&#39;: u&#39;pyppms@python-facility.example&#39;,</span>
</span><span id="PpmsConnection-801"><a href="#PpmsConnection-801"><span class="linenos"> 801</span></a><span class="sd">        ...     u&#39;fname&#39;: u&#39;PumAPI&#39;,</span>
</span><span id="PpmsConnection-802"><a href="#PpmsConnection-802"><span class="linenos"> 802</span></a><span class="sd">        ...     u&#39;lname&#39;: u&#39;Python&#39;,</span>
</span><span id="PpmsConnection-803"><a href="#PpmsConnection-803"><span class="linenos"> 803</span></a><span class="sd">        ...     u&#39;login&#39;: u&#39;pyppms&#39;,</span>
</span><span id="PpmsConnection-804"><a href="#PpmsConnection-804"><span class="linenos"> 804</span></a><span class="sd">        ...     u&#39;mustchbcode&#39;: False,</span>
</span><span id="PpmsConnection-805"><a href="#PpmsConnection-805"><span class="linenos"> 805</span></a><span class="sd">        ...     u&#39;mustchpwd&#39;: False&#39;,</span>
</span><span id="PpmsConnection-806"><a href="#PpmsConnection-806"><span class="linenos"> 806</span></a><span class="sd">        ...     u&#39;phone&#39;: u&#39;+98 (76) 54 3210&#39;,</span>
</span><span id="PpmsConnection-807"><a href="#PpmsConnection-807"><span class="linenos"> 807</span></a><span class="sd">        ...     u&#39;unitlogin&#39;: u&#39;pyppms&#39;</span>
</span><span id="PpmsConnection-808"><a href="#PpmsConnection-808"><span class="linenos"> 808</span></a><span class="sd">        ... }</span>
</span><span id="PpmsConnection-809"><a href="#PpmsConnection-809"><span class="linenos"> 809</span></a>
</span><span id="PpmsConnection-810"><a href="#PpmsConnection-810"><span class="linenos"> 810</span></a><span class="sd">        Raises</span>
</span><span id="PpmsConnection-811"><a href="#PpmsConnection-811"><span class="linenos"> 811</span></a><span class="sd">        ------</span>
</span><span id="PpmsConnection-812"><a href="#PpmsConnection-812"><span class="linenos"> 812</span></a><span class="sd">        KeyError</span>
</span><span id="PpmsConnection-813"><a href="#PpmsConnection-813"><span class="linenos"> 813</span></a><span class="sd">            Raised in case the user account is unknown to PPMS.</span>
</span><span id="PpmsConnection-814"><a href="#PpmsConnection-814"><span class="linenos"> 814</span></a><span class="sd">        ValueError</span>
</span><span id="PpmsConnection-815"><a href="#PpmsConnection-815"><span class="linenos"> 815</span></a><span class="sd">            Raised if the user details can&#39;t be parsed from the PUMAPI response.</span>
</span><span id="PpmsConnection-816"><a href="#PpmsConnection-816"><span class="linenos"> 816</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PpmsConnection-817"><a href="#PpmsConnection-817"><span class="linenos"> 817</span></a>        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;getuser&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;login&quot;</span><span class="p">:</span> <span class="n">login_name</span><span class="p">},</span> <span class="n">skip_cache</span><span class="o">=</span><span class="n">skip_cache</span><span class="p">)</span>
</span><span id="PpmsConnection-818"><a href="#PpmsConnection-818"><span class="linenos"> 818</span></a>
</span><span id="PpmsConnection-819"><a href="#PpmsConnection-819"><span class="linenos"> 819</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
</span><span id="PpmsConnection-820"><a href="#PpmsConnection-820"><span class="linenos"> 820</span></a>            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;User [</span><span class="si">{</span><span class="n">login_name</span><span class="si">}</span><span class="s2">] is unknown to PPMS&quot;</span>
</span><span id="PpmsConnection-821"><a href="#PpmsConnection-821"><span class="linenos"> 821</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="PpmsConnection-822"><a href="#PpmsConnection-822"><span class="linenos"> 822</span></a>            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="PpmsConnection-823"><a href="#PpmsConnection-823"><span class="linenos"> 823</span></a>
</span><span id="PpmsConnection-824"><a href="#PpmsConnection-824"><span class="linenos"> 824</span></a>        <span class="c1"># EXAMPLE:</span>
</span><span id="PpmsConnection-825"><a href="#PpmsConnection-825"><span class="linenos"> 825</span></a>        <span class="c1"># response.text = (</span>
</span><span id="PpmsConnection-826"><a href="#PpmsConnection-826"><span class="linenos"> 826</span></a>        <span class="c1">#     u&#39;login,lname,fname,email,&#39;</span>
</span><span id="PpmsConnection-827"><a href="#PpmsConnection-827"><span class="linenos"> 827</span></a>        <span class="c1">#     u&#39;phone,bcode,affiliation,unitlogin,mustchpwd,mustchbcode,&#39;</span>
</span><span id="PpmsConnection-828"><a href="#PpmsConnection-828"><span class="linenos"> 828</span></a>        <span class="c1">#     u&#39;active\r\n&#39;</span>
</span><span id="PpmsConnection-829"><a href="#PpmsConnection-829"><span class="linenos"> 829</span></a>        <span class="c1">#     u&#39;&quot;pyppms&quot;,&quot;Python&quot;,&quot;PumAPI&quot;,&quot;pyppms@python-facility.example&quot;,&#39;</span>
</span><span id="PpmsConnection-830"><a href="#PpmsConnection-830"><span class="linenos"> 830</span></a>        <span class="c1">#     u&#39;&quot;+98 (76) 54 3210&quot;,&quot;&quot;,&quot;&quot;,&quot;pyppms&quot;,false,false,&#39;</span>
</span><span id="PpmsConnection-831"><a href="#PpmsConnection-831"><span class="linenos"> 831</span></a>        <span class="c1">#     u&#39;true\r\n&#39;</span>
</span><span id="PpmsConnection-832"><a href="#PpmsConnection-832"><span class="linenos"> 832</span></a>        <span class="c1"># )</span>
</span><span id="PpmsConnection-833"><a href="#PpmsConnection-833"><span class="linenos"> 833</span></a>        <span class="n">details</span> <span class="o">=</span> <span class="n">dict_from_single_response</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</span><span id="PpmsConnection-834"><a href="#PpmsConnection-834"><span class="linenos"> 834</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s2">&quot;Details for user [</span><span class="si">{}</span><span class="s2">]: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">login_name</span><span class="p">,</span> <span class="n">details</span><span class="p">)</span>
</span><span id="PpmsConnection-835"><a href="#PpmsConnection-835"><span class="linenos"> 835</span></a>        <span class="k">return</span> <span class="n">details</span>
</span><span id="PpmsConnection-836"><a href="#PpmsConnection-836"><span class="linenos"> 836</span></a>
</span><span id="PpmsConnection-837"><a href="#PpmsConnection-837"><span class="linenos"> 837</span></a>    <span class="k">def</span> <span class="nf">get_user_experience</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">login</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">system_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="PpmsConnection-838"><a href="#PpmsConnection-838"><span class="linenos"> 838</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get user experience (&quot;User rights&quot;) from PPMS.</span>
</span><span id="PpmsConnection-839"><a href="#PpmsConnection-839"><span class="linenos"> 839</span></a>
</span><span id="PpmsConnection-840"><a href="#PpmsConnection-840"><span class="linenos"> 840</span></a><span class="sd">        Parameters</span>
</span><span id="PpmsConnection-841"><a href="#PpmsConnection-841"><span class="linenos"> 841</span></a><span class="sd">        ----------</span>
</span><span id="PpmsConnection-842"><a href="#PpmsConnection-842"><span class="linenos"> 842</span></a><span class="sd">        login : str, optional</span>
</span><span id="PpmsConnection-843"><a href="#PpmsConnection-843"><span class="linenos"> 843</span></a><span class="sd">            An optional login name to request the experience / permissions for,</span>
</span><span id="PpmsConnection-844"><a href="#PpmsConnection-844"><span class="linenos"> 844</span></a><span class="sd">            by default None</span>
</span><span id="PpmsConnection-845"><a href="#PpmsConnection-845"><span class="linenos"> 845</span></a><span class="sd">        system_id : int, optional</span>
</span><span id="PpmsConnection-846"><a href="#PpmsConnection-846"><span class="linenos"> 846</span></a><span class="sd">            An optional system ID to request the experience / permissions for,</span>
</span><span id="PpmsConnection-847"><a href="#PpmsConnection-847"><span class="linenos"> 847</span></a><span class="sd">            by default None</span>
</span><span id="PpmsConnection-848"><a href="#PpmsConnection-848"><span class="linenos"> 848</span></a>
</span><span id="PpmsConnection-849"><a href="#PpmsConnection-849"><span class="linenos"> 849</span></a><span class="sd">        Returns</span>
</span><span id="PpmsConnection-850"><a href="#PpmsConnection-850"><span class="linenos"> 850</span></a><span class="sd">        -------</span>
</span><span id="PpmsConnection-851"><a href="#PpmsConnection-851"><span class="linenos"> 851</span></a><span class="sd">        list(dict)</span>
</span><span id="PpmsConnection-852"><a href="#PpmsConnection-852"><span class="linenos"> 852</span></a><span class="sd">            A list with dicts parsed from the user experience response.</span>
</span><span id="PpmsConnection-853"><a href="#PpmsConnection-853"><span class="linenos"> 853</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PpmsConnection-854"><a href="#PpmsConnection-854"><span class="linenos"> 854</span></a>        <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="PpmsConnection-855"><a href="#PpmsConnection-855"><span class="linenos"> 855</span></a>        <span class="k">if</span> <span class="n">login</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="PpmsConnection-856"><a href="#PpmsConnection-856"><span class="linenos"> 856</span></a>            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;login&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">login</span>
</span><span id="PpmsConnection-857"><a href="#PpmsConnection-857"><span class="linenos"> 857</span></a>        <span class="k">if</span> <span class="n">system_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="PpmsConnection-858"><a href="#PpmsConnection-858"><span class="linenos"> 858</span></a>            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">system_id</span>
</span><span id="PpmsConnection-859"><a href="#PpmsConnection-859"><span class="linenos"> 859</span></a>        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;getuserexp&quot;</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
</span><span id="PpmsConnection-860"><a href="#PpmsConnection-860"><span class="linenos"> 860</span></a>
</span><span id="PpmsConnection-861"><a href="#PpmsConnection-861"><span class="linenos"> 861</span></a>        <span class="n">parsed</span> <span class="o">=</span> <span class="n">parse_multiline_response</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</span><span id="PpmsConnection-862"><a href="#PpmsConnection-862"><span class="linenos"> 862</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span>
</span><span id="PpmsConnection-863"><a href="#PpmsConnection-863"><span class="linenos"> 863</span></a>            <span class="s2">&quot;Received </span><span class="si">{}</span><span class="s2"> experience entries for filters [user:</span><span class="si">{}</span><span class="s2">] and [id:</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="p">,</span>
</span><span id="PpmsConnection-864"><a href="#PpmsConnection-864"><span class="linenos"> 864</span></a>            <span class="nb">len</span><span class="p">(</span><span class="n">parsed</span><span class="p">),</span>
</span><span id="PpmsConnection-865"><a href="#PpmsConnection-865"><span class="linenos"> 865</span></a>            <span class="n">login</span><span class="p">,</span>
</span><span id="PpmsConnection-866"><a href="#PpmsConnection-866"><span class="linenos"> 866</span></a>            <span class="n">system_id</span><span class="p">,</span>
</span><span id="PpmsConnection-867"><a href="#PpmsConnection-867"><span class="linenos"> 867</span></a>        <span class="p">)</span>
</span><span id="PpmsConnection-868"><a href="#PpmsConnection-868"><span class="linenos"> 868</span></a>        <span class="k">return</span> <span class="n">parsed</span>
</span><span id="PpmsConnection-869"><a href="#PpmsConnection-869"><span class="linenos"> 869</span></a>
</span><span id="PpmsConnection-870"><a href="#PpmsConnection-870"><span class="linenos"> 870</span></a>    <span class="k">def</span> <span class="nf">get_user_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="PpmsConnection-871"><a href="#PpmsConnection-871"><span class="linenos"> 871</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get a list with all user IDs in the PPMS system.</span>
</span><span id="PpmsConnection-872"><a href="#PpmsConnection-872"><span class="linenos"> 872</span></a>
</span><span id="PpmsConnection-873"><a href="#PpmsConnection-873"><span class="linenos"> 873</span></a><span class="sd">        Parameters</span>
</span><span id="PpmsConnection-874"><a href="#PpmsConnection-874"><span class="linenos"> 874</span></a><span class="sd">        ----------</span>
</span><span id="PpmsConnection-875"><a href="#PpmsConnection-875"><span class="linenos"> 875</span></a><span class="sd">        active : bool, optional</span>
</span><span id="PpmsConnection-876"><a href="#PpmsConnection-876"><span class="linenos"> 876</span></a><span class="sd">            Request only users marked as active in PPMS, by default False.</span>
</span><span id="PpmsConnection-877"><a href="#PpmsConnection-877"><span class="linenos"> 877</span></a><span class="sd">            NOTE: &quot;active&quot; is a tri-state parameter in PPMS: &quot;true&quot;, &quot;false&quot;</span>
</span><span id="PpmsConnection-878"><a href="#PpmsConnection-878"><span class="linenos"> 878</span></a><span class="sd">            or empty!</span>
</span><span id="PpmsConnection-879"><a href="#PpmsConnection-879"><span class="linenos"> 879</span></a>
</span><span id="PpmsConnection-880"><a href="#PpmsConnection-880"><span class="linenos"> 880</span></a><span class="sd">        Returns</span>
</span><span id="PpmsConnection-881"><a href="#PpmsConnection-881"><span class="linenos"> 881</span></a><span class="sd">        -------</span>
</span><span id="PpmsConnection-882"><a href="#PpmsConnection-882"><span class="linenos"> 882</span></a><span class="sd">        list</span>
</span><span id="PpmsConnection-883"><a href="#PpmsConnection-883"><span class="linenos"> 883</span></a><span class="sd">            A list of all (or active-only) user IDs in PPMS.</span>
</span><span id="PpmsConnection-884"><a href="#PpmsConnection-884"><span class="linenos"> 884</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PpmsConnection-885"><a href="#PpmsConnection-885"><span class="linenos"> 885</span></a>        <span class="c1"># TODO: describe format of returned list and / or give an example!</span>
</span><span id="PpmsConnection-886"><a href="#PpmsConnection-886"><span class="linenos"> 886</span></a>        <span class="n">parameters</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="PpmsConnection-887"><a href="#PpmsConnection-887"><span class="linenos"> 887</span></a>        <span class="k">if</span> <span class="n">active</span><span class="p">:</span>
</span><span id="PpmsConnection-888"><a href="#PpmsConnection-888"><span class="linenos"> 888</span></a>            <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;active&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;true&quot;</span>
</span><span id="PpmsConnection-889"><a href="#PpmsConnection-889"><span class="linenos"> 889</span></a>
</span><span id="PpmsConnection-890"><a href="#PpmsConnection-890"><span class="linenos"> 890</span></a>        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;getusers&quot;</span><span class="p">,</span> <span class="n">parameters</span><span class="p">)</span>
</span><span id="PpmsConnection-891"><a href="#PpmsConnection-891"><span class="linenos"> 891</span></a>
</span><span id="PpmsConnection-892"><a href="#PpmsConnection-892"><span class="linenos"> 892</span></a>        <span class="n">users</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
</span><span id="PpmsConnection-893"><a href="#PpmsConnection-893"><span class="linenos"> 893</span></a>        <span class="n">active_desc</span> <span class="o">=</span> <span class="s2">&quot;active &quot;</span> <span class="k">if</span> <span class="n">active</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
</span><span id="PpmsConnection-894"><a href="#PpmsConnection-894"><span class="linenos"> 894</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">users in the PPMS database&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">users</span><span class="p">),</span> <span class="n">active_desc</span><span class="p">)</span>
</span><span id="PpmsConnection-895"><a href="#PpmsConnection-895"><span class="linenos"> 895</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">users</span><span class="p">))</span>
</span><span id="PpmsConnection-896"><a href="#PpmsConnection-896"><span class="linenos"> 896</span></a>        <span class="k">return</span> <span class="n">users</span>
</span><span id="PpmsConnection-897"><a href="#PpmsConnection-897"><span class="linenos"> 897</span></a>
</span><span id="PpmsConnection-898"><a href="#PpmsConnection-898"><span class="linenos"> 898</span></a>    <span class="k">def</span> <span class="nf">get_users</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force_refresh</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">active_only</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="PpmsConnection-899"><a href="#PpmsConnection-899"><span class="linenos"> 899</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get user objects for all (or cached) PPMS users.</span>
</span><span id="PpmsConnection-900"><a href="#PpmsConnection-900"><span class="linenos"> 900</span></a>
</span><span id="PpmsConnection-901"><a href="#PpmsConnection-901"><span class="linenos"> 901</span></a><span class="sd">        Parameters</span>
</span><span id="PpmsConnection-902"><a href="#PpmsConnection-902"><span class="linenos"> 902</span></a><span class="sd">        ----------</span>
</span><span id="PpmsConnection-903"><a href="#PpmsConnection-903"><span class="linenos"> 903</span></a><span class="sd">        force_refresh : bool, optional</span>
</span><span id="PpmsConnection-904"><a href="#PpmsConnection-904"><span class="linenos"> 904</span></a><span class="sd">            Re-request information from PPMS even if user details have been</span>
</span><span id="PpmsConnection-905"><a href="#PpmsConnection-905"><span class="linenos"> 905</span></a><span class="sd">            cached locally before, by default False.</span>
</span><span id="PpmsConnection-906"><a href="#PpmsConnection-906"><span class="linenos"> 906</span></a><span class="sd">        active_only : bool, optional</span>
</span><span id="PpmsConnection-907"><a href="#PpmsConnection-907"><span class="linenos"> 907</span></a><span class="sd">            If set to `False` also &quot;inactive&quot; users will be fetched from PPMS,</span>
</span><span id="PpmsConnection-908"><a href="#PpmsConnection-908"><span class="linenos"> 908</span></a><span class="sd">            by default `True`.</span>
</span><span id="PpmsConnection-909"><a href="#PpmsConnection-909"><span class="linenos"> 909</span></a>
</span><span id="PpmsConnection-910"><a href="#PpmsConnection-910"><span class="linenos"> 910</span></a><span class="sd">        Returns</span>
</span><span id="PpmsConnection-911"><a href="#PpmsConnection-911"><span class="linenos"> 911</span></a><span class="sd">        -------</span>
</span><span id="PpmsConnection-912"><a href="#PpmsConnection-912"><span class="linenos"> 912</span></a><span class="sd">        dict(pyppms.user.PpmsUser)</span>
</span><span id="PpmsConnection-913"><a href="#PpmsConnection-913"><span class="linenos"> 913</span></a><span class="sd">            A dict of PpmsUser objects with the username (login) as key.</span>
</span><span id="PpmsConnection-914"><a href="#PpmsConnection-914"><span class="linenos"> 914</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PpmsConnection-915"><a href="#PpmsConnection-915"><span class="linenos"> 915</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">users</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">force_refresh</span><span class="p">:</span>
</span><span id="PpmsConnection-916"><a href="#PpmsConnection-916"><span class="linenos"> 916</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s2">&quot;Using cached details for </span><span class="si">{}</span><span class="s2"> users&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="p">))</span>
</span><span id="PpmsConnection-917"><a href="#PpmsConnection-917"><span class="linenos"> 917</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="PpmsConnection-918"><a href="#PpmsConnection-918"><span class="linenos"> 918</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">update_users</span><span class="p">(</span><span class="n">active_only</span><span class="o">=</span><span class="n">active_only</span><span class="p">)</span>
</span><span id="PpmsConnection-919"><a href="#PpmsConnection-919"><span class="linenos"> 919</span></a>
</span><span id="PpmsConnection-920"><a href="#PpmsConnection-920"><span class="linenos"> 920</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">users</span>
</span><span id="PpmsConnection-921"><a href="#PpmsConnection-921"><span class="linenos"> 921</span></a>
</span><span id="PpmsConnection-922"><a href="#PpmsConnection-922"><span class="linenos"> 922</span></a>    <span class="k">def</span> <span class="nf">get_users_emails</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">users</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="PpmsConnection-923"><a href="#PpmsConnection-923"><span class="linenos"> 923</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get a list of user email addresses. WARNING - very slow!</span>
</span><span id="PpmsConnection-924"><a href="#PpmsConnection-924"><span class="linenos"> 924</span></a>
</span><span id="PpmsConnection-925"><a href="#PpmsConnection-925"><span class="linenos"> 925</span></a><span class="sd">        Parameters</span>
</span><span id="PpmsConnection-926"><a href="#PpmsConnection-926"><span class="linenos"> 926</span></a><span class="sd">        ----------</span>
</span><span id="PpmsConnection-927"><a href="#PpmsConnection-927"><span class="linenos"> 927</span></a><span class="sd">        users : list(str), optional</span>
</span><span id="PpmsConnection-928"><a href="#PpmsConnection-928"><span class="linenos"> 928</span></a><span class="sd">            A list of login names to retrieve the email addresses for, if</span>
</span><span id="PpmsConnection-929"><a href="#PpmsConnection-929"><span class="linenos"> 929</span></a><span class="sd">            omitted addresses for all (or active ones) will be requested.</span>
</span><span id="PpmsConnection-930"><a href="#PpmsConnection-930"><span class="linenos"> 930</span></a><span class="sd">        active : bool, optional</span>
</span><span id="PpmsConnection-931"><a href="#PpmsConnection-931"><span class="linenos"> 931</span></a><span class="sd">            Request only addresses of users marked as active in PPMS, by default</span>
</span><span id="PpmsConnection-932"><a href="#PpmsConnection-932"><span class="linenos"> 932</span></a><span class="sd">            False. Will be ignored if a list of usernames is given explicitly.</span>
</span><span id="PpmsConnection-933"><a href="#PpmsConnection-933"><span class="linenos"> 933</span></a>
</span><span id="PpmsConnection-934"><a href="#PpmsConnection-934"><span class="linenos"> 934</span></a><span class="sd">        Returns</span>
</span><span id="PpmsConnection-935"><a href="#PpmsConnection-935"><span class="linenos"> 935</span></a><span class="sd">        -------</span>
</span><span id="PpmsConnection-936"><a href="#PpmsConnection-936"><span class="linenos"> 936</span></a><span class="sd">        list(str)</span>
</span><span id="PpmsConnection-937"><a href="#PpmsConnection-937"><span class="linenos"> 937</span></a><span class="sd">            Email addresses of the users requested.</span>
</span><span id="PpmsConnection-938"><a href="#PpmsConnection-938"><span class="linenos"> 938</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PpmsConnection-939"><a href="#PpmsConnection-939"><span class="linenos"> 939</span></a>        <span class="n">emails</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="PpmsConnection-940"><a href="#PpmsConnection-940"><span class="linenos"> 940</span></a>        <span class="k">if</span> <span class="n">users</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="PpmsConnection-941"><a href="#PpmsConnection-941"><span class="linenos"> 941</span></a>            <span class="n">users</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_ids</span><span class="p">(</span><span class="n">active</span><span class="o">=</span><span class="n">active</span><span class="p">)</span>
</span><span id="PpmsConnection-942"><a href="#PpmsConnection-942"><span class="linenos"> 942</span></a>        <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">users</span><span class="p">:</span>
</span><span id="PpmsConnection-943"><a href="#PpmsConnection-943"><span class="linenos"> 943</span></a>            <span class="n">email</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_dict</span><span class="p">(</span><span class="n">user</span><span class="p">)[</span><span class="s2">&quot;email&quot;</span><span class="p">]</span>
</span><span id="PpmsConnection-944"><a href="#PpmsConnection-944"><span class="linenos"> 944</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">email</span><span class="p">:</span>
</span><span id="PpmsConnection-945"><a href="#PpmsConnection-945"><span class="linenos"> 945</span></a>                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;--- WARNING: no email for user [</span><span class="si">{}</span><span class="s2">]! ---&quot;</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
</span><span id="PpmsConnection-946"><a href="#PpmsConnection-946"><span class="linenos"> 946</span></a>                <span class="k">continue</span>
</span><span id="PpmsConnection-947"><a href="#PpmsConnection-947"><span class="linenos"> 947</span></a>            <span class="c1"># log.trace(&quot;{}: {}&quot;, user, email)</span>
</span><span id="PpmsConnection-948"><a href="#PpmsConnection-948"><span class="linenos"> 948</span></a>            <span class="n">emails</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
</span><span id="PpmsConnection-949"><a href="#PpmsConnection-949"><span class="linenos"> 949</span></a>
</span><span id="PpmsConnection-950"><a href="#PpmsConnection-950"><span class="linenos"> 950</span></a>        <span class="k">return</span> <span class="n">emails</span>
</span><span id="PpmsConnection-951"><a href="#PpmsConnection-951"><span class="linenos"> 951</span></a>
</span><span id="PpmsConnection-952"><a href="#PpmsConnection-952"><span class="linenos"> 952</span></a>    <span class="k">def</span> <span class="nf">get_users_with_access_to_system</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">system_id</span><span class="p">):</span>
</span><span id="PpmsConnection-953"><a href="#PpmsConnection-953"><span class="linenos"> 953</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get a list of usernames allowed to book the system with the given ID.</span>
</span><span id="PpmsConnection-954"><a href="#PpmsConnection-954"><span class="linenos"> 954</span></a>
</span><span id="PpmsConnection-955"><a href="#PpmsConnection-955"><span class="linenos"> 955</span></a><span class="sd">        Parameters</span>
</span><span id="PpmsConnection-956"><a href="#PpmsConnection-956"><span class="linenos"> 956</span></a><span class="sd">        ----------</span>
</span><span id="PpmsConnection-957"><a href="#PpmsConnection-957"><span class="linenos"> 957</span></a><span class="sd">        system_id : int or int-like</span>
</span><span id="PpmsConnection-958"><a href="#PpmsConnection-958"><span class="linenos"> 958</span></a><span class="sd">            The ID of the system to query permitted users for.</span>
</span><span id="PpmsConnection-959"><a href="#PpmsConnection-959"><span class="linenos"> 959</span></a>
</span><span id="PpmsConnection-960"><a href="#PpmsConnection-960"><span class="linenos"> 960</span></a><span class="sd">        Returns</span>
</span><span id="PpmsConnection-961"><a href="#PpmsConnection-961"><span class="linenos"> 961</span></a><span class="sd">        -------</span>
</span><span id="PpmsConnection-962"><a href="#PpmsConnection-962"><span class="linenos"> 962</span></a><span class="sd">        list(str)</span>
</span><span id="PpmsConnection-963"><a href="#PpmsConnection-963"><span class="linenos"> 963</span></a><span class="sd">            A list of usernames (&#39;login&#39;) with permissions to book the system</span>
</span><span id="PpmsConnection-964"><a href="#PpmsConnection-964"><span class="linenos"> 964</span></a><span class="sd">            with the given ID in PPMS.</span>
</span><span id="PpmsConnection-965"><a href="#PpmsConnection-965"><span class="linenos"> 965</span></a>
</span><span id="PpmsConnection-966"><a href="#PpmsConnection-966"><span class="linenos"> 966</span></a><span class="sd">        Raises</span>
</span><span id="PpmsConnection-967"><a href="#PpmsConnection-967"><span class="linenos"> 967</span></a><span class="sd">        ------</span>
</span><span id="PpmsConnection-968"><a href="#PpmsConnection-968"><span class="linenos"> 968</span></a><span class="sd">        ValueError</span>
</span><span id="PpmsConnection-969"><a href="#PpmsConnection-969"><span class="linenos"> 969</span></a><span class="sd">            Raised in case parsing the response failes for any reason.</span>
</span><span id="PpmsConnection-970"><a href="#PpmsConnection-970"><span class="linenos"> 970</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PpmsConnection-971"><a href="#PpmsConnection-971"><span class="linenos"> 971</span></a>        <span class="n">users</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="PpmsConnection-972"><a href="#PpmsConnection-972"><span class="linenos"> 972</span></a>
</span><span id="PpmsConnection-973"><a href="#PpmsConnection-973"><span class="linenos"> 973</span></a>        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;getsysrights&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">system_id</span><span class="p">})</span>
</span><span id="PpmsConnection-974"><a href="#PpmsConnection-974"><span class="linenos"> 974</span></a>        <span class="c1"># this response has a unique format, so parse it directly here:</span>
</span><span id="PpmsConnection-975"><a href="#PpmsConnection-975"><span class="linenos"> 975</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="PpmsConnection-976"><a href="#PpmsConnection-976"><span class="linenos"> 976</span></a>            <span class="n">lines</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
</span><span id="PpmsConnection-977"><a href="#PpmsConnection-977"><span class="linenos"> 977</span></a>            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
</span><span id="PpmsConnection-978"><a href="#PpmsConnection-978"><span class="linenos"> 978</span></a>                <span class="n">permission</span><span class="p">,</span> <span class="n">username</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
</span><span id="PpmsConnection-979"><a href="#PpmsConnection-979"><span class="linenos"> 979</span></a>                <span class="k">if</span> <span class="n">permission</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;D&quot;</span><span class="p">:</span>
</span><span id="PpmsConnection-980"><a href="#PpmsConnection-980"><span class="linenos"> 980</span></a>                    <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span>
</span><span id="PpmsConnection-981"><a href="#PpmsConnection-981"><span class="linenos"> 981</span></a>                        <span class="s2">&quot;User [</span><span class="si">{}</span><span class="s2">] is deactivated for booking system [</span><span class="si">{}</span><span class="s2">], skipping&quot;</span><span class="p">,</span>
</span><span id="PpmsConnection-982"><a href="#PpmsConnection-982"><span class="linenos"> 982</span></a>                        <span class="n">username</span><span class="p">,</span>
</span><span id="PpmsConnection-983"><a href="#PpmsConnection-983"><span class="linenos"> 983</span></a>                        <span class="n">system_id</span><span class="p">,</span>
</span><span id="PpmsConnection-984"><a href="#PpmsConnection-984"><span class="linenos"> 984</span></a>                    <span class="p">)</span>
</span><span id="PpmsConnection-985"><a href="#PpmsConnection-985"><span class="linenos"> 985</span></a>                    <span class="k">continue</span>
</span><span id="PpmsConnection-986"><a href="#PpmsConnection-986"><span class="linenos"> 986</span></a>
</span><span id="PpmsConnection-987"><a href="#PpmsConnection-987"><span class="linenos"> 987</span></a>                <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span>
</span><span id="PpmsConnection-988"><a href="#PpmsConnection-988"><span class="linenos"> 988</span></a>                    <span class="s2">&quot;User [</span><span class="si">{}</span><span class="s2">] has permission to book system [</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">system_id</span>
</span><span id="PpmsConnection-989"><a href="#PpmsConnection-989"><span class="linenos"> 989</span></a>                <span class="p">)</span>
</span><span id="PpmsConnection-990"><a href="#PpmsConnection-990"><span class="linenos"> 990</span></a>                <span class="n">users</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
</span><span id="PpmsConnection-991"><a href="#PpmsConnection-991"><span class="linenos"> 991</span></a>
</span><span id="PpmsConnection-992"><a href="#PpmsConnection-992"><span class="linenos"> 992</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
</span><span id="PpmsConnection-993"><a href="#PpmsConnection-993"><span class="linenos"> 993</span></a>            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="PpmsConnection-994"><a href="#PpmsConnection-994"><span class="linenos"> 994</span></a>                <span class="sa">f</span><span class="s2">&quot;Unable to parse data returned by PUMAPI: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2"> - &quot;</span>
</span><span id="PpmsConnection-995"><a href="#PpmsConnection-995"><span class="linenos"> 995</span></a>                <span class="sa">f</span><span class="s2">&quot;ERROR: </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="PpmsConnection-996"><a href="#PpmsConnection-996"><span class="linenos"> 996</span></a>            <span class="p">)</span>
</span><span id="PpmsConnection-997"><a href="#PpmsConnection-997"><span class="linenos"> 997</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="PpmsConnection-998"><a href="#PpmsConnection-998"><span class="linenos"> 998</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">err</span>
</span><span id="PpmsConnection-999"><a href="#PpmsConnection-999"><span class="linenos"> 999</span></a>
</span><span id="PpmsConnection-1000"><a href="#PpmsConnection-1000"><span class="linenos">1000</span></a>        <span class="k">return</span> <span class="n">users</span>
</span><span id="PpmsConnection-1001"><a href="#PpmsConnection-1001"><span class="linenos">1001</span></a>
</span><span id="PpmsConnection-1002"><a href="#PpmsConnection-1002"><span class="linenos">1002</span></a>    <span class="k">def</span> <span class="nf">give_user_access_to_system</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">system_id</span><span class="p">):</span>
</span><span id="PpmsConnection-1003"><a href="#PpmsConnection-1003"><span class="linenos">1003</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Add permissions for a user to book a given system in PPMS.</span>
</span><span id="PpmsConnection-1004"><a href="#PpmsConnection-1004"><span class="linenos">1004</span></a>
</span><span id="PpmsConnection-1005"><a href="#PpmsConnection-1005"><span class="linenos">1005</span></a><span class="sd">        Parameters</span>
</span><span id="PpmsConnection-1006"><a href="#PpmsConnection-1006"><span class="linenos">1006</span></a><span class="sd">        ----------</span>
</span><span id="PpmsConnection-1007"><a href="#PpmsConnection-1007"><span class="linenos">1007</span></a><span class="sd">        username : str</span>
</span><span id="PpmsConnection-1008"><a href="#PpmsConnection-1008"><span class="linenos">1008</span></a><span class="sd">            The username (&#39;login&#39;) to allow for booking the system.</span>
</span><span id="PpmsConnection-1009"><a href="#PpmsConnection-1009"><span class="linenos">1009</span></a><span class="sd">        system_id : int or int-like</span>
</span><span id="PpmsConnection-1010"><a href="#PpmsConnection-1010"><span class="linenos">1010</span></a><span class="sd">            The ID of the system to add the permission for.</span>
</span><span id="PpmsConnection-1011"><a href="#PpmsConnection-1011"><span class="linenos">1011</span></a>
</span><span id="PpmsConnection-1012"><a href="#PpmsConnection-1012"><span class="linenos">1012</span></a><span class="sd">        Returns</span>
</span><span id="PpmsConnection-1013"><a href="#PpmsConnection-1013"><span class="linenos">1013</span></a><span class="sd">        -------</span>
</span><span id="PpmsConnection-1014"><a href="#PpmsConnection-1014"><span class="linenos">1014</span></a><span class="sd">        bool</span>
</span><span id="PpmsConnection-1015"><a href="#PpmsConnection-1015"><span class="linenos">1015</span></a><span class="sd">            True in case the given username now has the permissions to book the</span>
</span><span id="PpmsConnection-1016"><a href="#PpmsConnection-1016"><span class="linenos">1016</span></a><span class="sd">            system with the specified ID (or if the user already had them</span>
</span><span id="PpmsConnection-1017"><a href="#PpmsConnection-1017"><span class="linenos">1017</span></a><span class="sd">            before), False otherwise.</span>
</span><span id="PpmsConnection-1018"><a href="#PpmsConnection-1018"><span class="linenos">1018</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PpmsConnection-1019"><a href="#PpmsConnection-1019"><span class="linenos">1019</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_system_booking_permissions</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">system_id</span><span class="p">,</span> <span class="s2">&quot;A&quot;</span><span class="p">)</span>
</span><span id="PpmsConnection-1020"><a href="#PpmsConnection-1020"><span class="linenos">1020</span></a>
</span><span id="PpmsConnection-1021"><a href="#PpmsConnection-1021"><span class="linenos">1021</span></a>    <span class="k">def</span> <span class="nf">new_user</span><span class="p">(</span>  <span class="c1"># pylint: disable-msg=too-many-arguments</span>
</span><span id="PpmsConnection-1022"><a href="#PpmsConnection-1022"><span class="linenos">1022</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">login</span><span class="p">,</span> <span class="n">lname</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">ppms_group</span><span class="p">,</span> <span class="n">phone</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="kc">None</span>
</span><span id="PpmsConnection-1023"><a href="#PpmsConnection-1023"><span class="linenos">1023</span></a>    <span class="p">):</span>
</span><span id="PpmsConnection-1024"><a href="#PpmsConnection-1024"><span class="linenos">1024</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a new user in PPMS.</span>
</span><span id="PpmsConnection-1025"><a href="#PpmsConnection-1025"><span class="linenos">1025</span></a>
</span><span id="PpmsConnection-1026"><a href="#PpmsConnection-1026"><span class="linenos">1026</span></a><span class="sd">        The method is asking PPMS to create a new user account with the given details.</span>
</span><span id="PpmsConnection-1027"><a href="#PpmsConnection-1027"><span class="linenos">1027</span></a><span class="sd">        In case an account with that login name already exists, it will log a warning</span>
</span><span id="PpmsConnection-1028"><a href="#PpmsConnection-1028"><span class="linenos">1028</span></a><span class="sd">        and return without sending any further requests to PPMS.</span>
</span><span id="PpmsConnection-1029"><a href="#PpmsConnection-1029"><span class="linenos">1029</span></a>
</span><span id="PpmsConnection-1030"><a href="#PpmsConnection-1030"><span class="linenos">1030</span></a><span class="sd">        Parameters</span>
</span><span id="PpmsConnection-1031"><a href="#PpmsConnection-1031"><span class="linenos">1031</span></a><span class="sd">        ----------</span>
</span><span id="PpmsConnection-1032"><a href="#PpmsConnection-1032"><span class="linenos">1032</span></a><span class="sd">        login : str</span>
</span><span id="PpmsConnection-1033"><a href="#PpmsConnection-1033"><span class="linenos">1033</span></a><span class="sd">            The unique identifier for the user.</span>
</span><span id="PpmsConnection-1034"><a href="#PpmsConnection-1034"><span class="linenos">1034</span></a><span class="sd">        lname : str</span>
</span><span id="PpmsConnection-1035"><a href="#PpmsConnection-1035"><span class="linenos">1035</span></a><span class="sd">            The last name of the user.</span>
</span><span id="PpmsConnection-1036"><a href="#PpmsConnection-1036"><span class="linenos">1036</span></a><span class="sd">        fname : str</span>
</span><span id="PpmsConnection-1037"><a href="#PpmsConnection-1037"><span class="linenos">1037</span></a><span class="sd">            The first name of the user.</span>
</span><span id="PpmsConnection-1038"><a href="#PpmsConnection-1038"><span class="linenos">1038</span></a><span class="sd">        email : str</span>
</span><span id="PpmsConnection-1039"><a href="#PpmsConnection-1039"><span class="linenos">1039</span></a><span class="sd">            The email address of the user.</span>
</span><span id="PpmsConnection-1040"><a href="#PpmsConnection-1040"><span class="linenos">1040</span></a><span class="sd">        ppms_group : str</span>
</span><span id="PpmsConnection-1041"><a href="#PpmsConnection-1041"><span class="linenos">1041</span></a><span class="sd">            The unique identifier of the primary group of the new user. A new group will</span>
</span><span id="PpmsConnection-1042"><a href="#PpmsConnection-1042"><span class="linenos">1042</span></a><span class="sd">            be created if no group with the given name exists.</span>
</span><span id="PpmsConnection-1043"><a href="#PpmsConnection-1043"><span class="linenos">1043</span></a><span class="sd">        phone : str, optional</span>
</span><span id="PpmsConnection-1044"><a href="#PpmsConnection-1044"><span class="linenos">1044</span></a><span class="sd">            The phone number of the user.</span>
</span><span id="PpmsConnection-1045"><a href="#PpmsConnection-1045"><span class="linenos">1045</span></a><span class="sd">        password : str, optional</span>
</span><span id="PpmsConnection-1046"><a href="#PpmsConnection-1046"><span class="linenos">1046</span></a><span class="sd">            The password for the user. If no password is set the user will not be able</span>
</span><span id="PpmsConnection-1047"><a href="#PpmsConnection-1047"><span class="linenos">1047</span></a><span class="sd">            to log on to PPMS.</span>
</span><span id="PpmsConnection-1048"><a href="#PpmsConnection-1048"><span class="linenos">1048</span></a>
</span><span id="PpmsConnection-1049"><a href="#PpmsConnection-1049"><span class="linenos">1049</span></a><span class="sd">        Raises</span>
</span><span id="PpmsConnection-1050"><a href="#PpmsConnection-1050"><span class="linenos">1050</span></a><span class="sd">        ------</span>
</span><span id="PpmsConnection-1051"><a href="#PpmsConnection-1051"><span class="linenos">1051</span></a><span class="sd">        RuntimeError</span>
</span><span id="PpmsConnection-1052"><a href="#PpmsConnection-1052"><span class="linenos">1052</span></a><span class="sd">            Will be raised in case creating the user fails.</span>
</span><span id="PpmsConnection-1053"><a href="#PpmsConnection-1053"><span class="linenos">1053</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PpmsConnection-1054"><a href="#PpmsConnection-1054"><span class="linenos">1054</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_exists</span><span class="p">(</span><span class="n">login</span><span class="p">):</span>
</span><span id="PpmsConnection-1055"><a href="#PpmsConnection-1055"><span class="linenos">1055</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;NOT creating user [</span><span class="si">{}</span><span class="s2">] as it already exists!&quot;</span><span class="p">,</span> <span class="n">login</span><span class="p">)</span>
</span><span id="PpmsConnection-1056"><a href="#PpmsConnection-1056"><span class="linenos">1056</span></a>            <span class="k">return</span>
</span><span id="PpmsConnection-1057"><a href="#PpmsConnection-1057"><span class="linenos">1057</span></a>
</span><span id="PpmsConnection-1058"><a href="#PpmsConnection-1058"><span class="linenos">1058</span></a>        <span class="n">req_data</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="PpmsConnection-1059"><a href="#PpmsConnection-1059"><span class="linenos">1059</span></a>            <span class="s2">&quot;login&quot;</span><span class="p">:</span> <span class="n">login</span><span class="p">,</span>
</span><span id="PpmsConnection-1060"><a href="#PpmsConnection-1060"><span class="linenos">1060</span></a>            <span class="s2">&quot;lname&quot;</span><span class="p">:</span> <span class="n">lname</span><span class="p">,</span>
</span><span id="PpmsConnection-1061"><a href="#PpmsConnection-1061"><span class="linenos">1061</span></a>            <span class="s2">&quot;fname&quot;</span><span class="p">:</span> <span class="n">fname</span><span class="p">,</span>
</span><span id="PpmsConnection-1062"><a href="#PpmsConnection-1062"><span class="linenos">1062</span></a>            <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="n">email</span><span class="p">,</span>
</span><span id="PpmsConnection-1063"><a href="#PpmsConnection-1063"><span class="linenos">1063</span></a>            <span class="s2">&quot;unitlogin&quot;</span><span class="p">:</span> <span class="n">ppms_group</span><span class="p">,</span>
</span><span id="PpmsConnection-1064"><a href="#PpmsConnection-1064"><span class="linenos">1064</span></a>        <span class="p">}</span>
</span><span id="PpmsConnection-1065"><a href="#PpmsConnection-1065"><span class="linenos">1065</span></a>        <span class="k">if</span> <span class="n">phone</span><span class="p">:</span>
</span><span id="PpmsConnection-1066"><a href="#PpmsConnection-1066"><span class="linenos">1066</span></a>            <span class="n">req_data</span><span class="p">[</span><span class="s2">&quot;phone&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">phone</span>
</span><span id="PpmsConnection-1067"><a href="#PpmsConnection-1067"><span class="linenos">1067</span></a>        <span class="k">if</span> <span class="n">password</span><span class="p">:</span>
</span><span id="PpmsConnection-1068"><a href="#PpmsConnection-1068"><span class="linenos">1068</span></a>            <span class="n">req_data</span><span class="p">[</span><span class="s2">&quot;pwd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">password</span>
</span><span id="PpmsConnection-1069"><a href="#PpmsConnection-1069"><span class="linenos">1069</span></a>
</span><span id="PpmsConnection-1070"><a href="#PpmsConnection-1070"><span class="linenos">1070</span></a>        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;newuser&quot;</span><span class="p">,</span> <span class="n">req_data</span><span class="p">)</span>
</span><span id="PpmsConnection-1071"><a href="#PpmsConnection-1071"><span class="linenos">1071</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;OK newuser&quot;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
</span><span id="PpmsConnection-1072"><a href="#PpmsConnection-1072"><span class="linenos">1072</span></a>            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Creating new user failed: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="PpmsConnection-1073"><a href="#PpmsConnection-1073"><span class="linenos">1073</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="PpmsConnection-1074"><a href="#PpmsConnection-1074"><span class="linenos">1074</span></a>            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="PpmsConnection-1075"><a href="#PpmsConnection-1075"><span class="linenos">1075</span></a>
</span><span id="PpmsConnection-1076"><a href="#PpmsConnection-1076"><span class="linenos">1076</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Created user [</span><span class="si">{}</span><span class="s2">] in PPMS.&quot;</span><span class="p">,</span> <span class="n">login</span><span class="p">)</span>
</span><span id="PpmsConnection-1077"><a href="#PpmsConnection-1077"><span class="linenos">1077</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s2">&quot;Response was: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</span><span id="PpmsConnection-1078"><a href="#PpmsConnection-1078"><span class="linenos">1078</span></a>
</span><span id="PpmsConnection-1079"><a href="#PpmsConnection-1079"><span class="linenos">1079</span></a>    <span class="k">def</span> <span class="nf">remove_user_access_from_system</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">system_id</span><span class="p">):</span>
</span><span id="PpmsConnection-1080"><a href="#PpmsConnection-1080"><span class="linenos">1080</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Remove permissions for a user to book a given system in PPMS.</span>
</span><span id="PpmsConnection-1081"><a href="#PpmsConnection-1081"><span class="linenos">1081</span></a>
</span><span id="PpmsConnection-1082"><a href="#PpmsConnection-1082"><span class="linenos">1082</span></a><span class="sd">        Parameters</span>
</span><span id="PpmsConnection-1083"><a href="#PpmsConnection-1083"><span class="linenos">1083</span></a><span class="sd">        ----------</span>
</span><span id="PpmsConnection-1084"><a href="#PpmsConnection-1084"><span class="linenos">1084</span></a><span class="sd">        username : str</span>
</span><span id="PpmsConnection-1085"><a href="#PpmsConnection-1085"><span class="linenos">1085</span></a><span class="sd">            The username (&#39;login&#39;) to remove booking permissions on the system.</span>
</span><span id="PpmsConnection-1086"><a href="#PpmsConnection-1086"><span class="linenos">1086</span></a><span class="sd">        system_id : int or int-like</span>
</span><span id="PpmsConnection-1087"><a href="#PpmsConnection-1087"><span class="linenos">1087</span></a><span class="sd">            The ID of the system to modify the permission for.</span>
</span><span id="PpmsConnection-1088"><a href="#PpmsConnection-1088"><span class="linenos">1088</span></a>
</span><span id="PpmsConnection-1089"><a href="#PpmsConnection-1089"><span class="linenos">1089</span></a><span class="sd">        Returns</span>
</span><span id="PpmsConnection-1090"><a href="#PpmsConnection-1090"><span class="linenos">1090</span></a><span class="sd">        -------</span>
</span><span id="PpmsConnection-1091"><a href="#PpmsConnection-1091"><span class="linenos">1091</span></a><span class="sd">        bool</span>
</span><span id="PpmsConnection-1092"><a href="#PpmsConnection-1092"><span class="linenos">1092</span></a><span class="sd">            True in case the given username now has the permissions to book the</span>
</span><span id="PpmsConnection-1093"><a href="#PpmsConnection-1093"><span class="linenos">1093</span></a><span class="sd">            system with the specified ID (or if the user already had them</span>
</span><span id="PpmsConnection-1094"><a href="#PpmsConnection-1094"><span class="linenos">1094</span></a><span class="sd">            before), False otherwise.</span>
</span><span id="PpmsConnection-1095"><a href="#PpmsConnection-1095"><span class="linenos">1095</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PpmsConnection-1096"><a href="#PpmsConnection-1096"><span class="linenos">1096</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_system_booking_permissions</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">system_id</span><span class="p">,</span> <span class="s2">&quot;D&quot;</span><span class="p">)</span>
</span><span id="PpmsConnection-1097"><a href="#PpmsConnection-1097"><span class="linenos">1097</span></a>
</span><span id="PpmsConnection-1098"><a href="#PpmsConnection-1098"><span class="linenos">1098</span></a>    <span class="k">def</span> <span class="nf">set_system_booking_permissions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">login</span><span class="p">,</span> <span class="n">system_id</span><span class="p">,</span> <span class="n">permission</span><span class="p">):</span>
</span><span id="PpmsConnection-1099"><a href="#PpmsConnection-1099"><span class="linenos">1099</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Set permissions for a user on a given system in PPMS.</span>
</span><span id="PpmsConnection-1100"><a href="#PpmsConnection-1100"><span class="linenos">1100</span></a>
</span><span id="PpmsConnection-1101"><a href="#PpmsConnection-1101"><span class="linenos">1101</span></a><span class="sd">        Parameters</span>
</span><span id="PpmsConnection-1102"><a href="#PpmsConnection-1102"><span class="linenos">1102</span></a><span class="sd">        ----------</span>
</span><span id="PpmsConnection-1103"><a href="#PpmsConnection-1103"><span class="linenos">1103</span></a><span class="sd">        username : str</span>
</span><span id="PpmsConnection-1104"><a href="#PpmsConnection-1104"><span class="linenos">1104</span></a><span class="sd">            The username (&#39;login&#39;) to allow for booking the system.</span>
</span><span id="PpmsConnection-1105"><a href="#PpmsConnection-1105"><span class="linenos">1105</span></a><span class="sd">        system_id : int or int-like</span>
</span><span id="PpmsConnection-1106"><a href="#PpmsConnection-1106"><span class="linenos">1106</span></a><span class="sd">            The ID of the system to add the permission for.</span>
</span><span id="PpmsConnection-1107"><a href="#PpmsConnection-1107"><span class="linenos">1107</span></a><span class="sd">        permission : {&#39;D&#39;, &#39;A&#39;, &#39;N&#39;, &#39;S&#39;}</span>
</span><span id="PpmsConnection-1108"><a href="#PpmsConnection-1108"><span class="linenos">1108</span></a><span class="sd">            The permission level to set for the user, one of:</span>
</span><span id="PpmsConnection-1109"><a href="#PpmsConnection-1109"><span class="linenos">1109</span></a><span class="sd">              - ``D`` : deactivated</span>
</span><span id="PpmsConnection-1110"><a href="#PpmsConnection-1110"><span class="linenos">1110</span></a><span class="sd">              - ``A`` : autonomous</span>
</span><span id="PpmsConnection-1111"><a href="#PpmsConnection-1111"><span class="linenos">1111</span></a><span class="sd">              - ``N`` : novice</span>
</span><span id="PpmsConnection-1112"><a href="#PpmsConnection-1112"><span class="linenos">1112</span></a><span class="sd">              - ``S`` : superuser</span>
</span><span id="PpmsConnection-1113"><a href="#PpmsConnection-1113"><span class="linenos">1113</span></a>
</span><span id="PpmsConnection-1114"><a href="#PpmsConnection-1114"><span class="linenos">1114</span></a><span class="sd">        Returns</span>
</span><span id="PpmsConnection-1115"><a href="#PpmsConnection-1115"><span class="linenos">1115</span></a><span class="sd">        -------</span>
</span><span id="PpmsConnection-1116"><a href="#PpmsConnection-1116"><span class="linenos">1116</span></a><span class="sd">        bool</span>
</span><span id="PpmsConnection-1117"><a href="#PpmsConnection-1117"><span class="linenos">1117</span></a><span class="sd">            True in case setting permissions for the given username on the</span>
</span><span id="PpmsConnection-1118"><a href="#PpmsConnection-1118"><span class="linenos">1118</span></a><span class="sd">            system with the specified ID succeeded (or if the user already had</span>
</span><span id="PpmsConnection-1119"><a href="#PpmsConnection-1119"><span class="linenos">1119</span></a><span class="sd">            those permissions before), False otherwise.</span>
</span><span id="PpmsConnection-1120"><a href="#PpmsConnection-1120"><span class="linenos">1120</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PpmsConnection-1121"><a href="#PpmsConnection-1121"><span class="linenos">1121</span></a>
</span><span id="PpmsConnection-1122"><a href="#PpmsConnection-1122"><span class="linenos">1122</span></a>        <span class="k">def</span> <span class="nf">permission_name</span><span class="p">(</span><span class="n">shortname</span><span class="p">):</span>
</span><span id="PpmsConnection-1123"><a href="#PpmsConnection-1123"><span class="linenos">1123</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;Closure to validate a permission level and return its long name.</span>
</span><span id="PpmsConnection-1124"><a href="#PpmsConnection-1124"><span class="linenos">1124</span></a>
</span><span id="PpmsConnection-1125"><a href="#PpmsConnection-1125"><span class="linenos">1125</span></a><span class="sd">            Parameters</span>
</span><span id="PpmsConnection-1126"><a href="#PpmsConnection-1126"><span class="linenos">1126</span></a><span class="sd">            ----------</span>
</span><span id="PpmsConnection-1127"><a href="#PpmsConnection-1127"><span class="linenos">1127</span></a><span class="sd">            shortname : str</span>
</span><span id="PpmsConnection-1128"><a href="#PpmsConnection-1128"><span class="linenos">1128</span></a><span class="sd">                A single character defining the permission level.</span>
</span><span id="PpmsConnection-1129"><a href="#PpmsConnection-1129"><span class="linenos">1129</span></a>
</span><span id="PpmsConnection-1130"><a href="#PpmsConnection-1130"><span class="linenos">1130</span></a><span class="sd">            Returns</span>
</span><span id="PpmsConnection-1131"><a href="#PpmsConnection-1131"><span class="linenos">1131</span></a><span class="sd">            -------</span>
</span><span id="PpmsConnection-1132"><a href="#PpmsConnection-1132"><span class="linenos">1132</span></a><span class="sd">            str</span>
</span><span id="PpmsConnection-1133"><a href="#PpmsConnection-1133"><span class="linenos">1133</span></a><span class="sd">                The long (human-readable) name of the permission level.</span>
</span><span id="PpmsConnection-1134"><a href="#PpmsConnection-1134"><span class="linenos">1134</span></a>
</span><span id="PpmsConnection-1135"><a href="#PpmsConnection-1135"><span class="linenos">1135</span></a><span class="sd">            Raises</span>
</span><span id="PpmsConnection-1136"><a href="#PpmsConnection-1136"><span class="linenos">1136</span></a><span class="sd">            ------</span>
</span><span id="PpmsConnection-1137"><a href="#PpmsConnection-1137"><span class="linenos">1137</span></a><span class="sd">            KeyError</span>
</span><span id="PpmsConnection-1138"><a href="#PpmsConnection-1138"><span class="linenos">1138</span></a><span class="sd">                Raised in case an invalid permission level was given.</span>
</span><span id="PpmsConnection-1139"><a href="#PpmsConnection-1139"><span class="linenos">1139</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="PpmsConnection-1140"><a href="#PpmsConnection-1140"><span class="linenos">1140</span></a>            <span class="n">mapping</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="PpmsConnection-1141"><a href="#PpmsConnection-1141"><span class="linenos">1141</span></a>                <span class="s2">&quot;D&quot;</span><span class="p">:</span> <span class="s2">&quot;deactivated&quot;</span><span class="p">,</span>
</span><span id="PpmsConnection-1142"><a href="#PpmsConnection-1142"><span class="linenos">1142</span></a>                <span class="s2">&quot;A&quot;</span><span class="p">:</span> <span class="s2">&quot;autonomous&quot;</span><span class="p">,</span>
</span><span id="PpmsConnection-1143"><a href="#PpmsConnection-1143"><span class="linenos">1143</span></a>                <span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="s2">&quot;novice&quot;</span><span class="p">,</span>
</span><span id="PpmsConnection-1144"><a href="#PpmsConnection-1144"><span class="linenos">1144</span></a>                <span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="s2">&quot;superuser&quot;</span><span class="p">,</span>
</span><span id="PpmsConnection-1145"><a href="#PpmsConnection-1145"><span class="linenos">1145</span></a>            <span class="p">}</span>
</span><span id="PpmsConnection-1146"><a href="#PpmsConnection-1146"><span class="linenos">1146</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="PpmsConnection-1147"><a href="#PpmsConnection-1147"><span class="linenos">1147</span></a>                <span class="k">return</span> <span class="n">mapping</span><span class="p">[</span><span class="n">shortname</span><span class="p">]</span>
</span><span id="PpmsConnection-1148"><a href="#PpmsConnection-1148"><span class="linenos">1148</span></a>            <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
</span><span id="PpmsConnection-1149"><a href="#PpmsConnection-1149"><span class="linenos">1149</span></a>                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid permission [</span><span class="si">{</span><span class="n">shortname</span><span class="si">}</span><span class="s2">] given&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">err</span>
</span><span id="PpmsConnection-1150"><a href="#PpmsConnection-1150"><span class="linenos">1150</span></a>
</span><span id="PpmsConnection-1151"><a href="#PpmsConnection-1151"><span class="linenos">1151</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
</span><span id="PpmsConnection-1152"><a href="#PpmsConnection-1152"><span class="linenos">1152</span></a>            <span class="s2">&quot;Setting permission level [</span><span class="si">{}</span><span class="s2">] for user [</span><span class="si">{}</span><span class="s2">] on system [</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="p">,</span>
</span><span id="PpmsConnection-1153"><a href="#PpmsConnection-1153"><span class="linenos">1153</span></a>            <span class="n">permission_name</span><span class="p">(</span><span class="n">permission</span><span class="p">),</span>
</span><span id="PpmsConnection-1154"><a href="#PpmsConnection-1154"><span class="linenos">1154</span></a>            <span class="n">login</span><span class="p">,</span>
</span><span id="PpmsConnection-1155"><a href="#PpmsConnection-1155"><span class="linenos">1155</span></a>            <span class="n">system_id</span><span class="p">,</span>
</span><span id="PpmsConnection-1156"><a href="#PpmsConnection-1156"><span class="linenos">1156</span></a>        <span class="p">)</span>
</span><span id="PpmsConnection-1157"><a href="#PpmsConnection-1157"><span class="linenos">1157</span></a>
</span><span id="PpmsConnection-1158"><a href="#PpmsConnection-1158"><span class="linenos">1158</span></a>        <span class="n">parameters</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">system_id</span><span class="p">,</span> <span class="s2">&quot;login&quot;</span><span class="p">:</span> <span class="n">login</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">permission</span><span class="p">}</span>
</span><span id="PpmsConnection-1159"><a href="#PpmsConnection-1159"><span class="linenos">1159</span></a>        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;setright&quot;</span><span class="p">,</span> <span class="n">parameters</span><span class="p">)</span>
</span><span id="PpmsConnection-1160"><a href="#PpmsConnection-1160"><span class="linenos">1160</span></a>
</span><span id="PpmsConnection-1161"><a href="#PpmsConnection-1161"><span class="linenos">1161</span></a>        <span class="c1"># NOTE: the &#39;setright&#39; action will accept ANY permission type and return &#39;done&#39;</span>
</span><span id="PpmsConnection-1162"><a href="#PpmsConnection-1162"><span class="linenos">1162</span></a>        <span class="c1"># on the request, so there is no way to check from the response if setting the</span>
</span><span id="PpmsConnection-1163"><a href="#PpmsConnection-1163"><span class="linenos">1163</span></a>        <span class="c1"># permission really worked!!</span>
</span><span id="PpmsConnection-1164"><a href="#PpmsConnection-1164"><span class="linenos">1164</span></a>        <span class="c1"># log.trace(&#39;Request returned text: {}&#39;, response.text)</span>
</span><span id="PpmsConnection-1165"><a href="#PpmsConnection-1165"><span class="linenos">1165</span></a>        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;done&quot;</span><span class="p">:</span>
</span><span id="PpmsConnection-1166"><a href="#PpmsConnection-1166"><span class="linenos">1166</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span>
</span><span id="PpmsConnection-1167"><a href="#PpmsConnection-1167"><span class="linenos">1167</span></a>                <span class="s2">&quot;User [</span><span class="si">{}</span><span class="s2">] now has permission level [</span><span class="si">{}</span><span class="s2">] on system [</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="p">,</span>
</span><span id="PpmsConnection-1168"><a href="#PpmsConnection-1168"><span class="linenos">1168</span></a>                <span class="n">login</span><span class="p">,</span>
</span><span id="PpmsConnection-1169"><a href="#PpmsConnection-1169"><span class="linenos">1169</span></a>                <span class="n">permission_name</span><span class="p">(</span><span class="n">permission</span><span class="p">),</span>
</span><span id="PpmsConnection-1170"><a href="#PpmsConnection-1170"><span class="linenos">1170</span></a>                <span class="n">system_id</span><span class="p">,</span>
</span><span id="PpmsConnection-1171"><a href="#PpmsConnection-1171"><span class="linenos">1171</span></a>            <span class="p">)</span>
</span><span id="PpmsConnection-1172"><a href="#PpmsConnection-1172"><span class="linenos">1172</span></a>            <span class="k">return</span> <span class="kc">True</span>
</span><span id="PpmsConnection-1173"><a href="#PpmsConnection-1173"><span class="linenos">1173</span></a>
</span><span id="PpmsConnection-1174"><a href="#PpmsConnection-1174"><span class="linenos">1174</span></a>        <span class="k">if</span> <span class="s2">&quot;invalid user&quot;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
</span><span id="PpmsConnection-1175"><a href="#PpmsConnection-1175"><span class="linenos">1175</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;User [</span><span class="si">{}</span><span class="s2">] doesn&#39;t seem to exist in PPMS&quot;</span><span class="p">,</span> <span class="n">login</span><span class="p">)</span>
</span><span id="PpmsConnection-1176"><a href="#PpmsConnection-1176"><span class="linenos">1176</span></a>        <span class="k">elif</span> <span class="s2">&quot;system right not authorized&quot;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
</span><span id="PpmsConnection-1177"><a href="#PpmsConnection-1177"><span class="linenos">1177</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
</span><span id="PpmsConnection-1178"><a href="#PpmsConnection-1178"><span class="linenos">1178</span></a>                <span class="s2">&quot;Unable to set permissions for system </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">system_id</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span>
</span><span id="PpmsConnection-1179"><a href="#PpmsConnection-1179"><span class="linenos">1179</span></a>            <span class="p">)</span>
</span><span id="PpmsConnection-1180"><a href="#PpmsConnection-1180"><span class="linenos">1180</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="PpmsConnection-1181"><a href="#PpmsConnection-1181"><span class="linenos">1181</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Unexpected response, assuming request failed: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</span><span id="PpmsConnection-1182"><a href="#PpmsConnection-1182"><span class="linenos">1182</span></a>
</span><span id="PpmsConnection-1183"><a href="#PpmsConnection-1183"><span class="linenos">1183</span></a>        <span class="k">return</span> <span class="kc">False</span>
</span><span id="PpmsConnection-1184"><a href="#PpmsConnection-1184"><span class="linenos">1184</span></a>
</span><span id="PpmsConnection-1185"><a href="#PpmsConnection-1185"><span class="linenos">1185</span></a>    <span class="k">def</span> <span class="nf">update_systems</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="PpmsConnection-1186"><a href="#PpmsConnection-1186"><span class="linenos">1186</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Update cached details for all bookable systems from PPMS.</span>
</span><span id="PpmsConnection-1187"><a href="#PpmsConnection-1187"><span class="linenos">1187</span></a>
</span><span id="PpmsConnection-1188"><a href="#PpmsConnection-1188"><span class="linenos">1188</span></a><span class="sd">        Get the details on all bookable systems from PPMS and store them in the local</span>
</span><span id="PpmsConnection-1189"><a href="#PpmsConnection-1189"><span class="linenos">1189</span></a><span class="sd">        cache. If parsing the PUMAPI response for a system fails for any reason, the</span>
</span><span id="PpmsConnection-1190"><a href="#PpmsConnection-1190"><span class="linenos">1190</span></a><span class="sd">        system is skipped entirely.</span>
</span><span id="PpmsConnection-1191"><a href="#PpmsConnection-1191"><span class="linenos">1191</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PpmsConnection-1192"><a href="#PpmsConnection-1192"><span class="linenos">1192</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s2">&quot;Updating list of bookable systems...&quot;</span><span class="p">)</span>
</span><span id="PpmsConnection-1193"><a href="#PpmsConnection-1193"><span class="linenos">1193</span></a>        <span class="n">systems</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="PpmsConnection-1194"><a href="#PpmsConnection-1194"><span class="linenos">1194</span></a>        <span class="n">parse_fails</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="PpmsConnection-1195"><a href="#PpmsConnection-1195"><span class="linenos">1195</span></a>        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;getsystems&quot;</span><span class="p">)</span>
</span><span id="PpmsConnection-1196"><a href="#PpmsConnection-1196"><span class="linenos">1196</span></a>        <span class="n">details</span> <span class="o">=</span> <span class="n">parse_multiline_response</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">graceful</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="PpmsConnection-1197"><a href="#PpmsConnection-1197"><span class="linenos">1197</span></a>        <span class="k">for</span> <span class="n">detail</span> <span class="ow">in</span> <span class="n">details</span><span class="p">:</span>
</span><span id="PpmsConnection-1198"><a href="#PpmsConnection-1198"><span class="linenos">1198</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="PpmsConnection-1199"><a href="#PpmsConnection-1199"><span class="linenos">1199</span></a>                <span class="n">system</span> <span class="o">=</span> <span class="n">PpmsSystem</span><span class="p">(</span><span class="n">detail</span><span class="p">)</span>
</span><span id="PpmsConnection-1200"><a href="#PpmsConnection-1200"><span class="linenos">1200</span></a>            <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
</span><span id="PpmsConnection-1201"><a href="#PpmsConnection-1201"><span class="linenos">1201</span></a>                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error processing `getsystems` response: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
</span><span id="PpmsConnection-1202"><a href="#PpmsConnection-1202"><span class="linenos">1202</span></a>                <span class="n">parse_fails</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="PpmsConnection-1203"><a href="#PpmsConnection-1203"><span class="linenos">1203</span></a>                <span class="k">continue</span>
</span><span id="PpmsConnection-1204"><a href="#PpmsConnection-1204"><span class="linenos">1204</span></a>
</span><span id="PpmsConnection-1205"><a href="#PpmsConnection-1205"><span class="linenos">1205</span></a>            <span class="n">systems</span><span class="p">[</span><span class="n">system</span><span class="o">.</span><span class="n">system_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">system</span>
</span><span id="PpmsConnection-1206"><a href="#PpmsConnection-1206"><span class="linenos">1206</span></a>
</span><span id="PpmsConnection-1207"><a href="#PpmsConnection-1207"><span class="linenos">1207</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span>
</span><span id="PpmsConnection-1208"><a href="#PpmsConnection-1208"><span class="linenos">1208</span></a>            <span class="s2">&quot;Updated </span><span class="si">{}</span><span class="s2"> bookable systems from PPMS (</span><span class="si">{}</span><span class="s2"> systems failed parsing)&quot;</span><span class="p">,</span>
</span><span id="PpmsConnection-1209"><a href="#PpmsConnection-1209"><span class="linenos">1209</span></a>            <span class="nb">len</span><span class="p">(</span><span class="n">systems</span><span class="p">),</span>
</span><span id="PpmsConnection-1210"><a href="#PpmsConnection-1210"><span class="linenos">1210</span></a>            <span class="n">parse_fails</span><span class="p">,</span>
</span><span id="PpmsConnection-1211"><a href="#PpmsConnection-1211"><span class="linenos">1211</span></a>        <span class="p">)</span>
</span><span id="PpmsConnection-1212"><a href="#PpmsConnection-1212"><span class="linenos">1212</span></a>
</span><span id="PpmsConnection-1213"><a href="#PpmsConnection-1213"><span class="linenos">1213</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">systems</span> <span class="o">=</span> <span class="n">systems</span>
</span><span id="PpmsConnection-1214"><a href="#PpmsConnection-1214"><span class="linenos">1214</span></a>
</span><span id="PpmsConnection-1215"><a href="#PpmsConnection-1215"><span class="linenos">1215</span></a>    <span class="k">def</span> <span class="nf">update_users</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_ids</span><span class="o">=</span><span class="p">[],</span> <span class="n">active_only</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="PpmsConnection-1216"><a href="#PpmsConnection-1216"><span class="linenos">1216</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Update cached details for a list of users from PPMS.</span>
</span><span id="PpmsConnection-1217"><a href="#PpmsConnection-1217"><span class="linenos">1217</span></a>
</span><span id="PpmsConnection-1218"><a href="#PpmsConnection-1218"><span class="linenos">1218</span></a><span class="sd">        Get the user details on a list of users (or all active ones) from PPMS and store</span>
</span><span id="PpmsConnection-1219"><a href="#PpmsConnection-1219"><span class="linenos">1219</span></a><span class="sd">        them in the object&#39;s `users` dict. As a side effect, this will also fill the</span>
</span><span id="PpmsConnection-1220"><a href="#PpmsConnection-1220"><span class="linenos">1220</span></a><span class="sd">        cache directory in case the object&#39;s `cache_path` attribute is set.</span>
</span><span id="PpmsConnection-1221"><a href="#PpmsConnection-1221"><span class="linenos">1221</span></a>
</span><span id="PpmsConnection-1222"><a href="#PpmsConnection-1222"><span class="linenos">1222</span></a><span class="sd">        WARNING - very slow, especially when the PPMS instance has many users!</span>
</span><span id="PpmsConnection-1223"><a href="#PpmsConnection-1223"><span class="linenos">1223</span></a>
</span><span id="PpmsConnection-1224"><a href="#PpmsConnection-1224"><span class="linenos">1224</span></a><span class="sd">        Parameters</span>
</span><span id="PpmsConnection-1225"><a href="#PpmsConnection-1225"><span class="linenos">1225</span></a><span class="sd">        ----------</span>
</span><span id="PpmsConnection-1226"><a href="#PpmsConnection-1226"><span class="linenos">1226</span></a><span class="sd">        user_ids : list(str), optional</span>
</span><span id="PpmsConnection-1227"><a href="#PpmsConnection-1227"><span class="linenos">1227</span></a><span class="sd">            A list of user IDs (login names) to request the cache for, by</span>
</span><span id="PpmsConnection-1228"><a href="#PpmsConnection-1228"><span class="linenos">1228</span></a><span class="sd">            default [] which will result in all *active* users to be requested.</span>
</span><span id="PpmsConnection-1229"><a href="#PpmsConnection-1229"><span class="linenos">1229</span></a><span class="sd">        active_only : bool, optional</span>
</span><span id="PpmsConnection-1230"><a href="#PpmsConnection-1230"><span class="linenos">1230</span></a><span class="sd">            If set to `False` also &quot;inactive&quot; users will be fetched from PPMS,</span>
</span><span id="PpmsConnection-1231"><a href="#PpmsConnection-1231"><span class="linenos">1231</span></a><span class="sd">            by default `True`.</span>
</span><span id="PpmsConnection-1232"><a href="#PpmsConnection-1232"><span class="linenos">1232</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PpmsConnection-1233"><a href="#PpmsConnection-1233"><span class="linenos">1233</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">user_ids</span><span class="p">:</span>
</span><span id="PpmsConnection-1234"><a href="#PpmsConnection-1234"><span class="linenos">1234</span></a>            <span class="n">user_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_ids</span><span class="p">(</span><span class="n">active</span><span class="o">=</span><span class="n">active_only</span><span class="p">)</span>
</span><span id="PpmsConnection-1235"><a href="#PpmsConnection-1235"><span class="linenos">1235</span></a>
</span><span id="PpmsConnection-1236"><a href="#PpmsConnection-1236"><span class="linenos">1236</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s2">&quot;Updating details on </span><span class="si">{}</span><span class="s2"> users&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">user_ids</span><span class="p">))</span>
</span><span id="PpmsConnection-1237"><a href="#PpmsConnection-1237"><span class="linenos">1237</span></a>        <span class="k">for</span> <span class="n">user_id</span> <span class="ow">in</span> <span class="n">user_ids</span><span class="p">:</span>
</span><span id="PpmsConnection-1238"><a href="#PpmsConnection-1238"><span class="linenos">1238</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">skip_cache</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PpmsConnection-1239"><a href="#PpmsConnection-1239"><span class="linenos">1239</span></a>
</span><span id="PpmsConnection-1240"><a href="#PpmsConnection-1240"><span class="linenos">1240</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Collected details on </span><span class="si">{}</span><span class="s2"> users&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="p">))</span>
</span><span id="PpmsConnection-1241"><a href="#PpmsConnection-1241"><span class="linenos">1241</span></a>
</span><span id="PpmsConnection-1242"><a href="#PpmsConnection-1242"><span class="linenos">1242</span></a>    <span class="k">def</span> <span class="nf">user_exists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">login</span><span class="p">):</span>
</span><span id="PpmsConnection-1243"><a href="#PpmsConnection-1243"><span class="linenos">1243</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if an account with the given login name already exists in PPMS.</span>
</span><span id="PpmsConnection-1244"><a href="#PpmsConnection-1244"><span class="linenos">1244</span></a>
</span><span id="PpmsConnection-1245"><a href="#PpmsConnection-1245"><span class="linenos">1245</span></a><span class="sd">        Parameters</span>
</span><span id="PpmsConnection-1246"><a href="#PpmsConnection-1246"><span class="linenos">1246</span></a><span class="sd">        ----------</span>
</span><span id="PpmsConnection-1247"><a href="#PpmsConnection-1247"><span class="linenos">1247</span></a><span class="sd">        login : str</span>
</span><span id="PpmsConnection-1248"><a href="#PpmsConnection-1248"><span class="linenos">1248</span></a><span class="sd">            The login name to check for.</span>
</span><span id="PpmsConnection-1249"><a href="#PpmsConnection-1249"><span class="linenos">1249</span></a>
</span><span id="PpmsConnection-1250"><a href="#PpmsConnection-1250"><span class="linenos">1250</span></a><span class="sd">        Returns</span>
</span><span id="PpmsConnection-1251"><a href="#PpmsConnection-1251"><span class="linenos">1251</span></a><span class="sd">        -------</span>
</span><span id="PpmsConnection-1252"><a href="#PpmsConnection-1252"><span class="linenos">1252</span></a><span class="sd">        bool</span>
</span><span id="PpmsConnection-1253"><a href="#PpmsConnection-1253"><span class="linenos">1253</span></a><span class="sd">            True in case an account with that name exists in PPMS, false otherwise.</span>
</span><span id="PpmsConnection-1254"><a href="#PpmsConnection-1254"><span class="linenos">1254</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PpmsConnection-1255"><a href="#PpmsConnection-1255"><span class="linenos">1255</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="PpmsConnection-1256"><a href="#PpmsConnection-1256"><span class="linenos">1256</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="n">login</span><span class="p">)</span>
</span><span id="PpmsConnection-1257"><a href="#PpmsConnection-1257"><span class="linenos">1257</span></a>            <span class="k">return</span> <span class="kc">True</span>
</span><span id="PpmsConnection-1258"><a href="#PpmsConnection-1258"><span class="linenos">1258</span></a>        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
</span><span id="PpmsConnection-1259"><a href="#PpmsConnection-1259"><span class="linenos">1259</span></a>            <span class="k">return</span> <span class="kc">False</span>
</span></pre></div>


            <div class="docstring"><p>Connection object to communicate with a PPMS instance.</p>

<h6 id="attributes">Attributes</h6>

<ul>
<li><strong>url</strong> (str):
The URL of the PUMAPI instance.</li>
<li><strong>api_key</strong> (str):
The API key used for authenticating against the PUMAPI.</li>
<li><strong>timeout</strong> (float):
The timeout value used in the <code>requests.post</code> calls.</li>
<li><strong>cache_path</strong> (str):
A path to a local directory used for caching responses.</li>
<li><strong>cache_users_only</strong> (bool):
Flag indicating that only PPMS user details will be stored in the
on-disk cache, nothing else.</li>
<li><strong>last_served_from_cache</strong> (bool):
Indicates if the last request was served from the cache or on-line.</li>
<li><strong>users</strong> (dict):
A dict with usernames as keys, mapping to the related
<code><a href="user.html#PpmsUser">pyppms.user.PpmsUser</a></code> object, serves as a cache during the object's
lifetime (can be empty if no calls to <code>get_user()()</code> have been done yet).</li>
<li><strong>fullname_mapping</strong> (dict):
A dict mapping a user's <em>fullname</em> ("<code>&lt;LASTNAME&gt; &lt;FIRSTNAME&gt;</code>") to the
corresponding username. Entries are filled in dynamically by the
<code>get_user()()</code> method.</li>
<li><strong>systems</strong>: A dict with system IDs as keys, mapping to the related
<code><a href="system.html#PpmsSystem">pyppms.system.PpmsSystem</a></code> object. Serves as a cache during the
object's lifetime (can be empty if no calls to the <code>get_systems()()</code> have
been done yet).</li>
<li><strong>status</strong> (dict):
A dict with keys <code>auth_state</code>, <code>auth_response</code> and
<code>auth_httpstatus</code></li>
</ul>
</div>


                            <div id="PpmsConnection.__init__" class="classattr">
                                        <input id="PpmsConnection.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">PpmsConnection</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">url</span>, </span><span class="param"><span class="n">api_key</span>, </span><span class="param"><span class="n">timeout</span><span class="o">=</span><span class="mi">10</span>, </span><span class="param"><span class="n">cache</span><span class="o">=</span><span class="s1">&#39;&#39;</span>, </span><span class="param"><span class="n">cache_users_only</span><span class="o">=</span><span class="kc">False</span></span>)</span>

                <label class="view-source-button" for="PpmsConnection.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PpmsConnection.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PpmsConnection.__init__-64"><a href="#PpmsConnection.__init__-64"><span class="linenos"> 64</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">api_key</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">cache_users_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="PpmsConnection.__init__-65"><a href="#PpmsConnection.__init__-65"><span class="linenos"> 65</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Constructor for the PPMS connection object.</span>
</span><span id="PpmsConnection.__init__-66"><a href="#PpmsConnection.__init__-66"><span class="linenos"> 66</span></a>
</span><span id="PpmsConnection.__init__-67"><a href="#PpmsConnection.__init__-67"><span class="linenos"> 67</span></a><span class="sd">        Open a connection to the PUMAPI defined in `url` and try to authenticate</span>
</span><span id="PpmsConnection.__init__-68"><a href="#PpmsConnection.__init__-68"><span class="linenos"> 68</span></a><span class="sd">        against it using the given API key (or use cache-only mode if key is an</span>
</span><span id="PpmsConnection.__init__-69"><a href="#PpmsConnection.__init__-69"><span class="linenos"> 69</span></a><span class="sd">        empty string). If an optional path to a caching location is specified,</span>
</span><span id="PpmsConnection.__init__-70"><a href="#PpmsConnection.__init__-70"><span class="linenos"> 70</span></a><span class="sd">        responses will be read from that location unless no matching file can be</span>
</span><span id="PpmsConnection.__init__-71"><a href="#PpmsConnection.__init__-71"><span class="linenos"> 71</span></a><span class="sd">        found there, in which case an on-line request will be done (with the</span>
</span><span id="PpmsConnection.__init__-72"><a href="#PpmsConnection.__init__-72"><span class="linenos"> 72</span></a><span class="sd">        response being saved to the cache path).</span>
</span><span id="PpmsConnection.__init__-73"><a href="#PpmsConnection.__init__-73"><span class="linenos"> 73</span></a>
</span><span id="PpmsConnection.__init__-74"><a href="#PpmsConnection.__init__-74"><span class="linenos"> 74</span></a><span class="sd">        Parameters</span>
</span><span id="PpmsConnection.__init__-75"><a href="#PpmsConnection.__init__-75"><span class="linenos"> 75</span></a><span class="sd">        ----------</span>
</span><span id="PpmsConnection.__init__-76"><a href="#PpmsConnection.__init__-76"><span class="linenos"> 76</span></a><span class="sd">        url : str</span>
</span><span id="PpmsConnection.__init__-77"><a href="#PpmsConnection.__init__-77"><span class="linenos"> 77</span></a><span class="sd">            The URL of the PUMAPI to connect to.</span>
</span><span id="PpmsConnection.__init__-78"><a href="#PpmsConnection.__init__-78"><span class="linenos"> 78</span></a><span class="sd">        api_key : str</span>
</span><span id="PpmsConnection.__init__-79"><a href="#PpmsConnection.__init__-79"><span class="linenos"> 79</span></a><span class="sd">            The API key to use for authenticating against the PUMAPI. If</span>
</span><span id="PpmsConnection.__init__-80"><a href="#PpmsConnection.__init__-80"><span class="linenos"> 80</span></a><span class="sd">            specified as &#39;&#39; authentication will be skipped and the connection is</span>
</span><span id="PpmsConnection.__init__-81"><a href="#PpmsConnection.__init__-81"><span class="linenos"> 81</span></a><span class="sd">            running in cache-only (local) mode.</span>
</span><span id="PpmsConnection.__init__-82"><a href="#PpmsConnection.__init__-82"><span class="linenos"> 82</span></a><span class="sd">        timeout : float, optional</span>
</span><span id="PpmsConnection.__init__-83"><a href="#PpmsConnection.__init__-83"><span class="linenos"> 83</span></a><span class="sd">            How many seconds to wait for the PUMAPI server to send a response</span>
</span><span id="PpmsConnection.__init__-84"><a href="#PpmsConnection.__init__-84"><span class="linenos"> 84</span></a><span class="sd">            before giving up, by default 10.</span>
</span><span id="PpmsConnection.__init__-85"><a href="#PpmsConnection.__init__-85"><span class="linenos"> 85</span></a><span class="sd">        cache : str, optional</span>
</span><span id="PpmsConnection.__init__-86"><a href="#PpmsConnection.__init__-86"><span class="linenos"> 86</span></a><span class="sd">            A path to a local directory for caching responses from PUMAPI in</span>
</span><span id="PpmsConnection.__init__-87"><a href="#PpmsConnection.__init__-87"><span class="linenos"> 87</span></a><span class="sd">            individual text files. Useful for testing and for speeding up</span>
</span><span id="PpmsConnection.__init__-88"><a href="#PpmsConnection.__init__-88"><span class="linenos"> 88</span></a><span class="sd">            slow requests like &#39;getusers&#39;. By default empty, which will result</span>
</span><span id="PpmsConnection.__init__-89"><a href="#PpmsConnection.__init__-89"><span class="linenos"> 89</span></a><span class="sd">            in no caching being done.</span>
</span><span id="PpmsConnection.__init__-90"><a href="#PpmsConnection.__init__-90"><span class="linenos"> 90</span></a><span class="sd">        cache_users_only : bool, optional</span>
</span><span id="PpmsConnection.__init__-91"><a href="#PpmsConnection.__init__-91"><span class="linenos"> 91</span></a><span class="sd">            If set to `True`, only `getuser` requests will be cached on disk.</span>
</span><span id="PpmsConnection.__init__-92"><a href="#PpmsConnection.__init__-92"><span class="linenos"> 92</span></a><span class="sd">            This can be used in to speed up the slow requests (through the</span>
</span><span id="PpmsConnection.__init__-93"><a href="#PpmsConnection.__init__-93"><span class="linenos"> 93</span></a><span class="sd">            cache), while everything else will be handled through online</span>
</span><span id="PpmsConnection.__init__-94"><a href="#PpmsConnection.__init__-94"><span class="linenos"> 94</span></a><span class="sd">            requests. By default `False`.</span>
</span><span id="PpmsConnection.__init__-95"><a href="#PpmsConnection.__init__-95"><span class="linenos"> 95</span></a>
</span><span id="PpmsConnection.__init__-96"><a href="#PpmsConnection.__init__-96"><span class="linenos"> 96</span></a><span class="sd">        Raises</span>
</span><span id="PpmsConnection.__init__-97"><a href="#PpmsConnection.__init__-97"><span class="linenos"> 97</span></a><span class="sd">        ------</span>
</span><span id="PpmsConnection.__init__-98"><a href="#PpmsConnection.__init__-98"><span class="linenos"> 98</span></a><span class="sd">        requests.exceptions.ConnectionError</span>
</span><span id="PpmsConnection.__init__-99"><a href="#PpmsConnection.__init__-99"><span class="linenos"> 99</span></a><span class="sd">            Raised in case authentication fails.</span>
</span><span id="PpmsConnection.__init__-100"><a href="#PpmsConnection.__init__-100"><span class="linenos">100</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PpmsConnection.__init__-101"><a href="#PpmsConnection.__init__-101"><span class="linenos">101</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">url</span>
</span><span id="PpmsConnection.__init__-102"><a href="#PpmsConnection.__init__-102"><span class="linenos">102</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">api_key</span>
</span><span id="PpmsConnection.__init__-103"><a href="#PpmsConnection.__init__-103"><span class="linenos">103</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span>
</span><span id="PpmsConnection.__init__-104"><a href="#PpmsConnection.__init__-104"><span class="linenos">104</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">users</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="PpmsConnection.__init__-105"><a href="#PpmsConnection.__init__-105"><span class="linenos">105</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fullname_mapping</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="PpmsConnection.__init__-106"><a href="#PpmsConnection.__init__-106"><span class="linenos">106</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">systems</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="PpmsConnection.__init__-107"><a href="#PpmsConnection.__init__-107"><span class="linenos">107</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="PpmsConnection.__init__-108"><a href="#PpmsConnection.__init__-108"><span class="linenos">108</span></a>            <span class="s2">&quot;auth_state&quot;</span><span class="p">:</span> <span class="s2">&quot;NOT_TRIED&quot;</span><span class="p">,</span>
</span><span id="PpmsConnection.__init__-109"><a href="#PpmsConnection.__init__-109"><span class="linenos">109</span></a>            <span class="s2">&quot;auth_response&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="PpmsConnection.__init__-110"><a href="#PpmsConnection.__init__-110"><span class="linenos">110</span></a>            <span class="s2">&quot;auth_httpstatus&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
</span><span id="PpmsConnection.__init__-111"><a href="#PpmsConnection.__init__-111"><span class="linenos">111</span></a>        <span class="p">}</span>
</span><span id="PpmsConnection.__init__-112"><a href="#PpmsConnection.__init__-112"><span class="linenos">112</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cache_path</span> <span class="o">=</span> <span class="n">cache</span>
</span><span id="PpmsConnection.__init__-113"><a href="#PpmsConnection.__init__-113"><span class="linenos">113</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cache_users_only</span> <span class="o">=</span> <span class="n">cache_users_only</span>
</span><span id="PpmsConnection.__init__-114"><a href="#PpmsConnection.__init__-114"><span class="linenos">114</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">last_served_from_cache</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="PpmsConnection.__init__-115"><a href="#PpmsConnection.__init__-115"><span class="linenos">115</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Indicates if the last request was served from the cache or on-line.&quot;&quot;&quot;</span>
</span><span id="PpmsConnection.__init__-116"><a href="#PpmsConnection.__init__-116"><span class="linenos">116</span></a>
</span><span id="PpmsConnection.__init__-117"><a href="#PpmsConnection.__init__-117"><span class="linenos">117</span></a>        <span class="c1"># run in cache-only mode (e.g. for testing or off-line usage) if no API</span>
</span><span id="PpmsConnection.__init__-118"><a href="#PpmsConnection.__init__-118"><span class="linenos">118</span></a>        <span class="c1"># key has been specified, skip authentication then:</span>
</span><span id="PpmsConnection.__init__-119"><a href="#PpmsConnection.__init__-119"><span class="linenos">119</span></a>        <span class="k">if</span> <span class="n">api_key</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
</span><span id="PpmsConnection.__init__-120"><a href="#PpmsConnection.__init__-120"><span class="linenos">120</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">__authenticate</span><span class="p">()</span>
</span><span id="PpmsConnection.__init__-121"><a href="#PpmsConnection.__init__-121"><span class="linenos">121</span></a>        <span class="k">elif</span> <span class="n">cache</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
</span><span id="PpmsConnection.__init__-122"><a href="#PpmsConnection.__init__-122"><span class="linenos">122</span></a>            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
</span><span id="PpmsConnection.__init__-123"><a href="#PpmsConnection.__init__-123"><span class="linenos">123</span></a>                <span class="s2">&quot;Neither API key nor cache path given, at least one is required!&quot;</span>
</span><span id="PpmsConnection.__init__-124"><a href="#PpmsConnection.__init__-124"><span class="linenos">124</span></a>            <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Constructor for the PPMS connection object.</p>

<p>Open a connection to the PUMAPI defined in <code>url</code> and try to authenticate
against it using the given API key (or use cache-only mode if key is an
empty string). If an optional path to a caching location is specified,
responses will be read from that location unless no matching file can be
found there, in which case an on-line request will be done (with the
response being saved to the cache path).</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>url</strong> (str):
The URL of the PUMAPI to connect to.</li>
<li><strong>api_key</strong> (str):
The API key to use for authenticating against the PUMAPI. If
specified as '' authentication will be skipped and the connection is
running in cache-only (local) mode.</li>
<li><strong>timeout</strong> (float, optional):
How many seconds to wait for the PUMAPI server to send a response
before giving up, by default 10.</li>
<li><strong>cache</strong> (str, optional):
A path to a local directory for caching responses from PUMAPI in
individual text files. Useful for testing and for speeding up
slow requests like 'getusers'. By default empty, which will result
in no caching being done.</li>
<li><strong>cache_users_only</strong> (bool, optional):
If set to <code>True</code>, only <code>getuser</code> requests will be cached on disk.
This can be used in to speed up the slow requests (through the
cache), while everything else will be handled through online
requests. By default <code>False</code>.</li>
</ul>

<h6 id="raises">Raises</h6>

<ul>
<li><strong>requests.exceptions.ConnectionError</strong>: Raised in case authentication fails.</li>
</ul>
</div>


                            </div>
                            <div id="PpmsConnection.last_served_from_cache" class="classattr">
                                <div class="attr variable">
            <span class="name">last_served_from_cache</span>

        
    </div>
    <a class="headerlink" href="#PpmsConnection.last_served_from_cache"></a>
    
            <div class="docstring"><p>Indicates if the last request was served from the cache or on-line.</p>
</div>


                            </div>
                            <div id="PpmsConnection.request" class="classattr">
                                        <input id="PpmsConnection.request-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">request</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">action</span>, </span><span class="param"><span class="n">parameters</span><span class="o">=</span><span class="p">{}</span>, </span><span class="param"><span class="n">skip_cache</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="PpmsConnection.request-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PpmsConnection.request"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PpmsConnection.request-182"><a href="#PpmsConnection.request-182"><span class="linenos">182</span></a>    <span class="k">def</span> <span class="nf">request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="p">{},</span> <span class="n">skip_cache</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="PpmsConnection.request-183"><a href="#PpmsConnection.request-183"><span class="linenos">183</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Generic method to submit a request to PPMS and return the result.</span>
</span><span id="PpmsConnection.request-184"><a href="#PpmsConnection.request-184"><span class="linenos">184</span></a>
</span><span id="PpmsConnection.request-185"><a href="#PpmsConnection.request-185"><span class="linenos">185</span></a><span class="sd">        This convenience method deals with adding the API key to a given</span>
</span><span id="PpmsConnection.request-186"><a href="#PpmsConnection.request-186"><span class="linenos">186</span></a><span class="sd">        request, submitting it to the PUMAPI and checking the response for some</span>
</span><span id="PpmsConnection.request-187"><a href="#PpmsConnection.request-187"><span class="linenos">187</span></a><span class="sd">        specific keywords indicating an error.</span>
</span><span id="PpmsConnection.request-188"><a href="#PpmsConnection.request-188"><span class="linenos">188</span></a>
</span><span id="PpmsConnection.request-189"><a href="#PpmsConnection.request-189"><span class="linenos">189</span></a><span class="sd">        Parameters</span>
</span><span id="PpmsConnection.request-190"><a href="#PpmsConnection.request-190"><span class="linenos">190</span></a><span class="sd">        ----------</span>
</span><span id="PpmsConnection.request-191"><a href="#PpmsConnection.request-191"><span class="linenos">191</span></a><span class="sd">        action : str</span>
</span><span id="PpmsConnection.request-192"><a href="#PpmsConnection.request-192"><span class="linenos">192</span></a><span class="sd">            The command to be submitted to the PUMAPI.</span>
</span><span id="PpmsConnection.request-193"><a href="#PpmsConnection.request-193"><span class="linenos">193</span></a><span class="sd">        parameters : dict, optional</span>
</span><span id="PpmsConnection.request-194"><a href="#PpmsConnection.request-194"><span class="linenos">194</span></a><span class="sd">            A dictionary with additional parameters to be submitted with the</span>
</span><span id="PpmsConnection.request-195"><a href="#PpmsConnection.request-195"><span class="linenos">195</span></a><span class="sd">            request.</span>
</span><span id="PpmsConnection.request-196"><a href="#PpmsConnection.request-196"><span class="linenos">196</span></a><span class="sd">        skip_cache : bool, optional</span>
</span><span id="PpmsConnection.request-197"><a href="#PpmsConnection.request-197"><span class="linenos">197</span></a><span class="sd">            If set to True the request will NOT be served from the local cache,</span>
</span><span id="PpmsConnection.request-198"><a href="#PpmsConnection.request-198"><span class="linenos">198</span></a><span class="sd">            independent whether a matching response file exists there, by</span>
</span><span id="PpmsConnection.request-199"><a href="#PpmsConnection.request-199"><span class="linenos">199</span></a><span class="sd">            default False.</span>
</span><span id="PpmsConnection.request-200"><a href="#PpmsConnection.request-200"><span class="linenos">200</span></a>
</span><span id="PpmsConnection.request-201"><a href="#PpmsConnection.request-201"><span class="linenos">201</span></a><span class="sd">        Returns</span>
</span><span id="PpmsConnection.request-202"><a href="#PpmsConnection.request-202"><span class="linenos">202</span></a><span class="sd">        -------</span>
</span><span id="PpmsConnection.request-203"><a href="#PpmsConnection.request-203"><span class="linenos">203</span></a><span class="sd">        requests.Response</span>
</span><span id="PpmsConnection.request-204"><a href="#PpmsConnection.request-204"><span class="linenos">204</span></a><span class="sd">            The response object created by posting the request.</span>
</span><span id="PpmsConnection.request-205"><a href="#PpmsConnection.request-205"><span class="linenos">205</span></a>
</span><span id="PpmsConnection.request-206"><a href="#PpmsConnection.request-206"><span class="linenos">206</span></a><span class="sd">        Raises</span>
</span><span id="PpmsConnection.request-207"><a href="#PpmsConnection.request-207"><span class="linenos">207</span></a><span class="sd">        ------</span>
</span><span id="PpmsConnection.request-208"><a href="#PpmsConnection.request-208"><span class="linenos">208</span></a><span class="sd">        requests.exceptions.ConnectionError</span>
</span><span id="PpmsConnection.request-209"><a href="#PpmsConnection.request-209"><span class="linenos">209</span></a><span class="sd">            Raised in case the request is not authorized.</span>
</span><span id="PpmsConnection.request-210"><a href="#PpmsConnection.request-210"><span class="linenos">210</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PpmsConnection.request-211"><a href="#PpmsConnection.request-211"><span class="linenos">211</span></a>        <span class="n">req_data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">action</span><span class="p">,</span> <span class="s2">&quot;apikey&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">api_key</span><span class="p">}</span>
</span><span id="PpmsConnection.request-212"><a href="#PpmsConnection.request-212"><span class="linenos">212</span></a>        <span class="n">req_data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span>
</span><span id="PpmsConnection.request-213"><a href="#PpmsConnection.request-213"><span class="linenos">213</span></a>        <span class="c1"># log.debug(&quot;Request parameters: {}&quot;, parameters)</span>
</span><span id="PpmsConnection.request-214"><a href="#PpmsConnection.request-214"><span class="linenos">214</span></a>
</span><span id="PpmsConnection.request-215"><a href="#PpmsConnection.request-215"><span class="linenos">215</span></a>        <span class="n">response</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="PpmsConnection.request-216"><a href="#PpmsConnection.request-216"><span class="linenos">216</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="PpmsConnection.request-217"><a href="#PpmsConnection.request-217"><span class="linenos">217</span></a>            <span class="k">if</span> <span class="n">skip_cache</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
</span><span id="PpmsConnection.request-218"><a href="#PpmsConnection.request-218"><span class="linenos">218</span></a>                <span class="k">raise</span> <span class="ne">LookupError</span><span class="p">(</span><span class="s2">&quot;Skipping the cache has been requested&quot;</span><span class="p">)</span>
</span><span id="PpmsConnection.request-219"><a href="#PpmsConnection.request-219"><span class="linenos">219</span></a>            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__intercept_read</span><span class="p">(</span><span class="n">req_data</span><span class="p">)</span>
</span><span id="PpmsConnection.request-220"><a href="#PpmsConnection.request-220"><span class="linenos">220</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">last_served_from_cache</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="PpmsConnection.request-221"><a href="#PpmsConnection.request-221"><span class="linenos">221</span></a>        <span class="k">except</span> <span class="ne">LookupError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
</span><span id="PpmsConnection.request-222"><a href="#PpmsConnection.request-222"><span class="linenos">222</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Doing an on-line request: </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="PpmsConnection.request-223"><a href="#PpmsConnection.request-223"><span class="linenos">223</span></a>            <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">req_data</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>
</span><span id="PpmsConnection.request-224"><a href="#PpmsConnection.request-224"><span class="linenos">224</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">last_served_from_cache</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="PpmsConnection.request-225"><a href="#PpmsConnection.request-225"><span class="linenos">225</span></a>
</span><span id="PpmsConnection.request-226"><a href="#PpmsConnection.request-226"><span class="linenos">226</span></a>        <span class="c1"># store the response if it hasn&#39;t been read from the cache before:</span>
</span><span id="PpmsConnection.request-227"><a href="#PpmsConnection.request-227"><span class="linenos">227</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_served_from_cache</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
</span><span id="PpmsConnection.request-228"><a href="#PpmsConnection.request-228"><span class="linenos">228</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">__intercept_store</span><span class="p">(</span><span class="n">req_data</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>
</span><span id="PpmsConnection.request-229"><a href="#PpmsConnection.request-229"><span class="linenos">229</span></a>
</span><span id="PpmsConnection.request-230"><a href="#PpmsConnection.request-230"><span class="linenos">230</span></a>        <span class="c1"># NOTE: the HTTP status code returned is always `200` even if</span>
</span><span id="PpmsConnection.request-231"><a href="#PpmsConnection.request-231"><span class="linenos">231</span></a>        <span class="c1"># authentication failed, so we need to check the actual response *TEXT*</span>
</span><span id="PpmsConnection.request-232"><a href="#PpmsConnection.request-232"><span class="linenos">232</span></a>        <span class="c1"># to figure out if we have succeeded:</span>
</span><span id="PpmsConnection.request-233"><a href="#PpmsConnection.request-233"><span class="linenos">233</span></a>        <span class="k">if</span> <span class="s2">&quot;request not authorized&quot;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
</span><span id="PpmsConnection.request-234"><a href="#PpmsConnection.request-234"><span class="linenos">234</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s2">&quot;auth_state&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;FAILED&quot;</span>
</span><span id="PpmsConnection.request-235"><a href="#PpmsConnection.request-235"><span class="linenos">235</span></a>            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Not authorized to run action `</span><span class="si">{</span><span class="n">req_data</span><span class="p">[</span><span class="s1">&#39;action&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">`&quot;</span>
</span><span id="PpmsConnection.request-236"><a href="#PpmsConnection.request-236"><span class="linenos">236</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="PpmsConnection.request-237"><a href="#PpmsConnection.request-237"><span class="linenos">237</span></a>            <span class="k">raise</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ConnectionError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="PpmsConnection.request-238"><a href="#PpmsConnection.request-238"><span class="linenos">238</span></a>
</span><span id="PpmsConnection.request-239"><a href="#PpmsConnection.request-239"><span class="linenos">239</span></a>        <span class="k">return</span> <span class="n">response</span>
</span></pre></div>


            <div class="docstring"><p>Generic method to submit a request to PPMS and return the result.</p>

<p>This convenience method deals with adding the API key to a given
request, submitting it to the PUMAPI and checking the response for some
specific keywords indicating an error.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>action</strong> (str):
The command to be submitted to the PUMAPI.</li>
<li><strong>parameters</strong> (dict, optional):
A dictionary with additional parameters to be submitted with the
request.</li>
<li><strong>skip_cache</strong> (bool, optional):
If set to True the request will NOT be served from the local cache,
independent whether a matching response file exists there, by
default False.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>requests.Response</strong>: The response object created by posting the request.</li>
</ul>

<h6 id="raises">Raises</h6>

<ul>
<li><strong>requests.exceptions.ConnectionError</strong>: Raised in case the request is not authorized.</li>
</ul>
</div>


                            </div>
                            <div id="PpmsConnection.flush_cache" class="classattr">
                                        <input id="PpmsConnection.flush_cache-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">flush_cache</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">keep_users</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="PpmsConnection.flush_cache-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PpmsConnection.flush_cache"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PpmsConnection.flush_cache-375"><a href="#PpmsConnection.flush_cache-375"><span class="linenos">375</span></a>    <span class="k">def</span> <span class="nf">flush_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keep_users</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="PpmsConnection.flush_cache-376"><a href="#PpmsConnection.flush_cache-376"><span class="linenos">376</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Flush the PyPPMS on-disk cache.</span>
</span><span id="PpmsConnection.flush_cache-377"><a href="#PpmsConnection.flush_cache-377"><span class="linenos">377</span></a>
</span><span id="PpmsConnection.flush_cache-378"><a href="#PpmsConnection.flush_cache-378"><span class="linenos">378</span></a><span class="sd">        Optionally flushes everything *except* the `getuser` cache if the</span>
</span><span id="PpmsConnection.flush_cache-379"><a href="#PpmsConnection.flush_cache-379"><span class="linenos">379</span></a><span class="sd">        `keep_users` flag is set to `True`, as this is clearly the most</span>
</span><span id="PpmsConnection.flush_cache-380"><a href="#PpmsConnection.flush_cache-380"><span class="linenos">380</span></a><span class="sd">        time-consuming operation when fetching data from PUMAPI and therefore</span>
</span><span id="PpmsConnection.flush_cache-381"><a href="#PpmsConnection.flush_cache-381"><span class="linenos">381</span></a><span class="sd">        might want to be retained.</span>
</span><span id="PpmsConnection.flush_cache-382"><a href="#PpmsConnection.flush_cache-382"><span class="linenos">382</span></a>
</span><span id="PpmsConnection.flush_cache-383"><a href="#PpmsConnection.flush_cache-383"><span class="linenos">383</span></a><span class="sd">        Please note that the `getusers` cache (plural, including the `s` suffix)</span>
</span><span id="PpmsConnection.flush_cache-384"><a href="#PpmsConnection.flush_cache-384"><span class="linenos">384</span></a><span class="sd">        will be flushed no matter what, as this is simply a list of user IDs</span>
</span><span id="PpmsConnection.flush_cache-385"><a href="#PpmsConnection.flush_cache-385"><span class="linenos">385</span></a><span class="sd">        that can be fetched with a single request. In consequence this means</span>
</span><span id="PpmsConnection.flush_cache-386"><a href="#PpmsConnection.flush_cache-386"><span class="linenos">386</span></a><span class="sd">        that using the `keep_users` flag will allow you to have reasonably fast</span>
</span><span id="PpmsConnection.flush_cache-387"><a href="#PpmsConnection.flush_cache-387"><span class="linenos">387</span></a><span class="sd">        reaction times while still getting information on *new* users live from</span>
</span><span id="PpmsConnection.flush_cache-388"><a href="#PpmsConnection.flush_cache-388"><span class="linenos">388</span></a><span class="sd">        PUMAPI at the only cost of possibly having outdated information on</span>
</span><span id="PpmsConnection.flush_cache-389"><a href="#PpmsConnection.flush_cache-389"><span class="linenos">389</span></a><span class="sd">        *existing* users.</span>
</span><span id="PpmsConnection.flush_cache-390"><a href="#PpmsConnection.flush_cache-390"><span class="linenos">390</span></a>
</span><span id="PpmsConnection.flush_cache-391"><a href="#PpmsConnection.flush_cache-391"><span class="linenos">391</span></a><span class="sd">        Parameters</span>
</span><span id="PpmsConnection.flush_cache-392"><a href="#PpmsConnection.flush_cache-392"><span class="linenos">392</span></a><span class="sd">        ----------</span>
</span><span id="PpmsConnection.flush_cache-393"><a href="#PpmsConnection.flush_cache-393"><span class="linenos">393</span></a><span class="sd">        keep_users : bool, optional</span>
</span><span id="PpmsConnection.flush_cache-394"><a href="#PpmsConnection.flush_cache-394"><span class="linenos">394</span></a><span class="sd">            If set to `True` the `getuser` sub-directory in the cache location</span>
</span><span id="PpmsConnection.flush_cache-395"><a href="#PpmsConnection.flush_cache-395"><span class="linenos">395</span></a><span class="sd">            will be kept, by default `False`.</span>
</span><span id="PpmsConnection.flush_cache-396"><a href="#PpmsConnection.flush_cache-396"><span class="linenos">396</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PpmsConnection.flush_cache-397"><a href="#PpmsConnection.flush_cache-397"><span class="linenos">397</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_path</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
</span><span id="PpmsConnection.flush_cache-398"><a href="#PpmsConnection.flush_cache-398"><span class="linenos">398</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;No cache path configured, not flushing!&quot;</span><span class="p">)</span>
</span><span id="PpmsConnection.flush_cache-399"><a href="#PpmsConnection.flush_cache-399"><span class="linenos">399</span></a>            <span class="k">return</span>
</span><span id="PpmsConnection.flush_cache-400"><a href="#PpmsConnection.flush_cache-400"><span class="linenos">400</span></a>
</span><span id="PpmsConnection.flush_cache-401"><a href="#PpmsConnection.flush_cache-401"><span class="linenos">401</span></a>        <span class="n">dirs_to_remove</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_path</span><span class="p">]</span>  <span class="c1"># by default remove the entire cache dir</span>
</span><span id="PpmsConnection.flush_cache-402"><a href="#PpmsConnection.flush_cache-402"><span class="linenos">402</span></a>        <span class="n">keep_msg</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="PpmsConnection.flush_cache-403"><a href="#PpmsConnection.flush_cache-403"><span class="linenos">403</span></a>        <span class="k">if</span> <span class="n">keep_users</span><span class="p">:</span>
</span><span id="PpmsConnection.flush_cache-404"><a href="#PpmsConnection.flush_cache-404"><span class="linenos">404</span></a>            <span class="n">keep_msg</span> <span class="o">=</span> <span class="s2">&quot; (keeping user details dirs)&quot;</span>
</span><span id="PpmsConnection.flush_cache-405"><a href="#PpmsConnection.flush_cache-405"><span class="linenos">405</span></a>            <span class="n">dirs_to_remove</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="PpmsConnection.flush_cache-406"><a href="#PpmsConnection.flush_cache-406"><span class="linenos">406</span></a>            <span class="n">cache_dirs</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_path</span><span class="p">)</span>
</span><span id="PpmsConnection.flush_cache-407"><a href="#PpmsConnection.flush_cache-407"><span class="linenos">407</span></a>            <span class="k">for</span> <span class="n">subdir</span> <span class="ow">in</span> <span class="n">cache_dirs</span><span class="p">:</span>
</span><span id="PpmsConnection.flush_cache-408"><a href="#PpmsConnection.flush_cache-408"><span class="linenos">408</span></a>                <span class="k">if</span> <span class="n">subdir</span> <span class="o">==</span> <span class="s2">&quot;getuser&quot;</span><span class="p">:</span>
</span><span id="PpmsConnection.flush_cache-409"><a href="#PpmsConnection.flush_cache-409"><span class="linenos">409</span></a>                    <span class="k">continue</span>
</span><span id="PpmsConnection.flush_cache-410"><a href="#PpmsConnection.flush_cache-410"><span class="linenos">410</span></a>                <span class="n">dirs_to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_path</span><span class="p">,</span> <span class="n">subdir</span><span class="p">))</span>
</span><span id="PpmsConnection.flush_cache-411"><a href="#PpmsConnection.flush_cache-411"><span class="linenos">411</span></a>
</span><span id="PpmsConnection.flush_cache-412"><a href="#PpmsConnection.flush_cache-412"><span class="linenos">412</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Flushing the on-disk cache at [</span><span class="si">{}</span><span class="s2">] </span><span class="si">{}</span><span class="s2">...&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_path</span><span class="p">,</span> <span class="n">keep_msg</span><span class="p">)</span>
</span><span id="PpmsConnection.flush_cache-413"><a href="#PpmsConnection.flush_cache-413"><span class="linenos">413</span></a>        <span class="k">for</span> <span class="n">directory</span> <span class="ow">in</span> <span class="n">dirs_to_remove</span><span class="p">:</span>
</span><span id="PpmsConnection.flush_cache-414"><a href="#PpmsConnection.flush_cache-414"><span class="linenos">414</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="PpmsConnection.flush_cache-415"><a href="#PpmsConnection.flush_cache-415"><span class="linenos">415</span></a>                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
</span><span id="PpmsConnection.flush_cache-416"><a href="#PpmsConnection.flush_cache-416"><span class="linenos">416</span></a>                <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s2">&quot;Removed directory [</span><span class="si">{}</span><span class="s2">].&quot;</span><span class="p">,</span> <span class="n">directory</span><span class="p">)</span>
</span><span id="PpmsConnection.flush_cache-417"><a href="#PpmsConnection.flush_cache-417"><span class="linenos">417</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>  <span class="c1"># pylint: disable-msg=broad-except</span>
</span><span id="PpmsConnection.flush_cache-418"><a href="#PpmsConnection.flush_cache-418"><span class="linenos">418</span></a>                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Removing the cache at [</span><span class="si">{}</span><span class="s2">] failed: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">directory</span><span class="p">,</span> <span class="n">ex</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Flush the PyPPMS on-disk cache.</p>

<p>Optionally flushes everything <em>except</em> the <code>getuser</code> cache if the
<code>keep_users</code> flag is set to <code>True</code>, as this is clearly the most
time-consuming operation when fetching data from PUMAPI and therefore
might want to be retained.</p>

<p>Please note that the <code>getusers</code> cache (plural, including the <code>s</code> suffix)
will be flushed no matter what, as this is simply a list of user IDs
that can be fetched with a single request. In consequence this means
that using the <code>keep_users</code> flag will allow you to have reasonably fast
reaction times while still getting information on <em>new</em> users live from
PUMAPI at the only cost of possibly having outdated information on
<em>existing</em> users.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>keep_users</strong> (bool, optional):
If set to <code>True</code> the <code>getuser</code> sub-directory in the cache location
will be kept, by default <code>False</code>.</li>
</ul>
</div>


                            </div>
                            <div id="PpmsConnection.get_admins" class="classattr">
                                        <input id="PpmsConnection.get_admins-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_admins</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="PpmsConnection.get_admins-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PpmsConnection.get_admins"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PpmsConnection.get_admins-420"><a href="#PpmsConnection.get_admins-420"><span class="linenos">420</span></a>    <span class="k">def</span> <span class="nf">get_admins</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="PpmsConnection.get_admins-421"><a href="#PpmsConnection.get_admins-421"><span class="linenos">421</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get all PPMS administrator users.</span>
</span><span id="PpmsConnection.get_admins-422"><a href="#PpmsConnection.get_admins-422"><span class="linenos">422</span></a>
</span><span id="PpmsConnection.get_admins-423"><a href="#PpmsConnection.get_admins-423"><span class="linenos">423</span></a><span class="sd">        Returns</span>
</span><span id="PpmsConnection.get_admins-424"><a href="#PpmsConnection.get_admins-424"><span class="linenos">424</span></a><span class="sd">        -------</span>
</span><span id="PpmsConnection.get_admins-425"><a href="#PpmsConnection.get_admins-425"><span class="linenos">425</span></a><span class="sd">        list(pyppms.user.PpmsUser)</span>
</span><span id="PpmsConnection.get_admins-426"><a href="#PpmsConnection.get_admins-426"><span class="linenos">426</span></a><span class="sd">            A list with PpmsUser objects that are PPMS administrators.</span>
</span><span id="PpmsConnection.get_admins-427"><a href="#PpmsConnection.get_admins-427"><span class="linenos">427</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PpmsConnection.get_admins-428"><a href="#PpmsConnection.get_admins-428"><span class="linenos">428</span></a>        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;getadmins&quot;</span><span class="p">)</span>
</span><span id="PpmsConnection.get_admins-429"><a href="#PpmsConnection.get_admins-429"><span class="linenos">429</span></a>
</span><span id="PpmsConnection.get_admins-430"><a href="#PpmsConnection.get_admins-430"><span class="linenos">430</span></a>        <span class="n">admins</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
</span><span id="PpmsConnection.get_admins-431"><a href="#PpmsConnection.get_admins-431"><span class="linenos">431</span></a>        <span class="n">users</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="PpmsConnection.get_admins-432"><a href="#PpmsConnection.get_admins-432"><span class="linenos">432</span></a>        <span class="k">for</span> <span class="n">username</span> <span class="ow">in</span> <span class="n">admins</span><span class="p">:</span>
</span><span id="PpmsConnection.get_admins-433"><a href="#PpmsConnection.get_admins-433"><span class="linenos">433</span></a>            <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
</span><span id="PpmsConnection.get_admins-434"><a href="#PpmsConnection.get_admins-434"><span class="linenos">434</span></a>            <span class="n">users</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</span><span id="PpmsConnection.get_admins-435"><a href="#PpmsConnection.get_admins-435"><span class="linenos">435</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> admins in the PPMS database: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">admins</span><span class="p">),</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">admins</span><span class="p">))</span>
</span><span id="PpmsConnection.get_admins-436"><a href="#PpmsConnection.get_admins-436"><span class="linenos">436</span></a>        <span class="k">return</span> <span class="n">users</span>
</span></pre></div>


            <div class="docstring"><p>Get all PPMS administrator users.</p>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>list(<a href="user.html#PpmsUser">pyppms.user.PpmsUser</a>)</strong>: A list with PpmsUser objects that are PPMS administrators.</li>
</ul>
</div>


                            </div>
                            <div id="PpmsConnection.get_booking" class="classattr">
                                        <input id="PpmsConnection.get_booking-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_booking</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">system_id</span>, </span><span class="param"><span class="n">booking_type</span><span class="o">=</span><span class="s1">&#39;get&#39;</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="PpmsConnection.get_booking-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PpmsConnection.get_booking"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PpmsConnection.get_booking-438"><a href="#PpmsConnection.get_booking-438"><span class="linenos">438</span></a>    <span class="k">def</span> <span class="nf">get_booking</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">system_id</span><span class="p">,</span> <span class="n">booking_type</span><span class="o">=</span><span class="s2">&quot;get&quot;</span><span class="p">):</span>
</span><span id="PpmsConnection.get_booking-439"><a href="#PpmsConnection.get_booking-439"><span class="linenos">439</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the current or next booking of a system.</span>
</span><span id="PpmsConnection.get_booking-440"><a href="#PpmsConnection.get_booking-440"><span class="linenos">440</span></a>
</span><span id="PpmsConnection.get_booking-441"><a href="#PpmsConnection.get_booking-441"><span class="linenos">441</span></a><span class="sd">        WARNING: if the next booking is requested but it is too far in the future,</span>
</span><span id="PpmsConnection.get_booking-442"><a href="#PpmsConnection.get_booking-442"><span class="linenos">442</span></a><span class="sd">        PUMAPI silently ignores it - the response is identical to a system that has no</span>
</span><span id="PpmsConnection.get_booking-443"><a href="#PpmsConnection.get_booking-443"><span class="linenos">443</span></a><span class="sd">        future bookings and there is no error reported either. Currently it is unclear</span>
</span><span id="PpmsConnection.get_booking-444"><a href="#PpmsConnection.get_booking-444"><span class="linenos">444</span></a><span class="sd">        where the cutoff is (e.g. lookups for a booking that is two years from now still</span>
</span><span id="PpmsConnection.get_booking-445"><a href="#PpmsConnection.get_booking-445"><span class="linenos">445</span></a><span class="sd">        work fine, but a booking in about 10 years is silently skipped).</span>
</span><span id="PpmsConnection.get_booking-446"><a href="#PpmsConnection.get_booking-446"><span class="linenos">446</span></a>
</span><span id="PpmsConnection.get_booking-447"><a href="#PpmsConnection.get_booking-447"><span class="linenos">447</span></a><span class="sd">        Parameters</span>
</span><span id="PpmsConnection.get_booking-448"><a href="#PpmsConnection.get_booking-448"><span class="linenos">448</span></a><span class="sd">        ----------</span>
</span><span id="PpmsConnection.get_booking-449"><a href="#PpmsConnection.get_booking-449"><span class="linenos">449</span></a><span class="sd">        system_id : int or int-like</span>
</span><span id="PpmsConnection.get_booking-450"><a href="#PpmsConnection.get_booking-450"><span class="linenos">450</span></a><span class="sd">            The ID of the system in PPMS.</span>
</span><span id="PpmsConnection.get_booking-451"><a href="#PpmsConnection.get_booking-451"><span class="linenos">451</span></a><span class="sd">        booking_type : {&#39;get&#39;, &#39;next&#39;}, optional</span>
</span><span id="PpmsConnection.get_booking-452"><a href="#PpmsConnection.get_booking-452"><span class="linenos">452</span></a><span class="sd">            The type of booking to request, one of `get` (requesting the</span>
</span><span id="PpmsConnection.get_booking-453"><a href="#PpmsConnection.get_booking-453"><span class="linenos">453</span></a><span class="sd">            currently running booking) and `next` (requesting the next upcoming</span>
</span><span id="PpmsConnection.get_booking-454"><a href="#PpmsConnection.get_booking-454"><span class="linenos">454</span></a><span class="sd">            booking), by default `get`.</span>
</span><span id="PpmsConnection.get_booking-455"><a href="#PpmsConnection.get_booking-455"><span class="linenos">455</span></a><span class="sd">            NOTE: if `next` is requested the resulting booking object will **NOT** have</span>
</span><span id="PpmsConnection.get_booking-456"><a href="#PpmsConnection.get_booking-456"><span class="linenos">456</span></a><span class="sd">            an end time (`endtime` will be `None`) as PUMAPI doesn&#39;t provide one in that</span>
</span><span id="PpmsConnection.get_booking-457"><a href="#PpmsConnection.get_booking-457"><span class="linenos">457</span></a><span class="sd">            case!</span>
</span><span id="PpmsConnection.get_booking-458"><a href="#PpmsConnection.get_booking-458"><span class="linenos">458</span></a>
</span><span id="PpmsConnection.get_booking-459"><a href="#PpmsConnection.get_booking-459"><span class="linenos">459</span></a><span class="sd">        Returns</span>
</span><span id="PpmsConnection.get_booking-460"><a href="#PpmsConnection.get_booking-460"><span class="linenos">460</span></a><span class="sd">        -------</span>
</span><span id="PpmsConnection.get_booking-461"><a href="#PpmsConnection.get_booking-461"><span class="linenos">461</span></a><span class="sd">        pyppms.booking.PpmsBooking or None</span>
</span><span id="PpmsConnection.get_booking-462"><a href="#PpmsConnection.get_booking-462"><span class="linenos">462</span></a><span class="sd">            The booking object, or None if there is no booking for the system or the</span>
</span><span id="PpmsConnection.get_booking-463"><a href="#PpmsConnection.get_booking-463"><span class="linenos">463</span></a><span class="sd">            request is refused by PUMAPI (e.g. &quot;not authorized&quot;).</span>
</span><span id="PpmsConnection.get_booking-464"><a href="#PpmsConnection.get_booking-464"><span class="linenos">464</span></a>
</span><span id="PpmsConnection.get_booking-465"><a href="#PpmsConnection.get_booking-465"><span class="linenos">465</span></a><span class="sd">        Raises</span>
</span><span id="PpmsConnection.get_booking-466"><a href="#PpmsConnection.get_booking-466"><span class="linenos">466</span></a><span class="sd">        ------</span>
</span><span id="PpmsConnection.get_booking-467"><a href="#PpmsConnection.get_booking-467"><span class="linenos">467</span></a><span class="sd">        ValueError</span>
</span><span id="PpmsConnection.get_booking-468"><a href="#PpmsConnection.get_booking-468"><span class="linenos">468</span></a><span class="sd">            Raised if the specified `booking_type` is invalid.</span>
</span><span id="PpmsConnection.get_booking-469"><a href="#PpmsConnection.get_booking-469"><span class="linenos">469</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PpmsConnection.get_booking-470"><a href="#PpmsConnection.get_booking-470"><span class="linenos">470</span></a>        <span class="n">valid</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;get&quot;</span><span class="p">,</span> <span class="s2">&quot;next&quot;</span><span class="p">]</span>
</span><span id="PpmsConnection.get_booking-471"><a href="#PpmsConnection.get_booking-471"><span class="linenos">471</span></a>        <span class="k">if</span> <span class="n">booking_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid</span><span class="p">:</span>
</span><span id="PpmsConnection.get_booking-472"><a href="#PpmsConnection.get_booking-472"><span class="linenos">472</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="PpmsConnection.get_booking-473"><a href="#PpmsConnection.get_booking-473"><span class="linenos">473</span></a>                <span class="sa">f</span><span class="s2">&quot;Value for &#39;booking_type&#39; (</span><span class="si">{</span><span class="n">booking_type</span><span class="si">}</span><span class="s2">) not in </span><span class="si">{</span><span class="n">valid</span><span class="si">}</span><span class="s2">!&quot;</span>
</span><span id="PpmsConnection.get_booking-474"><a href="#PpmsConnection.get_booking-474"><span class="linenos">474</span></a>            <span class="p">)</span>
</span><span id="PpmsConnection.get_booking-475"><a href="#PpmsConnection.get_booking-475"><span class="linenos">475</span></a>
</span><span id="PpmsConnection.get_booking-476"><a href="#PpmsConnection.get_booking-476"><span class="linenos">476</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="PpmsConnection.get_booking-477"><a href="#PpmsConnection.get_booking-477"><span class="linenos">477</span></a>            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">booking_type</span> <span class="o">+</span> <span class="s2">&quot;booking&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">system_id</span><span class="p">})</span>
</span><span id="PpmsConnection.get_booking-478"><a href="#PpmsConnection.get_booking-478"><span class="linenos">478</span></a>        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ConnectionError</span><span class="p">:</span>
</span><span id="PpmsConnection.get_booking-479"><a href="#PpmsConnection.get_booking-479"><span class="linenos">479</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Requesting booking status for system </span><span class="si">{}</span><span class="s2"> failed!&quot;</span><span class="p">,</span> <span class="n">system_id</span><span class="p">)</span>
</span><span id="PpmsConnection.get_booking-480"><a href="#PpmsConnection.get_booking-480"><span class="linenos">480</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="PpmsConnection.get_booking-481"><a href="#PpmsConnection.get_booking-481"><span class="linenos">481</span></a>
</span><span id="PpmsConnection.get_booking-482"><a href="#PpmsConnection.get_booking-482"><span class="linenos">482</span></a>        <span class="n">desc</span> <span class="o">=</span> <span class="s2">&quot;any future bookings&quot;</span>
</span><span id="PpmsConnection.get_booking-483"><a href="#PpmsConnection.get_booking-483"><span class="linenos">483</span></a>        <span class="k">if</span> <span class="n">booking_type</span> <span class="o">==</span> <span class="s2">&quot;get&quot;</span><span class="p">:</span>
</span><span id="PpmsConnection.get_booking-484"><a href="#PpmsConnection.get_booking-484"><span class="linenos">484</span></a>            <span class="n">desc</span> <span class="o">=</span> <span class="s2">&quot;a currently active booking&quot;</span>
</span><span id="PpmsConnection.get_booking-485"><a href="#PpmsConnection.get_booking-485"><span class="linenos">485</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
</span><span id="PpmsConnection.get_booking-486"><a href="#PpmsConnection.get_booking-486"><span class="linenos">486</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s2">&quot;System [</span><span class="si">{}</span><span class="s2">] doesn&#39;t have </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">system_id</span><span class="p">,</span> <span class="n">desc</span><span class="p">)</span>
</span><span id="PpmsConnection.get_booking-487"><a href="#PpmsConnection.get_booking-487"><span class="linenos">487</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="PpmsConnection.get_booking-488"><a href="#PpmsConnection.get_booking-488"><span class="linenos">488</span></a>
</span><span id="PpmsConnection.get_booking-489"><a href="#PpmsConnection.get_booking-489"><span class="linenos">489</span></a>        <span class="k">return</span> <span class="n">PpmsBooking</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">booking_type</span><span class="p">,</span> <span class="n">system_id</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Get the current or next booking of a system.</p>

<p>WARNING: if the next booking is requested but it is too far in the future,
PUMAPI silently ignores it - the response is identical to a system that has no
future bookings and there is no error reported either. Currently it is unclear
where the cutoff is (e.g. lookups for a booking that is two years from now still
work fine, but a booking in about 10 years is silently skipped).</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>system_id</strong> (int or int-like):
The ID of the system in PPMS.</li>
<li><strong>booking_type</strong> ({'get', 'next'}, optional):
The type of booking to request, one of <code>get</code> (requesting the
currently running booking) and <code>next</code> (requesting the next upcoming
booking), by default <code>get</code>.
NOTE: if <code>next</code> is requested the resulting booking object will <strong>NOT</strong> have
an end time (<code>endtime</code> will be <code>None</code>) as PUMAPI doesn't provide one in that
case!</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong><a href="booking.html#PpmsBooking">pyppms.booking.PpmsBooking</a> or None</strong>: The booking object, or None if there is no booking for the system or the
request is refused by PUMAPI (e.g. "not authorized").</li>
</ul>

<h6 id="raises">Raises</h6>

<ul>
<li><strong>ValueError</strong>: Raised if the specified <code>booking_type</code> is invalid.</li>
</ul>
</div>


                            </div>
                            <div id="PpmsConnection.get_current_booking" class="classattr">
                                        <input id="PpmsConnection.get_current_booking-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_current_booking</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">system_id</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="PpmsConnection.get_current_booking-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PpmsConnection.get_current_booking"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PpmsConnection.get_current_booking-491"><a href="#PpmsConnection.get_current_booking-491"><span class="linenos">491</span></a>    <span class="k">def</span> <span class="nf">get_current_booking</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">system_id</span><span class="p">):</span>
</span><span id="PpmsConnection.get_current_booking-492"><a href="#PpmsConnection.get_current_booking-492"><span class="linenos">492</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Wrapper for `get_booking()` with &#39;booking_type&#39; set to &#39;get&#39;.&quot;&quot;&quot;</span>
</span><span id="PpmsConnection.get_current_booking-493"><a href="#PpmsConnection.get_current_booking-493"><span class="linenos">493</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_booking</span><span class="p">(</span><span class="n">system_id</span><span class="p">,</span> <span class="s2">&quot;get&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Wrapper for <code><a href="#PpmsConnection.get_booking">get_booking()</a></code> with 'booking_type' set to 'get'.</p>
</div>


                            </div>
                            <div id="PpmsConnection.get_group" class="classattr">
                                        <input id="PpmsConnection.get_group-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_group</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">group_id</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="PpmsConnection.get_group-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PpmsConnection.get_group"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PpmsConnection.get_group-495"><a href="#PpmsConnection.get_group-495"><span class="linenos">495</span></a>    <span class="k">def</span> <span class="nf">get_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group_id</span><span class="p">):</span>
</span><span id="PpmsConnection.get_group-496"><a href="#PpmsConnection.get_group-496"><span class="linenos">496</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Fetch group details from PPMS and create a dict from them.</span>
</span><span id="PpmsConnection.get_group-497"><a href="#PpmsConnection.get_group-497"><span class="linenos">497</span></a>
</span><span id="PpmsConnection.get_group-498"><a href="#PpmsConnection.get_group-498"><span class="linenos">498</span></a><span class="sd">        Parameters</span>
</span><span id="PpmsConnection.get_group-499"><a href="#PpmsConnection.get_group-499"><span class="linenos">499</span></a><span class="sd">        ----------</span>
</span><span id="PpmsConnection.get_group-500"><a href="#PpmsConnection.get_group-500"><span class="linenos">500</span></a><span class="sd">        group_id : str</span>
</span><span id="PpmsConnection.get_group-501"><a href="#PpmsConnection.get_group-501"><span class="linenos">501</span></a><span class="sd">            The group&#39;s identifier in PPMS, called &#39;unitlogin&#39; there.</span>
</span><span id="PpmsConnection.get_group-502"><a href="#PpmsConnection.get_group-502"><span class="linenos">502</span></a>
</span><span id="PpmsConnection.get_group-503"><a href="#PpmsConnection.get_group-503"><span class="linenos">503</span></a><span class="sd">        Returns</span>
</span><span id="PpmsConnection.get_group-504"><a href="#PpmsConnection.get_group-504"><span class="linenos">504</span></a><span class="sd">        -------</span>
</span><span id="PpmsConnection.get_group-505"><a href="#PpmsConnection.get_group-505"><span class="linenos">505</span></a><span class="sd">        dict</span>
</span><span id="PpmsConnection.get_group-506"><a href="#PpmsConnection.get_group-506"><span class="linenos">506</span></a><span class="sd">            A dict with the group details, keys being derived from the header</span>
</span><span id="PpmsConnection.get_group-507"><a href="#PpmsConnection.get_group-507"><span class="linenos">507</span></a><span class="sd">            line of the PUMAPI response, values from the data line.</span>
</span><span id="PpmsConnection.get_group-508"><a href="#PpmsConnection.get_group-508"><span class="linenos">508</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PpmsConnection.get_group-509"><a href="#PpmsConnection.get_group-509"><span class="linenos">509</span></a>        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;getgroup&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;unitlogin&quot;</span><span class="p">:</span> <span class="n">group_id</span><span class="p">})</span>
</span><span id="PpmsConnection.get_group-510"><a href="#PpmsConnection.get_group-510"><span class="linenos">510</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s2">&quot;Group details returned by PPMS (raw): </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</span><span id="PpmsConnection.get_group-511"><a href="#PpmsConnection.get_group-511"><span class="linenos">511</span></a>
</span><span id="PpmsConnection.get_group-512"><a href="#PpmsConnection.get_group-512"><span class="linenos">512</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
</span><span id="PpmsConnection.get_group-513"><a href="#PpmsConnection.get_group-513"><span class="linenos">513</span></a>            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Group [</span><span class="si">{</span><span class="n">group_id</span><span class="si">}</span><span class="s2">] is unknown to PPMS&quot;</span>
</span><span id="PpmsConnection.get_group-514"><a href="#PpmsConnection.get_group-514"><span class="linenos">514</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="PpmsConnection.get_group-515"><a href="#PpmsConnection.get_group-515"><span class="linenos">515</span></a>            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="PpmsConnection.get_group-516"><a href="#PpmsConnection.get_group-516"><span class="linenos">516</span></a>
</span><span id="PpmsConnection.get_group-517"><a href="#PpmsConnection.get_group-517"><span class="linenos">517</span></a>        <span class="n">details</span> <span class="o">=</span> <span class="n">dict_from_single_response</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</span><span id="PpmsConnection.get_group-518"><a href="#PpmsConnection.get_group-518"><span class="linenos">518</span></a>
</span><span id="PpmsConnection.get_group-519"><a href="#PpmsConnection.get_group-519"><span class="linenos">519</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s2">&quot;Details of group </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">group_id</span><span class="p">,</span> <span class="n">details</span><span class="p">)</span>
</span><span id="PpmsConnection.get_group-520"><a href="#PpmsConnection.get_group-520"><span class="linenos">520</span></a>        <span class="k">return</span> <span class="n">details</span>
</span></pre></div>


            <div class="docstring"><p>Fetch group details from PPMS and create a dict from them.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>group_id</strong> (str):
The group's identifier in PPMS, called 'unitlogin' there.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>dict</strong>: A dict with the group details, keys being derived from the header
line of the PUMAPI response, values from the data line.</li>
</ul>
</div>


                            </div>
                            <div id="PpmsConnection.get_group_users" class="classattr">
                                        <input id="PpmsConnection.get_group_users-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_group_users</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">unitlogin</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="PpmsConnection.get_group_users-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PpmsConnection.get_group_users"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PpmsConnection.get_group_users-522"><a href="#PpmsConnection.get_group_users-522"><span class="linenos">522</span></a>    <span class="k">def</span> <span class="nf">get_group_users</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unitlogin</span><span class="p">):</span>
</span><span id="PpmsConnection.get_group_users-523"><a href="#PpmsConnection.get_group_users-523"><span class="linenos">523</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get all members of a group in PPMS.</span>
</span><span id="PpmsConnection.get_group_users-524"><a href="#PpmsConnection.get_group_users-524"><span class="linenos">524</span></a>
</span><span id="PpmsConnection.get_group_users-525"><a href="#PpmsConnection.get_group_users-525"><span class="linenos">525</span></a><span class="sd">        Parameters</span>
</span><span id="PpmsConnection.get_group_users-526"><a href="#PpmsConnection.get_group_users-526"><span class="linenos">526</span></a><span class="sd">        ----------</span>
</span><span id="PpmsConnection.get_group_users-527"><a href="#PpmsConnection.get_group_users-527"><span class="linenos">527</span></a><span class="sd">        unitlogin : str</span>
</span><span id="PpmsConnection.get_group_users-528"><a href="#PpmsConnection.get_group_users-528"><span class="linenos">528</span></a><span class="sd">            The group&#39;s login (&quot;unique login or id&quot; in the PPMS web interface).</span>
</span><span id="PpmsConnection.get_group_users-529"><a href="#PpmsConnection.get_group_users-529"><span class="linenos">529</span></a>
</span><span id="PpmsConnection.get_group_users-530"><a href="#PpmsConnection.get_group_users-530"><span class="linenos">530</span></a><span class="sd">        Returns</span>
</span><span id="PpmsConnection.get_group_users-531"><a href="#PpmsConnection.get_group_users-531"><span class="linenos">531</span></a><span class="sd">        -------</span>
</span><span id="PpmsConnection.get_group_users-532"><a href="#PpmsConnection.get_group_users-532"><span class="linenos">532</span></a><span class="sd">        list(pyppms.user.PpmsUser)</span>
</span><span id="PpmsConnection.get_group_users-533"><a href="#PpmsConnection.get_group_users-533"><span class="linenos">533</span></a><span class="sd">            A list with PpmsUser objects that are members of this PPMS group.</span>
</span><span id="PpmsConnection.get_group_users-534"><a href="#PpmsConnection.get_group_users-534"><span class="linenos">534</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PpmsConnection.get_group_users-535"><a href="#PpmsConnection.get_group_users-535"><span class="linenos">535</span></a>        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;getgroupusers&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;unitlogin&quot;</span><span class="p">:</span> <span class="n">unitlogin</span><span class="p">})</span>
</span><span id="PpmsConnection.get_group_users-536"><a href="#PpmsConnection.get_group_users-536"><span class="linenos">536</span></a>
</span><span id="PpmsConnection.get_group_users-537"><a href="#PpmsConnection.get_group_users-537"><span class="linenos">537</span></a>        <span class="n">members</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
</span><span id="PpmsConnection.get_group_users-538"><a href="#PpmsConnection.get_group_users-538"><span class="linenos">538</span></a>        <span class="n">users</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="PpmsConnection.get_group_users-539"><a href="#PpmsConnection.get_group_users-539"><span class="linenos">539</span></a>        <span class="k">for</span> <span class="n">username</span> <span class="ow">in</span> <span class="n">members</span><span class="p">:</span>
</span><span id="PpmsConnection.get_group_users-540"><a href="#PpmsConnection.get_group_users-540"><span class="linenos">540</span></a>            <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
</span><span id="PpmsConnection.get_group_users-541"><a href="#PpmsConnection.get_group_users-541"><span class="linenos">541</span></a>            <span class="n">users</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</span><span id="PpmsConnection.get_group_users-542"><a href="#PpmsConnection.get_group_users-542"><span class="linenos">542</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span>
</span><span id="PpmsConnection.get_group_users-543"><a href="#PpmsConnection.get_group_users-543"><span class="linenos">543</span></a>            <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> members in PPMS group [</span><span class="si">{}</span><span class="s2">]: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="PpmsConnection.get_group_users-544"><a href="#PpmsConnection.get_group_users-544"><span class="linenos">544</span></a>            <span class="nb">len</span><span class="p">(</span><span class="n">members</span><span class="p">),</span>
</span><span id="PpmsConnection.get_group_users-545"><a href="#PpmsConnection.get_group_users-545"><span class="linenos">545</span></a>            <span class="n">unitlogin</span><span class="p">,</span>
</span><span id="PpmsConnection.get_group_users-546"><a href="#PpmsConnection.get_group_users-546"><span class="linenos">546</span></a>            <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">members</span><span class="p">),</span>
</span><span id="PpmsConnection.get_group_users-547"><a href="#PpmsConnection.get_group_users-547"><span class="linenos">547</span></a>        <span class="p">)</span>
</span><span id="PpmsConnection.get_group_users-548"><a href="#PpmsConnection.get_group_users-548"><span class="linenos">548</span></a>        <span class="k">return</span> <span class="n">users</span>
</span></pre></div>


            <div class="docstring"><p>Get all members of a group in PPMS.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>unitlogin</strong> (str):
The group's login ("unique login or id" in the PPMS web interface).</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>list(<a href="user.html#PpmsUser">pyppms.user.PpmsUser</a>)</strong>: A list with PpmsUser objects that are members of this PPMS group.</li>
</ul>
</div>


                            </div>
                            <div id="PpmsConnection.get_groups" class="classattr">
                                        <input id="PpmsConnection.get_groups-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_groups</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="PpmsConnection.get_groups-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PpmsConnection.get_groups"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PpmsConnection.get_groups-550"><a href="#PpmsConnection.get_groups-550"><span class="linenos">550</span></a>    <span class="k">def</span> <span class="nf">get_groups</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="PpmsConnection.get_groups-551"><a href="#PpmsConnection.get_groups-551"><span class="linenos">551</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get a list of all groups in PPMS.</span>
</span><span id="PpmsConnection.get_groups-552"><a href="#PpmsConnection.get_groups-552"><span class="linenos">552</span></a>
</span><span id="PpmsConnection.get_groups-553"><a href="#PpmsConnection.get_groups-553"><span class="linenos">553</span></a><span class="sd">        Returns</span>
</span><span id="PpmsConnection.get_groups-554"><a href="#PpmsConnection.get_groups-554"><span class="linenos">554</span></a><span class="sd">        -------</span>
</span><span id="PpmsConnection.get_groups-555"><a href="#PpmsConnection.get_groups-555"><span class="linenos">555</span></a><span class="sd">        list(str)</span>
</span><span id="PpmsConnection.get_groups-556"><a href="#PpmsConnection.get_groups-556"><span class="linenos">556</span></a><span class="sd">            A list with the group identifiers in PPMS.</span>
</span><span id="PpmsConnection.get_groups-557"><a href="#PpmsConnection.get_groups-557"><span class="linenos">557</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PpmsConnection.get_groups-558"><a href="#PpmsConnection.get_groups-558"><span class="linenos">558</span></a>        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;getgroups&quot;</span><span class="p">)</span>
</span><span id="PpmsConnection.get_groups-559"><a href="#PpmsConnection.get_groups-559"><span class="linenos">559</span></a>
</span><span id="PpmsConnection.get_groups-560"><a href="#PpmsConnection.get_groups-560"><span class="linenos">560</span></a>        <span class="n">groups</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
</span><span id="PpmsConnection.get_groups-561"><a href="#PpmsConnection.get_groups-561"><span class="linenos">561</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> groups in the PPMS database: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">groups</span><span class="p">),</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">groups</span><span class="p">))</span>
</span><span id="PpmsConnection.get_groups-562"><a href="#PpmsConnection.get_groups-562"><span class="linenos">562</span></a>        <span class="k">return</span> <span class="n">groups</span>
</span></pre></div>


            <div class="docstring"><p>Get a list of all groups in PPMS.</p>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>list(str)</strong>: A list with the group identifiers in PPMS.</li>
</ul>
</div>


                            </div>
                            <div id="PpmsConnection.get_next_booking" class="classattr">
                                        <input id="PpmsConnection.get_next_booking-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_next_booking</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">system_id</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="PpmsConnection.get_next_booking-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PpmsConnection.get_next_booking"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PpmsConnection.get_next_booking-564"><a href="#PpmsConnection.get_next_booking-564"><span class="linenos">564</span></a>    <span class="k">def</span> <span class="nf">get_next_booking</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">system_id</span><span class="p">):</span>
</span><span id="PpmsConnection.get_next_booking-565"><a href="#PpmsConnection.get_next_booking-565"><span class="linenos">565</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Wrapper for `get_booking()` with &#39;booking_type&#39; set to &#39;next&#39;.&quot;&quot;&quot;</span>
</span><span id="PpmsConnection.get_next_booking-566"><a href="#PpmsConnection.get_next_booking-566"><span class="linenos">566</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_booking</span><span class="p">(</span><span class="n">system_id</span><span class="p">,</span> <span class="s2">&quot;next&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Wrapper for <code><a href="#PpmsConnection.get_booking">get_booking()</a></code> with 'booking_type' set to 'next'.</p>
</div>


                            </div>
                            <div id="PpmsConnection.get_running_sheet" class="classattr">
                                        <input id="PpmsConnection.get_running_sheet-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_running_sheet</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">core_facility_ref</span>, </span><span class="param"><span class="n">date</span>, </span><span class="param"><span class="n">ignore_uncached_users</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="PpmsConnection.get_running_sheet-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PpmsConnection.get_running_sheet"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PpmsConnection.get_running_sheet-568"><a href="#PpmsConnection.get_running_sheet-568"><span class="linenos">568</span></a>    <span class="k">def</span> <span class="nf">get_running_sheet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">core_facility_ref</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">ignore_uncached_users</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="PpmsConnection.get_running_sheet-569"><a href="#PpmsConnection.get_running_sheet-569"><span class="linenos">569</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the running sheet for a specific day on the given facility.</span>
</span><span id="PpmsConnection.get_running_sheet-570"><a href="#PpmsConnection.get_running_sheet-570"><span class="linenos">570</span></a>
</span><span id="PpmsConnection.get_running_sheet-571"><a href="#PpmsConnection.get_running_sheet-571"><span class="linenos">571</span></a><span class="sd">        The so-called &quot;running-sheet&quot; consists of all bookings / reservations of</span>
</span><span id="PpmsConnection.get_running_sheet-572"><a href="#PpmsConnection.get_running_sheet-572"><span class="linenos">572</span></a><span class="sd">        a facility on a specifc day.</span>
</span><span id="PpmsConnection.get_running_sheet-573"><a href="#PpmsConnection.get_running_sheet-573"><span class="linenos">573</span></a>
</span><span id="PpmsConnection.get_running_sheet-574"><a href="#PpmsConnection.get_running_sheet-574"><span class="linenos">574</span></a><span class="sd">        WARNING: PUMAPI doesn&#39;t return a proper unique user identifier with the</span>
</span><span id="PpmsConnection.get_running_sheet-575"><a href="#PpmsConnection.get_running_sheet-575"><span class="linenos">575</span></a><span class="sd">        &#39;getrunningsheet&#39; request, instead the so called &quot;full name&quot; is given to</span>
</span><span id="PpmsConnection.get_running_sheet-576"><a href="#PpmsConnection.get_running_sheet-576"><span class="linenos">576</span></a><span class="sd">        identify the user - unfortunately this can lead to ambiguities as</span>
</span><span id="PpmsConnection.get_running_sheet-577"><a href="#PpmsConnection.get_running_sheet-577"><span class="linenos">577</span></a><span class="sd">        multiple different accounts can have the same full name.</span>
</span><span id="PpmsConnection.get_running_sheet-578"><a href="#PpmsConnection.get_running_sheet-578"><span class="linenos">578</span></a>
</span><span id="PpmsConnection.get_running_sheet-579"><a href="#PpmsConnection.get_running_sheet-579"><span class="linenos">579</span></a><span class="sd">        Parameters</span>
</span><span id="PpmsConnection.get_running_sheet-580"><a href="#PpmsConnection.get_running_sheet-580"><span class="linenos">580</span></a><span class="sd">        ----------</span>
</span><span id="PpmsConnection.get_running_sheet-581"><a href="#PpmsConnection.get_running_sheet-581"><span class="linenos">581</span></a><span class="sd">        core_facility_ref : int or int-like</span>
</span><span id="PpmsConnection.get_running_sheet-582"><a href="#PpmsConnection.get_running_sheet-582"><span class="linenos">582</span></a><span class="sd">            The core facility ID for PPMS.</span>
</span><span id="PpmsConnection.get_running_sheet-583"><a href="#PpmsConnection.get_running_sheet-583"><span class="linenos">583</span></a><span class="sd">        date : datetime.datetime</span>
</span><span id="PpmsConnection.get_running_sheet-584"><a href="#PpmsConnection.get_running_sheet-584"><span class="linenos">584</span></a><span class="sd">            The date to request the running sheet for, e.g. ``datetime.now()`` or</span>
</span><span id="PpmsConnection.get_running_sheet-585"><a href="#PpmsConnection.get_running_sheet-585"><span class="linenos">585</span></a><span class="sd">            similar. Note that only the date part is relevant, time will be ignored.</span>
</span><span id="PpmsConnection.get_running_sheet-586"><a href="#PpmsConnection.get_running_sheet-586"><span class="linenos">586</span></a><span class="sd">        ignore_uncached_users : bool, optional</span>
</span><span id="PpmsConnection.get_running_sheet-587"><a href="#PpmsConnection.get_running_sheet-587"><span class="linenos">587</span></a><span class="sd">            If set to `True` any booking for a user that is not present in the instance</span>
</span><span id="PpmsConnection.get_running_sheet-588"><a href="#PpmsConnection.get_running_sheet-588"><span class="linenos">588</span></a><span class="sd">            attribute `fullname_mapping` will be ignored in the resulting list.</span>
</span><span id="PpmsConnection.get_running_sheet-589"><a href="#PpmsConnection.get_running_sheet-589"><span class="linenos">589</span></a>
</span><span id="PpmsConnection.get_running_sheet-590"><a href="#PpmsConnection.get_running_sheet-590"><span class="linenos">590</span></a><span class="sd">        Returns</span>
</span><span id="PpmsConnection.get_running_sheet-591"><a href="#PpmsConnection.get_running_sheet-591"><span class="linenos">591</span></a><span class="sd">        -------</span>
</span><span id="PpmsConnection.get_running_sheet-592"><a href="#PpmsConnection.get_running_sheet-592"><span class="linenos">592</span></a><span class="sd">        list(pyppms.booking.PpmsBooking)</span>
</span><span id="PpmsConnection.get_running_sheet-593"><a href="#PpmsConnection.get_running_sheet-593"><span class="linenos">593</span></a><span class="sd">            A list with `PpmsBooking` objects for the given day. Empty in case</span>
</span><span id="PpmsConnection.get_running_sheet-594"><a href="#PpmsConnection.get_running_sheet-594"><span class="linenos">594</span></a><span class="sd">            there are no bookings or parsing the response failed.</span>
</span><span id="PpmsConnection.get_running_sheet-595"><a href="#PpmsConnection.get_running_sheet-595"><span class="linenos">595</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PpmsConnection.get_running_sheet-596"><a href="#PpmsConnection.get_running_sheet-596"><span class="linenos">596</span></a>        <span class="n">bookings</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="PpmsConnection.get_running_sheet-597"><a href="#PpmsConnection.get_running_sheet-597"><span class="linenos">597</span></a>        <span class="n">parameters</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="PpmsConnection.get_running_sheet-598"><a href="#PpmsConnection.get_running_sheet-598"><span class="linenos">598</span></a>            <span class="s2">&quot;plateformid&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">core_facility_ref</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="PpmsConnection.get_running_sheet-599"><a href="#PpmsConnection.get_running_sheet-599"><span class="linenos">599</span></a>            <span class="s2">&quot;day&quot;</span><span class="p">:</span> <span class="n">date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">),</span>
</span><span id="PpmsConnection.get_running_sheet-600"><a href="#PpmsConnection.get_running_sheet-600"><span class="linenos">600</span></a>        <span class="p">}</span>
</span><span id="PpmsConnection.get_running_sheet-601"><a href="#PpmsConnection.get_running_sheet-601"><span class="linenos">601</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s2">&quot;Requesting runningsheet for </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;day&quot;</span><span class="p">])</span>
</span><span id="PpmsConnection.get_running_sheet-602"><a href="#PpmsConnection.get_running_sheet-602"><span class="linenos">602</span></a>        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;getrunningsheet&quot;</span><span class="p">,</span> <span class="n">parameters</span><span class="p">)</span>
</span><span id="PpmsConnection.get_running_sheet-603"><a href="#PpmsConnection.get_running_sheet-603"><span class="linenos">603</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="PpmsConnection.get_running_sheet-604"><a href="#PpmsConnection.get_running_sheet-604"><span class="linenos">604</span></a>            <span class="n">entries</span> <span class="o">=</span> <span class="n">parse_multiline_response</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">graceful</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="PpmsConnection.get_running_sheet-605"><a href="#PpmsConnection.get_running_sheet-605"><span class="linenos">605</span></a>        <span class="k">except</span> <span class="n">NoDataError</span><span class="p">:</span>
</span><span id="PpmsConnection.get_running_sheet-606"><a href="#PpmsConnection.get_running_sheet-606"><span class="linenos">606</span></a>            <span class="c1"># in case no bookings exist the response will be empty!</span>
</span><span id="PpmsConnection.get_running_sheet-607"><a href="#PpmsConnection.get_running_sheet-607"><span class="linenos">607</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s2">&quot;Runningsheet for the given day was empty!&quot;</span><span class="p">)</span>
</span><span id="PpmsConnection.get_running_sheet-608"><a href="#PpmsConnection.get_running_sheet-608"><span class="linenos">608</span></a>            <span class="k">return</span> <span class="p">[]</span>
</span><span id="PpmsConnection.get_running_sheet-609"><a href="#PpmsConnection.get_running_sheet-609"><span class="linenos">609</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>  <span class="c1"># pylint: disable-msg=broad-except</span>
</span><span id="PpmsConnection.get_running_sheet-610"><a href="#PpmsConnection.get_running_sheet-610"><span class="linenos">610</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Parsing runningsheet details failed: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
</span><span id="PpmsConnection.get_running_sheet-611"><a href="#PpmsConnection.get_running_sheet-611"><span class="linenos">611</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s2">&quot;Runningsheet PUMPAI response was: &gt;&gt;&gt;</span><span class="si">{}</span><span class="s2">&lt;&lt;&lt;&quot;</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</span><span id="PpmsConnection.get_running_sheet-612"><a href="#PpmsConnection.get_running_sheet-612"><span class="linenos">612</span></a>            <span class="k">return</span> <span class="p">[]</span>
</span><span id="PpmsConnection.get_running_sheet-613"><a href="#PpmsConnection.get_running_sheet-613"><span class="linenos">613</span></a>
</span><span id="PpmsConnection.get_running_sheet-614"><a href="#PpmsConnection.get_running_sheet-614"><span class="linenos">614</span></a>        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
</span><span id="PpmsConnection.get_running_sheet-615"><a href="#PpmsConnection.get_running_sheet-615"><span class="linenos">615</span></a>            <span class="n">full</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;User&quot;</span><span class="p">]</span>
</span><span id="PpmsConnection.get_running_sheet-616"><a href="#PpmsConnection.get_running_sheet-616"><span class="linenos">616</span></a>            <span class="k">if</span> <span class="n">full</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fullname_mapping</span><span class="p">:</span>
</span><span id="PpmsConnection.get_running_sheet-617"><a href="#PpmsConnection.get_running_sheet-617"><span class="linenos">617</span></a>                <span class="k">if</span> <span class="n">ignore_uncached_users</span><span class="p">:</span>
</span><span id="PpmsConnection.get_running_sheet-618"><a href="#PpmsConnection.get_running_sheet-618"><span class="linenos">618</span></a>                    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Ignoring booking for uncached / unknown user [</span><span class="si">{</span><span class="n">full</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
</span><span id="PpmsConnection.get_running_sheet-619"><a href="#PpmsConnection.get_running_sheet-619"><span class="linenos">619</span></a>                    <span class="k">continue</span>
</span><span id="PpmsConnection.get_running_sheet-620"><a href="#PpmsConnection.get_running_sheet-620"><span class="linenos">620</span></a>
</span><span id="PpmsConnection.get_running_sheet-621"><a href="#PpmsConnection.get_running_sheet-621"><span class="linenos">621</span></a>                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Booking refers an uncached user (</span><span class="si">{</span><span class="n">full</span><span class="si">}</span><span class="s2">), updating users!&quot;</span><span class="p">)</span>
</span><span id="PpmsConnection.get_running_sheet-622"><a href="#PpmsConnection.get_running_sheet-622"><span class="linenos">622</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">update_users</span><span class="p">()</span>
</span><span id="PpmsConnection.get_running_sheet-623"><a href="#PpmsConnection.get_running_sheet-623"><span class="linenos">623</span></a>
</span><span id="PpmsConnection.get_running_sheet-624"><a href="#PpmsConnection.get_running_sheet-624"><span class="linenos">624</span></a>            <span class="k">if</span> <span class="n">full</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fullname_mapping</span><span class="p">:</span>
</span><span id="PpmsConnection.get_running_sheet-625"><a href="#PpmsConnection.get_running_sheet-625"><span class="linenos">625</span></a>                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;PPMS doesn&#39;t seem to know user [</span><span class="si">{}</span><span class="s2">], skipping&quot;</span><span class="p">,</span> <span class="n">full</span><span class="p">)</span>
</span><span id="PpmsConnection.get_running_sheet-626"><a href="#PpmsConnection.get_running_sheet-626"><span class="linenos">626</span></a>                <span class="k">continue</span>
</span><span id="PpmsConnection.get_running_sheet-627"><a href="#PpmsConnection.get_running_sheet-627"><span class="linenos">627</span></a>
</span><span id="PpmsConnection.get_running_sheet-628"><a href="#PpmsConnection.get_running_sheet-628"><span class="linenos">628</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span>
</span><span id="PpmsConnection.get_running_sheet-629"><a href="#PpmsConnection.get_running_sheet-629"><span class="linenos">629</span></a>                <span class="sa">f</span><span class="s2">&quot;Booking for user &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">fullname_mapping</span><span class="p">[</span><span class="n">full</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39; (</span><span class="si">{</span><span class="n">full</span><span class="si">}</span><span class="s2">) found&quot;</span>
</span><span id="PpmsConnection.get_running_sheet-630"><a href="#PpmsConnection.get_running_sheet-630"><span class="linenos">630</span></a>            <span class="p">)</span>
</span><span id="PpmsConnection.get_running_sheet-631"><a href="#PpmsConnection.get_running_sheet-631"><span class="linenos">631</span></a>            <span class="n">system_name</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;Object&quot;</span><span class="p">]</span>
</span><span id="PpmsConnection.get_running_sheet-632"><a href="#PpmsConnection.get_running_sheet-632"><span class="linenos">632</span></a>            <span class="n">system_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_systems_matching</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">system_name</span><span class="p">])</span>
</span><span id="PpmsConnection.get_running_sheet-633"><a href="#PpmsConnection.get_running_sheet-633"><span class="linenos">633</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">system_ids</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PpmsConnection.get_running_sheet-634"><a href="#PpmsConnection.get_running_sheet-634"><span class="linenos">634</span></a>                <span class="c1"># NOTE: more than one result should not happen as PPMS doesn&#39;t allow for</span>
</span><span id="PpmsConnection.get_running_sheet-635"><a href="#PpmsConnection.get_running_sheet-635"><span class="linenos">635</span></a>                <span class="c1"># multiple systems having the same name - no result might happen though!</span>
</span><span id="PpmsConnection.get_running_sheet-636"><a href="#PpmsConnection.get_running_sheet-636"><span class="linenos">636</span></a>                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Ignoring booking for unknown system [</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="n">system_name</span><span class="p">)</span>
</span><span id="PpmsConnection.get_running_sheet-637"><a href="#PpmsConnection.get_running_sheet-637"><span class="linenos">637</span></a>                <span class="k">continue</span>
</span><span id="PpmsConnection.get_running_sheet-638"><a href="#PpmsConnection.get_running_sheet-638"><span class="linenos">638</span></a>
</span><span id="PpmsConnection.get_running_sheet-639"><a href="#PpmsConnection.get_running_sheet-639"><span class="linenos">639</span></a>            <span class="n">booking</span> <span class="o">=</span> <span class="n">PpmsBooking</span><span class="o">.</span><span class="n">from_runningsheet</span><span class="p">(</span>
</span><span id="PpmsConnection.get_running_sheet-640"><a href="#PpmsConnection.get_running_sheet-640"><span class="linenos">640</span></a>                <span class="n">entry</span><span class="p">,</span>
</span><span id="PpmsConnection.get_running_sheet-641"><a href="#PpmsConnection.get_running_sheet-641"><span class="linenos">641</span></a>                <span class="n">system_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span><span id="PpmsConnection.get_running_sheet-642"><a href="#PpmsConnection.get_running_sheet-642"><span class="linenos">642</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">fullname_mapping</span><span class="p">[</span><span class="n">full</span><span class="p">],</span>
</span><span id="PpmsConnection.get_running_sheet-643"><a href="#PpmsConnection.get_running_sheet-643"><span class="linenos">643</span></a>                <span class="n">date</span><span class="p">,</span>
</span><span id="PpmsConnection.get_running_sheet-644"><a href="#PpmsConnection.get_running_sheet-644"><span class="linenos">644</span></a>            <span class="p">)</span>
</span><span id="PpmsConnection.get_running_sheet-645"><a href="#PpmsConnection.get_running_sheet-645"><span class="linenos">645</span></a>            <span class="n">bookings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">booking</span><span class="p">)</span>
</span><span id="PpmsConnection.get_running_sheet-646"><a href="#PpmsConnection.get_running_sheet-646"><span class="linenos">646</span></a>
</span><span id="PpmsConnection.get_running_sheet-647"><a href="#PpmsConnection.get_running_sheet-647"><span class="linenos">647</span></a>        <span class="k">return</span> <span class="n">bookings</span>
</span></pre></div>


            <div class="docstring"><p>Get the running sheet for a specific day on the given facility.</p>

<p>The so-called "running-sheet" consists of all bookings / reservations of
a facility on a specifc day.</p>

<p>WARNING: PUMAPI doesn't return a proper unique user identifier with the
'getrunningsheet' request, instead the so called "full name" is given to
identify the user - unfortunately this can lead to ambiguities as
multiple different accounts can have the same full name.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>core_facility_ref</strong> (int or int-like):
The core facility ID for PPMS.</li>
<li><strong>date</strong> (datetime.datetime):
The date to request the running sheet for, e.g. <code>datetime.now()</code> or
similar. Note that only the date part is relevant, time will be ignored.</li>
<li><strong>ignore_uncached_users</strong> (bool, optional):
If set to <code>True</code> any booking for a user that is not present in the instance
attribute <code>fullname_mapping</code> will be ignored in the resulting list.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>list(<a href="booking.html#PpmsBooking">pyppms.booking.PpmsBooking</a>)</strong>: A list with <code>PpmsBooking</code> objects for the given day. Empty in case
there are no bookings or parsing the response failed.</li>
</ul>
</div>


                            </div>
                            <div id="PpmsConnection.get_systems" class="classattr">
                                        <input id="PpmsConnection.get_systems-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_systems</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">force_refresh</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="PpmsConnection.get_systems-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PpmsConnection.get_systems"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PpmsConnection.get_systems-649"><a href="#PpmsConnection.get_systems-649"><span class="linenos">649</span></a>    <span class="k">def</span> <span class="nf">get_systems</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force_refresh</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="PpmsConnection.get_systems-650"><a href="#PpmsConnection.get_systems-650"><span class="linenos">650</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get a dict with all systems in PPMS.</span>
</span><span id="PpmsConnection.get_systems-651"><a href="#PpmsConnection.get_systems-651"><span class="linenos">651</span></a>
</span><span id="PpmsConnection.get_systems-652"><a href="#PpmsConnection.get_systems-652"><span class="linenos">652</span></a><span class="sd">        Parameters</span>
</span><span id="PpmsConnection.get_systems-653"><a href="#PpmsConnection.get_systems-653"><span class="linenos">653</span></a><span class="sd">        ----------</span>
</span><span id="PpmsConnection.get_systems-654"><a href="#PpmsConnection.get_systems-654"><span class="linenos">654</span></a><span class="sd">        force_refresh : bool, optional</span>
</span><span id="PpmsConnection.get_systems-655"><a href="#PpmsConnection.get_systems-655"><span class="linenos">655</span></a><span class="sd">            If `True` the list of systems will be refreshed even if the object&#39;s</span>
</span><span id="PpmsConnection.get_systems-656"><a href="#PpmsConnection.get_systems-656"><span class="linenos">656</span></a><span class="sd">            attribute `self.systems` is non-empty, by default `False`. Please</span>
</span><span id="PpmsConnection.get_systems-657"><a href="#PpmsConnection.get_systems-657"><span class="linenos">657</span></a><span class="sd">            note that this will NOT skip the on-disk cache in case that exists!</span>
</span><span id="PpmsConnection.get_systems-658"><a href="#PpmsConnection.get_systems-658"><span class="linenos">658</span></a>
</span><span id="PpmsConnection.get_systems-659"><a href="#PpmsConnection.get_systems-659"><span class="linenos">659</span></a><span class="sd">        Returns</span>
</span><span id="PpmsConnection.get_systems-660"><a href="#PpmsConnection.get_systems-660"><span class="linenos">660</span></a><span class="sd">        -------</span>
</span><span id="PpmsConnection.get_systems-661"><a href="#PpmsConnection.get_systems-661"><span class="linenos">661</span></a><span class="sd">        dict(pyppms.system.PpmsSystem)</span>
</span><span id="PpmsConnection.get_systems-662"><a href="#PpmsConnection.get_systems-662"><span class="linenos">662</span></a><span class="sd">            A dict with `PpmsSystem` objects parsed from the PUMAPI response where</span>
</span><span id="PpmsConnection.get_systems-663"><a href="#PpmsConnection.get_systems-663"><span class="linenos">663</span></a><span class="sd">            the system ID (int) is used as the dict&#39;s key. If parsing a system</span>
</span><span id="PpmsConnection.get_systems-664"><a href="#PpmsConnection.get_systems-664"><span class="linenos">664</span></a><span class="sd">            fails for any reason, the system is skipped entirely.</span>
</span><span id="PpmsConnection.get_systems-665"><a href="#PpmsConnection.get_systems-665"><span class="linenos">665</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PpmsConnection.get_systems-666"><a href="#PpmsConnection.get_systems-666"><span class="linenos">666</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">systems</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">force_refresh</span><span class="p">:</span>
</span><span id="PpmsConnection.get_systems-667"><a href="#PpmsConnection.get_systems-667"><span class="linenos">667</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s2">&quot;Using cached details for </span><span class="si">{}</span><span class="s2"> systems&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">systems</span><span class="p">))</span>
</span><span id="PpmsConnection.get_systems-668"><a href="#PpmsConnection.get_systems-668"><span class="linenos">668</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="PpmsConnection.get_systems-669"><a href="#PpmsConnection.get_systems-669"><span class="linenos">669</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">update_systems</span><span class="p">()</span>
</span><span id="PpmsConnection.get_systems-670"><a href="#PpmsConnection.get_systems-670"><span class="linenos">670</span></a>
</span><span id="PpmsConnection.get_systems-671"><a href="#PpmsConnection.get_systems-671"><span class="linenos">671</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">systems</span>
</span></pre></div>


            <div class="docstring"><p>Get a dict with all systems in PPMS.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>force_refresh</strong> (bool, optional):
If <code>True</code> the list of systems will be refreshed even if the object's
attribute <code>self.systems</code> is non-empty, by default <code>False</code>. Please
note that this will NOT skip the on-disk cache in case that exists!</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>dict(<a href="system.html#PpmsSystem">pyppms.system.PpmsSystem</a>)</strong>: A dict with <code>PpmsSystem</code> objects parsed from the PUMAPI response where
the system ID (int) is used as the dict's key. If parsing a system
fails for any reason, the system is skipped entirely.</li>
</ul>
</div>


                            </div>
                            <div id="PpmsConnection.get_systems_matching" class="classattr">
                                        <input id="PpmsConnection.get_systems_matching-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_systems_matching</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">localisation</span>, </span><span class="param"><span class="n">name_contains</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="PpmsConnection.get_systems_matching-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PpmsConnection.get_systems_matching"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PpmsConnection.get_systems_matching-673"><a href="#PpmsConnection.get_systems_matching-673"><span class="linenos">673</span></a>    <span class="k">def</span> <span class="nf">get_systems_matching</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">localisation</span><span class="p">,</span> <span class="n">name_contains</span><span class="p">):</span>
</span><span id="PpmsConnection.get_systems_matching-674"><a href="#PpmsConnection.get_systems_matching-674"><span class="linenos">674</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Query PPMS for systems with a specific location and name.</span>
</span><span id="PpmsConnection.get_systems_matching-675"><a href="#PpmsConnection.get_systems_matching-675"><span class="linenos">675</span></a>
</span><span id="PpmsConnection.get_systems_matching-676"><a href="#PpmsConnection.get_systems_matching-676"><span class="linenos">676</span></a><span class="sd">        This method assembles a list of PPMS system IDs whose &quot;localisation&quot;</span>
</span><span id="PpmsConnection.get_systems_matching-677"><a href="#PpmsConnection.get_systems_matching-677"><span class="linenos">677</span></a><span class="sd">        (room) field matches a given string and where the system name contains</span>
</span><span id="PpmsConnection.get_systems_matching-678"><a href="#PpmsConnection.get_systems_matching-678"><span class="linenos">678</span></a><span class="sd">        at least one of the strings given as the `name_contains` parameter.</span>
</span><span id="PpmsConnection.get_systems_matching-679"><a href="#PpmsConnection.get_systems_matching-679"><span class="linenos">679</span></a>
</span><span id="PpmsConnection.get_systems_matching-680"><a href="#PpmsConnection.get_systems_matching-680"><span class="linenos">680</span></a><span class="sd">        Parameters</span>
</span><span id="PpmsConnection.get_systems_matching-681"><a href="#PpmsConnection.get_systems_matching-681"><span class="linenos">681</span></a><span class="sd">        ----------</span>
</span><span id="PpmsConnection.get_systems_matching-682"><a href="#PpmsConnection.get_systems_matching-682"><span class="linenos">682</span></a><span class="sd">        localisation : str</span>
</span><span id="PpmsConnection.get_systems_matching-683"><a href="#PpmsConnection.get_systems_matching-683"><span class="linenos">683</span></a><span class="sd">            A string that the system&#39;s &quot;localisation&quot; (i.e. the &quot;Room&quot; field in</span>
</span><span id="PpmsConnection.get_systems_matching-684"><a href="#PpmsConnection.get_systems_matching-684"><span class="linenos">684</span></a><span class="sd">            the PPMS web interface) has to match. Can be an empty string which</span>
</span><span id="PpmsConnection.get_systems_matching-685"><a href="#PpmsConnection.get_systems_matching-685"><span class="linenos">685</span></a><span class="sd">            will result in no filtering being done on the &quot;Room&quot; attribute.</span>
</span><span id="PpmsConnection.get_systems_matching-686"><a href="#PpmsConnection.get_systems_matching-686"><span class="linenos">686</span></a><span class="sd">        name_contains : list(str)</span>
</span><span id="PpmsConnection.get_systems_matching-687"><a href="#PpmsConnection.get_systems_matching-687"><span class="linenos">687</span></a><span class="sd">            A list of valid names (categories) of which the system&#39;s name has to</span>
</span><span id="PpmsConnection.get_systems_matching-688"><a href="#PpmsConnection.get_systems_matching-688"><span class="linenos">688</span></a><span class="sd">            match at least one for being included. Supply an empty list for</span>
</span><span id="PpmsConnection.get_systems_matching-689"><a href="#PpmsConnection.get_systems_matching-689"><span class="linenos">689</span></a><span class="sd">            skipping this filter.</span>
</span><span id="PpmsConnection.get_systems_matching-690"><a href="#PpmsConnection.get_systems_matching-690"><span class="linenos">690</span></a>
</span><span id="PpmsConnection.get_systems_matching-691"><a href="#PpmsConnection.get_systems_matching-691"><span class="linenos">691</span></a><span class="sd">        Returns</span>
</span><span id="PpmsConnection.get_systems_matching-692"><a href="#PpmsConnection.get_systems_matching-692"><span class="linenos">692</span></a><span class="sd">        -------</span>
</span><span id="PpmsConnection.get_systems_matching-693"><a href="#PpmsConnection.get_systems_matching-693"><span class="linenos">693</span></a><span class="sd">        list(int)</span>
</span><span id="PpmsConnection.get_systems_matching-694"><a href="#PpmsConnection.get_systems_matching-694"><span class="linenos">694</span></a><span class="sd">            A list with PPMS system IDs matching all of the given criteria.</span>
</span><span id="PpmsConnection.get_systems_matching-695"><a href="#PpmsConnection.get_systems_matching-695"><span class="linenos">695</span></a>
</span><span id="PpmsConnection.get_systems_matching-696"><a href="#PpmsConnection.get_systems_matching-696"><span class="linenos">696</span></a><span class="sd">        Raises</span>
</span><span id="PpmsConnection.get_systems_matching-697"><a href="#PpmsConnection.get_systems_matching-697"><span class="linenos">697</span></a><span class="sd">        ------</span>
</span><span id="PpmsConnection.get_systems_matching-698"><a href="#PpmsConnection.get_systems_matching-698"><span class="linenos">698</span></a><span class="sd">        TypeError</span>
</span><span id="PpmsConnection.get_systems_matching-699"><a href="#PpmsConnection.get_systems_matching-699"><span class="linenos">699</span></a><span class="sd">            Raised in case the `name_contains` parameter is of type `str` (it</span>
</span><span id="PpmsConnection.get_systems_matching-700"><a href="#PpmsConnection.get_systems_matching-700"><span class="linenos">700</span></a><span class="sd">            needs to be `list(str)` instead).</span>
</span><span id="PpmsConnection.get_systems_matching-701"><a href="#PpmsConnection.get_systems_matching-701"><span class="linenos">701</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PpmsConnection.get_systems_matching-702"><a href="#PpmsConnection.get_systems_matching-702"><span class="linenos">702</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name_contains</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="PpmsConnection.get_systems_matching-703"><a href="#PpmsConnection.get_systems_matching-703"><span class="linenos">703</span></a>            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;`name_contains` must be a list of str, not str!&quot;</span><span class="p">)</span>
</span><span id="PpmsConnection.get_systems_matching-704"><a href="#PpmsConnection.get_systems_matching-704"><span class="linenos">704</span></a>
</span><span id="PpmsConnection.get_systems_matching-705"><a href="#PpmsConnection.get_systems_matching-705"><span class="linenos">705</span></a>        <span class="n">loc</span> <span class="o">=</span> <span class="n">localisation</span>
</span><span id="PpmsConnection.get_systems_matching-706"><a href="#PpmsConnection.get_systems_matching-706"><span class="linenos">706</span></a>        <span class="n">loc_desc</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;with location matching [</span><span class="si">{</span><span class="n">localisation</span><span class="si">}</span><span class="s2">]&quot;</span>
</span><span id="PpmsConnection.get_systems_matching-707"><a href="#PpmsConnection.get_systems_matching-707"><span class="linenos">707</span></a>        <span class="k">if</span> <span class="n">localisation</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
</span><span id="PpmsConnection.get_systems_matching-708"><a href="#PpmsConnection.get_systems_matching-708"><span class="linenos">708</span></a>            <span class="n">loc_desc</span> <span class="o">=</span> <span class="s2">&quot;(no location filter given)&quot;</span>
</span><span id="PpmsConnection.get_systems_matching-709"><a href="#PpmsConnection.get_systems_matching-709"><span class="linenos">709</span></a>
</span><span id="PpmsConnection.get_systems_matching-710"><a href="#PpmsConnection.get_systems_matching-710"><span class="linenos">710</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span>
</span><span id="PpmsConnection.get_systems_matching-711"><a href="#PpmsConnection.get_systems_matching-711"><span class="linenos">711</span></a>            <span class="s2">&quot;Querying PPMS for systems </span><span class="si">{}</span><span class="s2">, name matching any of </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="PpmsConnection.get_systems_matching-712"><a href="#PpmsConnection.get_systems_matching-712"><span class="linenos">712</span></a>            <span class="n">loc_desc</span><span class="p">,</span>
</span><span id="PpmsConnection.get_systems_matching-713"><a href="#PpmsConnection.get_systems_matching-713"><span class="linenos">713</span></a>            <span class="n">name_contains</span><span class="p">,</span>
</span><span id="PpmsConnection.get_systems_matching-714"><a href="#PpmsConnection.get_systems_matching-714"><span class="linenos">714</span></a>        <span class="p">)</span>
</span><span id="PpmsConnection.get_systems_matching-715"><a href="#PpmsConnection.get_systems_matching-715"><span class="linenos">715</span></a>        <span class="n">system_ids</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="PpmsConnection.get_systems_matching-716"><a href="#PpmsConnection.get_systems_matching-716"><span class="linenos">716</span></a>        <span class="n">systems</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_systems</span><span class="p">()</span>
</span><span id="PpmsConnection.get_systems_matching-717"><a href="#PpmsConnection.get_systems_matching-717"><span class="linenos">717</span></a>        <span class="k">for</span> <span class="n">sys_id</span><span class="p">,</span> <span class="n">system</span> <span class="ow">in</span> <span class="n">systems</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="PpmsConnection.get_systems_matching-718"><a href="#PpmsConnection.get_systems_matching-718"><span class="linenos">718</span></a>            <span class="k">if</span> <span class="n">loc</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">system</span><span class="o">.</span><span class="n">localisation</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
</span><span id="PpmsConnection.get_systems_matching-719"><a href="#PpmsConnection.get_systems_matching-719"><span class="linenos">719</span></a>                <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span>
</span><span id="PpmsConnection.get_systems_matching-720"><a href="#PpmsConnection.get_systems_matching-720"><span class="linenos">720</span></a>                    <span class="s2">&quot;System [</span><span class="si">{}</span><span class="s2">] location (</span><span class="si">{}</span><span class="s2">) is NOT matching (</span><span class="si">{}</span><span class="s2">), ignoring&quot;</span><span class="p">,</span>
</span><span id="PpmsConnection.get_systems_matching-721"><a href="#PpmsConnection.get_systems_matching-721"><span class="linenos">721</span></a>                    <span class="n">system</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
</span><span id="PpmsConnection.get_systems_matching-722"><a href="#PpmsConnection.get_systems_matching-722"><span class="linenos">722</span></a>                    <span class="n">system</span><span class="o">.</span><span class="n">localisation</span><span class="p">,</span>
</span><span id="PpmsConnection.get_systems_matching-723"><a href="#PpmsConnection.get_systems_matching-723"><span class="linenos">723</span></a>                    <span class="n">loc</span><span class="p">,</span>
</span><span id="PpmsConnection.get_systems_matching-724"><a href="#PpmsConnection.get_systems_matching-724"><span class="linenos">724</span></a>                <span class="p">)</span>
</span><span id="PpmsConnection.get_systems_matching-725"><a href="#PpmsConnection.get_systems_matching-725"><span class="linenos">725</span></a>                <span class="k">continue</span>
</span><span id="PpmsConnection.get_systems_matching-726"><a href="#PpmsConnection.get_systems_matching-726"><span class="linenos">726</span></a>
</span><span id="PpmsConnection.get_systems_matching-727"><a href="#PpmsConnection.get_systems_matching-727"><span class="linenos">727</span></a>            <span class="c1"># log.trace(&#39;System [{}] is matching location [{}], checking if &#39;</span>
</span><span id="PpmsConnection.get_systems_matching-728"><a href="#PpmsConnection.get_systems_matching-728"><span class="linenos">728</span></a>            <span class="c1">#           &#39;the name is matching any of the valid pattern {}&#39;,</span>
</span><span id="PpmsConnection.get_systems_matching-729"><a href="#PpmsConnection.get_systems_matching-729"><span class="linenos">729</span></a>            <span class="c1">#           system.name, loc, name_contains)</span>
</span><span id="PpmsConnection.get_systems_matching-730"><a href="#PpmsConnection.get_systems_matching-730"><span class="linenos">730</span></a>            <span class="k">for</span> <span class="n">valid_name</span> <span class="ow">in</span> <span class="n">name_contains</span><span class="p">:</span>
</span><span id="PpmsConnection.get_systems_matching-731"><a href="#PpmsConnection.get_systems_matching-731"><span class="linenos">731</span></a>                <span class="k">if</span> <span class="n">valid_name</span> <span class="ow">in</span> <span class="n">system</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
</span><span id="PpmsConnection.get_systems_matching-732"><a href="#PpmsConnection.get_systems_matching-732"><span class="linenos">732</span></a>                    <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s2">&quot;System [</span><span class="si">{}</span><span class="s2">] matches all criteria&quot;</span><span class="p">,</span> <span class="n">system</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</span><span id="PpmsConnection.get_systems_matching-733"><a href="#PpmsConnection.get_systems_matching-733"><span class="linenos">733</span></a>                    <span class="n">system_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sys_id</span><span class="p">)</span>
</span><span id="PpmsConnection.get_systems_matching-734"><a href="#PpmsConnection.get_systems_matching-734"><span class="linenos">734</span></a>                    <span class="k">break</span>
</span><span id="PpmsConnection.get_systems_matching-735"><a href="#PpmsConnection.get_systems_matching-735"><span class="linenos">735</span></a>
</span><span id="PpmsConnection.get_systems_matching-736"><a href="#PpmsConnection.get_systems_matching-736"><span class="linenos">736</span></a>            <span class="c1"># if sys_id not in system_ids:</span>
</span><span id="PpmsConnection.get_systems_matching-737"><a href="#PpmsConnection.get_systems_matching-737"><span class="linenos">737</span></a>            <span class="c1">#     log.trace(&#39;System [{}] does NOT match a valid name: {}&#39;,</span>
</span><span id="PpmsConnection.get_systems_matching-738"><a href="#PpmsConnection.get_systems_matching-738"><span class="linenos">738</span></a>            <span class="c1">#               system.name, name_contains)</span>
</span><span id="PpmsConnection.get_systems_matching-739"><a href="#PpmsConnection.get_systems_matching-739"><span class="linenos">739</span></a>
</span><span id="PpmsConnection.get_systems_matching-740"><a href="#PpmsConnection.get_systems_matching-740"><span class="linenos">740</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s2">&quot;Found </span><span class="si">{}</span><span class="s2"> bookable systems </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">system_ids</span><span class="p">),</span> <span class="n">loc_desc</span><span class="p">)</span>
</span><span id="PpmsConnection.get_systems_matching-741"><a href="#PpmsConnection.get_systems_matching-741"><span class="linenos">741</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s2">&quot;IDs of matching bookable systems </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">loc_desc</span><span class="p">,</span> <span class="n">system_ids</span><span class="p">)</span>
</span><span id="PpmsConnection.get_systems_matching-742"><a href="#PpmsConnection.get_systems_matching-742"><span class="linenos">742</span></a>        <span class="k">return</span> <span class="n">system_ids</span>
</span></pre></div>


            <div class="docstring"><p>Query PPMS for systems with a specific location and name.</p>

<p>This method assembles a list of PPMS system IDs whose "localisation"
(room) field matches a given string and where the system name contains
at least one of the strings given as the <code>name_contains</code> parameter.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>localisation</strong> (str):
A string that the system's "localisation" (i.e. the "Room" field in
the PPMS web interface) has to match. Can be an empty string which
will result in no filtering being done on the "Room" attribute.</li>
<li><strong>name_contains</strong> (list(str)):
A list of valid names (categories) of which the system's name has to
match at least one for being included. Supply an empty list for
skipping this filter.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>list(int)</strong>: A list with PPMS system IDs matching all of the given criteria.</li>
</ul>

<h6 id="raises">Raises</h6>

<ul>
<li><strong>TypeError</strong>: Raised in case the <code>name_contains</code> parameter is of type <code>str</code> (it
needs to be <code>list(str)</code> instead).</li>
</ul>
</div>


                            </div>
                            <div id="PpmsConnection.get_user" class="classattr">
                                        <input id="PpmsConnection.get_user-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_user</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">login_name</span>, </span><span class="param"><span class="n">skip_cache</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="PpmsConnection.get_user-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PpmsConnection.get_user"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PpmsConnection.get_user-744"><a href="#PpmsConnection.get_user-744"><span class="linenos">744</span></a>    <span class="k">def</span> <span class="nf">get_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">login_name</span><span class="p">,</span> <span class="n">skip_cache</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="PpmsConnection.get_user-745"><a href="#PpmsConnection.get_user-745"><span class="linenos">745</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Fetch user details from PPMS and create a PpmsUser object from it.</span>
</span><span id="PpmsConnection.get_user-746"><a href="#PpmsConnection.get_user-746"><span class="linenos">746</span></a>
</span><span id="PpmsConnection.get_user-747"><a href="#PpmsConnection.get_user-747"><span class="linenos">747</span></a><span class="sd">        Parameters</span>
</span><span id="PpmsConnection.get_user-748"><a href="#PpmsConnection.get_user-748"><span class="linenos">748</span></a><span class="sd">        ----------</span>
</span><span id="PpmsConnection.get_user-749"><a href="#PpmsConnection.get_user-749"><span class="linenos">749</span></a><span class="sd">        login_name : str</span>
</span><span id="PpmsConnection.get_user-750"><a href="#PpmsConnection.get_user-750"><span class="linenos">750</span></a><span class="sd">            The user&#39;s PPMS login name.</span>
</span><span id="PpmsConnection.get_user-751"><a href="#PpmsConnection.get_user-751"><span class="linenos">751</span></a><span class="sd">        skip_cache : bool, optional</span>
</span><span id="PpmsConnection.get_user-752"><a href="#PpmsConnection.get_user-752"><span class="linenos">752</span></a><span class="sd">            Passed as-is to the :py:meth:`request()` method</span>
</span><span id="PpmsConnection.get_user-753"><a href="#PpmsConnection.get_user-753"><span class="linenos">753</span></a>
</span><span id="PpmsConnection.get_user-754"><a href="#PpmsConnection.get_user-754"><span class="linenos">754</span></a><span class="sd">        Returns</span>
</span><span id="PpmsConnection.get_user-755"><a href="#PpmsConnection.get_user-755"><span class="linenos">755</span></a><span class="sd">        -------</span>
</span><span id="PpmsConnection.get_user-756"><a href="#PpmsConnection.get_user-756"><span class="linenos">756</span></a><span class="sd">        pyppms.user.PpmsUser</span>
</span><span id="PpmsConnection.get_user-757"><a href="#PpmsConnection.get_user-757"><span class="linenos">757</span></a><span class="sd">            The user object created from the PUMAPI response. The object will be</span>
</span><span id="PpmsConnection.get_user-758"><a href="#PpmsConnection.get_user-758"><span class="linenos">758</span></a><span class="sd">            additionally stored in the self.users dict using the login_name as</span>
</span><span id="PpmsConnection.get_user-759"><a href="#PpmsConnection.get_user-759"><span class="linenos">759</span></a><span class="sd">            the dict&#39;s key.</span>
</span><span id="PpmsConnection.get_user-760"><a href="#PpmsConnection.get_user-760"><span class="linenos">760</span></a>
</span><span id="PpmsConnection.get_user-761"><a href="#PpmsConnection.get_user-761"><span class="linenos">761</span></a><span class="sd">        Raises</span>
</span><span id="PpmsConnection.get_user-762"><a href="#PpmsConnection.get_user-762"><span class="linenos">762</span></a><span class="sd">        ------</span>
</span><span id="PpmsConnection.get_user-763"><a href="#PpmsConnection.get_user-763"><span class="linenos">763</span></a><span class="sd">        KeyError</span>
</span><span id="PpmsConnection.get_user-764"><a href="#PpmsConnection.get_user-764"><span class="linenos">764</span></a><span class="sd">            Raised if the user doesn&#39;t exist in PPMS.</span>
</span><span id="PpmsConnection.get_user-765"><a href="#PpmsConnection.get_user-765"><span class="linenos">765</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PpmsConnection.get_user-766"><a href="#PpmsConnection.get_user-766"><span class="linenos">766</span></a>        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;getuser&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;login&quot;</span><span class="p">:</span> <span class="n">login_name</span><span class="p">},</span> <span class="n">skip_cache</span><span class="o">=</span><span class="n">skip_cache</span><span class="p">)</span>
</span><span id="PpmsConnection.get_user-767"><a href="#PpmsConnection.get_user-767"><span class="linenos">767</span></a>
</span><span id="PpmsConnection.get_user-768"><a href="#PpmsConnection.get_user-768"><span class="linenos">768</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
</span><span id="PpmsConnection.get_user-769"><a href="#PpmsConnection.get_user-769"><span class="linenos">769</span></a>            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;User [</span><span class="si">{</span><span class="n">login_name</span><span class="si">}</span><span class="s2">] is unknown to PPMS&quot;</span>
</span><span id="PpmsConnection.get_user-770"><a href="#PpmsConnection.get_user-770"><span class="linenos">770</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="PpmsConnection.get_user-771"><a href="#PpmsConnection.get_user-771"><span class="linenos">771</span></a>            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="PpmsConnection.get_user-772"><a href="#PpmsConnection.get_user-772"><span class="linenos">772</span></a>
</span><span id="PpmsConnection.get_user-773"><a href="#PpmsConnection.get_user-773"><span class="linenos">773</span></a>        <span class="n">user</span> <span class="o">=</span> <span class="n">PpmsUser</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</span><span id="PpmsConnection.get_user-774"><a href="#PpmsConnection.get_user-774"><span class="linenos">774</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="p">[</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">]</span> <span class="o">=</span> <span class="n">user</span>  <span class="c1"># update / add to the cached user objs</span>
</span><span id="PpmsConnection.get_user-775"><a href="#PpmsConnection.get_user-775"><span class="linenos">775</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fullname_mapping</span><span class="p">[</span><span class="n">user</span><span class="o">.</span><span class="n">fullname</span><span class="p">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span>
</span><span id="PpmsConnection.get_user-776"><a href="#PpmsConnection.get_user-776"><span class="linenos">776</span></a>        <span class="k">return</span> <span class="n">user</span>
</span></pre></div>


            <div class="docstring"><p>Fetch user details from PPMS and create a PpmsUser object from it.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>login_name</strong> (str):
The user's PPMS login name.</li>
<li><strong>skip_cache</strong> (bool, optional):
Passed as-is to the <code>request()()</code> method</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong><a href="user.html#PpmsUser">pyppms.user.PpmsUser</a></strong>: The user object created from the PUMAPI response. The object will be
additionally stored in the self.users dict using the login_name as
the dict's key.</li>
</ul>

<h6 id="raises">Raises</h6>

<ul>
<li><strong>KeyError</strong>: Raised if the user doesn't exist in PPMS.</li>
</ul>
</div>


                            </div>
                            <div id="PpmsConnection.get_user_dict" class="classattr">
                                        <input id="PpmsConnection.get_user_dict-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_user_dict</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">login_name</span>, </span><span class="param"><span class="n">skip_cache</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="PpmsConnection.get_user_dict-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PpmsConnection.get_user_dict"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PpmsConnection.get_user_dict-778"><a href="#PpmsConnection.get_user_dict-778"><span class="linenos">778</span></a>    <span class="k">def</span> <span class="nf">get_user_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">login_name</span><span class="p">,</span> <span class="n">skip_cache</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="PpmsConnection.get_user_dict-779"><a href="#PpmsConnection.get_user_dict-779"><span class="linenos">779</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get details on a given user from PPMS.</span>
</span><span id="PpmsConnection.get_user_dict-780"><a href="#PpmsConnection.get_user_dict-780"><span class="linenos">780</span></a>
</span><span id="PpmsConnection.get_user_dict-781"><a href="#PpmsConnection.get_user_dict-781"><span class="linenos">781</span></a><span class="sd">        Parameters</span>
</span><span id="PpmsConnection.get_user_dict-782"><a href="#PpmsConnection.get_user_dict-782"><span class="linenos">782</span></a><span class="sd">        ----------</span>
</span><span id="PpmsConnection.get_user_dict-783"><a href="#PpmsConnection.get_user_dict-783"><span class="linenos">783</span></a><span class="sd">        login_name : str</span>
</span><span id="PpmsConnection.get_user_dict-784"><a href="#PpmsConnection.get_user_dict-784"><span class="linenos">784</span></a><span class="sd">            The PPMS account / login name of the user to query.</span>
</span><span id="PpmsConnection.get_user_dict-785"><a href="#PpmsConnection.get_user_dict-785"><span class="linenos">785</span></a><span class="sd">        skip_cache : bool, optional</span>
</span><span id="PpmsConnection.get_user_dict-786"><a href="#PpmsConnection.get_user_dict-786"><span class="linenos">786</span></a><span class="sd">            Passed as-is to the :py:meth:`request()` method</span>
</span><span id="PpmsConnection.get_user_dict-787"><a href="#PpmsConnection.get_user_dict-787"><span class="linenos">787</span></a>
</span><span id="PpmsConnection.get_user_dict-788"><a href="#PpmsConnection.get_user_dict-788"><span class="linenos">788</span></a><span class="sd">        Returns</span>
</span><span id="PpmsConnection.get_user_dict-789"><a href="#PpmsConnection.get_user_dict-789"><span class="linenos">789</span></a><span class="sd">        -------</span>
</span><span id="PpmsConnection.get_user_dict-790"><a href="#PpmsConnection.get_user_dict-790"><span class="linenos">790</span></a><span class="sd">        dict</span>
</span><span id="PpmsConnection.get_user_dict-791"><a href="#PpmsConnection.get_user_dict-791"><span class="linenos">791</span></a><span class="sd">            A dict with the user details returned by the PUMAPI.</span>
</span><span id="PpmsConnection.get_user_dict-792"><a href="#PpmsConnection.get_user_dict-792"><span class="linenos">792</span></a>
</span><span id="PpmsConnection.get_user_dict-793"><a href="#PpmsConnection.get_user_dict-793"><span class="linenos">793</span></a><span class="sd">        Example</span>
</span><span id="PpmsConnection.get_user_dict-794"><a href="#PpmsConnection.get_user_dict-794"><span class="linenos">794</span></a><span class="sd">        -------</span>
</span><span id="PpmsConnection.get_user_dict-795"><a href="#PpmsConnection.get_user_dict-795"><span class="linenos">795</span></a><span class="sd">        &gt;&gt;&gt; conn.get_user_dict(&#39;pyppms&#39;)</span>
</span><span id="PpmsConnection.get_user_dict-796"><a href="#PpmsConnection.get_user_dict-796"><span class="linenos">796</span></a><span class="sd">        ... {</span>
</span><span id="PpmsConnection.get_user_dict-797"><a href="#PpmsConnection.get_user_dict-797"><span class="linenos">797</span></a><span class="sd">        ...     u&#39;active&#39;: True,</span>
</span><span id="PpmsConnection.get_user_dict-798"><a href="#PpmsConnection.get_user_dict-798"><span class="linenos">798</span></a><span class="sd">        ...     u&#39;affiliation&#39;: u&#39;&#39;,</span>
</span><span id="PpmsConnection.get_user_dict-799"><a href="#PpmsConnection.get_user_dict-799"><span class="linenos">799</span></a><span class="sd">        ...     u&#39;bcode&#39;: u&#39;&#39;,</span>
</span><span id="PpmsConnection.get_user_dict-800"><a href="#PpmsConnection.get_user_dict-800"><span class="linenos">800</span></a><span class="sd">        ...     u&#39;email&#39;: u&#39;pyppms@python-facility.example&#39;,</span>
</span><span id="PpmsConnection.get_user_dict-801"><a href="#PpmsConnection.get_user_dict-801"><span class="linenos">801</span></a><span class="sd">        ...     u&#39;fname&#39;: u&#39;PumAPI&#39;,</span>
</span><span id="PpmsConnection.get_user_dict-802"><a href="#PpmsConnection.get_user_dict-802"><span class="linenos">802</span></a><span class="sd">        ...     u&#39;lname&#39;: u&#39;Python&#39;,</span>
</span><span id="PpmsConnection.get_user_dict-803"><a href="#PpmsConnection.get_user_dict-803"><span class="linenos">803</span></a><span class="sd">        ...     u&#39;login&#39;: u&#39;pyppms&#39;,</span>
</span><span id="PpmsConnection.get_user_dict-804"><a href="#PpmsConnection.get_user_dict-804"><span class="linenos">804</span></a><span class="sd">        ...     u&#39;mustchbcode&#39;: False,</span>
</span><span id="PpmsConnection.get_user_dict-805"><a href="#PpmsConnection.get_user_dict-805"><span class="linenos">805</span></a><span class="sd">        ...     u&#39;mustchpwd&#39;: False&#39;,</span>
</span><span id="PpmsConnection.get_user_dict-806"><a href="#PpmsConnection.get_user_dict-806"><span class="linenos">806</span></a><span class="sd">        ...     u&#39;phone&#39;: u&#39;+98 (76) 54 3210&#39;,</span>
</span><span id="PpmsConnection.get_user_dict-807"><a href="#PpmsConnection.get_user_dict-807"><span class="linenos">807</span></a><span class="sd">        ...     u&#39;unitlogin&#39;: u&#39;pyppms&#39;</span>
</span><span id="PpmsConnection.get_user_dict-808"><a href="#PpmsConnection.get_user_dict-808"><span class="linenos">808</span></a><span class="sd">        ... }</span>
</span><span id="PpmsConnection.get_user_dict-809"><a href="#PpmsConnection.get_user_dict-809"><span class="linenos">809</span></a>
</span><span id="PpmsConnection.get_user_dict-810"><a href="#PpmsConnection.get_user_dict-810"><span class="linenos">810</span></a><span class="sd">        Raises</span>
</span><span id="PpmsConnection.get_user_dict-811"><a href="#PpmsConnection.get_user_dict-811"><span class="linenos">811</span></a><span class="sd">        ------</span>
</span><span id="PpmsConnection.get_user_dict-812"><a href="#PpmsConnection.get_user_dict-812"><span class="linenos">812</span></a><span class="sd">        KeyError</span>
</span><span id="PpmsConnection.get_user_dict-813"><a href="#PpmsConnection.get_user_dict-813"><span class="linenos">813</span></a><span class="sd">            Raised in case the user account is unknown to PPMS.</span>
</span><span id="PpmsConnection.get_user_dict-814"><a href="#PpmsConnection.get_user_dict-814"><span class="linenos">814</span></a><span class="sd">        ValueError</span>
</span><span id="PpmsConnection.get_user_dict-815"><a href="#PpmsConnection.get_user_dict-815"><span class="linenos">815</span></a><span class="sd">            Raised if the user details can&#39;t be parsed from the PUMAPI response.</span>
</span><span id="PpmsConnection.get_user_dict-816"><a href="#PpmsConnection.get_user_dict-816"><span class="linenos">816</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PpmsConnection.get_user_dict-817"><a href="#PpmsConnection.get_user_dict-817"><span class="linenos">817</span></a>        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;getuser&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;login&quot;</span><span class="p">:</span> <span class="n">login_name</span><span class="p">},</span> <span class="n">skip_cache</span><span class="o">=</span><span class="n">skip_cache</span><span class="p">)</span>
</span><span id="PpmsConnection.get_user_dict-818"><a href="#PpmsConnection.get_user_dict-818"><span class="linenos">818</span></a>
</span><span id="PpmsConnection.get_user_dict-819"><a href="#PpmsConnection.get_user_dict-819"><span class="linenos">819</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
</span><span id="PpmsConnection.get_user_dict-820"><a href="#PpmsConnection.get_user_dict-820"><span class="linenos">820</span></a>            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;User [</span><span class="si">{</span><span class="n">login_name</span><span class="si">}</span><span class="s2">] is unknown to PPMS&quot;</span>
</span><span id="PpmsConnection.get_user_dict-821"><a href="#PpmsConnection.get_user_dict-821"><span class="linenos">821</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="PpmsConnection.get_user_dict-822"><a href="#PpmsConnection.get_user_dict-822"><span class="linenos">822</span></a>            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="PpmsConnection.get_user_dict-823"><a href="#PpmsConnection.get_user_dict-823"><span class="linenos">823</span></a>
</span><span id="PpmsConnection.get_user_dict-824"><a href="#PpmsConnection.get_user_dict-824"><span class="linenos">824</span></a>        <span class="c1"># EXAMPLE:</span>
</span><span id="PpmsConnection.get_user_dict-825"><a href="#PpmsConnection.get_user_dict-825"><span class="linenos">825</span></a>        <span class="c1"># response.text = (</span>
</span><span id="PpmsConnection.get_user_dict-826"><a href="#PpmsConnection.get_user_dict-826"><span class="linenos">826</span></a>        <span class="c1">#     u&#39;login,lname,fname,email,&#39;</span>
</span><span id="PpmsConnection.get_user_dict-827"><a href="#PpmsConnection.get_user_dict-827"><span class="linenos">827</span></a>        <span class="c1">#     u&#39;phone,bcode,affiliation,unitlogin,mustchpwd,mustchbcode,&#39;</span>
</span><span id="PpmsConnection.get_user_dict-828"><a href="#PpmsConnection.get_user_dict-828"><span class="linenos">828</span></a>        <span class="c1">#     u&#39;active\r\n&#39;</span>
</span><span id="PpmsConnection.get_user_dict-829"><a href="#PpmsConnection.get_user_dict-829"><span class="linenos">829</span></a>        <span class="c1">#     u&#39;&quot;pyppms&quot;,&quot;Python&quot;,&quot;PumAPI&quot;,&quot;pyppms@python-facility.example&quot;,&#39;</span>
</span><span id="PpmsConnection.get_user_dict-830"><a href="#PpmsConnection.get_user_dict-830"><span class="linenos">830</span></a>        <span class="c1">#     u&#39;&quot;+98 (76) 54 3210&quot;,&quot;&quot;,&quot;&quot;,&quot;pyppms&quot;,false,false,&#39;</span>
</span><span id="PpmsConnection.get_user_dict-831"><a href="#PpmsConnection.get_user_dict-831"><span class="linenos">831</span></a>        <span class="c1">#     u&#39;true\r\n&#39;</span>
</span><span id="PpmsConnection.get_user_dict-832"><a href="#PpmsConnection.get_user_dict-832"><span class="linenos">832</span></a>        <span class="c1"># )</span>
</span><span id="PpmsConnection.get_user_dict-833"><a href="#PpmsConnection.get_user_dict-833"><span class="linenos">833</span></a>        <span class="n">details</span> <span class="o">=</span> <span class="n">dict_from_single_response</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</span><span id="PpmsConnection.get_user_dict-834"><a href="#PpmsConnection.get_user_dict-834"><span class="linenos">834</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s2">&quot;Details for user [</span><span class="si">{}</span><span class="s2">]: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">login_name</span><span class="p">,</span> <span class="n">details</span><span class="p">)</span>
</span><span id="PpmsConnection.get_user_dict-835"><a href="#PpmsConnection.get_user_dict-835"><span class="linenos">835</span></a>        <span class="k">return</span> <span class="n">details</span>
</span></pre></div>


            <div class="docstring"><p>Get details on a given user from PPMS.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>login_name</strong> (str):
The PPMS account / login name of the user to query.</li>
<li><strong>skip_cache</strong> (bool, optional):
Passed as-is to the <code>request()()</code> method</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>dict</strong>: A dict with the user details returned by the PUMAPI.</li>
</ul>

<h6 id="example">Example</h6>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">conn</span><span class="o">.</span><span class="n">get_user_dict</span><span class="p">(</span><span class="s1">&#39;pyppms&#39;</span><span class="p">)</span>
<span class="gp">... </span><span class="p">{</span>
<span class="gp">... </span>    <span class="sa">u</span><span class="s1">&#39;active&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<span class="gp">... </span>    <span class="sa">u</span><span class="s1">&#39;affiliation&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="sa">u</span><span class="s1">&#39;bcode&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="sa">u</span><span class="s1">&#39;email&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;pyppms@python-facility.example&#39;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="sa">u</span><span class="s1">&#39;fname&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;PumAPI&#39;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="sa">u</span><span class="s1">&#39;lname&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;Python&#39;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="sa">u</span><span class="s1">&#39;login&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;pyppms&#39;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="sa">u</span><span class="s1">&#39;mustchbcode&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
<span class="gp">... </span>    <span class="sa">u</span><span class="s1">&#39;mustchpwd&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="s1">&#39;,</span>
<span class="gp">... </span>    <span class="sa">u</span><span class="s1">&#39;phone&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;+98 (76) 54 3210&#39;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="sa">u</span><span class="s1">&#39;unitlogin&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;pyppms&#39;</span>
<span class="gp">... </span><span class="p">}</span>
</code></pre>
</div>

<h6 id="raises">Raises</h6>

<ul>
<li><strong>KeyError</strong>: Raised in case the user account is unknown to PPMS.</li>
<li><strong>ValueError</strong>: Raised if the user details can't be parsed from the PUMAPI response.</li>
</ul>
</div>


                            </div>
                            <div id="PpmsConnection.get_user_experience" class="classattr">
                                        <input id="PpmsConnection.get_user_experience-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_user_experience</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">login</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">system_id</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="PpmsConnection.get_user_experience-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PpmsConnection.get_user_experience"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PpmsConnection.get_user_experience-837"><a href="#PpmsConnection.get_user_experience-837"><span class="linenos">837</span></a>    <span class="k">def</span> <span class="nf">get_user_experience</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">login</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">system_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="PpmsConnection.get_user_experience-838"><a href="#PpmsConnection.get_user_experience-838"><span class="linenos">838</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get user experience (&quot;User rights&quot;) from PPMS.</span>
</span><span id="PpmsConnection.get_user_experience-839"><a href="#PpmsConnection.get_user_experience-839"><span class="linenos">839</span></a>
</span><span id="PpmsConnection.get_user_experience-840"><a href="#PpmsConnection.get_user_experience-840"><span class="linenos">840</span></a><span class="sd">        Parameters</span>
</span><span id="PpmsConnection.get_user_experience-841"><a href="#PpmsConnection.get_user_experience-841"><span class="linenos">841</span></a><span class="sd">        ----------</span>
</span><span id="PpmsConnection.get_user_experience-842"><a href="#PpmsConnection.get_user_experience-842"><span class="linenos">842</span></a><span class="sd">        login : str, optional</span>
</span><span id="PpmsConnection.get_user_experience-843"><a href="#PpmsConnection.get_user_experience-843"><span class="linenos">843</span></a><span class="sd">            An optional login name to request the experience / permissions for,</span>
</span><span id="PpmsConnection.get_user_experience-844"><a href="#PpmsConnection.get_user_experience-844"><span class="linenos">844</span></a><span class="sd">            by default None</span>
</span><span id="PpmsConnection.get_user_experience-845"><a href="#PpmsConnection.get_user_experience-845"><span class="linenos">845</span></a><span class="sd">        system_id : int, optional</span>
</span><span id="PpmsConnection.get_user_experience-846"><a href="#PpmsConnection.get_user_experience-846"><span class="linenos">846</span></a><span class="sd">            An optional system ID to request the experience / permissions for,</span>
</span><span id="PpmsConnection.get_user_experience-847"><a href="#PpmsConnection.get_user_experience-847"><span class="linenos">847</span></a><span class="sd">            by default None</span>
</span><span id="PpmsConnection.get_user_experience-848"><a href="#PpmsConnection.get_user_experience-848"><span class="linenos">848</span></a>
</span><span id="PpmsConnection.get_user_experience-849"><a href="#PpmsConnection.get_user_experience-849"><span class="linenos">849</span></a><span class="sd">        Returns</span>
</span><span id="PpmsConnection.get_user_experience-850"><a href="#PpmsConnection.get_user_experience-850"><span class="linenos">850</span></a><span class="sd">        -------</span>
</span><span id="PpmsConnection.get_user_experience-851"><a href="#PpmsConnection.get_user_experience-851"><span class="linenos">851</span></a><span class="sd">        list(dict)</span>
</span><span id="PpmsConnection.get_user_experience-852"><a href="#PpmsConnection.get_user_experience-852"><span class="linenos">852</span></a><span class="sd">            A list with dicts parsed from the user experience response.</span>
</span><span id="PpmsConnection.get_user_experience-853"><a href="#PpmsConnection.get_user_experience-853"><span class="linenos">853</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PpmsConnection.get_user_experience-854"><a href="#PpmsConnection.get_user_experience-854"><span class="linenos">854</span></a>        <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="PpmsConnection.get_user_experience-855"><a href="#PpmsConnection.get_user_experience-855"><span class="linenos">855</span></a>        <span class="k">if</span> <span class="n">login</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="PpmsConnection.get_user_experience-856"><a href="#PpmsConnection.get_user_experience-856"><span class="linenos">856</span></a>            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;login&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">login</span>
</span><span id="PpmsConnection.get_user_experience-857"><a href="#PpmsConnection.get_user_experience-857"><span class="linenos">857</span></a>        <span class="k">if</span> <span class="n">system_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="PpmsConnection.get_user_experience-858"><a href="#PpmsConnection.get_user_experience-858"><span class="linenos">858</span></a>            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">system_id</span>
</span><span id="PpmsConnection.get_user_experience-859"><a href="#PpmsConnection.get_user_experience-859"><span class="linenos">859</span></a>        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;getuserexp&quot;</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
</span><span id="PpmsConnection.get_user_experience-860"><a href="#PpmsConnection.get_user_experience-860"><span class="linenos">860</span></a>
</span><span id="PpmsConnection.get_user_experience-861"><a href="#PpmsConnection.get_user_experience-861"><span class="linenos">861</span></a>        <span class="n">parsed</span> <span class="o">=</span> <span class="n">parse_multiline_response</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</span><span id="PpmsConnection.get_user_experience-862"><a href="#PpmsConnection.get_user_experience-862"><span class="linenos">862</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span>
</span><span id="PpmsConnection.get_user_experience-863"><a href="#PpmsConnection.get_user_experience-863"><span class="linenos">863</span></a>            <span class="s2">&quot;Received </span><span class="si">{}</span><span class="s2"> experience entries for filters [user:</span><span class="si">{}</span><span class="s2">] and [id:</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="p">,</span>
</span><span id="PpmsConnection.get_user_experience-864"><a href="#PpmsConnection.get_user_experience-864"><span class="linenos">864</span></a>            <span class="nb">len</span><span class="p">(</span><span class="n">parsed</span><span class="p">),</span>
</span><span id="PpmsConnection.get_user_experience-865"><a href="#PpmsConnection.get_user_experience-865"><span class="linenos">865</span></a>            <span class="n">login</span><span class="p">,</span>
</span><span id="PpmsConnection.get_user_experience-866"><a href="#PpmsConnection.get_user_experience-866"><span class="linenos">866</span></a>            <span class="n">system_id</span><span class="p">,</span>
</span><span id="PpmsConnection.get_user_experience-867"><a href="#PpmsConnection.get_user_experience-867"><span class="linenos">867</span></a>        <span class="p">)</span>
</span><span id="PpmsConnection.get_user_experience-868"><a href="#PpmsConnection.get_user_experience-868"><span class="linenos">868</span></a>        <span class="k">return</span> <span class="n">parsed</span>
</span></pre></div>


            <div class="docstring"><p>Get user experience ("User rights") from PPMS.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>login</strong> (str, optional):
An optional login name to request the experience / permissions for,
by default None</li>
<li><strong>system_id</strong> (int, optional):
An optional system ID to request the experience / permissions for,
by default None</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>list(dict)</strong>: A list with dicts parsed from the user experience response.</li>
</ul>
</div>


                            </div>
                            <div id="PpmsConnection.get_user_ids" class="classattr">
                                        <input id="PpmsConnection.get_user_ids-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_user_ids</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">active</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="PpmsConnection.get_user_ids-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PpmsConnection.get_user_ids"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PpmsConnection.get_user_ids-870"><a href="#PpmsConnection.get_user_ids-870"><span class="linenos">870</span></a>    <span class="k">def</span> <span class="nf">get_user_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="PpmsConnection.get_user_ids-871"><a href="#PpmsConnection.get_user_ids-871"><span class="linenos">871</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get a list with all user IDs in the PPMS system.</span>
</span><span id="PpmsConnection.get_user_ids-872"><a href="#PpmsConnection.get_user_ids-872"><span class="linenos">872</span></a>
</span><span id="PpmsConnection.get_user_ids-873"><a href="#PpmsConnection.get_user_ids-873"><span class="linenos">873</span></a><span class="sd">        Parameters</span>
</span><span id="PpmsConnection.get_user_ids-874"><a href="#PpmsConnection.get_user_ids-874"><span class="linenos">874</span></a><span class="sd">        ----------</span>
</span><span id="PpmsConnection.get_user_ids-875"><a href="#PpmsConnection.get_user_ids-875"><span class="linenos">875</span></a><span class="sd">        active : bool, optional</span>
</span><span id="PpmsConnection.get_user_ids-876"><a href="#PpmsConnection.get_user_ids-876"><span class="linenos">876</span></a><span class="sd">            Request only users marked as active in PPMS, by default False.</span>
</span><span id="PpmsConnection.get_user_ids-877"><a href="#PpmsConnection.get_user_ids-877"><span class="linenos">877</span></a><span class="sd">            NOTE: &quot;active&quot; is a tri-state parameter in PPMS: &quot;true&quot;, &quot;false&quot;</span>
</span><span id="PpmsConnection.get_user_ids-878"><a href="#PpmsConnection.get_user_ids-878"><span class="linenos">878</span></a><span class="sd">            or empty!</span>
</span><span id="PpmsConnection.get_user_ids-879"><a href="#PpmsConnection.get_user_ids-879"><span class="linenos">879</span></a>
</span><span id="PpmsConnection.get_user_ids-880"><a href="#PpmsConnection.get_user_ids-880"><span class="linenos">880</span></a><span class="sd">        Returns</span>
</span><span id="PpmsConnection.get_user_ids-881"><a href="#PpmsConnection.get_user_ids-881"><span class="linenos">881</span></a><span class="sd">        -------</span>
</span><span id="PpmsConnection.get_user_ids-882"><a href="#PpmsConnection.get_user_ids-882"><span class="linenos">882</span></a><span class="sd">        list</span>
</span><span id="PpmsConnection.get_user_ids-883"><a href="#PpmsConnection.get_user_ids-883"><span class="linenos">883</span></a><span class="sd">            A list of all (or active-only) user IDs in PPMS.</span>
</span><span id="PpmsConnection.get_user_ids-884"><a href="#PpmsConnection.get_user_ids-884"><span class="linenos">884</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PpmsConnection.get_user_ids-885"><a href="#PpmsConnection.get_user_ids-885"><span class="linenos">885</span></a>        <span class="c1"># TODO: describe format of returned list and / or give an example!</span>
</span><span id="PpmsConnection.get_user_ids-886"><a href="#PpmsConnection.get_user_ids-886"><span class="linenos">886</span></a>        <span class="n">parameters</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="PpmsConnection.get_user_ids-887"><a href="#PpmsConnection.get_user_ids-887"><span class="linenos">887</span></a>        <span class="k">if</span> <span class="n">active</span><span class="p">:</span>
</span><span id="PpmsConnection.get_user_ids-888"><a href="#PpmsConnection.get_user_ids-888"><span class="linenos">888</span></a>            <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;active&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;true&quot;</span>
</span><span id="PpmsConnection.get_user_ids-889"><a href="#PpmsConnection.get_user_ids-889"><span class="linenos">889</span></a>
</span><span id="PpmsConnection.get_user_ids-890"><a href="#PpmsConnection.get_user_ids-890"><span class="linenos">890</span></a>        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;getusers&quot;</span><span class="p">,</span> <span class="n">parameters</span><span class="p">)</span>
</span><span id="PpmsConnection.get_user_ids-891"><a href="#PpmsConnection.get_user_ids-891"><span class="linenos">891</span></a>
</span><span id="PpmsConnection.get_user_ids-892"><a href="#PpmsConnection.get_user_ids-892"><span class="linenos">892</span></a>        <span class="n">users</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
</span><span id="PpmsConnection.get_user_ids-893"><a href="#PpmsConnection.get_user_ids-893"><span class="linenos">893</span></a>        <span class="n">active_desc</span> <span class="o">=</span> <span class="s2">&quot;active &quot;</span> <span class="k">if</span> <span class="n">active</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
</span><span id="PpmsConnection.get_user_ids-894"><a href="#PpmsConnection.get_user_ids-894"><span class="linenos">894</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">users in the PPMS database&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">users</span><span class="p">),</span> <span class="n">active_desc</span><span class="p">)</span>
</span><span id="PpmsConnection.get_user_ids-895"><a href="#PpmsConnection.get_user_ids-895"><span class="linenos">895</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">users</span><span class="p">))</span>
</span><span id="PpmsConnection.get_user_ids-896"><a href="#PpmsConnection.get_user_ids-896"><span class="linenos">896</span></a>        <span class="k">return</span> <span class="n">users</span>
</span></pre></div>


            <div class="docstring"><p>Get a list with all user IDs in the PPMS system.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>active</strong> (bool, optional):
Request only users marked as active in PPMS, by default False.
NOTE: "active" is a tri-state parameter in PPMS: "true", "false"
or empty!</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>list</strong>: A list of all (or active-only) user IDs in PPMS.</li>
</ul>
</div>


                            </div>
                            <div id="PpmsConnection.get_users" class="classattr">
                                        <input id="PpmsConnection.get_users-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_users</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">force_refresh</span><span class="o">=</span><span class="kc">False</span>, </span><span class="param"><span class="n">active_only</span><span class="o">=</span><span class="kc">True</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="PpmsConnection.get_users-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PpmsConnection.get_users"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PpmsConnection.get_users-898"><a href="#PpmsConnection.get_users-898"><span class="linenos">898</span></a>    <span class="k">def</span> <span class="nf">get_users</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force_refresh</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">active_only</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="PpmsConnection.get_users-899"><a href="#PpmsConnection.get_users-899"><span class="linenos">899</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get user objects for all (or cached) PPMS users.</span>
</span><span id="PpmsConnection.get_users-900"><a href="#PpmsConnection.get_users-900"><span class="linenos">900</span></a>
</span><span id="PpmsConnection.get_users-901"><a href="#PpmsConnection.get_users-901"><span class="linenos">901</span></a><span class="sd">        Parameters</span>
</span><span id="PpmsConnection.get_users-902"><a href="#PpmsConnection.get_users-902"><span class="linenos">902</span></a><span class="sd">        ----------</span>
</span><span id="PpmsConnection.get_users-903"><a href="#PpmsConnection.get_users-903"><span class="linenos">903</span></a><span class="sd">        force_refresh : bool, optional</span>
</span><span id="PpmsConnection.get_users-904"><a href="#PpmsConnection.get_users-904"><span class="linenos">904</span></a><span class="sd">            Re-request information from PPMS even if user details have been</span>
</span><span id="PpmsConnection.get_users-905"><a href="#PpmsConnection.get_users-905"><span class="linenos">905</span></a><span class="sd">            cached locally before, by default False.</span>
</span><span id="PpmsConnection.get_users-906"><a href="#PpmsConnection.get_users-906"><span class="linenos">906</span></a><span class="sd">        active_only : bool, optional</span>
</span><span id="PpmsConnection.get_users-907"><a href="#PpmsConnection.get_users-907"><span class="linenos">907</span></a><span class="sd">            If set to `False` also &quot;inactive&quot; users will be fetched from PPMS,</span>
</span><span id="PpmsConnection.get_users-908"><a href="#PpmsConnection.get_users-908"><span class="linenos">908</span></a><span class="sd">            by default `True`.</span>
</span><span id="PpmsConnection.get_users-909"><a href="#PpmsConnection.get_users-909"><span class="linenos">909</span></a>
</span><span id="PpmsConnection.get_users-910"><a href="#PpmsConnection.get_users-910"><span class="linenos">910</span></a><span class="sd">        Returns</span>
</span><span id="PpmsConnection.get_users-911"><a href="#PpmsConnection.get_users-911"><span class="linenos">911</span></a><span class="sd">        -------</span>
</span><span id="PpmsConnection.get_users-912"><a href="#PpmsConnection.get_users-912"><span class="linenos">912</span></a><span class="sd">        dict(pyppms.user.PpmsUser)</span>
</span><span id="PpmsConnection.get_users-913"><a href="#PpmsConnection.get_users-913"><span class="linenos">913</span></a><span class="sd">            A dict of PpmsUser objects with the username (login) as key.</span>
</span><span id="PpmsConnection.get_users-914"><a href="#PpmsConnection.get_users-914"><span class="linenos">914</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PpmsConnection.get_users-915"><a href="#PpmsConnection.get_users-915"><span class="linenos">915</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">users</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">force_refresh</span><span class="p">:</span>
</span><span id="PpmsConnection.get_users-916"><a href="#PpmsConnection.get_users-916"><span class="linenos">916</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s2">&quot;Using cached details for </span><span class="si">{}</span><span class="s2"> users&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="p">))</span>
</span><span id="PpmsConnection.get_users-917"><a href="#PpmsConnection.get_users-917"><span class="linenos">917</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="PpmsConnection.get_users-918"><a href="#PpmsConnection.get_users-918"><span class="linenos">918</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">update_users</span><span class="p">(</span><span class="n">active_only</span><span class="o">=</span><span class="n">active_only</span><span class="p">)</span>
</span><span id="PpmsConnection.get_users-919"><a href="#PpmsConnection.get_users-919"><span class="linenos">919</span></a>
</span><span id="PpmsConnection.get_users-920"><a href="#PpmsConnection.get_users-920"><span class="linenos">920</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">users</span>
</span></pre></div>


            <div class="docstring"><p>Get user objects for all (or cached) PPMS users.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>force_refresh</strong> (bool, optional):
Re-request information from PPMS even if user details have been
cached locally before, by default False.</li>
<li><strong>active_only</strong> (bool, optional):
If set to <code>False</code> also "inactive" users will be fetched from PPMS,
by default <code>True</code>.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>dict(<a href="user.html#PpmsUser">pyppms.user.PpmsUser</a>)</strong>: A dict of PpmsUser objects with the username (login) as key.</li>
</ul>
</div>


                            </div>
                            <div id="PpmsConnection.get_users_emails" class="classattr">
                                        <input id="PpmsConnection.get_users_emails-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_users_emails</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">users</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">active</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="PpmsConnection.get_users_emails-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PpmsConnection.get_users_emails"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PpmsConnection.get_users_emails-922"><a href="#PpmsConnection.get_users_emails-922"><span class="linenos">922</span></a>    <span class="k">def</span> <span class="nf">get_users_emails</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">users</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="PpmsConnection.get_users_emails-923"><a href="#PpmsConnection.get_users_emails-923"><span class="linenos">923</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get a list of user email addresses. WARNING - very slow!</span>
</span><span id="PpmsConnection.get_users_emails-924"><a href="#PpmsConnection.get_users_emails-924"><span class="linenos">924</span></a>
</span><span id="PpmsConnection.get_users_emails-925"><a href="#PpmsConnection.get_users_emails-925"><span class="linenos">925</span></a><span class="sd">        Parameters</span>
</span><span id="PpmsConnection.get_users_emails-926"><a href="#PpmsConnection.get_users_emails-926"><span class="linenos">926</span></a><span class="sd">        ----------</span>
</span><span id="PpmsConnection.get_users_emails-927"><a href="#PpmsConnection.get_users_emails-927"><span class="linenos">927</span></a><span class="sd">        users : list(str), optional</span>
</span><span id="PpmsConnection.get_users_emails-928"><a href="#PpmsConnection.get_users_emails-928"><span class="linenos">928</span></a><span class="sd">            A list of login names to retrieve the email addresses for, if</span>
</span><span id="PpmsConnection.get_users_emails-929"><a href="#PpmsConnection.get_users_emails-929"><span class="linenos">929</span></a><span class="sd">            omitted addresses for all (or active ones) will be requested.</span>
</span><span id="PpmsConnection.get_users_emails-930"><a href="#PpmsConnection.get_users_emails-930"><span class="linenos">930</span></a><span class="sd">        active : bool, optional</span>
</span><span id="PpmsConnection.get_users_emails-931"><a href="#PpmsConnection.get_users_emails-931"><span class="linenos">931</span></a><span class="sd">            Request only addresses of users marked as active in PPMS, by default</span>
</span><span id="PpmsConnection.get_users_emails-932"><a href="#PpmsConnection.get_users_emails-932"><span class="linenos">932</span></a><span class="sd">            False. Will be ignored if a list of usernames is given explicitly.</span>
</span><span id="PpmsConnection.get_users_emails-933"><a href="#PpmsConnection.get_users_emails-933"><span class="linenos">933</span></a>
</span><span id="PpmsConnection.get_users_emails-934"><a href="#PpmsConnection.get_users_emails-934"><span class="linenos">934</span></a><span class="sd">        Returns</span>
</span><span id="PpmsConnection.get_users_emails-935"><a href="#PpmsConnection.get_users_emails-935"><span class="linenos">935</span></a><span class="sd">        -------</span>
</span><span id="PpmsConnection.get_users_emails-936"><a href="#PpmsConnection.get_users_emails-936"><span class="linenos">936</span></a><span class="sd">        list(str)</span>
</span><span id="PpmsConnection.get_users_emails-937"><a href="#PpmsConnection.get_users_emails-937"><span class="linenos">937</span></a><span class="sd">            Email addresses of the users requested.</span>
</span><span id="PpmsConnection.get_users_emails-938"><a href="#PpmsConnection.get_users_emails-938"><span class="linenos">938</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PpmsConnection.get_users_emails-939"><a href="#PpmsConnection.get_users_emails-939"><span class="linenos">939</span></a>        <span class="n">emails</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="PpmsConnection.get_users_emails-940"><a href="#PpmsConnection.get_users_emails-940"><span class="linenos">940</span></a>        <span class="k">if</span> <span class="n">users</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="PpmsConnection.get_users_emails-941"><a href="#PpmsConnection.get_users_emails-941"><span class="linenos">941</span></a>            <span class="n">users</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_ids</span><span class="p">(</span><span class="n">active</span><span class="o">=</span><span class="n">active</span><span class="p">)</span>
</span><span id="PpmsConnection.get_users_emails-942"><a href="#PpmsConnection.get_users_emails-942"><span class="linenos">942</span></a>        <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">users</span><span class="p">:</span>
</span><span id="PpmsConnection.get_users_emails-943"><a href="#PpmsConnection.get_users_emails-943"><span class="linenos">943</span></a>            <span class="n">email</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_dict</span><span class="p">(</span><span class="n">user</span><span class="p">)[</span><span class="s2">&quot;email&quot;</span><span class="p">]</span>
</span><span id="PpmsConnection.get_users_emails-944"><a href="#PpmsConnection.get_users_emails-944"><span class="linenos">944</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">email</span><span class="p">:</span>
</span><span id="PpmsConnection.get_users_emails-945"><a href="#PpmsConnection.get_users_emails-945"><span class="linenos">945</span></a>                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;--- WARNING: no email for user [</span><span class="si">{}</span><span class="s2">]! ---&quot;</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
</span><span id="PpmsConnection.get_users_emails-946"><a href="#PpmsConnection.get_users_emails-946"><span class="linenos">946</span></a>                <span class="k">continue</span>
</span><span id="PpmsConnection.get_users_emails-947"><a href="#PpmsConnection.get_users_emails-947"><span class="linenos">947</span></a>            <span class="c1"># log.trace(&quot;{}: {}&quot;, user, email)</span>
</span><span id="PpmsConnection.get_users_emails-948"><a href="#PpmsConnection.get_users_emails-948"><span class="linenos">948</span></a>            <span class="n">emails</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
</span><span id="PpmsConnection.get_users_emails-949"><a href="#PpmsConnection.get_users_emails-949"><span class="linenos">949</span></a>
</span><span id="PpmsConnection.get_users_emails-950"><a href="#PpmsConnection.get_users_emails-950"><span class="linenos">950</span></a>        <span class="k">return</span> <span class="n">emails</span>
</span></pre></div>


            <div class="docstring"><p>Get a list of user email addresses. WARNING - very slow!</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>users</strong> (list(str), optional):
A list of login names to retrieve the email addresses for, if
omitted addresses for all (or active ones) will be requested.</li>
<li><strong>active</strong> (bool, optional):
Request only addresses of users marked as active in PPMS, by default
False. Will be ignored if a list of usernames is given explicitly.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>list(str)</strong>: Email addresses of the users requested.</li>
</ul>
</div>


                            </div>
                            <div id="PpmsConnection.get_users_with_access_to_system" class="classattr">
                                        <input id="PpmsConnection.get_users_with_access_to_system-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_users_with_access_to_system</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">system_id</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="PpmsConnection.get_users_with_access_to_system-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PpmsConnection.get_users_with_access_to_system"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PpmsConnection.get_users_with_access_to_system-952"><a href="#PpmsConnection.get_users_with_access_to_system-952"><span class="linenos"> 952</span></a>    <span class="k">def</span> <span class="nf">get_users_with_access_to_system</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">system_id</span><span class="p">):</span>
</span><span id="PpmsConnection.get_users_with_access_to_system-953"><a href="#PpmsConnection.get_users_with_access_to_system-953"><span class="linenos"> 953</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get a list of usernames allowed to book the system with the given ID.</span>
</span><span id="PpmsConnection.get_users_with_access_to_system-954"><a href="#PpmsConnection.get_users_with_access_to_system-954"><span class="linenos"> 954</span></a>
</span><span id="PpmsConnection.get_users_with_access_to_system-955"><a href="#PpmsConnection.get_users_with_access_to_system-955"><span class="linenos"> 955</span></a><span class="sd">        Parameters</span>
</span><span id="PpmsConnection.get_users_with_access_to_system-956"><a href="#PpmsConnection.get_users_with_access_to_system-956"><span class="linenos"> 956</span></a><span class="sd">        ----------</span>
</span><span id="PpmsConnection.get_users_with_access_to_system-957"><a href="#PpmsConnection.get_users_with_access_to_system-957"><span class="linenos"> 957</span></a><span class="sd">        system_id : int or int-like</span>
</span><span id="PpmsConnection.get_users_with_access_to_system-958"><a href="#PpmsConnection.get_users_with_access_to_system-958"><span class="linenos"> 958</span></a><span class="sd">            The ID of the system to query permitted users for.</span>
</span><span id="PpmsConnection.get_users_with_access_to_system-959"><a href="#PpmsConnection.get_users_with_access_to_system-959"><span class="linenos"> 959</span></a>
</span><span id="PpmsConnection.get_users_with_access_to_system-960"><a href="#PpmsConnection.get_users_with_access_to_system-960"><span class="linenos"> 960</span></a><span class="sd">        Returns</span>
</span><span id="PpmsConnection.get_users_with_access_to_system-961"><a href="#PpmsConnection.get_users_with_access_to_system-961"><span class="linenos"> 961</span></a><span class="sd">        -------</span>
</span><span id="PpmsConnection.get_users_with_access_to_system-962"><a href="#PpmsConnection.get_users_with_access_to_system-962"><span class="linenos"> 962</span></a><span class="sd">        list(str)</span>
</span><span id="PpmsConnection.get_users_with_access_to_system-963"><a href="#PpmsConnection.get_users_with_access_to_system-963"><span class="linenos"> 963</span></a><span class="sd">            A list of usernames (&#39;login&#39;) with permissions to book the system</span>
</span><span id="PpmsConnection.get_users_with_access_to_system-964"><a href="#PpmsConnection.get_users_with_access_to_system-964"><span class="linenos"> 964</span></a><span class="sd">            with the given ID in PPMS.</span>
</span><span id="PpmsConnection.get_users_with_access_to_system-965"><a href="#PpmsConnection.get_users_with_access_to_system-965"><span class="linenos"> 965</span></a>
</span><span id="PpmsConnection.get_users_with_access_to_system-966"><a href="#PpmsConnection.get_users_with_access_to_system-966"><span class="linenos"> 966</span></a><span class="sd">        Raises</span>
</span><span id="PpmsConnection.get_users_with_access_to_system-967"><a href="#PpmsConnection.get_users_with_access_to_system-967"><span class="linenos"> 967</span></a><span class="sd">        ------</span>
</span><span id="PpmsConnection.get_users_with_access_to_system-968"><a href="#PpmsConnection.get_users_with_access_to_system-968"><span class="linenos"> 968</span></a><span class="sd">        ValueError</span>
</span><span id="PpmsConnection.get_users_with_access_to_system-969"><a href="#PpmsConnection.get_users_with_access_to_system-969"><span class="linenos"> 969</span></a><span class="sd">            Raised in case parsing the response failes for any reason.</span>
</span><span id="PpmsConnection.get_users_with_access_to_system-970"><a href="#PpmsConnection.get_users_with_access_to_system-970"><span class="linenos"> 970</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PpmsConnection.get_users_with_access_to_system-971"><a href="#PpmsConnection.get_users_with_access_to_system-971"><span class="linenos"> 971</span></a>        <span class="n">users</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="PpmsConnection.get_users_with_access_to_system-972"><a href="#PpmsConnection.get_users_with_access_to_system-972"><span class="linenos"> 972</span></a>
</span><span id="PpmsConnection.get_users_with_access_to_system-973"><a href="#PpmsConnection.get_users_with_access_to_system-973"><span class="linenos"> 973</span></a>        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;getsysrights&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">system_id</span><span class="p">})</span>
</span><span id="PpmsConnection.get_users_with_access_to_system-974"><a href="#PpmsConnection.get_users_with_access_to_system-974"><span class="linenos"> 974</span></a>        <span class="c1"># this response has a unique format, so parse it directly here:</span>
</span><span id="PpmsConnection.get_users_with_access_to_system-975"><a href="#PpmsConnection.get_users_with_access_to_system-975"><span class="linenos"> 975</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="PpmsConnection.get_users_with_access_to_system-976"><a href="#PpmsConnection.get_users_with_access_to_system-976"><span class="linenos"> 976</span></a>            <span class="n">lines</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
</span><span id="PpmsConnection.get_users_with_access_to_system-977"><a href="#PpmsConnection.get_users_with_access_to_system-977"><span class="linenos"> 977</span></a>            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
</span><span id="PpmsConnection.get_users_with_access_to_system-978"><a href="#PpmsConnection.get_users_with_access_to_system-978"><span class="linenos"> 978</span></a>                <span class="n">permission</span><span class="p">,</span> <span class="n">username</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
</span><span id="PpmsConnection.get_users_with_access_to_system-979"><a href="#PpmsConnection.get_users_with_access_to_system-979"><span class="linenos"> 979</span></a>                <span class="k">if</span> <span class="n">permission</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;D&quot;</span><span class="p">:</span>
</span><span id="PpmsConnection.get_users_with_access_to_system-980"><a href="#PpmsConnection.get_users_with_access_to_system-980"><span class="linenos"> 980</span></a>                    <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span>
</span><span id="PpmsConnection.get_users_with_access_to_system-981"><a href="#PpmsConnection.get_users_with_access_to_system-981"><span class="linenos"> 981</span></a>                        <span class="s2">&quot;User [</span><span class="si">{}</span><span class="s2">] is deactivated for booking system [</span><span class="si">{}</span><span class="s2">], skipping&quot;</span><span class="p">,</span>
</span><span id="PpmsConnection.get_users_with_access_to_system-982"><a href="#PpmsConnection.get_users_with_access_to_system-982"><span class="linenos"> 982</span></a>                        <span class="n">username</span><span class="p">,</span>
</span><span id="PpmsConnection.get_users_with_access_to_system-983"><a href="#PpmsConnection.get_users_with_access_to_system-983"><span class="linenos"> 983</span></a>                        <span class="n">system_id</span><span class="p">,</span>
</span><span id="PpmsConnection.get_users_with_access_to_system-984"><a href="#PpmsConnection.get_users_with_access_to_system-984"><span class="linenos"> 984</span></a>                    <span class="p">)</span>
</span><span id="PpmsConnection.get_users_with_access_to_system-985"><a href="#PpmsConnection.get_users_with_access_to_system-985"><span class="linenos"> 985</span></a>                    <span class="k">continue</span>
</span><span id="PpmsConnection.get_users_with_access_to_system-986"><a href="#PpmsConnection.get_users_with_access_to_system-986"><span class="linenos"> 986</span></a>
</span><span id="PpmsConnection.get_users_with_access_to_system-987"><a href="#PpmsConnection.get_users_with_access_to_system-987"><span class="linenos"> 987</span></a>                <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span>
</span><span id="PpmsConnection.get_users_with_access_to_system-988"><a href="#PpmsConnection.get_users_with_access_to_system-988"><span class="linenos"> 988</span></a>                    <span class="s2">&quot;User [</span><span class="si">{}</span><span class="s2">] has permission to book system [</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">system_id</span>
</span><span id="PpmsConnection.get_users_with_access_to_system-989"><a href="#PpmsConnection.get_users_with_access_to_system-989"><span class="linenos"> 989</span></a>                <span class="p">)</span>
</span><span id="PpmsConnection.get_users_with_access_to_system-990"><a href="#PpmsConnection.get_users_with_access_to_system-990"><span class="linenos"> 990</span></a>                <span class="n">users</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
</span><span id="PpmsConnection.get_users_with_access_to_system-991"><a href="#PpmsConnection.get_users_with_access_to_system-991"><span class="linenos"> 991</span></a>
</span><span id="PpmsConnection.get_users_with_access_to_system-992"><a href="#PpmsConnection.get_users_with_access_to_system-992"><span class="linenos"> 992</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
</span><span id="PpmsConnection.get_users_with_access_to_system-993"><a href="#PpmsConnection.get_users_with_access_to_system-993"><span class="linenos"> 993</span></a>            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="PpmsConnection.get_users_with_access_to_system-994"><a href="#PpmsConnection.get_users_with_access_to_system-994"><span class="linenos"> 994</span></a>                <span class="sa">f</span><span class="s2">&quot;Unable to parse data returned by PUMAPI: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2"> - &quot;</span>
</span><span id="PpmsConnection.get_users_with_access_to_system-995"><a href="#PpmsConnection.get_users_with_access_to_system-995"><span class="linenos"> 995</span></a>                <span class="sa">f</span><span class="s2">&quot;ERROR: </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="PpmsConnection.get_users_with_access_to_system-996"><a href="#PpmsConnection.get_users_with_access_to_system-996"><span class="linenos"> 996</span></a>            <span class="p">)</span>
</span><span id="PpmsConnection.get_users_with_access_to_system-997"><a href="#PpmsConnection.get_users_with_access_to_system-997"><span class="linenos"> 997</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="PpmsConnection.get_users_with_access_to_system-998"><a href="#PpmsConnection.get_users_with_access_to_system-998"><span class="linenos"> 998</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">err</span>
</span><span id="PpmsConnection.get_users_with_access_to_system-999"><a href="#PpmsConnection.get_users_with_access_to_system-999"><span class="linenos"> 999</span></a>
</span><span id="PpmsConnection.get_users_with_access_to_system-1000"><a href="#PpmsConnection.get_users_with_access_to_system-1000"><span class="linenos">1000</span></a>        <span class="k">return</span> <span class="n">users</span>
</span></pre></div>


            <div class="docstring"><p>Get a list of usernames allowed to book the system with the given ID.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>system_id</strong> (int or int-like):
The ID of the system to query permitted users for.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>list(str)</strong>: A list of usernames ('login') with permissions to book the system
with the given ID in PPMS.</li>
</ul>

<h6 id="raises">Raises</h6>

<ul>
<li><strong>ValueError</strong>: Raised in case parsing the response failes for any reason.</li>
</ul>
</div>


                            </div>
                            <div id="PpmsConnection.give_user_access_to_system" class="classattr">
                                        <input id="PpmsConnection.give_user_access_to_system-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">give_user_access_to_system</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">username</span>, </span><span class="param"><span class="n">system_id</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="PpmsConnection.give_user_access_to_system-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PpmsConnection.give_user_access_to_system"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PpmsConnection.give_user_access_to_system-1002"><a href="#PpmsConnection.give_user_access_to_system-1002"><span class="linenos">1002</span></a>    <span class="k">def</span> <span class="nf">give_user_access_to_system</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">system_id</span><span class="p">):</span>
</span><span id="PpmsConnection.give_user_access_to_system-1003"><a href="#PpmsConnection.give_user_access_to_system-1003"><span class="linenos">1003</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Add permissions for a user to book a given system in PPMS.</span>
</span><span id="PpmsConnection.give_user_access_to_system-1004"><a href="#PpmsConnection.give_user_access_to_system-1004"><span class="linenos">1004</span></a>
</span><span id="PpmsConnection.give_user_access_to_system-1005"><a href="#PpmsConnection.give_user_access_to_system-1005"><span class="linenos">1005</span></a><span class="sd">        Parameters</span>
</span><span id="PpmsConnection.give_user_access_to_system-1006"><a href="#PpmsConnection.give_user_access_to_system-1006"><span class="linenos">1006</span></a><span class="sd">        ----------</span>
</span><span id="PpmsConnection.give_user_access_to_system-1007"><a href="#PpmsConnection.give_user_access_to_system-1007"><span class="linenos">1007</span></a><span class="sd">        username : str</span>
</span><span id="PpmsConnection.give_user_access_to_system-1008"><a href="#PpmsConnection.give_user_access_to_system-1008"><span class="linenos">1008</span></a><span class="sd">            The username (&#39;login&#39;) to allow for booking the system.</span>
</span><span id="PpmsConnection.give_user_access_to_system-1009"><a href="#PpmsConnection.give_user_access_to_system-1009"><span class="linenos">1009</span></a><span class="sd">        system_id : int or int-like</span>
</span><span id="PpmsConnection.give_user_access_to_system-1010"><a href="#PpmsConnection.give_user_access_to_system-1010"><span class="linenos">1010</span></a><span class="sd">            The ID of the system to add the permission for.</span>
</span><span id="PpmsConnection.give_user_access_to_system-1011"><a href="#PpmsConnection.give_user_access_to_system-1011"><span class="linenos">1011</span></a>
</span><span id="PpmsConnection.give_user_access_to_system-1012"><a href="#PpmsConnection.give_user_access_to_system-1012"><span class="linenos">1012</span></a><span class="sd">        Returns</span>
</span><span id="PpmsConnection.give_user_access_to_system-1013"><a href="#PpmsConnection.give_user_access_to_system-1013"><span class="linenos">1013</span></a><span class="sd">        -------</span>
</span><span id="PpmsConnection.give_user_access_to_system-1014"><a href="#PpmsConnection.give_user_access_to_system-1014"><span class="linenos">1014</span></a><span class="sd">        bool</span>
</span><span id="PpmsConnection.give_user_access_to_system-1015"><a href="#PpmsConnection.give_user_access_to_system-1015"><span class="linenos">1015</span></a><span class="sd">            True in case the given username now has the permissions to book the</span>
</span><span id="PpmsConnection.give_user_access_to_system-1016"><a href="#PpmsConnection.give_user_access_to_system-1016"><span class="linenos">1016</span></a><span class="sd">            system with the specified ID (or if the user already had them</span>
</span><span id="PpmsConnection.give_user_access_to_system-1017"><a href="#PpmsConnection.give_user_access_to_system-1017"><span class="linenos">1017</span></a><span class="sd">            before), False otherwise.</span>
</span><span id="PpmsConnection.give_user_access_to_system-1018"><a href="#PpmsConnection.give_user_access_to_system-1018"><span class="linenos">1018</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PpmsConnection.give_user_access_to_system-1019"><a href="#PpmsConnection.give_user_access_to_system-1019"><span class="linenos">1019</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_system_booking_permissions</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">system_id</span><span class="p">,</span> <span class="s2">&quot;A&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Add permissions for a user to book a given system in PPMS.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>username</strong> (str):
The username ('login') to allow for booking the system.</li>
<li><strong>system_id</strong> (int or int-like):
The ID of the system to add the permission for.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>bool</strong>: True in case the given username now has the permissions to book the
system with the specified ID (or if the user already had them
before), False otherwise.</li>
</ul>
</div>


                            </div>
                            <div id="PpmsConnection.new_user" class="classattr">
                                        <input id="PpmsConnection.new_user-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">new_user</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">login</span>,</span><span class="param">	<span class="n">lname</span>,</span><span class="param">	<span class="n">fname</span>,</span><span class="param">	<span class="n">email</span>,</span><span class="param">	<span class="n">ppms_group</span>,</span><span class="param">	<span class="n">phone</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">password</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="PpmsConnection.new_user-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PpmsConnection.new_user"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PpmsConnection.new_user-1021"><a href="#PpmsConnection.new_user-1021"><span class="linenos">1021</span></a>    <span class="k">def</span> <span class="nf">new_user</span><span class="p">(</span>  <span class="c1"># pylint: disable-msg=too-many-arguments</span>
</span><span id="PpmsConnection.new_user-1022"><a href="#PpmsConnection.new_user-1022"><span class="linenos">1022</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">login</span><span class="p">,</span> <span class="n">lname</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">ppms_group</span><span class="p">,</span> <span class="n">phone</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="kc">None</span>
</span><span id="PpmsConnection.new_user-1023"><a href="#PpmsConnection.new_user-1023"><span class="linenos">1023</span></a>    <span class="p">):</span>
</span><span id="PpmsConnection.new_user-1024"><a href="#PpmsConnection.new_user-1024"><span class="linenos">1024</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a new user in PPMS.</span>
</span><span id="PpmsConnection.new_user-1025"><a href="#PpmsConnection.new_user-1025"><span class="linenos">1025</span></a>
</span><span id="PpmsConnection.new_user-1026"><a href="#PpmsConnection.new_user-1026"><span class="linenos">1026</span></a><span class="sd">        The method is asking PPMS to create a new user account with the given details.</span>
</span><span id="PpmsConnection.new_user-1027"><a href="#PpmsConnection.new_user-1027"><span class="linenos">1027</span></a><span class="sd">        In case an account with that login name already exists, it will log a warning</span>
</span><span id="PpmsConnection.new_user-1028"><a href="#PpmsConnection.new_user-1028"><span class="linenos">1028</span></a><span class="sd">        and return without sending any further requests to PPMS.</span>
</span><span id="PpmsConnection.new_user-1029"><a href="#PpmsConnection.new_user-1029"><span class="linenos">1029</span></a>
</span><span id="PpmsConnection.new_user-1030"><a href="#PpmsConnection.new_user-1030"><span class="linenos">1030</span></a><span class="sd">        Parameters</span>
</span><span id="PpmsConnection.new_user-1031"><a href="#PpmsConnection.new_user-1031"><span class="linenos">1031</span></a><span class="sd">        ----------</span>
</span><span id="PpmsConnection.new_user-1032"><a href="#PpmsConnection.new_user-1032"><span class="linenos">1032</span></a><span class="sd">        login : str</span>
</span><span id="PpmsConnection.new_user-1033"><a href="#PpmsConnection.new_user-1033"><span class="linenos">1033</span></a><span class="sd">            The unique identifier for the user.</span>
</span><span id="PpmsConnection.new_user-1034"><a href="#PpmsConnection.new_user-1034"><span class="linenos">1034</span></a><span class="sd">        lname : str</span>
</span><span id="PpmsConnection.new_user-1035"><a href="#PpmsConnection.new_user-1035"><span class="linenos">1035</span></a><span class="sd">            The last name of the user.</span>
</span><span id="PpmsConnection.new_user-1036"><a href="#PpmsConnection.new_user-1036"><span class="linenos">1036</span></a><span class="sd">        fname : str</span>
</span><span id="PpmsConnection.new_user-1037"><a href="#PpmsConnection.new_user-1037"><span class="linenos">1037</span></a><span class="sd">            The first name of the user.</span>
</span><span id="PpmsConnection.new_user-1038"><a href="#PpmsConnection.new_user-1038"><span class="linenos">1038</span></a><span class="sd">        email : str</span>
</span><span id="PpmsConnection.new_user-1039"><a href="#PpmsConnection.new_user-1039"><span class="linenos">1039</span></a><span class="sd">            The email address of the user.</span>
</span><span id="PpmsConnection.new_user-1040"><a href="#PpmsConnection.new_user-1040"><span class="linenos">1040</span></a><span class="sd">        ppms_group : str</span>
</span><span id="PpmsConnection.new_user-1041"><a href="#PpmsConnection.new_user-1041"><span class="linenos">1041</span></a><span class="sd">            The unique identifier of the primary group of the new user. A new group will</span>
</span><span id="PpmsConnection.new_user-1042"><a href="#PpmsConnection.new_user-1042"><span class="linenos">1042</span></a><span class="sd">            be created if no group with the given name exists.</span>
</span><span id="PpmsConnection.new_user-1043"><a href="#PpmsConnection.new_user-1043"><span class="linenos">1043</span></a><span class="sd">        phone : str, optional</span>
</span><span id="PpmsConnection.new_user-1044"><a href="#PpmsConnection.new_user-1044"><span class="linenos">1044</span></a><span class="sd">            The phone number of the user.</span>
</span><span id="PpmsConnection.new_user-1045"><a href="#PpmsConnection.new_user-1045"><span class="linenos">1045</span></a><span class="sd">        password : str, optional</span>
</span><span id="PpmsConnection.new_user-1046"><a href="#PpmsConnection.new_user-1046"><span class="linenos">1046</span></a><span class="sd">            The password for the user. If no password is set the user will not be able</span>
</span><span id="PpmsConnection.new_user-1047"><a href="#PpmsConnection.new_user-1047"><span class="linenos">1047</span></a><span class="sd">            to log on to PPMS.</span>
</span><span id="PpmsConnection.new_user-1048"><a href="#PpmsConnection.new_user-1048"><span class="linenos">1048</span></a>
</span><span id="PpmsConnection.new_user-1049"><a href="#PpmsConnection.new_user-1049"><span class="linenos">1049</span></a><span class="sd">        Raises</span>
</span><span id="PpmsConnection.new_user-1050"><a href="#PpmsConnection.new_user-1050"><span class="linenos">1050</span></a><span class="sd">        ------</span>
</span><span id="PpmsConnection.new_user-1051"><a href="#PpmsConnection.new_user-1051"><span class="linenos">1051</span></a><span class="sd">        RuntimeError</span>
</span><span id="PpmsConnection.new_user-1052"><a href="#PpmsConnection.new_user-1052"><span class="linenos">1052</span></a><span class="sd">            Will be raised in case creating the user fails.</span>
</span><span id="PpmsConnection.new_user-1053"><a href="#PpmsConnection.new_user-1053"><span class="linenos">1053</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PpmsConnection.new_user-1054"><a href="#PpmsConnection.new_user-1054"><span class="linenos">1054</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_exists</span><span class="p">(</span><span class="n">login</span><span class="p">):</span>
</span><span id="PpmsConnection.new_user-1055"><a href="#PpmsConnection.new_user-1055"><span class="linenos">1055</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;NOT creating user [</span><span class="si">{}</span><span class="s2">] as it already exists!&quot;</span><span class="p">,</span> <span class="n">login</span><span class="p">)</span>
</span><span id="PpmsConnection.new_user-1056"><a href="#PpmsConnection.new_user-1056"><span class="linenos">1056</span></a>            <span class="k">return</span>
</span><span id="PpmsConnection.new_user-1057"><a href="#PpmsConnection.new_user-1057"><span class="linenos">1057</span></a>
</span><span id="PpmsConnection.new_user-1058"><a href="#PpmsConnection.new_user-1058"><span class="linenos">1058</span></a>        <span class="n">req_data</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="PpmsConnection.new_user-1059"><a href="#PpmsConnection.new_user-1059"><span class="linenos">1059</span></a>            <span class="s2">&quot;login&quot;</span><span class="p">:</span> <span class="n">login</span><span class="p">,</span>
</span><span id="PpmsConnection.new_user-1060"><a href="#PpmsConnection.new_user-1060"><span class="linenos">1060</span></a>            <span class="s2">&quot;lname&quot;</span><span class="p">:</span> <span class="n">lname</span><span class="p">,</span>
</span><span id="PpmsConnection.new_user-1061"><a href="#PpmsConnection.new_user-1061"><span class="linenos">1061</span></a>            <span class="s2">&quot;fname&quot;</span><span class="p">:</span> <span class="n">fname</span><span class="p">,</span>
</span><span id="PpmsConnection.new_user-1062"><a href="#PpmsConnection.new_user-1062"><span class="linenos">1062</span></a>            <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="n">email</span><span class="p">,</span>
</span><span id="PpmsConnection.new_user-1063"><a href="#PpmsConnection.new_user-1063"><span class="linenos">1063</span></a>            <span class="s2">&quot;unitlogin&quot;</span><span class="p">:</span> <span class="n">ppms_group</span><span class="p">,</span>
</span><span id="PpmsConnection.new_user-1064"><a href="#PpmsConnection.new_user-1064"><span class="linenos">1064</span></a>        <span class="p">}</span>
</span><span id="PpmsConnection.new_user-1065"><a href="#PpmsConnection.new_user-1065"><span class="linenos">1065</span></a>        <span class="k">if</span> <span class="n">phone</span><span class="p">:</span>
</span><span id="PpmsConnection.new_user-1066"><a href="#PpmsConnection.new_user-1066"><span class="linenos">1066</span></a>            <span class="n">req_data</span><span class="p">[</span><span class="s2">&quot;phone&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">phone</span>
</span><span id="PpmsConnection.new_user-1067"><a href="#PpmsConnection.new_user-1067"><span class="linenos">1067</span></a>        <span class="k">if</span> <span class="n">password</span><span class="p">:</span>
</span><span id="PpmsConnection.new_user-1068"><a href="#PpmsConnection.new_user-1068"><span class="linenos">1068</span></a>            <span class="n">req_data</span><span class="p">[</span><span class="s2">&quot;pwd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">password</span>
</span><span id="PpmsConnection.new_user-1069"><a href="#PpmsConnection.new_user-1069"><span class="linenos">1069</span></a>
</span><span id="PpmsConnection.new_user-1070"><a href="#PpmsConnection.new_user-1070"><span class="linenos">1070</span></a>        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;newuser&quot;</span><span class="p">,</span> <span class="n">req_data</span><span class="p">)</span>
</span><span id="PpmsConnection.new_user-1071"><a href="#PpmsConnection.new_user-1071"><span class="linenos">1071</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;OK newuser&quot;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
</span><span id="PpmsConnection.new_user-1072"><a href="#PpmsConnection.new_user-1072"><span class="linenos">1072</span></a>            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Creating new user failed: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="PpmsConnection.new_user-1073"><a href="#PpmsConnection.new_user-1073"><span class="linenos">1073</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="PpmsConnection.new_user-1074"><a href="#PpmsConnection.new_user-1074"><span class="linenos">1074</span></a>            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="PpmsConnection.new_user-1075"><a href="#PpmsConnection.new_user-1075"><span class="linenos">1075</span></a>
</span><span id="PpmsConnection.new_user-1076"><a href="#PpmsConnection.new_user-1076"><span class="linenos">1076</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Created user [</span><span class="si">{}</span><span class="s2">] in PPMS.&quot;</span><span class="p">,</span> <span class="n">login</span><span class="p">)</span>
</span><span id="PpmsConnection.new_user-1077"><a href="#PpmsConnection.new_user-1077"><span class="linenos">1077</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s2">&quot;Response was: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Create a new user in PPMS.</p>

<p>The method is asking PPMS to create a new user account with the given details.
In case an account with that login name already exists, it will log a warning
and return without sending any further requests to PPMS.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>login</strong> (str):
The unique identifier for the user.</li>
<li><strong>lname</strong> (str):
The last name of the user.</li>
<li><strong>fname</strong> (str):
The first name of the user.</li>
<li><strong>email</strong> (str):
The email address of the user.</li>
<li><strong>ppms_group</strong> (str):
The unique identifier of the primary group of the new user. A new group will
be created if no group with the given name exists.</li>
<li><strong>phone</strong> (str, optional):
The phone number of the user.</li>
<li><strong>password</strong> (str, optional):
The password for the user. If no password is set the user will not be able
to log on to PPMS.</li>
</ul>

<h6 id="raises">Raises</h6>

<ul>
<li><strong>RuntimeError</strong>: Will be raised in case creating the user fails.</li>
</ul>
</div>


                            </div>
                            <div id="PpmsConnection.remove_user_access_from_system" class="classattr">
                                        <input id="PpmsConnection.remove_user_access_from_system-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">remove_user_access_from_system</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">username</span>, </span><span class="param"><span class="n">system_id</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="PpmsConnection.remove_user_access_from_system-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PpmsConnection.remove_user_access_from_system"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PpmsConnection.remove_user_access_from_system-1079"><a href="#PpmsConnection.remove_user_access_from_system-1079"><span class="linenos">1079</span></a>    <span class="k">def</span> <span class="nf">remove_user_access_from_system</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">system_id</span><span class="p">):</span>
</span><span id="PpmsConnection.remove_user_access_from_system-1080"><a href="#PpmsConnection.remove_user_access_from_system-1080"><span class="linenos">1080</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Remove permissions for a user to book a given system in PPMS.</span>
</span><span id="PpmsConnection.remove_user_access_from_system-1081"><a href="#PpmsConnection.remove_user_access_from_system-1081"><span class="linenos">1081</span></a>
</span><span id="PpmsConnection.remove_user_access_from_system-1082"><a href="#PpmsConnection.remove_user_access_from_system-1082"><span class="linenos">1082</span></a><span class="sd">        Parameters</span>
</span><span id="PpmsConnection.remove_user_access_from_system-1083"><a href="#PpmsConnection.remove_user_access_from_system-1083"><span class="linenos">1083</span></a><span class="sd">        ----------</span>
</span><span id="PpmsConnection.remove_user_access_from_system-1084"><a href="#PpmsConnection.remove_user_access_from_system-1084"><span class="linenos">1084</span></a><span class="sd">        username : str</span>
</span><span id="PpmsConnection.remove_user_access_from_system-1085"><a href="#PpmsConnection.remove_user_access_from_system-1085"><span class="linenos">1085</span></a><span class="sd">            The username (&#39;login&#39;) to remove booking permissions on the system.</span>
</span><span id="PpmsConnection.remove_user_access_from_system-1086"><a href="#PpmsConnection.remove_user_access_from_system-1086"><span class="linenos">1086</span></a><span class="sd">        system_id : int or int-like</span>
</span><span id="PpmsConnection.remove_user_access_from_system-1087"><a href="#PpmsConnection.remove_user_access_from_system-1087"><span class="linenos">1087</span></a><span class="sd">            The ID of the system to modify the permission for.</span>
</span><span id="PpmsConnection.remove_user_access_from_system-1088"><a href="#PpmsConnection.remove_user_access_from_system-1088"><span class="linenos">1088</span></a>
</span><span id="PpmsConnection.remove_user_access_from_system-1089"><a href="#PpmsConnection.remove_user_access_from_system-1089"><span class="linenos">1089</span></a><span class="sd">        Returns</span>
</span><span id="PpmsConnection.remove_user_access_from_system-1090"><a href="#PpmsConnection.remove_user_access_from_system-1090"><span class="linenos">1090</span></a><span class="sd">        -------</span>
</span><span id="PpmsConnection.remove_user_access_from_system-1091"><a href="#PpmsConnection.remove_user_access_from_system-1091"><span class="linenos">1091</span></a><span class="sd">        bool</span>
</span><span id="PpmsConnection.remove_user_access_from_system-1092"><a href="#PpmsConnection.remove_user_access_from_system-1092"><span class="linenos">1092</span></a><span class="sd">            True in case the given username now has the permissions to book the</span>
</span><span id="PpmsConnection.remove_user_access_from_system-1093"><a href="#PpmsConnection.remove_user_access_from_system-1093"><span class="linenos">1093</span></a><span class="sd">            system with the specified ID (or if the user already had them</span>
</span><span id="PpmsConnection.remove_user_access_from_system-1094"><a href="#PpmsConnection.remove_user_access_from_system-1094"><span class="linenos">1094</span></a><span class="sd">            before), False otherwise.</span>
</span><span id="PpmsConnection.remove_user_access_from_system-1095"><a href="#PpmsConnection.remove_user_access_from_system-1095"><span class="linenos">1095</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PpmsConnection.remove_user_access_from_system-1096"><a href="#PpmsConnection.remove_user_access_from_system-1096"><span class="linenos">1096</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_system_booking_permissions</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">system_id</span><span class="p">,</span> <span class="s2">&quot;D&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Remove permissions for a user to book a given system in PPMS.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>username</strong> (str):
The username ('login') to remove booking permissions on the system.</li>
<li><strong>system_id</strong> (int or int-like):
The ID of the system to modify the permission for.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>bool</strong>: True in case the given username now has the permissions to book the
system with the specified ID (or if the user already had them
before), False otherwise.</li>
</ul>
</div>


                            </div>
                            <div id="PpmsConnection.set_system_booking_permissions" class="classattr">
                                        <input id="PpmsConnection.set_system_booking_permissions-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">set_system_booking_permissions</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">login</span>, </span><span class="param"><span class="n">system_id</span>, </span><span class="param"><span class="n">permission</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="PpmsConnection.set_system_booking_permissions-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PpmsConnection.set_system_booking_permissions"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PpmsConnection.set_system_booking_permissions-1098"><a href="#PpmsConnection.set_system_booking_permissions-1098"><span class="linenos">1098</span></a>    <span class="k">def</span> <span class="nf">set_system_booking_permissions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">login</span><span class="p">,</span> <span class="n">system_id</span><span class="p">,</span> <span class="n">permission</span><span class="p">):</span>
</span><span id="PpmsConnection.set_system_booking_permissions-1099"><a href="#PpmsConnection.set_system_booking_permissions-1099"><span class="linenos">1099</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Set permissions for a user on a given system in PPMS.</span>
</span><span id="PpmsConnection.set_system_booking_permissions-1100"><a href="#PpmsConnection.set_system_booking_permissions-1100"><span class="linenos">1100</span></a>
</span><span id="PpmsConnection.set_system_booking_permissions-1101"><a href="#PpmsConnection.set_system_booking_permissions-1101"><span class="linenos">1101</span></a><span class="sd">        Parameters</span>
</span><span id="PpmsConnection.set_system_booking_permissions-1102"><a href="#PpmsConnection.set_system_booking_permissions-1102"><span class="linenos">1102</span></a><span class="sd">        ----------</span>
</span><span id="PpmsConnection.set_system_booking_permissions-1103"><a href="#PpmsConnection.set_system_booking_permissions-1103"><span class="linenos">1103</span></a><span class="sd">        username : str</span>
</span><span id="PpmsConnection.set_system_booking_permissions-1104"><a href="#PpmsConnection.set_system_booking_permissions-1104"><span class="linenos">1104</span></a><span class="sd">            The username (&#39;login&#39;) to allow for booking the system.</span>
</span><span id="PpmsConnection.set_system_booking_permissions-1105"><a href="#PpmsConnection.set_system_booking_permissions-1105"><span class="linenos">1105</span></a><span class="sd">        system_id : int or int-like</span>
</span><span id="PpmsConnection.set_system_booking_permissions-1106"><a href="#PpmsConnection.set_system_booking_permissions-1106"><span class="linenos">1106</span></a><span class="sd">            The ID of the system to add the permission for.</span>
</span><span id="PpmsConnection.set_system_booking_permissions-1107"><a href="#PpmsConnection.set_system_booking_permissions-1107"><span class="linenos">1107</span></a><span class="sd">        permission : {&#39;D&#39;, &#39;A&#39;, &#39;N&#39;, &#39;S&#39;}</span>
</span><span id="PpmsConnection.set_system_booking_permissions-1108"><a href="#PpmsConnection.set_system_booking_permissions-1108"><span class="linenos">1108</span></a><span class="sd">            The permission level to set for the user, one of:</span>
</span><span id="PpmsConnection.set_system_booking_permissions-1109"><a href="#PpmsConnection.set_system_booking_permissions-1109"><span class="linenos">1109</span></a><span class="sd">              - ``D`` : deactivated</span>
</span><span id="PpmsConnection.set_system_booking_permissions-1110"><a href="#PpmsConnection.set_system_booking_permissions-1110"><span class="linenos">1110</span></a><span class="sd">              - ``A`` : autonomous</span>
</span><span id="PpmsConnection.set_system_booking_permissions-1111"><a href="#PpmsConnection.set_system_booking_permissions-1111"><span class="linenos">1111</span></a><span class="sd">              - ``N`` : novice</span>
</span><span id="PpmsConnection.set_system_booking_permissions-1112"><a href="#PpmsConnection.set_system_booking_permissions-1112"><span class="linenos">1112</span></a><span class="sd">              - ``S`` : superuser</span>
</span><span id="PpmsConnection.set_system_booking_permissions-1113"><a href="#PpmsConnection.set_system_booking_permissions-1113"><span class="linenos">1113</span></a>
</span><span id="PpmsConnection.set_system_booking_permissions-1114"><a href="#PpmsConnection.set_system_booking_permissions-1114"><span class="linenos">1114</span></a><span class="sd">        Returns</span>
</span><span id="PpmsConnection.set_system_booking_permissions-1115"><a href="#PpmsConnection.set_system_booking_permissions-1115"><span class="linenos">1115</span></a><span class="sd">        -------</span>
</span><span id="PpmsConnection.set_system_booking_permissions-1116"><a href="#PpmsConnection.set_system_booking_permissions-1116"><span class="linenos">1116</span></a><span class="sd">        bool</span>
</span><span id="PpmsConnection.set_system_booking_permissions-1117"><a href="#PpmsConnection.set_system_booking_permissions-1117"><span class="linenos">1117</span></a><span class="sd">            True in case setting permissions for the given username on the</span>
</span><span id="PpmsConnection.set_system_booking_permissions-1118"><a href="#PpmsConnection.set_system_booking_permissions-1118"><span class="linenos">1118</span></a><span class="sd">            system with the specified ID succeeded (or if the user already had</span>
</span><span id="PpmsConnection.set_system_booking_permissions-1119"><a href="#PpmsConnection.set_system_booking_permissions-1119"><span class="linenos">1119</span></a><span class="sd">            those permissions before), False otherwise.</span>
</span><span id="PpmsConnection.set_system_booking_permissions-1120"><a href="#PpmsConnection.set_system_booking_permissions-1120"><span class="linenos">1120</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PpmsConnection.set_system_booking_permissions-1121"><a href="#PpmsConnection.set_system_booking_permissions-1121"><span class="linenos">1121</span></a>
</span><span id="PpmsConnection.set_system_booking_permissions-1122"><a href="#PpmsConnection.set_system_booking_permissions-1122"><span class="linenos">1122</span></a>        <span class="k">def</span> <span class="nf">permission_name</span><span class="p">(</span><span class="n">shortname</span><span class="p">):</span>
</span><span id="PpmsConnection.set_system_booking_permissions-1123"><a href="#PpmsConnection.set_system_booking_permissions-1123"><span class="linenos">1123</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;Closure to validate a permission level and return its long name.</span>
</span><span id="PpmsConnection.set_system_booking_permissions-1124"><a href="#PpmsConnection.set_system_booking_permissions-1124"><span class="linenos">1124</span></a>
</span><span id="PpmsConnection.set_system_booking_permissions-1125"><a href="#PpmsConnection.set_system_booking_permissions-1125"><span class="linenos">1125</span></a><span class="sd">            Parameters</span>
</span><span id="PpmsConnection.set_system_booking_permissions-1126"><a href="#PpmsConnection.set_system_booking_permissions-1126"><span class="linenos">1126</span></a><span class="sd">            ----------</span>
</span><span id="PpmsConnection.set_system_booking_permissions-1127"><a href="#PpmsConnection.set_system_booking_permissions-1127"><span class="linenos">1127</span></a><span class="sd">            shortname : str</span>
</span><span id="PpmsConnection.set_system_booking_permissions-1128"><a href="#PpmsConnection.set_system_booking_permissions-1128"><span class="linenos">1128</span></a><span class="sd">                A single character defining the permission level.</span>
</span><span id="PpmsConnection.set_system_booking_permissions-1129"><a href="#PpmsConnection.set_system_booking_permissions-1129"><span class="linenos">1129</span></a>
</span><span id="PpmsConnection.set_system_booking_permissions-1130"><a href="#PpmsConnection.set_system_booking_permissions-1130"><span class="linenos">1130</span></a><span class="sd">            Returns</span>
</span><span id="PpmsConnection.set_system_booking_permissions-1131"><a href="#PpmsConnection.set_system_booking_permissions-1131"><span class="linenos">1131</span></a><span class="sd">            -------</span>
</span><span id="PpmsConnection.set_system_booking_permissions-1132"><a href="#PpmsConnection.set_system_booking_permissions-1132"><span class="linenos">1132</span></a><span class="sd">            str</span>
</span><span id="PpmsConnection.set_system_booking_permissions-1133"><a href="#PpmsConnection.set_system_booking_permissions-1133"><span class="linenos">1133</span></a><span class="sd">                The long (human-readable) name of the permission level.</span>
</span><span id="PpmsConnection.set_system_booking_permissions-1134"><a href="#PpmsConnection.set_system_booking_permissions-1134"><span class="linenos">1134</span></a>
</span><span id="PpmsConnection.set_system_booking_permissions-1135"><a href="#PpmsConnection.set_system_booking_permissions-1135"><span class="linenos">1135</span></a><span class="sd">            Raises</span>
</span><span id="PpmsConnection.set_system_booking_permissions-1136"><a href="#PpmsConnection.set_system_booking_permissions-1136"><span class="linenos">1136</span></a><span class="sd">            ------</span>
</span><span id="PpmsConnection.set_system_booking_permissions-1137"><a href="#PpmsConnection.set_system_booking_permissions-1137"><span class="linenos">1137</span></a><span class="sd">            KeyError</span>
</span><span id="PpmsConnection.set_system_booking_permissions-1138"><a href="#PpmsConnection.set_system_booking_permissions-1138"><span class="linenos">1138</span></a><span class="sd">                Raised in case an invalid permission level was given.</span>
</span><span id="PpmsConnection.set_system_booking_permissions-1139"><a href="#PpmsConnection.set_system_booking_permissions-1139"><span class="linenos">1139</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="PpmsConnection.set_system_booking_permissions-1140"><a href="#PpmsConnection.set_system_booking_permissions-1140"><span class="linenos">1140</span></a>            <span class="n">mapping</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="PpmsConnection.set_system_booking_permissions-1141"><a href="#PpmsConnection.set_system_booking_permissions-1141"><span class="linenos">1141</span></a>                <span class="s2">&quot;D&quot;</span><span class="p">:</span> <span class="s2">&quot;deactivated&quot;</span><span class="p">,</span>
</span><span id="PpmsConnection.set_system_booking_permissions-1142"><a href="#PpmsConnection.set_system_booking_permissions-1142"><span class="linenos">1142</span></a>                <span class="s2">&quot;A&quot;</span><span class="p">:</span> <span class="s2">&quot;autonomous&quot;</span><span class="p">,</span>
</span><span id="PpmsConnection.set_system_booking_permissions-1143"><a href="#PpmsConnection.set_system_booking_permissions-1143"><span class="linenos">1143</span></a>                <span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="s2">&quot;novice&quot;</span><span class="p">,</span>
</span><span id="PpmsConnection.set_system_booking_permissions-1144"><a href="#PpmsConnection.set_system_booking_permissions-1144"><span class="linenos">1144</span></a>                <span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="s2">&quot;superuser&quot;</span><span class="p">,</span>
</span><span id="PpmsConnection.set_system_booking_permissions-1145"><a href="#PpmsConnection.set_system_booking_permissions-1145"><span class="linenos">1145</span></a>            <span class="p">}</span>
</span><span id="PpmsConnection.set_system_booking_permissions-1146"><a href="#PpmsConnection.set_system_booking_permissions-1146"><span class="linenos">1146</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="PpmsConnection.set_system_booking_permissions-1147"><a href="#PpmsConnection.set_system_booking_permissions-1147"><span class="linenos">1147</span></a>                <span class="k">return</span> <span class="n">mapping</span><span class="p">[</span><span class="n">shortname</span><span class="p">]</span>
</span><span id="PpmsConnection.set_system_booking_permissions-1148"><a href="#PpmsConnection.set_system_booking_permissions-1148"><span class="linenos">1148</span></a>            <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
</span><span id="PpmsConnection.set_system_booking_permissions-1149"><a href="#PpmsConnection.set_system_booking_permissions-1149"><span class="linenos">1149</span></a>                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid permission [</span><span class="si">{</span><span class="n">shortname</span><span class="si">}</span><span class="s2">] given&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">err</span>
</span><span id="PpmsConnection.set_system_booking_permissions-1150"><a href="#PpmsConnection.set_system_booking_permissions-1150"><span class="linenos">1150</span></a>
</span><span id="PpmsConnection.set_system_booking_permissions-1151"><a href="#PpmsConnection.set_system_booking_permissions-1151"><span class="linenos">1151</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
</span><span id="PpmsConnection.set_system_booking_permissions-1152"><a href="#PpmsConnection.set_system_booking_permissions-1152"><span class="linenos">1152</span></a>            <span class="s2">&quot;Setting permission level [</span><span class="si">{}</span><span class="s2">] for user [</span><span class="si">{}</span><span class="s2">] on system [</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="p">,</span>
</span><span id="PpmsConnection.set_system_booking_permissions-1153"><a href="#PpmsConnection.set_system_booking_permissions-1153"><span class="linenos">1153</span></a>            <span class="n">permission_name</span><span class="p">(</span><span class="n">permission</span><span class="p">),</span>
</span><span id="PpmsConnection.set_system_booking_permissions-1154"><a href="#PpmsConnection.set_system_booking_permissions-1154"><span class="linenos">1154</span></a>            <span class="n">login</span><span class="p">,</span>
</span><span id="PpmsConnection.set_system_booking_permissions-1155"><a href="#PpmsConnection.set_system_booking_permissions-1155"><span class="linenos">1155</span></a>            <span class="n">system_id</span><span class="p">,</span>
</span><span id="PpmsConnection.set_system_booking_permissions-1156"><a href="#PpmsConnection.set_system_booking_permissions-1156"><span class="linenos">1156</span></a>        <span class="p">)</span>
</span><span id="PpmsConnection.set_system_booking_permissions-1157"><a href="#PpmsConnection.set_system_booking_permissions-1157"><span class="linenos">1157</span></a>
</span><span id="PpmsConnection.set_system_booking_permissions-1158"><a href="#PpmsConnection.set_system_booking_permissions-1158"><span class="linenos">1158</span></a>        <span class="n">parameters</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">system_id</span><span class="p">,</span> <span class="s2">&quot;login&quot;</span><span class="p">:</span> <span class="n">login</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">permission</span><span class="p">}</span>
</span><span id="PpmsConnection.set_system_booking_permissions-1159"><a href="#PpmsConnection.set_system_booking_permissions-1159"><span class="linenos">1159</span></a>        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;setright&quot;</span><span class="p">,</span> <span class="n">parameters</span><span class="p">)</span>
</span><span id="PpmsConnection.set_system_booking_permissions-1160"><a href="#PpmsConnection.set_system_booking_permissions-1160"><span class="linenos">1160</span></a>
</span><span id="PpmsConnection.set_system_booking_permissions-1161"><a href="#PpmsConnection.set_system_booking_permissions-1161"><span class="linenos">1161</span></a>        <span class="c1"># NOTE: the &#39;setright&#39; action will accept ANY permission type and return &#39;done&#39;</span>
</span><span id="PpmsConnection.set_system_booking_permissions-1162"><a href="#PpmsConnection.set_system_booking_permissions-1162"><span class="linenos">1162</span></a>        <span class="c1"># on the request, so there is no way to check from the response if setting the</span>
</span><span id="PpmsConnection.set_system_booking_permissions-1163"><a href="#PpmsConnection.set_system_booking_permissions-1163"><span class="linenos">1163</span></a>        <span class="c1"># permission really worked!!</span>
</span><span id="PpmsConnection.set_system_booking_permissions-1164"><a href="#PpmsConnection.set_system_booking_permissions-1164"><span class="linenos">1164</span></a>        <span class="c1"># log.trace(&#39;Request returned text: {}&#39;, response.text)</span>
</span><span id="PpmsConnection.set_system_booking_permissions-1165"><a href="#PpmsConnection.set_system_booking_permissions-1165"><span class="linenos">1165</span></a>        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;done&quot;</span><span class="p">:</span>
</span><span id="PpmsConnection.set_system_booking_permissions-1166"><a href="#PpmsConnection.set_system_booking_permissions-1166"><span class="linenos">1166</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span>
</span><span id="PpmsConnection.set_system_booking_permissions-1167"><a href="#PpmsConnection.set_system_booking_permissions-1167"><span class="linenos">1167</span></a>                <span class="s2">&quot;User [</span><span class="si">{}</span><span class="s2">] now has permission level [</span><span class="si">{}</span><span class="s2">] on system [</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="p">,</span>
</span><span id="PpmsConnection.set_system_booking_permissions-1168"><a href="#PpmsConnection.set_system_booking_permissions-1168"><span class="linenos">1168</span></a>                <span class="n">login</span><span class="p">,</span>
</span><span id="PpmsConnection.set_system_booking_permissions-1169"><a href="#PpmsConnection.set_system_booking_permissions-1169"><span class="linenos">1169</span></a>                <span class="n">permission_name</span><span class="p">(</span><span class="n">permission</span><span class="p">),</span>
</span><span id="PpmsConnection.set_system_booking_permissions-1170"><a href="#PpmsConnection.set_system_booking_permissions-1170"><span class="linenos">1170</span></a>                <span class="n">system_id</span><span class="p">,</span>
</span><span id="PpmsConnection.set_system_booking_permissions-1171"><a href="#PpmsConnection.set_system_booking_permissions-1171"><span class="linenos">1171</span></a>            <span class="p">)</span>
</span><span id="PpmsConnection.set_system_booking_permissions-1172"><a href="#PpmsConnection.set_system_booking_permissions-1172"><span class="linenos">1172</span></a>            <span class="k">return</span> <span class="kc">True</span>
</span><span id="PpmsConnection.set_system_booking_permissions-1173"><a href="#PpmsConnection.set_system_booking_permissions-1173"><span class="linenos">1173</span></a>
</span><span id="PpmsConnection.set_system_booking_permissions-1174"><a href="#PpmsConnection.set_system_booking_permissions-1174"><span class="linenos">1174</span></a>        <span class="k">if</span> <span class="s2">&quot;invalid user&quot;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
</span><span id="PpmsConnection.set_system_booking_permissions-1175"><a href="#PpmsConnection.set_system_booking_permissions-1175"><span class="linenos">1175</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;User [</span><span class="si">{}</span><span class="s2">] doesn&#39;t seem to exist in PPMS&quot;</span><span class="p">,</span> <span class="n">login</span><span class="p">)</span>
</span><span id="PpmsConnection.set_system_booking_permissions-1176"><a href="#PpmsConnection.set_system_booking_permissions-1176"><span class="linenos">1176</span></a>        <span class="k">elif</span> <span class="s2">&quot;system right not authorized&quot;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
</span><span id="PpmsConnection.set_system_booking_permissions-1177"><a href="#PpmsConnection.set_system_booking_permissions-1177"><span class="linenos">1177</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
</span><span id="PpmsConnection.set_system_booking_permissions-1178"><a href="#PpmsConnection.set_system_booking_permissions-1178"><span class="linenos">1178</span></a>                <span class="s2">&quot;Unable to set permissions for system </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">system_id</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span>
</span><span id="PpmsConnection.set_system_booking_permissions-1179"><a href="#PpmsConnection.set_system_booking_permissions-1179"><span class="linenos">1179</span></a>            <span class="p">)</span>
</span><span id="PpmsConnection.set_system_booking_permissions-1180"><a href="#PpmsConnection.set_system_booking_permissions-1180"><span class="linenos">1180</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="PpmsConnection.set_system_booking_permissions-1181"><a href="#PpmsConnection.set_system_booking_permissions-1181"><span class="linenos">1181</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Unexpected response, assuming request failed: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</span><span id="PpmsConnection.set_system_booking_permissions-1182"><a href="#PpmsConnection.set_system_booking_permissions-1182"><span class="linenos">1182</span></a>
</span><span id="PpmsConnection.set_system_booking_permissions-1183"><a href="#PpmsConnection.set_system_booking_permissions-1183"><span class="linenos">1183</span></a>        <span class="k">return</span> <span class="kc">False</span>
</span></pre></div>


            <div class="docstring"><p>Set permissions for a user on a given system in PPMS.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>username</strong> (str):
The username ('login') to allow for booking the system.</li>
<li><strong>system_id</strong> (int or int-like):
The ID of the system to add the permission for.</li>
<li><strong>permission</strong> ({'D', 'A', 'N', 'S'}):
The permission level to set for the user, one of:
<ul>
<li><code>D</code> : deactivated</li>
<li><code>A</code> : autonomous</li>
<li><code>N</code> : novice</li>
<li><code>S</code> : superuser</li>
</ul></li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>bool</strong>: True in case setting permissions for the given username on the
system with the specified ID succeeded (or if the user already had
those permissions before), False otherwise.</li>
</ul>
</div>


                            </div>
                            <div id="PpmsConnection.update_systems" class="classattr">
                                        <input id="PpmsConnection.update_systems-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">update_systems</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="PpmsConnection.update_systems-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PpmsConnection.update_systems"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PpmsConnection.update_systems-1185"><a href="#PpmsConnection.update_systems-1185"><span class="linenos">1185</span></a>    <span class="k">def</span> <span class="nf">update_systems</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="PpmsConnection.update_systems-1186"><a href="#PpmsConnection.update_systems-1186"><span class="linenos">1186</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Update cached details for all bookable systems from PPMS.</span>
</span><span id="PpmsConnection.update_systems-1187"><a href="#PpmsConnection.update_systems-1187"><span class="linenos">1187</span></a>
</span><span id="PpmsConnection.update_systems-1188"><a href="#PpmsConnection.update_systems-1188"><span class="linenos">1188</span></a><span class="sd">        Get the details on all bookable systems from PPMS and store them in the local</span>
</span><span id="PpmsConnection.update_systems-1189"><a href="#PpmsConnection.update_systems-1189"><span class="linenos">1189</span></a><span class="sd">        cache. If parsing the PUMAPI response for a system fails for any reason, the</span>
</span><span id="PpmsConnection.update_systems-1190"><a href="#PpmsConnection.update_systems-1190"><span class="linenos">1190</span></a><span class="sd">        system is skipped entirely.</span>
</span><span id="PpmsConnection.update_systems-1191"><a href="#PpmsConnection.update_systems-1191"><span class="linenos">1191</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PpmsConnection.update_systems-1192"><a href="#PpmsConnection.update_systems-1192"><span class="linenos">1192</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s2">&quot;Updating list of bookable systems...&quot;</span><span class="p">)</span>
</span><span id="PpmsConnection.update_systems-1193"><a href="#PpmsConnection.update_systems-1193"><span class="linenos">1193</span></a>        <span class="n">systems</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="PpmsConnection.update_systems-1194"><a href="#PpmsConnection.update_systems-1194"><span class="linenos">1194</span></a>        <span class="n">parse_fails</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="PpmsConnection.update_systems-1195"><a href="#PpmsConnection.update_systems-1195"><span class="linenos">1195</span></a>        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;getsystems&quot;</span><span class="p">)</span>
</span><span id="PpmsConnection.update_systems-1196"><a href="#PpmsConnection.update_systems-1196"><span class="linenos">1196</span></a>        <span class="n">details</span> <span class="o">=</span> <span class="n">parse_multiline_response</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">graceful</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="PpmsConnection.update_systems-1197"><a href="#PpmsConnection.update_systems-1197"><span class="linenos">1197</span></a>        <span class="k">for</span> <span class="n">detail</span> <span class="ow">in</span> <span class="n">details</span><span class="p">:</span>
</span><span id="PpmsConnection.update_systems-1198"><a href="#PpmsConnection.update_systems-1198"><span class="linenos">1198</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="PpmsConnection.update_systems-1199"><a href="#PpmsConnection.update_systems-1199"><span class="linenos">1199</span></a>                <span class="n">system</span> <span class="o">=</span> <span class="n">PpmsSystem</span><span class="p">(</span><span class="n">detail</span><span class="p">)</span>
</span><span id="PpmsConnection.update_systems-1200"><a href="#PpmsConnection.update_systems-1200"><span class="linenos">1200</span></a>            <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
</span><span id="PpmsConnection.update_systems-1201"><a href="#PpmsConnection.update_systems-1201"><span class="linenos">1201</span></a>                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error processing `getsystems` response: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
</span><span id="PpmsConnection.update_systems-1202"><a href="#PpmsConnection.update_systems-1202"><span class="linenos">1202</span></a>                <span class="n">parse_fails</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="PpmsConnection.update_systems-1203"><a href="#PpmsConnection.update_systems-1203"><span class="linenos">1203</span></a>                <span class="k">continue</span>
</span><span id="PpmsConnection.update_systems-1204"><a href="#PpmsConnection.update_systems-1204"><span class="linenos">1204</span></a>
</span><span id="PpmsConnection.update_systems-1205"><a href="#PpmsConnection.update_systems-1205"><span class="linenos">1205</span></a>            <span class="n">systems</span><span class="p">[</span><span class="n">system</span><span class="o">.</span><span class="n">system_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">system</span>
</span><span id="PpmsConnection.update_systems-1206"><a href="#PpmsConnection.update_systems-1206"><span class="linenos">1206</span></a>
</span><span id="PpmsConnection.update_systems-1207"><a href="#PpmsConnection.update_systems-1207"><span class="linenos">1207</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span>
</span><span id="PpmsConnection.update_systems-1208"><a href="#PpmsConnection.update_systems-1208"><span class="linenos">1208</span></a>            <span class="s2">&quot;Updated </span><span class="si">{}</span><span class="s2"> bookable systems from PPMS (</span><span class="si">{}</span><span class="s2"> systems failed parsing)&quot;</span><span class="p">,</span>
</span><span id="PpmsConnection.update_systems-1209"><a href="#PpmsConnection.update_systems-1209"><span class="linenos">1209</span></a>            <span class="nb">len</span><span class="p">(</span><span class="n">systems</span><span class="p">),</span>
</span><span id="PpmsConnection.update_systems-1210"><a href="#PpmsConnection.update_systems-1210"><span class="linenos">1210</span></a>            <span class="n">parse_fails</span><span class="p">,</span>
</span><span id="PpmsConnection.update_systems-1211"><a href="#PpmsConnection.update_systems-1211"><span class="linenos">1211</span></a>        <span class="p">)</span>
</span><span id="PpmsConnection.update_systems-1212"><a href="#PpmsConnection.update_systems-1212"><span class="linenos">1212</span></a>
</span><span id="PpmsConnection.update_systems-1213"><a href="#PpmsConnection.update_systems-1213"><span class="linenos">1213</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">systems</span> <span class="o">=</span> <span class="n">systems</span>
</span></pre></div>


            <div class="docstring"><p>Update cached details for all bookable systems from PPMS.</p>

<p>Get the details on all bookable systems from PPMS and store them in the local
cache. If parsing the PUMAPI response for a system fails for any reason, the
system is skipped entirely.</p>
</div>


                            </div>
                            <div id="PpmsConnection.update_users" class="classattr">
                                        <input id="PpmsConnection.update_users-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">update_users</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">user_ids</span><span class="o">=</span><span class="p">[]</span>, </span><span class="param"><span class="n">active_only</span><span class="o">=</span><span class="kc">True</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="PpmsConnection.update_users-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PpmsConnection.update_users"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PpmsConnection.update_users-1215"><a href="#PpmsConnection.update_users-1215"><span class="linenos">1215</span></a>    <span class="k">def</span> <span class="nf">update_users</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_ids</span><span class="o">=</span><span class="p">[],</span> <span class="n">active_only</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="PpmsConnection.update_users-1216"><a href="#PpmsConnection.update_users-1216"><span class="linenos">1216</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Update cached details for a list of users from PPMS.</span>
</span><span id="PpmsConnection.update_users-1217"><a href="#PpmsConnection.update_users-1217"><span class="linenos">1217</span></a>
</span><span id="PpmsConnection.update_users-1218"><a href="#PpmsConnection.update_users-1218"><span class="linenos">1218</span></a><span class="sd">        Get the user details on a list of users (or all active ones) from PPMS and store</span>
</span><span id="PpmsConnection.update_users-1219"><a href="#PpmsConnection.update_users-1219"><span class="linenos">1219</span></a><span class="sd">        them in the object&#39;s `users` dict. As a side effect, this will also fill the</span>
</span><span id="PpmsConnection.update_users-1220"><a href="#PpmsConnection.update_users-1220"><span class="linenos">1220</span></a><span class="sd">        cache directory in case the object&#39;s `cache_path` attribute is set.</span>
</span><span id="PpmsConnection.update_users-1221"><a href="#PpmsConnection.update_users-1221"><span class="linenos">1221</span></a>
</span><span id="PpmsConnection.update_users-1222"><a href="#PpmsConnection.update_users-1222"><span class="linenos">1222</span></a><span class="sd">        WARNING - very slow, especially when the PPMS instance has many users!</span>
</span><span id="PpmsConnection.update_users-1223"><a href="#PpmsConnection.update_users-1223"><span class="linenos">1223</span></a>
</span><span id="PpmsConnection.update_users-1224"><a href="#PpmsConnection.update_users-1224"><span class="linenos">1224</span></a><span class="sd">        Parameters</span>
</span><span id="PpmsConnection.update_users-1225"><a href="#PpmsConnection.update_users-1225"><span class="linenos">1225</span></a><span class="sd">        ----------</span>
</span><span id="PpmsConnection.update_users-1226"><a href="#PpmsConnection.update_users-1226"><span class="linenos">1226</span></a><span class="sd">        user_ids : list(str), optional</span>
</span><span id="PpmsConnection.update_users-1227"><a href="#PpmsConnection.update_users-1227"><span class="linenos">1227</span></a><span class="sd">            A list of user IDs (login names) to request the cache for, by</span>
</span><span id="PpmsConnection.update_users-1228"><a href="#PpmsConnection.update_users-1228"><span class="linenos">1228</span></a><span class="sd">            default [] which will result in all *active* users to be requested.</span>
</span><span id="PpmsConnection.update_users-1229"><a href="#PpmsConnection.update_users-1229"><span class="linenos">1229</span></a><span class="sd">        active_only : bool, optional</span>
</span><span id="PpmsConnection.update_users-1230"><a href="#PpmsConnection.update_users-1230"><span class="linenos">1230</span></a><span class="sd">            If set to `False` also &quot;inactive&quot; users will be fetched from PPMS,</span>
</span><span id="PpmsConnection.update_users-1231"><a href="#PpmsConnection.update_users-1231"><span class="linenos">1231</span></a><span class="sd">            by default `True`.</span>
</span><span id="PpmsConnection.update_users-1232"><a href="#PpmsConnection.update_users-1232"><span class="linenos">1232</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PpmsConnection.update_users-1233"><a href="#PpmsConnection.update_users-1233"><span class="linenos">1233</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">user_ids</span><span class="p">:</span>
</span><span id="PpmsConnection.update_users-1234"><a href="#PpmsConnection.update_users-1234"><span class="linenos">1234</span></a>            <span class="n">user_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_ids</span><span class="p">(</span><span class="n">active</span><span class="o">=</span><span class="n">active_only</span><span class="p">)</span>
</span><span id="PpmsConnection.update_users-1235"><a href="#PpmsConnection.update_users-1235"><span class="linenos">1235</span></a>
</span><span id="PpmsConnection.update_users-1236"><a href="#PpmsConnection.update_users-1236"><span class="linenos">1236</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s2">&quot;Updating details on </span><span class="si">{}</span><span class="s2"> users&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">user_ids</span><span class="p">))</span>
</span><span id="PpmsConnection.update_users-1237"><a href="#PpmsConnection.update_users-1237"><span class="linenos">1237</span></a>        <span class="k">for</span> <span class="n">user_id</span> <span class="ow">in</span> <span class="n">user_ids</span><span class="p">:</span>
</span><span id="PpmsConnection.update_users-1238"><a href="#PpmsConnection.update_users-1238"><span class="linenos">1238</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">skip_cache</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PpmsConnection.update_users-1239"><a href="#PpmsConnection.update_users-1239"><span class="linenos">1239</span></a>
</span><span id="PpmsConnection.update_users-1240"><a href="#PpmsConnection.update_users-1240"><span class="linenos">1240</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Collected details on </span><span class="si">{}</span><span class="s2"> users&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="p">))</span>
</span></pre></div>


            <div class="docstring"><p>Update cached details for a list of users from PPMS.</p>

<p>Get the user details on a list of users (or all active ones) from PPMS and store
them in the object's <code>users</code> dict. As a side effect, this will also fill the
cache directory in case the object's <code>cache_path</code> attribute is set.</p>

<p>WARNING - very slow, especially when the PPMS instance has many users!</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>user_ids</strong> (list(str), optional):
A list of user IDs (login names) to request the cache for, by
default [] which will result in all <em>active</em> users to be requested.</li>
<li><strong>active_only</strong> (bool, optional):
If set to <code>False</code> also "inactive" users will be fetched from PPMS,
by default <code>True</code>.</li>
</ul>
</div>


                            </div>
                            <div id="PpmsConnection.user_exists" class="classattr">
                                        <input id="PpmsConnection.user_exists-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">user_exists</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">login</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="PpmsConnection.user_exists-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PpmsConnection.user_exists"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PpmsConnection.user_exists-1242"><a href="#PpmsConnection.user_exists-1242"><span class="linenos">1242</span></a>    <span class="k">def</span> <span class="nf">user_exists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">login</span><span class="p">):</span>
</span><span id="PpmsConnection.user_exists-1243"><a href="#PpmsConnection.user_exists-1243"><span class="linenos">1243</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if an account with the given login name already exists in PPMS.</span>
</span><span id="PpmsConnection.user_exists-1244"><a href="#PpmsConnection.user_exists-1244"><span class="linenos">1244</span></a>
</span><span id="PpmsConnection.user_exists-1245"><a href="#PpmsConnection.user_exists-1245"><span class="linenos">1245</span></a><span class="sd">        Parameters</span>
</span><span id="PpmsConnection.user_exists-1246"><a href="#PpmsConnection.user_exists-1246"><span class="linenos">1246</span></a><span class="sd">        ----------</span>
</span><span id="PpmsConnection.user_exists-1247"><a href="#PpmsConnection.user_exists-1247"><span class="linenos">1247</span></a><span class="sd">        login : str</span>
</span><span id="PpmsConnection.user_exists-1248"><a href="#PpmsConnection.user_exists-1248"><span class="linenos">1248</span></a><span class="sd">            The login name to check for.</span>
</span><span id="PpmsConnection.user_exists-1249"><a href="#PpmsConnection.user_exists-1249"><span class="linenos">1249</span></a>
</span><span id="PpmsConnection.user_exists-1250"><a href="#PpmsConnection.user_exists-1250"><span class="linenos">1250</span></a><span class="sd">        Returns</span>
</span><span id="PpmsConnection.user_exists-1251"><a href="#PpmsConnection.user_exists-1251"><span class="linenos">1251</span></a><span class="sd">        -------</span>
</span><span id="PpmsConnection.user_exists-1252"><a href="#PpmsConnection.user_exists-1252"><span class="linenos">1252</span></a><span class="sd">        bool</span>
</span><span id="PpmsConnection.user_exists-1253"><a href="#PpmsConnection.user_exists-1253"><span class="linenos">1253</span></a><span class="sd">            True in case an account with that name exists in PPMS, false otherwise.</span>
</span><span id="PpmsConnection.user_exists-1254"><a href="#PpmsConnection.user_exists-1254"><span class="linenos">1254</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PpmsConnection.user_exists-1255"><a href="#PpmsConnection.user_exists-1255"><span class="linenos">1255</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="PpmsConnection.user_exists-1256"><a href="#PpmsConnection.user_exists-1256"><span class="linenos">1256</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="n">login</span><span class="p">)</span>
</span><span id="PpmsConnection.user_exists-1257"><a href="#PpmsConnection.user_exists-1257"><span class="linenos">1257</span></a>            <span class="k">return</span> <span class="kc">True</span>
</span><span id="PpmsConnection.user_exists-1258"><a href="#PpmsConnection.user_exists-1258"><span class="linenos">1258</span></a>        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
</span><span id="PpmsConnection.user_exists-1259"><a href="#PpmsConnection.user_exists-1259"><span class="linenos">1259</span></a>            <span class="k">return</span> <span class="kc">False</span>
</span></pre></div>


            <div class="docstring"><p>Check if an account with the given login name already exists in PPMS.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>login</strong> (str):
The login name to check for.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>bool</strong>: True in case an account with that name exists in PPMS, false otherwise.</li>
</ul>
</div>


                            </div>
                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>