<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 10.0.4"/>
    <title>pyppms.ppms API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;}nav.pdoc{--pad:1.75rem;--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent }nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc li{display:block;margin:0;padding:.2rem 0 .2rem var(--indent);transition:all 100ms;}nav.pdoc > div > ul > li{padding-left:0;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--code);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc section{margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.pdoc details{filter:opacity(1);}.pdoc details:not([open]){height:0;}.pdoc details > summary{position:absolute;top:-35px;right:0;font-size:.75rem;color:var(--muted);padding:0 .7em;user-select:none;cursor:pointer;}.pdoc details > summary:focus{outline:0;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc > section:first-of-type > .docstring{margin-bottom:2.5rem;}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc .headerlink{position:absolute;width:0;margin-left:-1.5rem;line-height:1.4rem;font-size:1.5rem;font-weight:normal;transition:all 100ms ease-in-out;opacity:0;user-select:none;}.pdoc .attr > .headerlink{margin-left:-2.5rem;}.pdoc *:hover > .headerlink,.pdoc *:target > .attr > .headerlink{opacity:1;}.pdoc .attr{display:block;color:var(--text);margin:.5rem 0 .5rem;padding:.4rem 5rem .4rem 1rem;background-color:var(--accent);}.pdoc .classattr{margin-left:2rem;}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{white-space:pre-wrap;}.pdoc .annotation{color:var(--annotation);}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../pyppms.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;pyppms</a>


            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



        <h2>API Documentation</h2>
            <ul class="memberlist">
            <li>
                    <a class="class" href="#PpmsConnection">PpmsConnection</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#PpmsConnection.__init__">PpmsConnection</a>
                        </li>
                        <li>
                                <a class="function" href="#PpmsConnection.request">request</a>
                        </li>
                        <li>
                                <a class="function" href="#PpmsConnection.new_user">new_user</a>
                        </li>
                        <li>
                                <a class="function" href="#PpmsConnection.get_user_ids">get_user_ids</a>
                        </li>
                        <li>
                                <a class="function" href="#PpmsConnection.get_user_dict">get_user_dict</a>
                        </li>
                        <li>
                                <a class="function" href="#PpmsConnection.get_user">get_user</a>
                        </li>
                        <li>
                                <a class="function" href="#PpmsConnection.user_exists">user_exists</a>
                        </li>
                        <li>
                                <a class="function" href="#PpmsConnection.get_users">get_users</a>
                        </li>
                        <li>
                                <a class="function" href="#PpmsConnection.update_users">update_users</a>
                        </li>
                        <li>
                                <a class="function" href="#PpmsConnection.get_admins">get_admins</a>
                        </li>
                        <li>
                                <a class="function" href="#PpmsConnection.get_groups">get_groups</a>
                        </li>
                        <li>
                                <a class="function" href="#PpmsConnection.get_group">get_group</a>
                        </li>
                        <li>
                                <a class="function" href="#PpmsConnection.get_group_users">get_group_users</a>
                        </li>
                        <li>
                                <a class="function" href="#PpmsConnection.get_user_experience">get_user_experience</a>
                        </li>
                        <li>
                                <a class="function" href="#PpmsConnection.get_users_emails">get_users_emails</a>
                        </li>
                        <li>
                                <a class="function" href="#PpmsConnection.get_systems">get_systems</a>
                        </li>
                        <li>
                                <a class="function" href="#PpmsConnection.update_systems">update_systems</a>
                        </li>
                        <li>
                                <a class="function" href="#PpmsConnection.get_systems_matching">get_systems_matching</a>
                        </li>
                        <li>
                                <a class="function" href="#PpmsConnection.get_users_with_access_to_system">get_users_with_access_to_system</a>
                        </li>
                        <li>
                                <a class="function" href="#PpmsConnection.set_system_booking_permissions">set_system_booking_permissions</a>
                        </li>
                        <li>
                                <a class="function" href="#PpmsConnection.give_user_access_to_system">give_user_access_to_system</a>
                        </li>
                        <li>
                                <a class="function" href="#PpmsConnection.remove_user_access_from_system">remove_user_access_from_system</a>
                        </li>
                        <li>
                                <a class="function" href="#PpmsConnection.get_booking">get_booking</a>
                        </li>
                        <li>
                                <a class="function" href="#PpmsConnection.get_current_booking">get_current_booking</a>
                        </li>
                        <li>
                                <a class="function" href="#PpmsConnection.get_next_booking">get_next_booking</a>
                        </li>
                        <li>
                                <a class="function" href="#PpmsConnection.get_running_sheet">get_running_sheet</a>
                        </li>
                        <li>
                                <a class="function" href="#PpmsConnection.get_bookable_ids">get_bookable_ids</a>
                        </li>
                        <li>
                                <a class="function" href="#PpmsConnection.get_system">get_system</a>
                        </li>
                </ul>

            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section>
                    <h1 class="modulename">
<a href="./../pyppms.html">pyppms</a><wbr>.ppms    </h1>

                        <div class="docstring"><p>Core connection module for the PUMAPI communication.</p>
</div>

                        <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="sd">&quot;&quot;&quot;Core connection module for the PUMAPI communication.&quot;&quot;&quot;</span>

<span class="c1"># pylint: disable-msg=dangerous-default-value</span>

<span class="c1"># NOTE: the &quot;pyppms&quot; package is simply a wrapper for the existing API, so we can&#39;t make</span>
<span class="c1">#       any design decisions here - hence it is pointless to complain about the number</span>
<span class="c1">#       of instance attributes, public methods or other stuff:</span>
<span class="c1"># pylint: disable-msg=too-many-instance-attributes</span>
<span class="c1"># pylint: disable-msg=too-many-public-methods</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">os.path</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="nb">open</span>

<span class="kn">import</span> <span class="nn">requests</span>

<span class="kn">from</span> <span class="nn">.common</span> <span class="kn">import</span> <span class="n">dict_from_single_response</span><span class="p">,</span> <span class="n">parse_multiline_response</span>
<span class="kn">from</span> <span class="nn">.user</span> <span class="kn">import</span> <span class="n">PpmsUser</span>
<span class="kn">from</span> <span class="nn">.system</span> <span class="kn">import</span> <span class="n">PpmsSystem</span>
<span class="kn">from</span> <span class="nn">.booking</span> <span class="kn">import</span> <span class="n">PpmsBooking</span>


<span class="n">LOG</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">PpmsConnection</span><span class="p">:</span>

    <span class="sd">&quot;&quot;&quot;Connection object to communicate with a PPMS instance.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    url : str</span>
<span class="sd">        The URL of the PUMAPI instance.</span>
<span class="sd">    api_key : str</span>
<span class="sd">        The API key used for authenticating against the PUMAPI.</span>
<span class="sd">    timeout : float</span>
<span class="sd">        The timeout value used in the ``requests.post`` calls.</span>
<span class="sd">    cache_path : str</span>
<span class="sd">        A path to a local directory used for caching responses.</span>
<span class="sd">    users : dict</span>
<span class="sd">        A dict with usernames as keys, mapping to the related</span>
<span class="sd">        :py:class:`pyppms.user.PpmsUser` object, serves as a cache during the object&#39;s</span>
<span class="sd">        lifetime (can be empty if no calls to :py:meth:`get_user()` have been done yet).</span>
<span class="sd">    fullname_mapping : dict</span>
<span class="sd">        A dict mapping a user&#39;s *fullname* (&quot;``&lt;LASTNAME&gt; &lt;FIRSTNAME&gt;``&quot;) to the</span>
<span class="sd">        corresponding username. Entries are filled in dynamically by the</span>
<span class="sd">        :py:meth:`get_user()` method.</span>
<span class="sd">    systems</span>
<span class="sd">        A dict with system IDs as keys, mapping to the related</span>
<span class="sd">        :py:class:`pyppms.system.PpmsSystem` object. Serves as a cache during the</span>
<span class="sd">        object&#39;s lifetime (can be empty if no calls to the :py:meth:`get_systems()` have</span>
<span class="sd">        been done yet).</span>
<span class="sd">    status : dict</span>
<span class="sd">        A dict with keys ``auth_state``, ``auth_response`` and</span>
<span class="sd">        ``auth_httpstatus``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># TODO: all methods returning a list of user objects (get_group_users,</span>
    <span class="c1"># get_admins, ...) should be refactored to return a dict with those objects</span>
    <span class="c1"># instead, having the username (&#39;login&#39;) as the key.</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">api_key</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Constructor for the PPMS connection object.</span>

<span class="sd">        Open a connection to the PUMAPI defined in `url` and try to authenticate</span>
<span class="sd">        against it using the given API key (or use cache-only mode if key is an</span>
<span class="sd">        empty string). If an optional path to a caching location is specified,</span>
<span class="sd">        responses will be read from that location unless no matching file can be</span>
<span class="sd">        found there, in which case an on-line request will be done (with the</span>
<span class="sd">        response being saved to the cache path).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        url : str</span>
<span class="sd">            The URL of the PUMAPI to connect to.</span>
<span class="sd">        api_key : str</span>
<span class="sd">            The API key to use for authenticating against the PUMAPI. If</span>
<span class="sd">            specified as &#39;&#39; authentication will be skipped and the connection is</span>
<span class="sd">            running in cache-only (local) mode.</span>
<span class="sd">        timeout : float, optional</span>
<span class="sd">            How many seconds to wait for the PUMAPI server to send a response</span>
<span class="sd">            before giving up, by default 10.</span>
<span class="sd">        cache : str, optional</span>
<span class="sd">            A path to a local directory for caching responses from PUMAPI in</span>
<span class="sd">            individual text files. Useful for testing and for speeding up</span>
<span class="sd">            slow requests like &#39;getusers&#39;. By default empty, which will result</span>
<span class="sd">            in no caching being done.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        requests.exceptions.ConnectionError</span>
<span class="sd">            Raised in case authentication fails.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">url</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">api_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">users</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fullname_mapping</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">systems</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;auth_state&quot;</span><span class="p">:</span> <span class="s2">&quot;NOT_TRIED&quot;</span><span class="p">,</span>
            <span class="s2">&quot;auth_response&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;auth_httpstatus&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache_path</span> <span class="o">=</span> <span class="n">cache</span>

        <span class="c1"># run in cache-only mode (e.g. for testing or off-line usage) if no API</span>
        <span class="c1"># key has been specified, skip authentication then:</span>
        <span class="k">if</span> <span class="n">api_key</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__authenticate</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">cache</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;Neither API key nor cache path given, at least one is required!&quot;</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__authenticate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Try to authenticate to PPMS using the `auth` request.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        requests.exceptions.ConnectionError</span>
<span class="sd">            Raised in case authentication failed for any reason.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;Attempting authentication against </span><span class="si">%s</span><span class="s2"> with key [</span><span class="si">%s</span><span class="s2">...</span><span class="si">%s</span><span class="s2">]&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">api_key</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">api_key</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:],</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s2">&quot;auth_state&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;attempting&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;auth&quot;</span><span class="p">)</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Authenticate response: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s2">&quot;auth_response&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s2">&quot;auth_httpstatus&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span>

        <span class="c1"># NOTE: an unauthorized request has already been caught be the request() method</span>
        <span class="c1"># above. Our legacy code was additionally testing for &#39;error&#39; in the response</span>
        <span class="c1"># text - however, it is unclear if PUMAPI ever returns this:</span>
        <span class="k">if</span> <span class="s2">&quot;error&quot;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s2">&quot;auth_state&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;FAILED-ERROR&quot;</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Authentication failed with an error: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ConnectionError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">status_ok</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">codes</span><span class="o">.</span><span class="n">ok</span>  <span class="c1"># pylint: disable-msg=no-member</span>

        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="n">status_ok</span><span class="p">:</span>
            <span class="c1"># NOTE: branch excluded from coverage as we don&#39;t have a known way</span>
            <span class="c1"># to produce such a response from the API</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Unexpected combination of response [</span><span class="si">%s</span><span class="s2">] and status code [</span><span class="si">%s</span><span class="s2">], it&#39;s &quot;</span>
                <span class="s2">&quot;unclear if authentication succeeded (assuming it didn&#39;t)&quot;</span><span class="p">,</span>
                <span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span>
                <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s2">&quot;auth_state&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;FAILED-UNKNOWN&quot;</span>

            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Authenticating against </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="si">}</span><span class="s2"> with key &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">api_key</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">...</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">api_key</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span><span class="si">}</span><span class="s2">] FAILED!&quot;</span>
            <span class="p">)</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ConnectionError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Authentication succeeded, response=[</span><span class="si">%s</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;HTTP Status: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s2">&quot;auth_state&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;good&quot;</span>

    <span class="k">def</span> <span class="nf">request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="p">{},</span> <span class="n">skip_cache</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generic method to submit a request to PPMS and return the result.</span>

<span class="sd">        This convenience method deals with adding the API key to a given</span>
<span class="sd">        request, submitting it to the PUMAPI and checking the response for some</span>
<span class="sd">        specific keywords indicating an error.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        action : str</span>
<span class="sd">            The command to be submitted to the PUMAPI.</span>
<span class="sd">        parameters : dict, optional</span>
<span class="sd">            A dictionary with additional parameters to be submitted with the</span>
<span class="sd">            request.</span>
<span class="sd">        skip_cache : bool, optional</span>
<span class="sd">            If set to True the request will NOT be served from the local cache,</span>
<span class="sd">            independent whether a matching response file exists there, by</span>
<span class="sd">            default False.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        requests.Response</span>
<span class="sd">            The response object created by posting the request.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        requests.exceptions.ConnectionError</span>
<span class="sd">            Raised in case the request is not authorized.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">req_data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">action</span><span class="p">,</span> <span class="s2">&quot;apikey&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">api_key</span><span class="p">}</span>
        <span class="n">req_data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span>
        <span class="c1"># LOG.debug(&quot;Request parameters: %s&quot;, parameters)</span>

        <span class="n">response</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">read_from_cache</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">skip_cache</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                <span class="k">raise</span> <span class="ne">LookupError</span><span class="p">(</span><span class="s2">&quot;Skipping the cache has been requested&quot;</span><span class="p">)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__intercept_read</span><span class="p">(</span><span class="n">req_data</span><span class="p">)</span>
            <span class="n">read_from_cache</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">LookupError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Doing an on-line request: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">req_data</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>

        <span class="c1"># store the response if it hasn&#39;t been read from the cache before:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">read_from_cache</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__intercept_store</span><span class="p">(</span><span class="n">req_data</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>

        <span class="c1"># NOTE: the HTTP status code returned is always `200` even if</span>
        <span class="c1"># authentication failed, so we need to check the actual response *TEXT*</span>
        <span class="c1"># to figure out if we have succeeded:</span>
        <span class="k">if</span> <span class="s2">&quot;request not authorized&quot;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s2">&quot;auth_state&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;FAILED&quot;</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Not authorized to run action `</span><span class="si">{</span><span class="n">req_data</span><span class="p">[</span><span class="s1">&#39;action&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">`&quot;</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ConnectionError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">response</span>

    <span class="k">def</span> <span class="nf">__interception_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req_data</span><span class="p">,</span> <span class="n">create_dir</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Derive the path for a local cache file from a request&#39;s parameters.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        req_data : dict</span>
<span class="sd">            The request&#39;s parameters, used to derive the name of the cache file.</span>
<span class="sd">        create_dir : bool, optional</span>
<span class="sd">            If set to True the cache directory will be created if necessary.</span>
<span class="sd">            Useful when adding responses to the cache. By default False.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">            The full path to a file name identified by all parameters of the</span>
<span class="sd">            request (except credentials like &#39;apikey&#39;).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">action</span> <span class="o">=</span> <span class="n">req_data</span><span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">]</span>
        <span class="n">intercept_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_path</span><span class="p">,</span> <span class="n">action</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">create_dir</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">intercept_dir</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">intercept_dir</span><span class="p">)</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Created dir to store response: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">intercept_dir</span><span class="p">)</span>

        <span class="n">signature</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="c1"># different python versions are returning dict items in different order, so</span>
        <span class="c1"># simply iterating over them will not always produce the same result - hence we</span>
        <span class="c1"># build up a sorted list of keys first and use that one then:</span>
        <span class="n">keylist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">req_data</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">keylist</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keylist</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">,</span> <span class="s2">&quot;apikey&quot;</span><span class="p">]:</span>
                <span class="k">continue</span>
            <span class="n">signature</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;__</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">--</span><span class="si">{</span><span class="n">req_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">signature</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">signature</span> <span class="o">=</span> <span class="s2">&quot;__response&quot;</span>
        <span class="n">signature</span> <span class="o">=</span> <span class="n">signature</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span> <span class="o">+</span> <span class="s2">&quot;.txt&quot;</span>
        <span class="n">intercept_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">intercept_dir</span><span class="p">,</span> <span class="n">signature</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">intercept_file</span>

    <span class="k">def</span> <span class="nf">__intercept_read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req_data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Try to read a cached response from a local file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        req_data : dict</span>
<span class="sd">            The request&#39;s parameters, used to derive the name of the cache file.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        PseudoResponse</span>
<span class="sd">            The response text read from the cache file wrapped in a</span>
<span class="sd">            PseudoResponse object, or None in case no matching file was found in</span>
<span class="sd">            the local cache.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        LookupError</span>
<span class="sd">            Raised in case no cache path has been set or no cache file matching</span>
<span class="sd">            the request parameters could be found in the cache.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># pylint: disable-msg=too-few-public-methods</span>
        <span class="k">class</span> <span class="nc">PseudoResponse</span><span class="p">:</span>
            <span class="sd">&quot;&quot;&quot;Dummy response object with attribs &#39;text&#39; and &#39;status_code&#39;.&quot;&quot;&quot;</span>

            <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">status_code</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">text</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">status_code</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_path</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">LookupError</span><span class="p">(</span><span class="s2">&quot;No cache path configured&quot;</span><span class="p">)</span>

        <span class="n">intercept_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__interception_path</span><span class="p">(</span><span class="n">req_data</span><span class="p">,</span> <span class="n">create_dir</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">intercept_file</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
            <span class="k">raise</span> <span class="ne">LookupError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No cache hit for [</span><span class="si">{</span><span class="n">intercept_file</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">intercept_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">infile</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">infile</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Read intercepted response text from [</span><span class="si">%s</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="n">intercept_file</span><span class="p">)</span>

        <span class="n">status_code</span> <span class="o">=</span> <span class="mi">200</span>
        <span class="n">status_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">intercept_file</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_status-code.txt&quot;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">status_file</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">status_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">infile</span><span class="p">:</span>
                <span class="n">status_code</span> <span class="o">=</span> <span class="n">infile</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Read intercepted response status code from [</span><span class="si">%s</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="n">status_file</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">PseudoResponse</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">status_code</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__intercept_store</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req_data</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
        <span class="sd">&quot;&quot;&quot;Store the response in a local cache file named after the request.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        req_data : dict</span>
<span class="sd">            The request&#39;s parameters, used to derive the name of the cache file</span>
<span class="sd">            so it can be matched later when running the same request again.</span>
<span class="sd">        response : requests.Response</span>
<span class="sd">            The response object to store in the local cache.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># NOTE: this method is excluded from coverage measurements as it can only be</span>
        <span class="c1"># triggered when testing in online mode with at least one request not being</span>
        <span class="c1"># served from the cache (which is orthogonal to off-line testing)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_path</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">intercept_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__interception_path</span><span class="p">(</span><span class="n">req_data</span><span class="p">,</span> <span class="n">create_dir</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">intercept_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outfile</span><span class="p">:</span>
                <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;Wrote response text to [</span><span class="si">%s</span><span class="s2">] (</span><span class="si">%s</span><span class="s2"> lines)&quot;</span><span class="p">,</span>
                <span class="n">intercept_file</span><span class="p">,</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()),</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>  <span class="c1"># pylint: disable-msg=broad-except</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Storing response text in [</span><span class="si">%s</span><span class="s2">] failed: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">intercept_file</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Response text was:</span><span class="se">\n</span><span class="s2">--------</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="s2">--------&quot;</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>

    <span class="c1">############ users / groups ############</span>

    <span class="k">def</span> <span class="nf">new_user</span><span class="p">(</span>  <span class="c1"># pylint: disable-msg=too-many-arguments</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">login</span><span class="p">,</span> <span class="n">lname</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">ppms_group</span><span class="p">,</span> <span class="n">phone</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a new user in PPMS.</span>

<span class="sd">        The method is asking PPMS to create a new user account with the given details.</span>
<span class="sd">        In case an account with that login name already exists, it will log a warning</span>
<span class="sd">        and return without sending any further requests to PPMS.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        login : str</span>
<span class="sd">            The unique identifier for the user.</span>
<span class="sd">        lname : str</span>
<span class="sd">            The last name of the user.</span>
<span class="sd">        fname : str</span>
<span class="sd">            The first name of the user.</span>
<span class="sd">        email : str</span>
<span class="sd">            The email address of the user.</span>
<span class="sd">        ppms_group : str</span>
<span class="sd">            The unique identifier of the primary group of the new user. A new group will</span>
<span class="sd">            be created if no group with the given name exists.</span>
<span class="sd">        phone : str, optional</span>
<span class="sd">            The phone number of the user.</span>
<span class="sd">        password : str, optional</span>
<span class="sd">            The password for the user. If no password is set the user will not be able</span>
<span class="sd">            to log on to PPMS.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        RuntimeError</span>
<span class="sd">            Will be raised in case creating the user fails.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_exists</span><span class="p">(</span><span class="n">login</span><span class="p">):</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;NOT creating user [</span><span class="si">%s</span><span class="s2">] as it already exists!&quot;</span><span class="p">,</span> <span class="n">login</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">req_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;login&quot;</span><span class="p">:</span> <span class="n">login</span><span class="p">,</span>
            <span class="s2">&quot;lname&quot;</span><span class="p">:</span> <span class="n">lname</span><span class="p">,</span>
            <span class="s2">&quot;fname&quot;</span><span class="p">:</span> <span class="n">fname</span><span class="p">,</span>
            <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="n">email</span><span class="p">,</span>
            <span class="s2">&quot;unitlogin&quot;</span><span class="p">:</span> <span class="n">ppms_group</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">phone</span><span class="p">:</span>
            <span class="n">req_data</span><span class="p">[</span><span class="s2">&quot;phone&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">phone</span>
        <span class="k">if</span> <span class="n">password</span><span class="p">:</span>
            <span class="n">req_data</span><span class="p">[</span><span class="s2">&quot;pwd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">password</span>

        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;newuser&quot;</span><span class="p">,</span> <span class="n">req_data</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;OK newuser&quot;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Creating new user failed: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Created user [</span><span class="si">%s</span><span class="s2">] in PPMS.&quot;</span><span class="p">,</span> <span class="n">login</span><span class="p">)</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Response was: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_user_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get a list with all user IDs in the PPMS system.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        active : bool, optional</span>
<span class="sd">            Request only users marked as active in PPMS, by default False.</span>
<span class="sd">            NOTE: &quot;active&quot; is a tri-state parameter in PPMS: &quot;true&quot;, &quot;false&quot;</span>
<span class="sd">            or empty!</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list</span>
<span class="sd">            A list of all (or active-only) user IDs in PPMS.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: describe format of returned list and / or give an example!</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">active</span><span class="p">:</span>
            <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;active&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;true&quot;</span>

        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;getusers&quot;</span><span class="p">,</span> <span class="n">parameters</span><span class="p">)</span>

        <span class="n">users</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
        <span class="n">active_desc</span> <span class="o">=</span> <span class="s2">&quot;active &quot;</span> <span class="k">if</span> <span class="n">active</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">users in the PPMS database&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">users</span><span class="p">),</span> <span class="n">active_desc</span><span class="p">)</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">users</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">users</span>

    <span class="k">def</span> <span class="nf">get_user_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">login_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get details on a given user from PPMS.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        login_name : str</span>
<span class="sd">            The PPMS account / login name of the user to query.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            A dict with the user details returned by the PUMAPI.</span>

<span class="sd">        Example</span>
<span class="sd">        -------</span>
<span class="sd">        &gt;&gt;&gt; conn.get_user_dict(&#39;pyppms&#39;)</span>
<span class="sd">        ... {</span>
<span class="sd">        ...     u&#39;active&#39;: True,</span>
<span class="sd">        ...     u&#39;affiliation&#39;: u&#39;&#39;,</span>
<span class="sd">        ...     u&#39;bcode&#39;: u&#39;&#39;,</span>
<span class="sd">        ...     u&#39;email&#39;: u&#39;pyppms@python-facility.example&#39;,</span>
<span class="sd">        ...     u&#39;fname&#39;: u&#39;PumAPI&#39;,</span>
<span class="sd">        ...     u&#39;lname&#39;: u&#39;Python&#39;,</span>
<span class="sd">        ...     u&#39;login&#39;: u&#39;pyppms&#39;,</span>
<span class="sd">        ...     u&#39;mustchbcode&#39;: False,</span>
<span class="sd">        ...     u&#39;mustchpwd&#39;: False&#39;,</span>
<span class="sd">        ...     u&#39;phone&#39;: u&#39;+98 (76) 54 3210&#39;,</span>
<span class="sd">        ...     u&#39;unitlogin&#39;: u&#39;pyppms&#39;</span>
<span class="sd">        ... }</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        KeyError</span>
<span class="sd">            Raised in case the user account is unknown to PPMS.</span>
<span class="sd">        ValueError</span>
<span class="sd">            Raised if the user details can&#39;t be parsed from the PUMAPI response.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;getuser&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;login&quot;</span><span class="p">:</span> <span class="n">login_name</span><span class="p">})</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;User [</span><span class="si">{</span><span class="n">login_name</span><span class="si">}</span><span class="s2">] is unknown to PPMS&quot;</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># EXAMPLE:</span>
        <span class="c1"># response.text = (</span>
        <span class="c1">#     u&#39;login,lname,fname,email,&#39;</span>
        <span class="c1">#     u&#39;phone,bcode,affiliation,unitlogin,mustchpwd,mustchbcode,&#39;</span>
        <span class="c1">#     u&#39;active\r\n&#39;</span>
        <span class="c1">#     u&#39;&quot;pyppms&quot;,&quot;Python&quot;,&quot;PumAPI&quot;,&quot;pyppms@python-facility.example&quot;,&#39;</span>
        <span class="c1">#     u&#39;&quot;+98 (76) 54 3210&quot;,&quot;&quot;,&quot;&quot;,&quot;pyppms&quot;,false,false,&#39;</span>
        <span class="c1">#     u&#39;true\r\n&#39;</span>
        <span class="c1"># )</span>
        <span class="n">details</span> <span class="o">=</span> <span class="n">dict_from_single_response</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Details for user [</span><span class="si">%s</span><span class="s2">]: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">login_name</span><span class="p">,</span> <span class="n">details</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">details</span>

    <span class="k">def</span> <span class="nf">get_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">login_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fetch user details from PPMS and create a PpmsUser object from it.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        login_name : str</span>
<span class="sd">            The user&#39;s PPMS login name.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        PpmsUser</span>
<span class="sd">            The user object created from the PUMAPI response. The object will be</span>
<span class="sd">            additionally stored in the self.users dict using the login_name as</span>
<span class="sd">            the dict&#39;s key.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        KeyError</span>
<span class="sd">            Raised if the user doesn&#39;t exist in PPMS.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;getuser&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;login&quot;</span><span class="p">:</span> <span class="n">login_name</span><span class="p">})</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;User [</span><span class="si">{</span><span class="n">login_name</span><span class="si">}</span><span class="s2">] is unknown to PPMS&quot;</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">user</span> <span class="o">=</span> <span class="n">PpmsUser</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="p">[</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">]</span> <span class="o">=</span> <span class="n">user</span>  <span class="c1"># update / add to the cached user objs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fullname_mapping</span><span class="p">[</span><span class="n">user</span><span class="o">.</span><span class="n">fullname</span><span class="p">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span>
        <span class="k">return</span> <span class="n">user</span>

    <span class="k">def</span> <span class="nf">user_exists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">login</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check if an account with the given login name already exists in PPMS.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        login : str</span>
<span class="sd">            The login name to check for.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            True in case an account with that name exists in PPMS, false otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="n">login</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">get_users</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force_refresh</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get user objects for all (or cached) PPMS users.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        force_refresh : bool, optional</span>
<span class="sd">            Re-request information from PPMS even if user details have been</span>
<span class="sd">            cached locally before, by default False.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict(PpmsUser)</span>
<span class="sd">            A dict of PpmsUser objects with the username (login) as key.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">users</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">force_refresh</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Using cached details for </span><span class="si">%s</span><span class="s2"> users&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_users</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">users</span>

    <span class="k">def</span> <span class="nf">update_users</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_ids</span><span class="o">=</span><span class="p">[]):</span>
        <span class="sd">&quot;&quot;&quot;Update cached details for a list of users from PPMS.</span>

<span class="sd">        Get the user details on a list of users (or all active ones) from PPMS and store</span>
<span class="sd">        them in the object&#39;s `users` dict. As a side effect, this will also fill the</span>
<span class="sd">        cache directory in case the object&#39;s `cache_path` attribute is set.</span>

<span class="sd">        WARNING - very slow, especially when the PPMS instance has many users!</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        user_ids : list(str), optional</span>
<span class="sd">            A list of user IDs (login names) to request the cache for, by</span>
<span class="sd">            default [] which will result in all *active* users to be requested.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">user_ids</span><span class="p">:</span>
            <span class="n">user_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_ids</span><span class="p">(</span><span class="n">active</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Updating details on </span><span class="si">%s</span><span class="s2"> users&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">user_ids</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">user_id</span> <span class="ow">in</span> <span class="n">user_ids</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>

        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Collected details on </span><span class="si">%s</span><span class="s2"> users&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">get_admins</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get all PPMS administrator users.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list(PpmsUser)</span>
<span class="sd">            A list with PpmsUser objects that are PPMS administrators.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;getadmins&quot;</span><span class="p">)</span>

        <span class="n">admins</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
        <span class="n">users</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">username</span> <span class="ow">in</span> <span class="n">admins</span><span class="p">:</span>
            <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
            <span class="n">users</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> admins in the PPMS database: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">admins</span><span class="p">),</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">admins</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">users</span>

    <span class="k">def</span> <span class="nf">get_groups</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get a list of all groups in PPMS.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list(str)</span>
<span class="sd">            A list with the group identifiers in PPMS.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;getgroups&quot;</span><span class="p">)</span>

        <span class="n">groups</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> groups in the PPMS database: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">groups</span><span class="p">),</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">groups</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">groups</span>

    <span class="k">def</span> <span class="nf">get_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fetch group details from PPMS and create a dict from them.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        group_id : str</span>
<span class="sd">            The group&#39;s identifier in PPMS, called &#39;unitlogin&#39; there.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            A dict with the group details, keys being derived from the header</span>
<span class="sd">            line of the PUMAPI response, values from the data line.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;getgroup&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;unitlogin&quot;</span><span class="p">:</span> <span class="n">group_id</span><span class="p">})</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Group details returned by PPMS (raw): </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Group [</span><span class="si">{</span><span class="n">group_id</span><span class="si">}</span><span class="s2">] is unknown to PPMS&quot;</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">details</span> <span class="o">=</span> <span class="n">dict_from_single_response</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>

        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Details of group </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">group_id</span><span class="p">,</span> <span class="n">details</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">details</span>

    <span class="k">def</span> <span class="nf">get_group_users</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unitlogin</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get all members of a group in PPMS.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        unitlogin : str</span>
<span class="sd">            The group&#39;s login (&quot;unique login or id&quot; in the PPMS web interface).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list(PpmsUser)</span>
<span class="sd">            A list with PpmsUser objects that are members of this PPMS group.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;getgroupusers&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;unitlogin&quot;</span><span class="p">:</span> <span class="n">unitlogin</span><span class="p">})</span>

        <span class="n">members</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
        <span class="n">users</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">username</span> <span class="ow">in</span> <span class="n">members</span><span class="p">:</span>
            <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
            <span class="n">users</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> members in PPMS group [</span><span class="si">%s</span><span class="s2">]: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">members</span><span class="p">),</span>
            <span class="n">unitlogin</span><span class="p">,</span>
            <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">members</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">users</span>

    <span class="k">def</span> <span class="nf">get_user_experience</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">login</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">system_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get user experience (&quot;User rights&quot;) from PPMS.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        login : str, optional</span>
<span class="sd">            An optional login name to request the experience / permissions for,</span>
<span class="sd">            by default None</span>
<span class="sd">        system_id : int, optional</span>
<span class="sd">            An optional system ID to request the experience / permissions for,</span>
<span class="sd">            by default None</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list(dict)</span>
<span class="sd">            A list with dicts parsed from the user experience response.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">login</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;login&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">login</span>
        <span class="k">if</span> <span class="n">system_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">system_id</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;getuserexp&quot;</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>

        <span class="n">parsed</span> <span class="o">=</span> <span class="n">parse_multiline_response</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;Received </span><span class="si">%s</span><span class="s2"> experience entries for filters [user:</span><span class="si">%s</span><span class="s2">] and [id:</span><span class="si">%s</span><span class="s2">]&quot;</span><span class="p">,</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">parsed</span><span class="p">),</span>
            <span class="n">login</span><span class="p">,</span>
            <span class="n">system_id</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">parsed</span>

    <span class="k">def</span> <span class="nf">get_users_emails</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">users</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get a list of user email addresses. WARNING - very slow!</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        users : list(str), optional</span>
<span class="sd">            A list of login names to retrieve the email addresses for, if</span>
<span class="sd">            omitted addresses for all (or active ones) will be requested.</span>
<span class="sd">        active : bool, optional</span>
<span class="sd">            Request only addresses of users marked as active in PPMS, by default</span>
<span class="sd">            False. Will be ignored if a list of usernames is given explicitly.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list(str)</span>
<span class="sd">            Email addresses of the users requested.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">emails</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">users</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">users</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_ids</span><span class="p">(</span><span class="n">active</span><span class="o">=</span><span class="n">active</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">users</span><span class="p">:</span>
            <span class="n">email</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_dict</span><span class="p">(</span><span class="n">user</span><span class="p">)[</span><span class="s2">&quot;email&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">email</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;--- WARNING: no email for user [</span><span class="si">%s</span><span class="s2">]! ---&quot;</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="c1"># LOG.debug(&quot;%s: %s&quot;, user, email)</span>
            <span class="n">emails</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">emails</span>

    <span class="c1">############ resources ############</span>

    <span class="k">def</span> <span class="nf">get_systems</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force_refresh</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get a dict with all systems in PPMS.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict(pyppms.system.PpmsSystem)</span>
<span class="sd">            A dict with `PpmsSystem` objects parsed from the PUMAPI response where</span>
<span class="sd">            the system ID (int) is used as the dict&#39;s key. If parsing a system</span>
<span class="sd">            fails for any reason, the system is skipped entirely.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">systems</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">force_refresh</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Using cached details for </span><span class="si">%s</span><span class="s2"> systems&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">systems</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_systems</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">systems</span>

    <span class="k">def</span> <span class="nf">update_systems</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update cached details for all bookable systems from PPMS.</span>

<span class="sd">        Get the details on all bookable systems from PPMS and store them in the local</span>
<span class="sd">        cache. If parsing the PUMAPI response for a system fails for any reason, the</span>
<span class="sd">        system is skipped entirely.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Updating list of bookable systems...&quot;</span><span class="p">)</span>
        <span class="n">systems</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">parse_fails</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;getsystems&quot;</span><span class="p">)</span>
        <span class="n">details</span> <span class="o">=</span> <span class="n">parse_multiline_response</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">graceful</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">detail</span> <span class="ow">in</span> <span class="n">details</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">system</span> <span class="o">=</span> <span class="n">PpmsSystem</span><span class="p">(</span><span class="n">detail</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error processing `getsystems` response: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
                <span class="n">parse_fails</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">continue</span>

            <span class="n">systems</span><span class="p">[</span><span class="n">system</span><span class="o">.</span><span class="n">system_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">system</span>

        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;Updated </span><span class="si">%s</span><span class="s2"> bookable systems from PPMS (</span><span class="si">%s</span><span class="s2"> systems failed parsing)&quot;</span><span class="p">,</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">systems</span><span class="p">),</span>
            <span class="n">parse_fails</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">systems</span> <span class="o">=</span> <span class="n">systems</span>

    <span class="k">def</span> <span class="nf">get_systems_matching</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">localisation</span><span class="p">,</span> <span class="n">name_contains</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Query PPMS for systems with a specific location and name.</span>

<span class="sd">        This method assembles a list of PPMS system IDs whose &quot;localisation&quot;</span>
<span class="sd">        (room) field matches a given string and where the system name contains</span>
<span class="sd">        at least one of the strings given as the `name_contains` parameter.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        localisation : str</span>
<span class="sd">            A string that the system&#39;s &quot;localisation&quot; (i.e. the &quot;Room&quot; field in</span>
<span class="sd">            the PPMS web interface) has to match.</span>
<span class="sd">        name_contains : list(str)</span>
<span class="sd">            A list of valid names (categories) of which the system&#39;s name has to</span>
<span class="sd">            match at least one for being included. Supply an empty list for</span>
<span class="sd">            skipping this filter.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list(int)</span>
<span class="sd">            A list with PPMS system IDs matching all of the given criteria.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">loc</span> <span class="o">=</span> <span class="n">localisation</span>
        <span class="n">loc_desc</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;with location matching [</span><span class="si">{</span><span class="n">localisation</span><span class="si">}</span><span class="s2">]&quot;</span>
        <span class="k">if</span> <span class="n">localisation</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">loc_desc</span> <span class="o">=</span> <span class="s2">&quot;(no location filter given)&quot;</span>

        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Querying PPMS for systems </span><span class="si">%s</span><span class="s2">, name matching any of </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">loc_desc</span><span class="p">,</span>
            <span class="n">name_contains</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">system_ids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">systems</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_systems</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">sys_id</span><span class="p">,</span> <span class="n">system</span> <span class="ow">in</span> <span class="n">systems</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">loc</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">system</span><span class="o">.</span><span class="n">localisation</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s2">&quot;System [</span><span class="si">%s</span><span class="s2">] location (</span><span class="si">%s</span><span class="s2">) is NOT matching (</span><span class="si">%s</span><span class="s2">), ignoring&quot;</span><span class="p">,</span>
                    <span class="n">system</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">system</span><span class="o">.</span><span class="n">localisation</span><span class="p">,</span>
                    <span class="n">loc</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># LOG.debug(&#39;System [%s] is matching location [%s], checking if &#39;</span>
            <span class="c1">#           &#39;the name is matching any of the valid pattern %s&#39;,</span>
            <span class="c1">#           system.name, loc, name_contains)</span>
            <span class="k">for</span> <span class="n">valid_name</span> <span class="ow">in</span> <span class="n">name_contains</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">valid_name</span> <span class="ow">in</span> <span class="n">system</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;System [</span><span class="si">%s</span><span class="s2">] matches all criteria&quot;</span><span class="p">,</span> <span class="n">system</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                    <span class="n">system_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sys_id</span><span class="p">)</span>
                    <span class="k">break</span>

            <span class="c1"># if sys_id not in system_ids:</span>
            <span class="c1">#     LOG.debug(&#39;System [%s] does NOT match a valid name: %s&#39;,</span>
            <span class="c1">#               system.name, name_contains)</span>

        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Found </span><span class="si">%s</span><span class="s2"> bookable systems </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">system_ids</span><span class="p">),</span> <span class="n">loc_desc</span><span class="p">)</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;IDs of matching bookable systems </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">loc_desc</span><span class="p">,</span> <span class="n">system_ids</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">system_ids</span>

    <span class="c1">############ system / user permissions ############</span>

    <span class="k">def</span> <span class="nf">get_users_with_access_to_system</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">system_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get a list of usernames allowed to book the system with the given ID.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        system_id : int or int-like</span>
<span class="sd">            The ID of the system to query permitted users for.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list(str)</span>
<span class="sd">            A list of usernames (&#39;login&#39;) with permissions to book the system</span>
<span class="sd">            with the given ID in PPMS.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            Raised in case parsing the response failes for any reason.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">users</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;getsysrights&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">system_id</span><span class="p">})</span>
        <span class="c1"># this response has a unique format, so parse it directly here:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
                <span class="n">permission</span><span class="p">,</span> <span class="n">username</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">permission</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;D&quot;</span><span class="p">:</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="s2">&quot;User [</span><span class="si">%s</span><span class="s2">] is deactivated for booking system [</span><span class="si">%s</span><span class="s2">], skipping&quot;</span><span class="p">,</span>
                        <span class="n">username</span><span class="p">,</span>
                        <span class="n">system_id</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="k">continue</span>

                <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s2">&quot;User [</span><span class="si">%s</span><span class="s2">] has permission to book system [</span><span class="si">%s</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">system_id</span>
                <span class="p">)</span>
                <span class="n">users</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Unable to parse data returned by PUMAPI: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2"> - &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;ERROR: </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">err</span>

        <span class="k">return</span> <span class="n">users</span>

    <span class="k">def</span> <span class="nf">set_system_booking_permissions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">login</span><span class="p">,</span> <span class="n">system_id</span><span class="p">,</span> <span class="n">permission</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set permissions for a user on a given system in PPMS.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        username : str</span>
<span class="sd">            The username (&#39;login&#39;) to allow for booking the system.</span>
<span class="sd">        system_id : int or int-like</span>
<span class="sd">            The ID of the system to add the permission for.</span>
<span class="sd">        permission : {&#39;D&#39;, &#39;A&#39;, &#39;N&#39;, &#39;S&#39;}</span>
<span class="sd">            The permission level to set for the user, one of:</span>
<span class="sd">              - ``D`` : deactivated</span>
<span class="sd">              - ``A`` : autonomous</span>
<span class="sd">              - ``N`` : novice</span>
<span class="sd">              - ``S`` : superuser</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            True in case setting permissions for the given username on the</span>
<span class="sd">            system with the specified ID succeeded (or if the user already had</span>
<span class="sd">            those permissions before), False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">permission_name</span><span class="p">(</span><span class="n">shortname</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Closure to validate a permission level and return its long name.</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            shortname : str</span>
<span class="sd">                A single character defining the permission level.</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            str</span>
<span class="sd">                The long (human-readable) name of the permission level.</span>

<span class="sd">            Raises</span>
<span class="sd">            ------</span>
<span class="sd">            KeyError</span>
<span class="sd">                Raised in case an invalid permission level was given.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">mapping</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;D&quot;</span><span class="p">:</span> <span class="s2">&quot;deactivated&quot;</span><span class="p">,</span>
                <span class="s2">&quot;A&quot;</span><span class="p">:</span> <span class="s2">&quot;autonomous&quot;</span><span class="p">,</span>
                <span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="s2">&quot;novice&quot;</span><span class="p">,</span>
                <span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="s2">&quot;superuser&quot;</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">mapping</span><span class="p">[</span><span class="n">shortname</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid permission [</span><span class="si">{</span><span class="n">shortname</span><span class="si">}</span><span class="s2">] given&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">err</span>

        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;Setting permission level [</span><span class="si">%s</span><span class="s2">] for user [</span><span class="si">%s</span><span class="s2">] on system [</span><span class="si">%s</span><span class="s2">]&quot;</span><span class="p">,</span>
            <span class="n">permission_name</span><span class="p">(</span><span class="n">permission</span><span class="p">),</span>
            <span class="n">login</span><span class="p">,</span>
            <span class="n">system_id</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">parameters</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">system_id</span><span class="p">,</span> <span class="s2">&quot;login&quot;</span><span class="p">:</span> <span class="n">login</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">permission</span><span class="p">}</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;setright&quot;</span><span class="p">,</span> <span class="n">parameters</span><span class="p">)</span>

        <span class="c1"># NOTE: the &#39;setright&#39; action will accept ANY permission type and return &#39;done&#39;</span>
        <span class="c1"># on the request, so there is no way to check from the response if setting the</span>
        <span class="c1"># permission really worked!!</span>
        <span class="c1"># LOG.debug(&#39;Request returned text: %s&#39;, response.text)</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;done&quot;</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;User [</span><span class="si">%s</span><span class="s2">] now has permission level [</span><span class="si">%s</span><span class="s2">] on system [</span><span class="si">%s</span><span class="s2">]&quot;</span><span class="p">,</span>
                <span class="n">login</span><span class="p">,</span>
                <span class="n">permission_name</span><span class="p">(</span><span class="n">permission</span><span class="p">),</span>
                <span class="n">system_id</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="s2">&quot;invalid user&quot;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;User [</span><span class="si">%s</span><span class="s2">] doesn&#39;t seem to exist in PPMS&quot;</span><span class="p">,</span> <span class="n">login</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s2">&quot;system right not authorized&quot;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;Unable to set permissions for system </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">system_id</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Unexpected response, assuming request failed: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">give_user_access_to_system</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">system_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add permissions for a user to book a given system in PPMS.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        username : str</span>
<span class="sd">            The username (&#39;login&#39;) to allow for booking the system.</span>
<span class="sd">        system_id : int or int-like</span>
<span class="sd">            The ID of the system to add the permission for.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            True in case the given username now has the permissions to book the</span>
<span class="sd">            system with the specified ID (or if the user already had them</span>
<span class="sd">            before), False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_system_booking_permissions</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">system_id</span><span class="p">,</span> <span class="s2">&quot;A&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">remove_user_access_from_system</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">system_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove permissions for a user to book a given system in PPMS.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        username : str</span>
<span class="sd">            The username (&#39;login&#39;) to remove booking permissions on the system.</span>
<span class="sd">        system_id : int or int-like</span>
<span class="sd">            The ID of the system to modify the permission for.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            True in case the given username now has the permissions to book the</span>
<span class="sd">            system with the specified ID (or if the user already had them</span>
<span class="sd">            before), False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_system_booking_permissions</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">system_id</span><span class="p">,</span> <span class="s2">&quot;D&quot;</span><span class="p">)</span>

    <span class="c1">############ bookings ############</span>

    <span class="k">def</span> <span class="nf">get_booking</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">system_id</span><span class="p">,</span> <span class="n">booking_type</span><span class="o">=</span><span class="s2">&quot;get&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the current or next booking of a system.</span>

<span class="sd">        WARNING: if the next booking is requested but it is too far in the future,</span>
<span class="sd">        PUMAPI silently ignores it - the response is identical to a system that has no</span>
<span class="sd">        future bookings and there is no error reported either. Currently it is unclear</span>
<span class="sd">        where the cutoff is (e.g. lookups for a booking that is two years from now still</span>
<span class="sd">        work fine, but a booking in about 10 years is silently skipped).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        system_id : int or int-like</span>
<span class="sd">            The ID of the system in PPMS.</span>
<span class="sd">        booking_type : {&#39;get&#39;, &#39;next&#39;}, optional</span>
<span class="sd">            The type of booking to request, one of `get` (requesting the</span>
<span class="sd">            currently running booking) and `next` (requesting the next upcoming</span>
<span class="sd">            booking), by default `get`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        PpmsBooking or None</span>
<span class="sd">            The booking object, or None if there is no booking for the system or the</span>
<span class="sd">            request is refused by PUMAPI (e.g. &quot;not authorized&quot;).</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            Raised if the specified `booking_type` is invalid.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">valid</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;get&quot;</span><span class="p">,</span> <span class="s2">&quot;next&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">booking_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Value for &#39;booking_type&#39; (</span><span class="si">{</span><span class="n">booking_type</span><span class="si">}</span><span class="s2">) not in </span><span class="si">{</span><span class="n">valid</span><span class="si">}</span><span class="s2">!&quot;</span>
            <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">booking_type</span> <span class="o">+</span> <span class="s2">&quot;booking&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">system_id</span><span class="p">})</span>
        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ConnectionError</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Requesting booking status for system </span><span class="si">%s</span><span class="s2"> failed!&quot;</span><span class="p">,</span> <span class="n">system_id</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">desc</span> <span class="o">=</span> <span class="s2">&quot;any future bookings&quot;</span>
        <span class="k">if</span> <span class="n">booking_type</span> <span class="o">==</span> <span class="s2">&quot;get&quot;</span><span class="p">:</span>
            <span class="n">desc</span> <span class="o">=</span> <span class="s2">&quot;a currently active booking&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;System [</span><span class="si">%s</span><span class="s2">] doesn&#39;t have </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">system_id</span><span class="p">,</span> <span class="n">desc</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">PpmsBooking</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">booking_type</span><span class="p">,</span> <span class="n">system_id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_current_booking</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">system_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Wrapper for `get_booking()` with &#39;booking_type&#39; set to &#39;get&#39;.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_booking</span><span class="p">(</span><span class="n">system_id</span><span class="p">,</span> <span class="s2">&quot;get&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_next_booking</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">system_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Wrapper for `get_booking()` with &#39;booking_type&#39; set to &#39;next&#39;.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_booking</span><span class="p">(</span><span class="n">system_id</span><span class="p">,</span> <span class="s2">&quot;next&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_running_sheet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">core_facility_ref</span><span class="p">,</span> <span class="n">date</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the running sheet for a specific day on the given facility.</span>

<span class="sd">        The so-called &quot;running-sheet&quot; consists of all bookings / reservations of</span>
<span class="sd">        a facility on a specifc day.</span>

<span class="sd">        WARNING: PUMAPI doesn&#39;t return a proper unique user identifier with the</span>
<span class="sd">        &#39;getrunningsheet&#39; request, instead the so called &quot;full name&quot; is given to</span>
<span class="sd">        identify the user - unfortunately this can lead to ambiguities as</span>
<span class="sd">        multiple different accounts can have the same full name.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        core_facility_ref : int or int-like</span>
<span class="sd">            The core facility ID for PPMS.</span>
<span class="sd">        date : datetime.datetime</span>
<span class="sd">            The date to request the running sheet for, e.g. ``datetime.now()`` or</span>
<span class="sd">            similar. Note that only the date part is relevant, time will be ignored.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list(pyppms.booking.PpmsBooking)</span>
<span class="sd">            A list with `PpmsBooking` objects for the given day. Empty in case</span>
<span class="sd">            there are no bookings or parsing the response failed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">bookings</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;plateformid&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">core_facility_ref</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;day&quot;</span><span class="p">:</span> <span class="n">date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Requesting runningsheet for </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;day&quot;</span><span class="p">])</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;getrunningsheet&quot;</span><span class="p">,</span> <span class="n">parameters</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">entries</span> <span class="o">=</span> <span class="n">parse_multiline_response</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">graceful</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>  <span class="c1"># pylint: disable-msg=broad-except</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Parsing runningsheet details failed: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
            <span class="c1"># NOTE: in case no future bookings exist the response will be empty!</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Possibly the runningsheet is empty as no bookings exist?&quot;</span><span class="p">)</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Runningsheet PUMPAI response was: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">bookings</span>

        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
            <span class="n">full</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;User&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">full</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fullname_mapping</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Booking for an uncached user (</span><span class="si">%s</span><span class="s2">) found!&quot;</span><span class="p">,</span> <span class="n">full</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">update_users</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">full</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fullname_mapping</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;PPMS doesn&#39;t seem to know user [</span><span class="si">%s</span><span class="s2">], skipping&quot;</span><span class="p">,</span> <span class="n">full</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Booking for user &#39;</span><span class="si">%s</span><span class="s2">&#39; (</span><span class="si">%s</span><span class="s2">) found&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fullname_mapping</span><span class="p">[</span><span class="n">full</span><span class="p">],</span> <span class="n">full</span>
            <span class="p">)</span>
            <span class="n">booking</span> <span class="o">=</span> <span class="n">PpmsBooking</span><span class="o">.</span><span class="n">from_runningsheet</span><span class="p">(</span>
                <span class="n">entry</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_get_system_with_name</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="s2">&quot;Object&quot;</span><span class="p">]),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fullname_mapping</span><span class="p">[</span><span class="n">full</span><span class="p">],</span>
                <span class="n">date</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">bookings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">booking</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">bookings</span>

    <span class="c1">############ deprecated methods ############</span>

    <span class="c1"># TODO: remove methods below with one of the next releases</span>

    <span class="k">def</span> <span class="nf">_get_system_with_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">system_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the system ID from the system&#39;s name.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        system_name : str</span>
<span class="sd">            The system name to look for in PPMS.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        int</span>
<span class="sd">            The ID of the system with the given name or &#39;-1&#39; if no system with</span>
<span class="sd">            that name could be found.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        DeprecationWarning</span>
<span class="sd">            This method will be removed in one of the next releases.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># raise DeprecationWarning(&#39;Use get_systems_matching() instead!&#39;)</span>
        <span class="n">sys_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_systems_matching</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">system_name</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">sys_ids</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">sys_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>

    <span class="k">def</span> <span class="nf">_get_machine_catalogue_from_system</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">system_name</span><span class="p">,</span> <span class="n">catalogue_names</span><span class="o">=</span><span class="p">[]):</span>
        <span class="sd">&quot;&quot;&quot;Get the machine catalog (location / category) of a system.</span>

<span class="sd">        WARNING: deprecated method from the legacy API!</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        system_name : str</span>
<span class="sd">            The name of the system to check PPMS for.</span>
<span class="sd">        catalogue_names : list(str), optional</span>
<span class="sd">            [description], by default []</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">            The machine catalog / location / category of the system. Will be an</span>
<span class="sd">            empty string (&#39;&#39;) if none is found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># raise DeprecationWarning(&#39;Use get_systems_matching() instead!&#39;)</span>
        <span class="k">for</span> <span class="n">category</span> <span class="ow">in</span> <span class="n">catalogue_names</span><span class="p">:</span>
            <span class="n">sys_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_systems_matching</span><span class="p">(</span><span class="n">category</span><span class="p">,</span> <span class="p">[</span><span class="n">system_name</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">sys_ids</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s2">&quot;Found system(s) </span><span class="si">%s</span><span class="s2"> to be in category [</span><span class="si">%s</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="n">sys_ids</span><span class="p">,</span> <span class="n">category</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="n">category</span>

        <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No category found for system [</span><span class="si">%s</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="n">system_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">get_bookable_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">localisation</span><span class="p">,</span> <span class="n">name_contains</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Legacy method for getting IDs of specific systems (name + location).</span>

<span class="sd">        This method is not implemented any more, use `get_systems_matching()` with</span>
<span class="sd">        appropriate parameters to select the desired systems instead.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        NotImplementedError</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Use get_systems_matching() instead!&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_system</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">system_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Legacy method for getting details of a specific system.</span>

<span class="sd">        This method is not implemented any more, use `get_systems()` instead and access</span>
<span class="sd">        the desired system by using the respective system ID as the key on the returned</span>
<span class="sd">        dict, e.g. `get_systems()[42]`.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        NotImplementedError</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Use get_systems()[system_id] instead!&quot;</span><span class="p">)</span>
</pre></div>

        </details>

            </section>
                <section id="PpmsConnection">
                                <div class="attr class">
        <a class="headerlink" href="#PpmsConnection">#&nbsp;&nbsp</a>

        
        <span class="def">class</span>
        <span class="name">PpmsConnection</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">class</span> <span class="nc">PpmsConnection</span><span class="p">:</span>

    <span class="sd">&quot;&quot;&quot;Connection object to communicate with a PPMS instance.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    url : str</span>
<span class="sd">        The URL of the PUMAPI instance.</span>
<span class="sd">    api_key : str</span>
<span class="sd">        The API key used for authenticating against the PUMAPI.</span>
<span class="sd">    timeout : float</span>
<span class="sd">        The timeout value used in the ``requests.post`` calls.</span>
<span class="sd">    cache_path : str</span>
<span class="sd">        A path to a local directory used for caching responses.</span>
<span class="sd">    users : dict</span>
<span class="sd">        A dict with usernames as keys, mapping to the related</span>
<span class="sd">        :py:class:`pyppms.user.PpmsUser` object, serves as a cache during the object&#39;s</span>
<span class="sd">        lifetime (can be empty if no calls to :py:meth:`get_user()` have been done yet).</span>
<span class="sd">    fullname_mapping : dict</span>
<span class="sd">        A dict mapping a user&#39;s *fullname* (&quot;``&lt;LASTNAME&gt; &lt;FIRSTNAME&gt;``&quot;) to the</span>
<span class="sd">        corresponding username. Entries are filled in dynamically by the</span>
<span class="sd">        :py:meth:`get_user()` method.</span>
<span class="sd">    systems</span>
<span class="sd">        A dict with system IDs as keys, mapping to the related</span>
<span class="sd">        :py:class:`pyppms.system.PpmsSystem` object. Serves as a cache during the</span>
<span class="sd">        object&#39;s lifetime (can be empty if no calls to the :py:meth:`get_systems()` have</span>
<span class="sd">        been done yet).</span>
<span class="sd">    status : dict</span>
<span class="sd">        A dict with keys ``auth_state``, ``auth_response`` and</span>
<span class="sd">        ``auth_httpstatus``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># TODO: all methods returning a list of user objects (get_group_users,</span>
    <span class="c1"># get_admins, ...) should be refactored to return a dict with those objects</span>
    <span class="c1"># instead, having the username (&#39;login&#39;) as the key.</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">api_key</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Constructor for the PPMS connection object.</span>

<span class="sd">        Open a connection to the PUMAPI defined in `url` and try to authenticate</span>
<span class="sd">        against it using the given API key (or use cache-only mode if key is an</span>
<span class="sd">        empty string). If an optional path to a caching location is specified,</span>
<span class="sd">        responses will be read from that location unless no matching file can be</span>
<span class="sd">        found there, in which case an on-line request will be done (with the</span>
<span class="sd">        response being saved to the cache path).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        url : str</span>
<span class="sd">            The URL of the PUMAPI to connect to.</span>
<span class="sd">        api_key : str</span>
<span class="sd">            The API key to use for authenticating against the PUMAPI. If</span>
<span class="sd">            specified as &#39;&#39; authentication will be skipped and the connection is</span>
<span class="sd">            running in cache-only (local) mode.</span>
<span class="sd">        timeout : float, optional</span>
<span class="sd">            How many seconds to wait for the PUMAPI server to send a response</span>
<span class="sd">            before giving up, by default 10.</span>
<span class="sd">        cache : str, optional</span>
<span class="sd">            A path to a local directory for caching responses from PUMAPI in</span>
<span class="sd">            individual text files. Useful for testing and for speeding up</span>
<span class="sd">            slow requests like &#39;getusers&#39;. By default empty, which will result</span>
<span class="sd">            in no caching being done.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        requests.exceptions.ConnectionError</span>
<span class="sd">            Raised in case authentication fails.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">url</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">api_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">users</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fullname_mapping</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">systems</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;auth_state&quot;</span><span class="p">:</span> <span class="s2">&quot;NOT_TRIED&quot;</span><span class="p">,</span>
            <span class="s2">&quot;auth_response&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;auth_httpstatus&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache_path</span> <span class="o">=</span> <span class="n">cache</span>

        <span class="c1"># run in cache-only mode (e.g. for testing or off-line usage) if no API</span>
        <span class="c1"># key has been specified, skip authentication then:</span>
        <span class="k">if</span> <span class="n">api_key</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__authenticate</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">cache</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;Neither API key nor cache path given, at least one is required!&quot;</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__authenticate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Try to authenticate to PPMS using the `auth` request.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        requests.exceptions.ConnectionError</span>
<span class="sd">            Raised in case authentication failed for any reason.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;Attempting authentication against </span><span class="si">%s</span><span class="s2"> with key [</span><span class="si">%s</span><span class="s2">...</span><span class="si">%s</span><span class="s2">]&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">api_key</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">api_key</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:],</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s2">&quot;auth_state&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;attempting&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;auth&quot;</span><span class="p">)</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Authenticate response: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s2">&quot;auth_response&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s2">&quot;auth_httpstatus&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span>

        <span class="c1"># NOTE: an unauthorized request has already been caught be the request() method</span>
        <span class="c1"># above. Our legacy code was additionally testing for &#39;error&#39; in the response</span>
        <span class="c1"># text - however, it is unclear if PUMAPI ever returns this:</span>
        <span class="k">if</span> <span class="s2">&quot;error&quot;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s2">&quot;auth_state&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;FAILED-ERROR&quot;</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Authentication failed with an error: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ConnectionError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">status_ok</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">codes</span><span class="o">.</span><span class="n">ok</span>  <span class="c1"># pylint: disable-msg=no-member</span>

        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="n">status_ok</span><span class="p">:</span>
            <span class="c1"># NOTE: branch excluded from coverage as we don&#39;t have a known way</span>
            <span class="c1"># to produce such a response from the API</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Unexpected combination of response [</span><span class="si">%s</span><span class="s2">] and status code [</span><span class="si">%s</span><span class="s2">], it&#39;s &quot;</span>
                <span class="s2">&quot;unclear if authentication succeeded (assuming it didn&#39;t)&quot;</span><span class="p">,</span>
                <span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span>
                <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s2">&quot;auth_state&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;FAILED-UNKNOWN&quot;</span>

            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Authenticating against </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="si">}</span><span class="s2"> with key &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">api_key</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">...</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">api_key</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span><span class="si">}</span><span class="s2">] FAILED!&quot;</span>
            <span class="p">)</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ConnectionError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Authentication succeeded, response=[</span><span class="si">%s</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;HTTP Status: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s2">&quot;auth_state&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;good&quot;</span>

    <span class="k">def</span> <span class="nf">request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="p">{},</span> <span class="n">skip_cache</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generic method to submit a request to PPMS and return the result.</span>

<span class="sd">        This convenience method deals with adding the API key to a given</span>
<span class="sd">        request, submitting it to the PUMAPI and checking the response for some</span>
<span class="sd">        specific keywords indicating an error.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        action : str</span>
<span class="sd">            The command to be submitted to the PUMAPI.</span>
<span class="sd">        parameters : dict, optional</span>
<span class="sd">            A dictionary with additional parameters to be submitted with the</span>
<span class="sd">            request.</span>
<span class="sd">        skip_cache : bool, optional</span>
<span class="sd">            If set to True the request will NOT be served from the local cache,</span>
<span class="sd">            independent whether a matching response file exists there, by</span>
<span class="sd">            default False.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        requests.Response</span>
<span class="sd">            The response object created by posting the request.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        requests.exceptions.ConnectionError</span>
<span class="sd">            Raised in case the request is not authorized.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">req_data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">action</span><span class="p">,</span> <span class="s2">&quot;apikey&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">api_key</span><span class="p">}</span>
        <span class="n">req_data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span>
        <span class="c1"># LOG.debug(&quot;Request parameters: %s&quot;, parameters)</span>

        <span class="n">response</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">read_from_cache</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">skip_cache</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                <span class="k">raise</span> <span class="ne">LookupError</span><span class="p">(</span><span class="s2">&quot;Skipping the cache has been requested&quot;</span><span class="p">)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__intercept_read</span><span class="p">(</span><span class="n">req_data</span><span class="p">)</span>
            <span class="n">read_from_cache</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">LookupError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Doing an on-line request: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">req_data</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>

        <span class="c1"># store the response if it hasn&#39;t been read from the cache before:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">read_from_cache</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__intercept_store</span><span class="p">(</span><span class="n">req_data</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>

        <span class="c1"># NOTE: the HTTP status code returned is always `200` even if</span>
        <span class="c1"># authentication failed, so we need to check the actual response *TEXT*</span>
        <span class="c1"># to figure out if we have succeeded:</span>
        <span class="k">if</span> <span class="s2">&quot;request not authorized&quot;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s2">&quot;auth_state&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;FAILED&quot;</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Not authorized to run action `</span><span class="si">{</span><span class="n">req_data</span><span class="p">[</span><span class="s1">&#39;action&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">`&quot;</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ConnectionError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">response</span>

    <span class="k">def</span> <span class="nf">__interception_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req_data</span><span class="p">,</span> <span class="n">create_dir</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Derive the path for a local cache file from a request&#39;s parameters.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        req_data : dict</span>
<span class="sd">            The request&#39;s parameters, used to derive the name of the cache file.</span>
<span class="sd">        create_dir : bool, optional</span>
<span class="sd">            If set to True the cache directory will be created if necessary.</span>
<span class="sd">            Useful when adding responses to the cache. By default False.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">            The full path to a file name identified by all parameters of the</span>
<span class="sd">            request (except credentials like &#39;apikey&#39;).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">action</span> <span class="o">=</span> <span class="n">req_data</span><span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">]</span>
        <span class="n">intercept_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_path</span><span class="p">,</span> <span class="n">action</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">create_dir</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">intercept_dir</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">intercept_dir</span><span class="p">)</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Created dir to store response: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">intercept_dir</span><span class="p">)</span>

        <span class="n">signature</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="c1"># different python versions are returning dict items in different order, so</span>
        <span class="c1"># simply iterating over them will not always produce the same result - hence we</span>
        <span class="c1"># build up a sorted list of keys first and use that one then:</span>
        <span class="n">keylist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">req_data</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">keylist</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keylist</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">,</span> <span class="s2">&quot;apikey&quot;</span><span class="p">]:</span>
                <span class="k">continue</span>
            <span class="n">signature</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;__</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">--</span><span class="si">{</span><span class="n">req_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">signature</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">signature</span> <span class="o">=</span> <span class="s2">&quot;__response&quot;</span>
        <span class="n">signature</span> <span class="o">=</span> <span class="n">signature</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span> <span class="o">+</span> <span class="s2">&quot;.txt&quot;</span>
        <span class="n">intercept_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">intercept_dir</span><span class="p">,</span> <span class="n">signature</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">intercept_file</span>

    <span class="k">def</span> <span class="nf">__intercept_read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req_data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Try to read a cached response from a local file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        req_data : dict</span>
<span class="sd">            The request&#39;s parameters, used to derive the name of the cache file.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        PseudoResponse</span>
<span class="sd">            The response text read from the cache file wrapped in a</span>
<span class="sd">            PseudoResponse object, or None in case no matching file was found in</span>
<span class="sd">            the local cache.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        LookupError</span>
<span class="sd">            Raised in case no cache path has been set or no cache file matching</span>
<span class="sd">            the request parameters could be found in the cache.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># pylint: disable-msg=too-few-public-methods</span>
        <span class="k">class</span> <span class="nc">PseudoResponse</span><span class="p">:</span>
            <span class="sd">&quot;&quot;&quot;Dummy response object with attribs &#39;text&#39; and &#39;status_code&#39;.&quot;&quot;&quot;</span>

            <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">status_code</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">text</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">status_code</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_path</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">LookupError</span><span class="p">(</span><span class="s2">&quot;No cache path configured&quot;</span><span class="p">)</span>

        <span class="n">intercept_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__interception_path</span><span class="p">(</span><span class="n">req_data</span><span class="p">,</span> <span class="n">create_dir</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">intercept_file</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
            <span class="k">raise</span> <span class="ne">LookupError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No cache hit for [</span><span class="si">{</span><span class="n">intercept_file</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">intercept_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">infile</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">infile</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Read intercepted response text from [</span><span class="si">%s</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="n">intercept_file</span><span class="p">)</span>

        <span class="n">status_code</span> <span class="o">=</span> <span class="mi">200</span>
        <span class="n">status_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">intercept_file</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_status-code.txt&quot;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">status_file</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">status_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">infile</span><span class="p">:</span>
                <span class="n">status_code</span> <span class="o">=</span> <span class="n">infile</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Read intercepted response status code from [</span><span class="si">%s</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="n">status_file</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">PseudoResponse</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">status_code</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__intercept_store</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req_data</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
        <span class="sd">&quot;&quot;&quot;Store the response in a local cache file named after the request.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        req_data : dict</span>
<span class="sd">            The request&#39;s parameters, used to derive the name of the cache file</span>
<span class="sd">            so it can be matched later when running the same request again.</span>
<span class="sd">        response : requests.Response</span>
<span class="sd">            The response object to store in the local cache.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># NOTE: this method is excluded from coverage measurements as it can only be</span>
        <span class="c1"># triggered when testing in online mode with at least one request not being</span>
        <span class="c1"># served from the cache (which is orthogonal to off-line testing)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_path</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">intercept_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__interception_path</span><span class="p">(</span><span class="n">req_data</span><span class="p">,</span> <span class="n">create_dir</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">intercept_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outfile</span><span class="p">:</span>
                <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;Wrote response text to [</span><span class="si">%s</span><span class="s2">] (</span><span class="si">%s</span><span class="s2"> lines)&quot;</span><span class="p">,</span>
                <span class="n">intercept_file</span><span class="p">,</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()),</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>  <span class="c1"># pylint: disable-msg=broad-except</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Storing response text in [</span><span class="si">%s</span><span class="s2">] failed: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">intercept_file</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Response text was:</span><span class="se">\n</span><span class="s2">--------</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="s2">--------&quot;</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>

    <span class="c1">############ users / groups ############</span>

    <span class="k">def</span> <span class="nf">new_user</span><span class="p">(</span>  <span class="c1"># pylint: disable-msg=too-many-arguments</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">login</span><span class="p">,</span> <span class="n">lname</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">ppms_group</span><span class="p">,</span> <span class="n">phone</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a new user in PPMS.</span>

<span class="sd">        The method is asking PPMS to create a new user account with the given details.</span>
<span class="sd">        In case an account with that login name already exists, it will log a warning</span>
<span class="sd">        and return without sending any further requests to PPMS.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        login : str</span>
<span class="sd">            The unique identifier for the user.</span>
<span class="sd">        lname : str</span>
<span class="sd">            The last name of the user.</span>
<span class="sd">        fname : str</span>
<span class="sd">            The first name of the user.</span>
<span class="sd">        email : str</span>
<span class="sd">            The email address of the user.</span>
<span class="sd">        ppms_group : str</span>
<span class="sd">            The unique identifier of the primary group of the new user. A new group will</span>
<span class="sd">            be created if no group with the given name exists.</span>
<span class="sd">        phone : str, optional</span>
<span class="sd">            The phone number of the user.</span>
<span class="sd">        password : str, optional</span>
<span class="sd">            The password for the user. If no password is set the user will not be able</span>
<span class="sd">            to log on to PPMS.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        RuntimeError</span>
<span class="sd">            Will be raised in case creating the user fails.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_exists</span><span class="p">(</span><span class="n">login</span><span class="p">):</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;NOT creating user [</span><span class="si">%s</span><span class="s2">] as it already exists!&quot;</span><span class="p">,</span> <span class="n">login</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">req_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;login&quot;</span><span class="p">:</span> <span class="n">login</span><span class="p">,</span>
            <span class="s2">&quot;lname&quot;</span><span class="p">:</span> <span class="n">lname</span><span class="p">,</span>
            <span class="s2">&quot;fname&quot;</span><span class="p">:</span> <span class="n">fname</span><span class="p">,</span>
            <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="n">email</span><span class="p">,</span>
            <span class="s2">&quot;unitlogin&quot;</span><span class="p">:</span> <span class="n">ppms_group</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">phone</span><span class="p">:</span>
            <span class="n">req_data</span><span class="p">[</span><span class="s2">&quot;phone&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">phone</span>
        <span class="k">if</span> <span class="n">password</span><span class="p">:</span>
            <span class="n">req_data</span><span class="p">[</span><span class="s2">&quot;pwd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">password</span>

        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;newuser&quot;</span><span class="p">,</span> <span class="n">req_data</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;OK newuser&quot;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Creating new user failed: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Created user [</span><span class="si">%s</span><span class="s2">] in PPMS.&quot;</span><span class="p">,</span> <span class="n">login</span><span class="p">)</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Response was: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_user_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get a list with all user IDs in the PPMS system.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        active : bool, optional</span>
<span class="sd">            Request only users marked as active in PPMS, by default False.</span>
<span class="sd">            NOTE: &quot;active&quot; is a tri-state parameter in PPMS: &quot;true&quot;, &quot;false&quot;</span>
<span class="sd">            or empty!</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list</span>
<span class="sd">            A list of all (or active-only) user IDs in PPMS.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: describe format of returned list and / or give an example!</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">active</span><span class="p">:</span>
            <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;active&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;true&quot;</span>

        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;getusers&quot;</span><span class="p">,</span> <span class="n">parameters</span><span class="p">)</span>

        <span class="n">users</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
        <span class="n">active_desc</span> <span class="o">=</span> <span class="s2">&quot;active &quot;</span> <span class="k">if</span> <span class="n">active</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">users in the PPMS database&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">users</span><span class="p">),</span> <span class="n">active_desc</span><span class="p">)</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">users</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">users</span>

    <span class="k">def</span> <span class="nf">get_user_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">login_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get details on a given user from PPMS.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        login_name : str</span>
<span class="sd">            The PPMS account / login name of the user to query.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            A dict with the user details returned by the PUMAPI.</span>

<span class="sd">        Example</span>
<span class="sd">        -------</span>
<span class="sd">        &gt;&gt;&gt; conn.get_user_dict(&#39;pyppms&#39;)</span>
<span class="sd">        ... {</span>
<span class="sd">        ...     u&#39;active&#39;: True,</span>
<span class="sd">        ...     u&#39;affiliation&#39;: u&#39;&#39;,</span>
<span class="sd">        ...     u&#39;bcode&#39;: u&#39;&#39;,</span>
<span class="sd">        ...     u&#39;email&#39;: u&#39;pyppms@python-facility.example&#39;,</span>
<span class="sd">        ...     u&#39;fname&#39;: u&#39;PumAPI&#39;,</span>
<span class="sd">        ...     u&#39;lname&#39;: u&#39;Python&#39;,</span>
<span class="sd">        ...     u&#39;login&#39;: u&#39;pyppms&#39;,</span>
<span class="sd">        ...     u&#39;mustchbcode&#39;: False,</span>
<span class="sd">        ...     u&#39;mustchpwd&#39;: False&#39;,</span>
<span class="sd">        ...     u&#39;phone&#39;: u&#39;+98 (76) 54 3210&#39;,</span>
<span class="sd">        ...     u&#39;unitlogin&#39;: u&#39;pyppms&#39;</span>
<span class="sd">        ... }</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        KeyError</span>
<span class="sd">            Raised in case the user account is unknown to PPMS.</span>
<span class="sd">        ValueError</span>
<span class="sd">            Raised if the user details can&#39;t be parsed from the PUMAPI response.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;getuser&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;login&quot;</span><span class="p">:</span> <span class="n">login_name</span><span class="p">})</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;User [</span><span class="si">{</span><span class="n">login_name</span><span class="si">}</span><span class="s2">] is unknown to PPMS&quot;</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># EXAMPLE:</span>
        <span class="c1"># response.text = (</span>
        <span class="c1">#     u&#39;login,lname,fname,email,&#39;</span>
        <span class="c1">#     u&#39;phone,bcode,affiliation,unitlogin,mustchpwd,mustchbcode,&#39;</span>
        <span class="c1">#     u&#39;active\r\n&#39;</span>
        <span class="c1">#     u&#39;&quot;pyppms&quot;,&quot;Python&quot;,&quot;PumAPI&quot;,&quot;pyppms@python-facility.example&quot;,&#39;</span>
        <span class="c1">#     u&#39;&quot;+98 (76) 54 3210&quot;,&quot;&quot;,&quot;&quot;,&quot;pyppms&quot;,false,false,&#39;</span>
        <span class="c1">#     u&#39;true\r\n&#39;</span>
        <span class="c1"># )</span>
        <span class="n">details</span> <span class="o">=</span> <span class="n">dict_from_single_response</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Details for user [</span><span class="si">%s</span><span class="s2">]: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">login_name</span><span class="p">,</span> <span class="n">details</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">details</span>

    <span class="k">def</span> <span class="nf">get_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">login_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fetch user details from PPMS and create a PpmsUser object from it.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        login_name : str</span>
<span class="sd">            The user&#39;s PPMS login name.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        PpmsUser</span>
<span class="sd">            The user object created from the PUMAPI response. The object will be</span>
<span class="sd">            additionally stored in the self.users dict using the login_name as</span>
<span class="sd">            the dict&#39;s key.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        KeyError</span>
<span class="sd">            Raised if the user doesn&#39;t exist in PPMS.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;getuser&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;login&quot;</span><span class="p">:</span> <span class="n">login_name</span><span class="p">})</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;User [</span><span class="si">{</span><span class="n">login_name</span><span class="si">}</span><span class="s2">] is unknown to PPMS&quot;</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">user</span> <span class="o">=</span> <span class="n">PpmsUser</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="p">[</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">]</span> <span class="o">=</span> <span class="n">user</span>  <span class="c1"># update / add to the cached user objs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fullname_mapping</span><span class="p">[</span><span class="n">user</span><span class="o">.</span><span class="n">fullname</span><span class="p">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span>
        <span class="k">return</span> <span class="n">user</span>

    <span class="k">def</span> <span class="nf">user_exists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">login</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check if an account with the given login name already exists in PPMS.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        login : str</span>
<span class="sd">            The login name to check for.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            True in case an account with that name exists in PPMS, false otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="n">login</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">get_users</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force_refresh</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get user objects for all (or cached) PPMS users.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        force_refresh : bool, optional</span>
<span class="sd">            Re-request information from PPMS even if user details have been</span>
<span class="sd">            cached locally before, by default False.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict(PpmsUser)</span>
<span class="sd">            A dict of PpmsUser objects with the username (login) as key.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">users</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">force_refresh</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Using cached details for </span><span class="si">%s</span><span class="s2"> users&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_users</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">users</span>

    <span class="k">def</span> <span class="nf">update_users</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_ids</span><span class="o">=</span><span class="p">[]):</span>
        <span class="sd">&quot;&quot;&quot;Update cached details for a list of users from PPMS.</span>

<span class="sd">        Get the user details on a list of users (or all active ones) from PPMS and store</span>
<span class="sd">        them in the object&#39;s `users` dict. As a side effect, this will also fill the</span>
<span class="sd">        cache directory in case the object&#39;s `cache_path` attribute is set.</span>

<span class="sd">        WARNING - very slow, especially when the PPMS instance has many users!</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        user_ids : list(str), optional</span>
<span class="sd">            A list of user IDs (login names) to request the cache for, by</span>
<span class="sd">            default [] which will result in all *active* users to be requested.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">user_ids</span><span class="p">:</span>
            <span class="n">user_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_ids</span><span class="p">(</span><span class="n">active</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Updating details on </span><span class="si">%s</span><span class="s2"> users&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">user_ids</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">user_id</span> <span class="ow">in</span> <span class="n">user_ids</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>

        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Collected details on </span><span class="si">%s</span><span class="s2"> users&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">get_admins</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get all PPMS administrator users.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list(PpmsUser)</span>
<span class="sd">            A list with PpmsUser objects that are PPMS administrators.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;getadmins&quot;</span><span class="p">)</span>

        <span class="n">admins</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
        <span class="n">users</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">username</span> <span class="ow">in</span> <span class="n">admins</span><span class="p">:</span>
            <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
            <span class="n">users</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> admins in the PPMS database: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">admins</span><span class="p">),</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">admins</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">users</span>

    <span class="k">def</span> <span class="nf">get_groups</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get a list of all groups in PPMS.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list(str)</span>
<span class="sd">            A list with the group identifiers in PPMS.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;getgroups&quot;</span><span class="p">)</span>

        <span class="n">groups</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> groups in the PPMS database: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">groups</span><span class="p">),</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">groups</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">groups</span>

    <span class="k">def</span> <span class="nf">get_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fetch group details from PPMS and create a dict from them.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        group_id : str</span>
<span class="sd">            The group&#39;s identifier in PPMS, called &#39;unitlogin&#39; there.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            A dict with the group details, keys being derived from the header</span>
<span class="sd">            line of the PUMAPI response, values from the data line.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;getgroup&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;unitlogin&quot;</span><span class="p">:</span> <span class="n">group_id</span><span class="p">})</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Group details returned by PPMS (raw): </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Group [</span><span class="si">{</span><span class="n">group_id</span><span class="si">}</span><span class="s2">] is unknown to PPMS&quot;</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">details</span> <span class="o">=</span> <span class="n">dict_from_single_response</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>

        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Details of group </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">group_id</span><span class="p">,</span> <span class="n">details</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">details</span>

    <span class="k">def</span> <span class="nf">get_group_users</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unitlogin</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get all members of a group in PPMS.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        unitlogin : str</span>
<span class="sd">            The group&#39;s login (&quot;unique login or id&quot; in the PPMS web interface).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list(PpmsUser)</span>
<span class="sd">            A list with PpmsUser objects that are members of this PPMS group.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;getgroupusers&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;unitlogin&quot;</span><span class="p">:</span> <span class="n">unitlogin</span><span class="p">})</span>

        <span class="n">members</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
        <span class="n">users</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">username</span> <span class="ow">in</span> <span class="n">members</span><span class="p">:</span>
            <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
            <span class="n">users</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> members in PPMS group [</span><span class="si">%s</span><span class="s2">]: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">members</span><span class="p">),</span>
            <span class="n">unitlogin</span><span class="p">,</span>
            <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">members</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">users</span>

    <span class="k">def</span> <span class="nf">get_user_experience</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">login</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">system_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get user experience (&quot;User rights&quot;) from PPMS.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        login : str, optional</span>
<span class="sd">            An optional login name to request the experience / permissions for,</span>
<span class="sd">            by default None</span>
<span class="sd">        system_id : int, optional</span>
<span class="sd">            An optional system ID to request the experience / permissions for,</span>
<span class="sd">            by default None</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list(dict)</span>
<span class="sd">            A list with dicts parsed from the user experience response.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">login</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;login&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">login</span>
        <span class="k">if</span> <span class="n">system_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">system_id</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;getuserexp&quot;</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>

        <span class="n">parsed</span> <span class="o">=</span> <span class="n">parse_multiline_response</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;Received </span><span class="si">%s</span><span class="s2"> experience entries for filters [user:</span><span class="si">%s</span><span class="s2">] and [id:</span><span class="si">%s</span><span class="s2">]&quot;</span><span class="p">,</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">parsed</span><span class="p">),</span>
            <span class="n">login</span><span class="p">,</span>
            <span class="n">system_id</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">parsed</span>

    <span class="k">def</span> <span class="nf">get_users_emails</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">users</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get a list of user email addresses. WARNING - very slow!</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        users : list(str), optional</span>
<span class="sd">            A list of login names to retrieve the email addresses for, if</span>
<span class="sd">            omitted addresses for all (or active ones) will be requested.</span>
<span class="sd">        active : bool, optional</span>
<span class="sd">            Request only addresses of users marked as active in PPMS, by default</span>
<span class="sd">            False. Will be ignored if a list of usernames is given explicitly.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list(str)</span>
<span class="sd">            Email addresses of the users requested.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">emails</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">users</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">users</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_ids</span><span class="p">(</span><span class="n">active</span><span class="o">=</span><span class="n">active</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">users</span><span class="p">:</span>
            <span class="n">email</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_dict</span><span class="p">(</span><span class="n">user</span><span class="p">)[</span><span class="s2">&quot;email&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">email</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;--- WARNING: no email for user [</span><span class="si">%s</span><span class="s2">]! ---&quot;</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="c1"># LOG.debug(&quot;%s: %s&quot;, user, email)</span>
            <span class="n">emails</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">emails</span>

    <span class="c1">############ resources ############</span>

    <span class="k">def</span> <span class="nf">get_systems</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force_refresh</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get a dict with all systems in PPMS.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict(pyppms.system.PpmsSystem)</span>
<span class="sd">            A dict with `PpmsSystem` objects parsed from the PUMAPI response where</span>
<span class="sd">            the system ID (int) is used as the dict&#39;s key. If parsing a system</span>
<span class="sd">            fails for any reason, the system is skipped entirely.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">systems</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">force_refresh</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Using cached details for </span><span class="si">%s</span><span class="s2"> systems&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">systems</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_systems</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">systems</span>

    <span class="k">def</span> <span class="nf">update_systems</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update cached details for all bookable systems from PPMS.</span>

<span class="sd">        Get the details on all bookable systems from PPMS and store them in the local</span>
<span class="sd">        cache. If parsing the PUMAPI response for a system fails for any reason, the</span>
<span class="sd">        system is skipped entirely.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Updating list of bookable systems...&quot;</span><span class="p">)</span>
        <span class="n">systems</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">parse_fails</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;getsystems&quot;</span><span class="p">)</span>
        <span class="n">details</span> <span class="o">=</span> <span class="n">parse_multiline_response</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">graceful</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">detail</span> <span class="ow">in</span> <span class="n">details</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">system</span> <span class="o">=</span> <span class="n">PpmsSystem</span><span class="p">(</span><span class="n">detail</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error processing `getsystems` response: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
                <span class="n">parse_fails</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">continue</span>

            <span class="n">systems</span><span class="p">[</span><span class="n">system</span><span class="o">.</span><span class="n">system_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">system</span>

        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;Updated </span><span class="si">%s</span><span class="s2"> bookable systems from PPMS (</span><span class="si">%s</span><span class="s2"> systems failed parsing)&quot;</span><span class="p">,</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">systems</span><span class="p">),</span>
            <span class="n">parse_fails</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">systems</span> <span class="o">=</span> <span class="n">systems</span>

    <span class="k">def</span> <span class="nf">get_systems_matching</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">localisation</span><span class="p">,</span> <span class="n">name_contains</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Query PPMS for systems with a specific location and name.</span>

<span class="sd">        This method assembles a list of PPMS system IDs whose &quot;localisation&quot;</span>
<span class="sd">        (room) field matches a given string and where the system name contains</span>
<span class="sd">        at least one of the strings given as the `name_contains` parameter.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        localisation : str</span>
<span class="sd">            A string that the system&#39;s &quot;localisation&quot; (i.e. the &quot;Room&quot; field in</span>
<span class="sd">            the PPMS web interface) has to match.</span>
<span class="sd">        name_contains : list(str)</span>
<span class="sd">            A list of valid names (categories) of which the system&#39;s name has to</span>
<span class="sd">            match at least one for being included. Supply an empty list for</span>
<span class="sd">            skipping this filter.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list(int)</span>
<span class="sd">            A list with PPMS system IDs matching all of the given criteria.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">loc</span> <span class="o">=</span> <span class="n">localisation</span>
        <span class="n">loc_desc</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;with location matching [</span><span class="si">{</span><span class="n">localisation</span><span class="si">}</span><span class="s2">]&quot;</span>
        <span class="k">if</span> <span class="n">localisation</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">loc_desc</span> <span class="o">=</span> <span class="s2">&quot;(no location filter given)&quot;</span>

        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Querying PPMS for systems </span><span class="si">%s</span><span class="s2">, name matching any of </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">loc_desc</span><span class="p">,</span>
            <span class="n">name_contains</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">system_ids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">systems</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_systems</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">sys_id</span><span class="p">,</span> <span class="n">system</span> <span class="ow">in</span> <span class="n">systems</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">loc</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">system</span><span class="o">.</span><span class="n">localisation</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s2">&quot;System [</span><span class="si">%s</span><span class="s2">] location (</span><span class="si">%s</span><span class="s2">) is NOT matching (</span><span class="si">%s</span><span class="s2">), ignoring&quot;</span><span class="p">,</span>
                    <span class="n">system</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">system</span><span class="o">.</span><span class="n">localisation</span><span class="p">,</span>
                    <span class="n">loc</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># LOG.debug(&#39;System [%s] is matching location [%s], checking if &#39;</span>
            <span class="c1">#           &#39;the name is matching any of the valid pattern %s&#39;,</span>
            <span class="c1">#           system.name, loc, name_contains)</span>
            <span class="k">for</span> <span class="n">valid_name</span> <span class="ow">in</span> <span class="n">name_contains</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">valid_name</span> <span class="ow">in</span> <span class="n">system</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;System [</span><span class="si">%s</span><span class="s2">] matches all criteria&quot;</span><span class="p">,</span> <span class="n">system</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                    <span class="n">system_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sys_id</span><span class="p">)</span>
                    <span class="k">break</span>

            <span class="c1"># if sys_id not in system_ids:</span>
            <span class="c1">#     LOG.debug(&#39;System [%s] does NOT match a valid name: %s&#39;,</span>
            <span class="c1">#               system.name, name_contains)</span>

        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Found </span><span class="si">%s</span><span class="s2"> bookable systems </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">system_ids</span><span class="p">),</span> <span class="n">loc_desc</span><span class="p">)</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;IDs of matching bookable systems </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">loc_desc</span><span class="p">,</span> <span class="n">system_ids</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">system_ids</span>

    <span class="c1">############ system / user permissions ############</span>

    <span class="k">def</span> <span class="nf">get_users_with_access_to_system</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">system_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get a list of usernames allowed to book the system with the given ID.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        system_id : int or int-like</span>
<span class="sd">            The ID of the system to query permitted users for.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list(str)</span>
<span class="sd">            A list of usernames (&#39;login&#39;) with permissions to book the system</span>
<span class="sd">            with the given ID in PPMS.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            Raised in case parsing the response failes for any reason.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">users</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;getsysrights&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">system_id</span><span class="p">})</span>
        <span class="c1"># this response has a unique format, so parse it directly here:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
                <span class="n">permission</span><span class="p">,</span> <span class="n">username</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">permission</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;D&quot;</span><span class="p">:</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="s2">&quot;User [</span><span class="si">%s</span><span class="s2">] is deactivated for booking system [</span><span class="si">%s</span><span class="s2">], skipping&quot;</span><span class="p">,</span>
                        <span class="n">username</span><span class="p">,</span>
                        <span class="n">system_id</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="k">continue</span>

                <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s2">&quot;User [</span><span class="si">%s</span><span class="s2">] has permission to book system [</span><span class="si">%s</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">system_id</span>
                <span class="p">)</span>
                <span class="n">users</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Unable to parse data returned by PUMAPI: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2"> - &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;ERROR: </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">err</span>

        <span class="k">return</span> <span class="n">users</span>

    <span class="k">def</span> <span class="nf">set_system_booking_permissions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">login</span><span class="p">,</span> <span class="n">system_id</span><span class="p">,</span> <span class="n">permission</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set permissions for a user on a given system in PPMS.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        username : str</span>
<span class="sd">            The username (&#39;login&#39;) to allow for booking the system.</span>
<span class="sd">        system_id : int or int-like</span>
<span class="sd">            The ID of the system to add the permission for.</span>
<span class="sd">        permission : {&#39;D&#39;, &#39;A&#39;, &#39;N&#39;, &#39;S&#39;}</span>
<span class="sd">            The permission level to set for the user, one of:</span>
<span class="sd">              - ``D`` : deactivated</span>
<span class="sd">              - ``A`` : autonomous</span>
<span class="sd">              - ``N`` : novice</span>
<span class="sd">              - ``S`` : superuser</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            True in case setting permissions for the given username on the</span>
<span class="sd">            system with the specified ID succeeded (or if the user already had</span>
<span class="sd">            those permissions before), False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">permission_name</span><span class="p">(</span><span class="n">shortname</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Closure to validate a permission level and return its long name.</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            shortname : str</span>
<span class="sd">                A single character defining the permission level.</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            str</span>
<span class="sd">                The long (human-readable) name of the permission level.</span>

<span class="sd">            Raises</span>
<span class="sd">            ------</span>
<span class="sd">            KeyError</span>
<span class="sd">                Raised in case an invalid permission level was given.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">mapping</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;D&quot;</span><span class="p">:</span> <span class="s2">&quot;deactivated&quot;</span><span class="p">,</span>
                <span class="s2">&quot;A&quot;</span><span class="p">:</span> <span class="s2">&quot;autonomous&quot;</span><span class="p">,</span>
                <span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="s2">&quot;novice&quot;</span><span class="p">,</span>
                <span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="s2">&quot;superuser&quot;</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">mapping</span><span class="p">[</span><span class="n">shortname</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid permission [</span><span class="si">{</span><span class="n">shortname</span><span class="si">}</span><span class="s2">] given&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">err</span>

        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;Setting permission level [</span><span class="si">%s</span><span class="s2">] for user [</span><span class="si">%s</span><span class="s2">] on system [</span><span class="si">%s</span><span class="s2">]&quot;</span><span class="p">,</span>
            <span class="n">permission_name</span><span class="p">(</span><span class="n">permission</span><span class="p">),</span>
            <span class="n">login</span><span class="p">,</span>
            <span class="n">system_id</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">parameters</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">system_id</span><span class="p">,</span> <span class="s2">&quot;login&quot;</span><span class="p">:</span> <span class="n">login</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">permission</span><span class="p">}</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;setright&quot;</span><span class="p">,</span> <span class="n">parameters</span><span class="p">)</span>

        <span class="c1"># NOTE: the &#39;setright&#39; action will accept ANY permission type and return &#39;done&#39;</span>
        <span class="c1"># on the request, so there is no way to check from the response if setting the</span>
        <span class="c1"># permission really worked!!</span>
        <span class="c1"># LOG.debug(&#39;Request returned text: %s&#39;, response.text)</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;done&quot;</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;User [</span><span class="si">%s</span><span class="s2">] now has permission level [</span><span class="si">%s</span><span class="s2">] on system [</span><span class="si">%s</span><span class="s2">]&quot;</span><span class="p">,</span>
                <span class="n">login</span><span class="p">,</span>
                <span class="n">permission_name</span><span class="p">(</span><span class="n">permission</span><span class="p">),</span>
                <span class="n">system_id</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="s2">&quot;invalid user&quot;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;User [</span><span class="si">%s</span><span class="s2">] doesn&#39;t seem to exist in PPMS&quot;</span><span class="p">,</span> <span class="n">login</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s2">&quot;system right not authorized&quot;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;Unable to set permissions for system </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">system_id</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Unexpected response, assuming request failed: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">give_user_access_to_system</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">system_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add permissions for a user to book a given system in PPMS.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        username : str</span>
<span class="sd">            The username (&#39;login&#39;) to allow for booking the system.</span>
<span class="sd">        system_id : int or int-like</span>
<span class="sd">            The ID of the system to add the permission for.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            True in case the given username now has the permissions to book the</span>
<span class="sd">            system with the specified ID (or if the user already had them</span>
<span class="sd">            before), False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_system_booking_permissions</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">system_id</span><span class="p">,</span> <span class="s2">&quot;A&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">remove_user_access_from_system</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">system_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove permissions for a user to book a given system in PPMS.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        username : str</span>
<span class="sd">            The username (&#39;login&#39;) to remove booking permissions on the system.</span>
<span class="sd">        system_id : int or int-like</span>
<span class="sd">            The ID of the system to modify the permission for.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            True in case the given username now has the permissions to book the</span>
<span class="sd">            system with the specified ID (or if the user already had them</span>
<span class="sd">            before), False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_system_booking_permissions</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">system_id</span><span class="p">,</span> <span class="s2">&quot;D&quot;</span><span class="p">)</span>

    <span class="c1">############ bookings ############</span>

    <span class="k">def</span> <span class="nf">get_booking</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">system_id</span><span class="p">,</span> <span class="n">booking_type</span><span class="o">=</span><span class="s2">&quot;get&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the current or next booking of a system.</span>

<span class="sd">        WARNING: if the next booking is requested but it is too far in the future,</span>
<span class="sd">        PUMAPI silently ignores it - the response is identical to a system that has no</span>
<span class="sd">        future bookings and there is no error reported either. Currently it is unclear</span>
<span class="sd">        where the cutoff is (e.g. lookups for a booking that is two years from now still</span>
<span class="sd">        work fine, but a booking in about 10 years is silently skipped).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        system_id : int or int-like</span>
<span class="sd">            The ID of the system in PPMS.</span>
<span class="sd">        booking_type : {&#39;get&#39;, &#39;next&#39;}, optional</span>
<span class="sd">            The type of booking to request, one of `get` (requesting the</span>
<span class="sd">            currently running booking) and `next` (requesting the next upcoming</span>
<span class="sd">            booking), by default `get`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        PpmsBooking or None</span>
<span class="sd">            The booking object, or None if there is no booking for the system or the</span>
<span class="sd">            request is refused by PUMAPI (e.g. &quot;not authorized&quot;).</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            Raised if the specified `booking_type` is invalid.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">valid</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;get&quot;</span><span class="p">,</span> <span class="s2">&quot;next&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">booking_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Value for &#39;booking_type&#39; (</span><span class="si">{</span><span class="n">booking_type</span><span class="si">}</span><span class="s2">) not in </span><span class="si">{</span><span class="n">valid</span><span class="si">}</span><span class="s2">!&quot;</span>
            <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">booking_type</span> <span class="o">+</span> <span class="s2">&quot;booking&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">system_id</span><span class="p">})</span>
        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ConnectionError</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Requesting booking status for system </span><span class="si">%s</span><span class="s2"> failed!&quot;</span><span class="p">,</span> <span class="n">system_id</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">desc</span> <span class="o">=</span> <span class="s2">&quot;any future bookings&quot;</span>
        <span class="k">if</span> <span class="n">booking_type</span> <span class="o">==</span> <span class="s2">&quot;get&quot;</span><span class="p">:</span>
            <span class="n">desc</span> <span class="o">=</span> <span class="s2">&quot;a currently active booking&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;System [</span><span class="si">%s</span><span class="s2">] doesn&#39;t have </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">system_id</span><span class="p">,</span> <span class="n">desc</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">PpmsBooking</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">booking_type</span><span class="p">,</span> <span class="n">system_id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_current_booking</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">system_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Wrapper for `get_booking()` with &#39;booking_type&#39; set to &#39;get&#39;.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_booking</span><span class="p">(</span><span class="n">system_id</span><span class="p">,</span> <span class="s2">&quot;get&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_next_booking</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">system_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Wrapper for `get_booking()` with &#39;booking_type&#39; set to &#39;next&#39;.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_booking</span><span class="p">(</span><span class="n">system_id</span><span class="p">,</span> <span class="s2">&quot;next&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_running_sheet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">core_facility_ref</span><span class="p">,</span> <span class="n">date</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the running sheet for a specific day on the given facility.</span>

<span class="sd">        The so-called &quot;running-sheet&quot; consists of all bookings / reservations of</span>
<span class="sd">        a facility on a specifc day.</span>

<span class="sd">        WARNING: PUMAPI doesn&#39;t return a proper unique user identifier with the</span>
<span class="sd">        &#39;getrunningsheet&#39; request, instead the so called &quot;full name&quot; is given to</span>
<span class="sd">        identify the user - unfortunately this can lead to ambiguities as</span>
<span class="sd">        multiple different accounts can have the same full name.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        core_facility_ref : int or int-like</span>
<span class="sd">            The core facility ID for PPMS.</span>
<span class="sd">        date : datetime.datetime</span>
<span class="sd">            The date to request the running sheet for, e.g. ``datetime.now()`` or</span>
<span class="sd">            similar. Note that only the date part is relevant, time will be ignored.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list(pyppms.booking.PpmsBooking)</span>
<span class="sd">            A list with `PpmsBooking` objects for the given day. Empty in case</span>
<span class="sd">            there are no bookings or parsing the response failed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">bookings</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;plateformid&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">core_facility_ref</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;day&quot;</span><span class="p">:</span> <span class="n">date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Requesting runningsheet for </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;day&quot;</span><span class="p">])</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;getrunningsheet&quot;</span><span class="p">,</span> <span class="n">parameters</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">entries</span> <span class="o">=</span> <span class="n">parse_multiline_response</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">graceful</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>  <span class="c1"># pylint: disable-msg=broad-except</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Parsing runningsheet details failed: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
            <span class="c1"># NOTE: in case no future bookings exist the response will be empty!</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Possibly the runningsheet is empty as no bookings exist?&quot;</span><span class="p">)</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Runningsheet PUMPAI response was: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">bookings</span>

        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
            <span class="n">full</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;User&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">full</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fullname_mapping</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Booking for an uncached user (</span><span class="si">%s</span><span class="s2">) found!&quot;</span><span class="p">,</span> <span class="n">full</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">update_users</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">full</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fullname_mapping</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;PPMS doesn&#39;t seem to know user [</span><span class="si">%s</span><span class="s2">], skipping&quot;</span><span class="p">,</span> <span class="n">full</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Booking for user &#39;</span><span class="si">%s</span><span class="s2">&#39; (</span><span class="si">%s</span><span class="s2">) found&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fullname_mapping</span><span class="p">[</span><span class="n">full</span><span class="p">],</span> <span class="n">full</span>
            <span class="p">)</span>
            <span class="n">booking</span> <span class="o">=</span> <span class="n">PpmsBooking</span><span class="o">.</span><span class="n">from_runningsheet</span><span class="p">(</span>
                <span class="n">entry</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_get_system_with_name</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="s2">&quot;Object&quot;</span><span class="p">]),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fullname_mapping</span><span class="p">[</span><span class="n">full</span><span class="p">],</span>
                <span class="n">date</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">bookings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">booking</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">bookings</span>

    <span class="c1">############ deprecated methods ############</span>

    <span class="c1"># TODO: remove methods below with one of the next releases</span>

    <span class="k">def</span> <span class="nf">_get_system_with_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">system_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the system ID from the system&#39;s name.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        system_name : str</span>
<span class="sd">            The system name to look for in PPMS.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        int</span>
<span class="sd">            The ID of the system with the given name or &#39;-1&#39; if no system with</span>
<span class="sd">            that name could be found.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        DeprecationWarning</span>
<span class="sd">            This method will be removed in one of the next releases.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># raise DeprecationWarning(&#39;Use get_systems_matching() instead!&#39;)</span>
        <span class="n">sys_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_systems_matching</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">system_name</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">sys_ids</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">sys_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>

    <span class="k">def</span> <span class="nf">_get_machine_catalogue_from_system</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">system_name</span><span class="p">,</span> <span class="n">catalogue_names</span><span class="o">=</span><span class="p">[]):</span>
        <span class="sd">&quot;&quot;&quot;Get the machine catalog (location / category) of a system.</span>

<span class="sd">        WARNING: deprecated method from the legacy API!</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        system_name : str</span>
<span class="sd">            The name of the system to check PPMS for.</span>
<span class="sd">        catalogue_names : list(str), optional</span>
<span class="sd">            [description], by default []</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">            The machine catalog / location / category of the system. Will be an</span>
<span class="sd">            empty string (&#39;&#39;) if none is found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># raise DeprecationWarning(&#39;Use get_systems_matching() instead!&#39;)</span>
        <span class="k">for</span> <span class="n">category</span> <span class="ow">in</span> <span class="n">catalogue_names</span><span class="p">:</span>
            <span class="n">sys_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_systems_matching</span><span class="p">(</span><span class="n">category</span><span class="p">,</span> <span class="p">[</span><span class="n">system_name</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">sys_ids</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s2">&quot;Found system(s) </span><span class="si">%s</span><span class="s2"> to be in category [</span><span class="si">%s</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="n">sys_ids</span><span class="p">,</span> <span class="n">category</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="n">category</span>

        <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No category found for system [</span><span class="si">%s</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="n">system_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">get_bookable_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">localisation</span><span class="p">,</span> <span class="n">name_contains</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Legacy method for getting IDs of specific systems (name + location).</span>

<span class="sd">        This method is not implemented any more, use `get_systems_matching()` with</span>
<span class="sd">        appropriate parameters to select the desired systems instead.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        NotImplementedError</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Use get_systems_matching() instead!&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_system</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">system_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Legacy method for getting details of a specific system.</span>

<span class="sd">        This method is not implemented any more, use `get_systems()` instead and access</span>
<span class="sd">        the desired system by using the respective system ID as the key on the returned</span>
<span class="sd">        dict, e.g. `get_systems()[42]`.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        NotImplementedError</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Use get_systems()[system_id] instead!&quot;</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>Connection object to communicate with a PPMS instance.</p>

<h6 id="attributes">Attributes</h6>

<ul>
<li><strong>url</strong> (str):
The URL of the PUMAPI instance.</li>
<li><strong>api_key</strong> (str):
The API key used for authenticating against the PUMAPI.</li>
<li><strong>timeout</strong> (float):
The timeout value used in the <code>requests.post</code> calls.</li>
<li><strong>cache_path</strong> (str):
A path to a local directory used for caching responses.</li>
<li><strong>users</strong> (dict):
A dict with usernames as keys, mapping to the related
<code><a href="user.html#PpmsUser">pyppms.user.PpmsUser</a></code> object, serves as a cache during the object's
lifetime (can be empty if no calls to <code><a href="#PpmsConnection.get_user">get_user()</a></code> have been done yet).</li>
<li><strong>fullname_mapping</strong> (dict):
A dict mapping a user's <em>fullname</em> ("<code>&lt;LASTNAME&gt; &lt;FIRSTNAME&gt;</code>") to the
corresponding username. Entries are filled in dynamically by the
<code><a href="#PpmsConnection.get_user">get_user()</a></code> method.</li>
<li><strong>systems</strong>: A dict with system IDs as keys, mapping to the related
<code><a href="system.html#PpmsSystem">pyppms.system.PpmsSystem</a></code> object. Serves as a cache during the
object's lifetime (can be empty if no calls to the <code><a href="#PpmsConnection.get_systems">get_systems()</a></code> have
been done yet).</li>
<li><strong>status</strong> (dict):
A dict with keys <code>auth_state</code>, <code>auth_response</code> and
<code>auth_httpstatus</code></li>
</ul>
</div>


                            <div id="PpmsConnection.__init__" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#PpmsConnection.__init__">#&nbsp;&nbsp</a>

        
            <span class="name">PpmsConnection</span><span class="signature">(url, api_key, timeout=10, cache=&#39;&#39;)</span>
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">api_key</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Constructor for the PPMS connection object.</span>

<span class="sd">        Open a connection to the PUMAPI defined in `url` and try to authenticate</span>
<span class="sd">        against it using the given API key (or use cache-only mode if key is an</span>
<span class="sd">        empty string). If an optional path to a caching location is specified,</span>
<span class="sd">        responses will be read from that location unless no matching file can be</span>
<span class="sd">        found there, in which case an on-line request will be done (with the</span>
<span class="sd">        response being saved to the cache path).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        url : str</span>
<span class="sd">            The URL of the PUMAPI to connect to.</span>
<span class="sd">        api_key : str</span>
<span class="sd">            The API key to use for authenticating against the PUMAPI. If</span>
<span class="sd">            specified as &#39;&#39; authentication will be skipped and the connection is</span>
<span class="sd">            running in cache-only (local) mode.</span>
<span class="sd">        timeout : float, optional</span>
<span class="sd">            How many seconds to wait for the PUMAPI server to send a response</span>
<span class="sd">            before giving up, by default 10.</span>
<span class="sd">        cache : str, optional</span>
<span class="sd">            A path to a local directory for caching responses from PUMAPI in</span>
<span class="sd">            individual text files. Useful for testing and for speeding up</span>
<span class="sd">            slow requests like &#39;getusers&#39;. By default empty, which will result</span>
<span class="sd">            in no caching being done.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        requests.exceptions.ConnectionError</span>
<span class="sd">            Raised in case authentication fails.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">url</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">api_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">users</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fullname_mapping</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">systems</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;auth_state&quot;</span><span class="p">:</span> <span class="s2">&quot;NOT_TRIED&quot;</span><span class="p">,</span>
            <span class="s2">&quot;auth_response&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;auth_httpstatus&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache_path</span> <span class="o">=</span> <span class="n">cache</span>

        <span class="c1"># run in cache-only mode (e.g. for testing or off-line usage) if no API</span>
        <span class="c1"># key has been specified, skip authentication then:</span>
        <span class="k">if</span> <span class="n">api_key</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__authenticate</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">cache</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;Neither API key nor cache path given, at least one is required!&quot;</span>
            <span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>Constructor for the PPMS connection object.</p>

<p>Open a connection to the PUMAPI defined in <code>url</code> and try to authenticate
against it using the given API key (or use cache-only mode if key is an
empty string). If an optional path to a caching location is specified,
responses will be read from that location unless no matching file can be
found there, in which case an on-line request will be done (with the
response being saved to the cache path).</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>url</strong> (str):
The URL of the PUMAPI to connect to.</li>
<li><strong>api_key</strong> (str):
The API key to use for authenticating against the PUMAPI. If
specified as '' authentication will be skipped and the connection is
running in cache-only (local) mode.</li>
<li><strong>timeout</strong> (float, optional):
How many seconds to wait for the PUMAPI server to send a response
before giving up, by default 10.</li>
<li><strong>cache</strong> (str, optional):
A path to a local directory for caching responses from PUMAPI in
individual text files. Useful for testing and for speeding up
slow requests like 'getusers'. By default empty, which will result
in no caching being done.</li>
</ul>

<h6 id="raises">Raises</h6>

<ul>
<li><strong>requests.exceptions.ConnectionError</strong>: Raised in case authentication fails.</li>
</ul>
</div>


                            </div>
                            <div id="PpmsConnection.request" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#PpmsConnection.request">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">request</span><span class="signature">(self, action, parameters={}, skip_cache=False)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="p">{},</span> <span class="n">skip_cache</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generic method to submit a request to PPMS and return the result.</span>

<span class="sd">        This convenience method deals with adding the API key to a given</span>
<span class="sd">        request, submitting it to the PUMAPI and checking the response for some</span>
<span class="sd">        specific keywords indicating an error.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        action : str</span>
<span class="sd">            The command to be submitted to the PUMAPI.</span>
<span class="sd">        parameters : dict, optional</span>
<span class="sd">            A dictionary with additional parameters to be submitted with the</span>
<span class="sd">            request.</span>
<span class="sd">        skip_cache : bool, optional</span>
<span class="sd">            If set to True the request will NOT be served from the local cache,</span>
<span class="sd">            independent whether a matching response file exists there, by</span>
<span class="sd">            default False.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        requests.Response</span>
<span class="sd">            The response object created by posting the request.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        requests.exceptions.ConnectionError</span>
<span class="sd">            Raised in case the request is not authorized.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">req_data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">action</span><span class="p">,</span> <span class="s2">&quot;apikey&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">api_key</span><span class="p">}</span>
        <span class="n">req_data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span>
        <span class="c1"># LOG.debug(&quot;Request parameters: %s&quot;, parameters)</span>

        <span class="n">response</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">read_from_cache</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">skip_cache</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                <span class="k">raise</span> <span class="ne">LookupError</span><span class="p">(</span><span class="s2">&quot;Skipping the cache has been requested&quot;</span><span class="p">)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__intercept_read</span><span class="p">(</span><span class="n">req_data</span><span class="p">)</span>
            <span class="n">read_from_cache</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">LookupError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Doing an on-line request: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">req_data</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>

        <span class="c1"># store the response if it hasn&#39;t been read from the cache before:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">read_from_cache</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__intercept_store</span><span class="p">(</span><span class="n">req_data</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>

        <span class="c1"># NOTE: the HTTP status code returned is always `200` even if</span>
        <span class="c1"># authentication failed, so we need to check the actual response *TEXT*</span>
        <span class="c1"># to figure out if we have succeeded:</span>
        <span class="k">if</span> <span class="s2">&quot;request not authorized&quot;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s2">&quot;auth_state&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;FAILED&quot;</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Not authorized to run action `</span><span class="si">{</span><span class="n">req_data</span><span class="p">[</span><span class="s1">&#39;action&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">`&quot;</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ConnectionError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">response</span>
</pre></div>

        </details>

            <div class="docstring"><p>Generic method to submit a request to PPMS and return the result.</p>

<p>This convenience method deals with adding the API key to a given
request, submitting it to the PUMAPI and checking the response for some
specific keywords indicating an error.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>action</strong> (str):
The command to be submitted to the PUMAPI.</li>
<li><strong>parameters</strong> (dict, optional):
A dictionary with additional parameters to be submitted with the
request.</li>
<li><strong>skip_cache</strong> (bool, optional):
If set to True the request will NOT be served from the local cache,
independent whether a matching response file exists there, by
default False.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>requests.Response</strong>: The response object created by posting the request.</li>
</ul>

<h6 id="raises">Raises</h6>

<ul>
<li><strong>requests.exceptions.ConnectionError</strong>: Raised in case the request is not authorized.</li>
</ul>
</div>


                            </div>
                            <div id="PpmsConnection.new_user" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#PpmsConnection.new_user">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">new_user</span><span class="signature">(
    self,
    login,
    lname,
    fname,
    email,
    ppms_group,
    phone=None,
    password=None
)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">new_user</span><span class="p">(</span>  <span class="c1"># pylint: disable-msg=too-many-arguments</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">login</span><span class="p">,</span> <span class="n">lname</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">ppms_group</span><span class="p">,</span> <span class="n">phone</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a new user in PPMS.</span>

<span class="sd">        The method is asking PPMS to create a new user account with the given details.</span>
<span class="sd">        In case an account with that login name already exists, it will log a warning</span>
<span class="sd">        and return without sending any further requests to PPMS.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        login : str</span>
<span class="sd">            The unique identifier for the user.</span>
<span class="sd">        lname : str</span>
<span class="sd">            The last name of the user.</span>
<span class="sd">        fname : str</span>
<span class="sd">            The first name of the user.</span>
<span class="sd">        email : str</span>
<span class="sd">            The email address of the user.</span>
<span class="sd">        ppms_group : str</span>
<span class="sd">            The unique identifier of the primary group of the new user. A new group will</span>
<span class="sd">            be created if no group with the given name exists.</span>
<span class="sd">        phone : str, optional</span>
<span class="sd">            The phone number of the user.</span>
<span class="sd">        password : str, optional</span>
<span class="sd">            The password for the user. If no password is set the user will not be able</span>
<span class="sd">            to log on to PPMS.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        RuntimeError</span>
<span class="sd">            Will be raised in case creating the user fails.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_exists</span><span class="p">(</span><span class="n">login</span><span class="p">):</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;NOT creating user [</span><span class="si">%s</span><span class="s2">] as it already exists!&quot;</span><span class="p">,</span> <span class="n">login</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">req_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;login&quot;</span><span class="p">:</span> <span class="n">login</span><span class="p">,</span>
            <span class="s2">&quot;lname&quot;</span><span class="p">:</span> <span class="n">lname</span><span class="p">,</span>
            <span class="s2">&quot;fname&quot;</span><span class="p">:</span> <span class="n">fname</span><span class="p">,</span>
            <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="n">email</span><span class="p">,</span>
            <span class="s2">&quot;unitlogin&quot;</span><span class="p">:</span> <span class="n">ppms_group</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">phone</span><span class="p">:</span>
            <span class="n">req_data</span><span class="p">[</span><span class="s2">&quot;phone&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">phone</span>
        <span class="k">if</span> <span class="n">password</span><span class="p">:</span>
            <span class="n">req_data</span><span class="p">[</span><span class="s2">&quot;pwd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">password</span>

        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;newuser&quot;</span><span class="p">,</span> <span class="n">req_data</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;OK newuser&quot;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Creating new user failed: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Created user [</span><span class="si">%s</span><span class="s2">] in PPMS.&quot;</span><span class="p">,</span> <span class="n">login</span><span class="p">)</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Response was: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>Create a new user in PPMS.</p>

<p>The method is asking PPMS to create a new user account with the given details.
In case an account with that login name already exists, it will log a warning
and return without sending any further requests to PPMS.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>login</strong> (str):
The unique identifier for the user.</li>
<li><strong>lname</strong> (str):
The last name of the user.</li>
<li><strong>fname</strong> (str):
The first name of the user.</li>
<li><strong>email</strong> (str):
The email address of the user.</li>
<li><strong>ppms_group</strong> (str):
The unique identifier of the primary group of the new user. A new group will
be created if no group with the given name exists.</li>
<li><strong>phone</strong> (str, optional):
The phone number of the user.</li>
<li><strong>password</strong> (str, optional):
The password for the user. If no password is set the user will not be able
to log on to PPMS.</li>
</ul>

<h6 id="raises">Raises</h6>

<ul>
<li><strong>RuntimeError</strong>: Will be raised in case creating the user fails.</li>
</ul>
</div>


                            </div>
                            <div id="PpmsConnection.get_user_ids" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#PpmsConnection.get_user_ids">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">get_user_ids</span><span class="signature">(self, active=False)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">get_user_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get a list with all user IDs in the PPMS system.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        active : bool, optional</span>
<span class="sd">            Request only users marked as active in PPMS, by default False.</span>
<span class="sd">            NOTE: &quot;active&quot; is a tri-state parameter in PPMS: &quot;true&quot;, &quot;false&quot;</span>
<span class="sd">            or empty!</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list</span>
<span class="sd">            A list of all (or active-only) user IDs in PPMS.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: describe format of returned list and / or give an example!</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">active</span><span class="p">:</span>
            <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;active&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;true&quot;</span>

        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;getusers&quot;</span><span class="p">,</span> <span class="n">parameters</span><span class="p">)</span>

        <span class="n">users</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
        <span class="n">active_desc</span> <span class="o">=</span> <span class="s2">&quot;active &quot;</span> <span class="k">if</span> <span class="n">active</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">users in the PPMS database&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">users</span><span class="p">),</span> <span class="n">active_desc</span><span class="p">)</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">users</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">users</span>
</pre></div>

        </details>

            <div class="docstring"><p>Get a list with all user IDs in the PPMS system.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>active</strong> (bool, optional):
Request only users marked as active in PPMS, by default False.
NOTE: "active" is a tri-state parameter in PPMS: "true", "false"
or empty!</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>list</strong>: A list of all (or active-only) user IDs in PPMS.</li>
</ul>
</div>


                            </div>
                            <div id="PpmsConnection.get_user_dict" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#PpmsConnection.get_user_dict">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">get_user_dict</span><span class="signature">(self, login_name)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">get_user_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">login_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get details on a given user from PPMS.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        login_name : str</span>
<span class="sd">            The PPMS account / login name of the user to query.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            A dict with the user details returned by the PUMAPI.</span>

<span class="sd">        Example</span>
<span class="sd">        -------</span>
<span class="sd">        &gt;&gt;&gt; conn.get_user_dict(&#39;pyppms&#39;)</span>
<span class="sd">        ... {</span>
<span class="sd">        ...     u&#39;active&#39;: True,</span>
<span class="sd">        ...     u&#39;affiliation&#39;: u&#39;&#39;,</span>
<span class="sd">        ...     u&#39;bcode&#39;: u&#39;&#39;,</span>
<span class="sd">        ...     u&#39;email&#39;: u&#39;pyppms@python-facility.example&#39;,</span>
<span class="sd">        ...     u&#39;fname&#39;: u&#39;PumAPI&#39;,</span>
<span class="sd">        ...     u&#39;lname&#39;: u&#39;Python&#39;,</span>
<span class="sd">        ...     u&#39;login&#39;: u&#39;pyppms&#39;,</span>
<span class="sd">        ...     u&#39;mustchbcode&#39;: False,</span>
<span class="sd">        ...     u&#39;mustchpwd&#39;: False&#39;,</span>
<span class="sd">        ...     u&#39;phone&#39;: u&#39;+98 (76) 54 3210&#39;,</span>
<span class="sd">        ...     u&#39;unitlogin&#39;: u&#39;pyppms&#39;</span>
<span class="sd">        ... }</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        KeyError</span>
<span class="sd">            Raised in case the user account is unknown to PPMS.</span>
<span class="sd">        ValueError</span>
<span class="sd">            Raised if the user details can&#39;t be parsed from the PUMAPI response.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;getuser&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;login&quot;</span><span class="p">:</span> <span class="n">login_name</span><span class="p">})</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;User [</span><span class="si">{</span><span class="n">login_name</span><span class="si">}</span><span class="s2">] is unknown to PPMS&quot;</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># EXAMPLE:</span>
        <span class="c1"># response.text = (</span>
        <span class="c1">#     u&#39;login,lname,fname,email,&#39;</span>
        <span class="c1">#     u&#39;phone,bcode,affiliation,unitlogin,mustchpwd,mustchbcode,&#39;</span>
        <span class="c1">#     u&#39;active\r\n&#39;</span>
        <span class="c1">#     u&#39;&quot;pyppms&quot;,&quot;Python&quot;,&quot;PumAPI&quot;,&quot;pyppms@python-facility.example&quot;,&#39;</span>
        <span class="c1">#     u&#39;&quot;+98 (76) 54 3210&quot;,&quot;&quot;,&quot;&quot;,&quot;pyppms&quot;,false,false,&#39;</span>
        <span class="c1">#     u&#39;true\r\n&#39;</span>
        <span class="c1"># )</span>
        <span class="n">details</span> <span class="o">=</span> <span class="n">dict_from_single_response</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Details for user [</span><span class="si">%s</span><span class="s2">]: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">login_name</span><span class="p">,</span> <span class="n">details</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">details</span>
</pre></div>

        </details>

            <div class="docstring"><p>Get details on a given user from PPMS.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>login_name</strong> (str):
The PPMS account / login name of the user to query.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>dict</strong>: A dict with the user details returned by the PUMAPI.</li>
</ul>

<h6 id="example">Example</h6>

<div class="pdoc-code codehilite"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">conn</span><span class="o">.</span><span class="n">get_user_dict</span><span class="p">(</span><span class="s1">&#39;pyppms&#39;</span><span class="p">)</span>
<span class="gp">... </span><span class="p">{</span>
<span class="gp">... </span>    <span class="sa">u</span><span class="s1">&#39;active&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<span class="gp">... </span>    <span class="sa">u</span><span class="s1">&#39;affiliation&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="sa">u</span><span class="s1">&#39;bcode&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="sa">u</span><span class="s1">&#39;email&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;pyppms@python-facility.example&#39;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="sa">u</span><span class="s1">&#39;fname&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;PumAPI&#39;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="sa">u</span><span class="s1">&#39;lname&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;Python&#39;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="sa">u</span><span class="s1">&#39;login&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;pyppms&#39;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="sa">u</span><span class="s1">&#39;mustchbcode&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
<span class="gp">... </span>    <span class="sa">u</span><span class="s1">&#39;mustchpwd&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="s1">&#39;,</span>
<span class="gp">... </span>    <span class="sa">u</span><span class="s1">&#39;phone&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;+98 (76) 54 3210&#39;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="sa">u</span><span class="s1">&#39;unitlogin&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;pyppms&#39;</span>
<span class="gp">... </span><span class="p">}</span>
</code></pre></div>

<h6 id="raises">Raises</h6>

<ul>
<li><strong>KeyError</strong>: Raised in case the user account is unknown to PPMS.</li>
<li><strong>ValueError</strong>: Raised if the user details can't be parsed from the PUMAPI response.</li>
</ul>
</div>


                            </div>
                            <div id="PpmsConnection.get_user" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#PpmsConnection.get_user">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">get_user</span><span class="signature">(self, login_name)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">get_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">login_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fetch user details from PPMS and create a PpmsUser object from it.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        login_name : str</span>
<span class="sd">            The user&#39;s PPMS login name.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        PpmsUser</span>
<span class="sd">            The user object created from the PUMAPI response. The object will be</span>
<span class="sd">            additionally stored in the self.users dict using the login_name as</span>
<span class="sd">            the dict&#39;s key.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        KeyError</span>
<span class="sd">            Raised if the user doesn&#39;t exist in PPMS.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;getuser&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;login&quot;</span><span class="p">:</span> <span class="n">login_name</span><span class="p">})</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;User [</span><span class="si">{</span><span class="n">login_name</span><span class="si">}</span><span class="s2">] is unknown to PPMS&quot;</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">user</span> <span class="o">=</span> <span class="n">PpmsUser</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="p">[</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">]</span> <span class="o">=</span> <span class="n">user</span>  <span class="c1"># update / add to the cached user objs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fullname_mapping</span><span class="p">[</span><span class="n">user</span><span class="o">.</span><span class="n">fullname</span><span class="p">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span>
        <span class="k">return</span> <span class="n">user</span>
</pre></div>

        </details>

            <div class="docstring"><p>Fetch user details from PPMS and create a PpmsUser object from it.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>login_name</strong> (str):
The user's PPMS login name.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>PpmsUser</strong>: The user object created from the PUMAPI response. The object will be
additionally stored in the self.users dict using the login_name as
the dict's key.</li>
</ul>

<h6 id="raises">Raises</h6>

<ul>
<li><strong>KeyError</strong>: Raised if the user doesn't exist in PPMS.</li>
</ul>
</div>


                            </div>
                            <div id="PpmsConnection.user_exists" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#PpmsConnection.user_exists">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">user_exists</span><span class="signature">(self, login)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">user_exists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">login</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check if an account with the given login name already exists in PPMS.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        login : str</span>
<span class="sd">            The login name to check for.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            True in case an account with that name exists in PPMS, false otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="n">login</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
</pre></div>

        </details>

            <div class="docstring"><p>Check if an account with the given login name already exists in PPMS.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>login</strong> (str):
The login name to check for.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>bool</strong>: True in case an account with that name exists in PPMS, false otherwise.</li>
</ul>
</div>


                            </div>
                            <div id="PpmsConnection.get_users" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#PpmsConnection.get_users">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">get_users</span><span class="signature">(self, force_refresh=False)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">get_users</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force_refresh</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get user objects for all (or cached) PPMS users.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        force_refresh : bool, optional</span>
<span class="sd">            Re-request information from PPMS even if user details have been</span>
<span class="sd">            cached locally before, by default False.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict(PpmsUser)</span>
<span class="sd">            A dict of PpmsUser objects with the username (login) as key.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">users</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">force_refresh</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Using cached details for </span><span class="si">%s</span><span class="s2"> users&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_users</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">users</span>
</pre></div>

        </details>

            <div class="docstring"><p>Get user objects for all (or cached) PPMS users.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>force_refresh</strong> (bool, optional):
Re-request information from PPMS even if user details have been
cached locally before, by default False.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>dict(PpmsUser)</strong>: A dict of PpmsUser objects with the username (login) as key.</li>
</ul>
</div>


                            </div>
                            <div id="PpmsConnection.update_users" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#PpmsConnection.update_users">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">update_users</span><span class="signature">(self, user_ids=[])</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">update_users</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_ids</span><span class="o">=</span><span class="p">[]):</span>
        <span class="sd">&quot;&quot;&quot;Update cached details for a list of users from PPMS.</span>

<span class="sd">        Get the user details on a list of users (or all active ones) from PPMS and store</span>
<span class="sd">        them in the object&#39;s `users` dict. As a side effect, this will also fill the</span>
<span class="sd">        cache directory in case the object&#39;s `cache_path` attribute is set.</span>

<span class="sd">        WARNING - very slow, especially when the PPMS instance has many users!</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        user_ids : list(str), optional</span>
<span class="sd">            A list of user IDs (login names) to request the cache for, by</span>
<span class="sd">            default [] which will result in all *active* users to be requested.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">user_ids</span><span class="p">:</span>
            <span class="n">user_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_ids</span><span class="p">(</span><span class="n">active</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Updating details on </span><span class="si">%s</span><span class="s2"> users&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">user_ids</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">user_id</span> <span class="ow">in</span> <span class="n">user_ids</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>

        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Collected details on </span><span class="si">%s</span><span class="s2"> users&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="p">))</span>
</pre></div>

        </details>

            <div class="docstring"><p>Update cached details for a list of users from PPMS.</p>

<p>Get the user details on a list of users (or all active ones) from PPMS and store
them in the object's <code>users</code> dict. As a side effect, this will also fill the
cache directory in case the object's <code>cache_path</code> attribute is set.</p>

<p>WARNING - very slow, especially when the PPMS instance has many users!</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>user_ids</strong> (list(str), optional):
A list of user IDs (login names) to request the cache for, by
default [] which will result in all <em>active</em> users to be requested.</li>
</ul>
</div>


                            </div>
                            <div id="PpmsConnection.get_admins" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#PpmsConnection.get_admins">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">get_admins</span><span class="signature">(self)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">get_admins</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get all PPMS administrator users.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list(PpmsUser)</span>
<span class="sd">            A list with PpmsUser objects that are PPMS administrators.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;getadmins&quot;</span><span class="p">)</span>

        <span class="n">admins</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
        <span class="n">users</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">username</span> <span class="ow">in</span> <span class="n">admins</span><span class="p">:</span>
            <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
            <span class="n">users</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> admins in the PPMS database: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">admins</span><span class="p">),</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">admins</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">users</span>
</pre></div>

        </details>

            <div class="docstring"><p>Get all PPMS administrator users.</p>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>list(PpmsUser)</strong>: A list with PpmsUser objects that are PPMS administrators.</li>
</ul>
</div>


                            </div>
                            <div id="PpmsConnection.get_groups" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#PpmsConnection.get_groups">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">get_groups</span><span class="signature">(self)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">get_groups</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get a list of all groups in PPMS.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list(str)</span>
<span class="sd">            A list with the group identifiers in PPMS.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;getgroups&quot;</span><span class="p">)</span>

        <span class="n">groups</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> groups in the PPMS database: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">groups</span><span class="p">),</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">groups</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">groups</span>
</pre></div>

        </details>

            <div class="docstring"><p>Get a list of all groups in PPMS.</p>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>list(str)</strong>: A list with the group identifiers in PPMS.</li>
</ul>
</div>


                            </div>
                            <div id="PpmsConnection.get_group" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#PpmsConnection.get_group">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">get_group</span><span class="signature">(self, group_id)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">get_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fetch group details from PPMS and create a dict from them.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        group_id : str</span>
<span class="sd">            The group&#39;s identifier in PPMS, called &#39;unitlogin&#39; there.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            A dict with the group details, keys being derived from the header</span>
<span class="sd">            line of the PUMAPI response, values from the data line.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;getgroup&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;unitlogin&quot;</span><span class="p">:</span> <span class="n">group_id</span><span class="p">})</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Group details returned by PPMS (raw): </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Group [</span><span class="si">{</span><span class="n">group_id</span><span class="si">}</span><span class="s2">] is unknown to PPMS&quot;</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">details</span> <span class="o">=</span> <span class="n">dict_from_single_response</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>

        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Details of group </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">group_id</span><span class="p">,</span> <span class="n">details</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">details</span>
</pre></div>

        </details>

            <div class="docstring"><p>Fetch group details from PPMS and create a dict from them.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>group_id</strong> (str):
The group's identifier in PPMS, called 'unitlogin' there.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>dict</strong>: A dict with the group details, keys being derived from the header
line of the PUMAPI response, values from the data line.</li>
</ul>
</div>


                            </div>
                            <div id="PpmsConnection.get_group_users" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#PpmsConnection.get_group_users">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">get_group_users</span><span class="signature">(self, unitlogin)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">get_group_users</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unitlogin</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get all members of a group in PPMS.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        unitlogin : str</span>
<span class="sd">            The group&#39;s login (&quot;unique login or id&quot; in the PPMS web interface).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list(PpmsUser)</span>
<span class="sd">            A list with PpmsUser objects that are members of this PPMS group.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;getgroupusers&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;unitlogin&quot;</span><span class="p">:</span> <span class="n">unitlogin</span><span class="p">})</span>

        <span class="n">members</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
        <span class="n">users</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">username</span> <span class="ow">in</span> <span class="n">members</span><span class="p">:</span>
            <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
            <span class="n">users</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> members in PPMS group [</span><span class="si">%s</span><span class="s2">]: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">members</span><span class="p">),</span>
            <span class="n">unitlogin</span><span class="p">,</span>
            <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">members</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">users</span>
</pre></div>

        </details>

            <div class="docstring"><p>Get all members of a group in PPMS.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>unitlogin</strong> (str):
The group's login ("unique login or id" in the PPMS web interface).</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>list(PpmsUser)</strong>: A list with PpmsUser objects that are members of this PPMS group.</li>
</ul>
</div>


                            </div>
                            <div id="PpmsConnection.get_user_experience" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#PpmsConnection.get_user_experience">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">get_user_experience</span><span class="signature">(self, login=None, system_id=None)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">get_user_experience</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">login</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">system_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get user experience (&quot;User rights&quot;) from PPMS.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        login : str, optional</span>
<span class="sd">            An optional login name to request the experience / permissions for,</span>
<span class="sd">            by default None</span>
<span class="sd">        system_id : int, optional</span>
<span class="sd">            An optional system ID to request the experience / permissions for,</span>
<span class="sd">            by default None</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list(dict)</span>
<span class="sd">            A list with dicts parsed from the user experience response.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">login</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;login&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">login</span>
        <span class="k">if</span> <span class="n">system_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">system_id</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;getuserexp&quot;</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>

        <span class="n">parsed</span> <span class="o">=</span> <span class="n">parse_multiline_response</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;Received </span><span class="si">%s</span><span class="s2"> experience entries for filters [user:</span><span class="si">%s</span><span class="s2">] and [id:</span><span class="si">%s</span><span class="s2">]&quot;</span><span class="p">,</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">parsed</span><span class="p">),</span>
            <span class="n">login</span><span class="p">,</span>
            <span class="n">system_id</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">parsed</span>
</pre></div>

        </details>

            <div class="docstring"><p>Get user experience ("User rights") from PPMS.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>login</strong> (str, optional):
An optional login name to request the experience / permissions for,
by default None</li>
<li><strong>system_id</strong> (int, optional):
An optional system ID to request the experience / permissions for,
by default None</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>list(dict)</strong>: A list with dicts parsed from the user experience response.</li>
</ul>
</div>


                            </div>
                            <div id="PpmsConnection.get_users_emails" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#PpmsConnection.get_users_emails">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">get_users_emails</span><span class="signature">(self, users=None, active=False)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">get_users_emails</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">users</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get a list of user email addresses. WARNING - very slow!</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        users : list(str), optional</span>
<span class="sd">            A list of login names to retrieve the email addresses for, if</span>
<span class="sd">            omitted addresses for all (or active ones) will be requested.</span>
<span class="sd">        active : bool, optional</span>
<span class="sd">            Request only addresses of users marked as active in PPMS, by default</span>
<span class="sd">            False. Will be ignored if a list of usernames is given explicitly.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list(str)</span>
<span class="sd">            Email addresses of the users requested.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">emails</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">users</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">users</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_ids</span><span class="p">(</span><span class="n">active</span><span class="o">=</span><span class="n">active</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">users</span><span class="p">:</span>
            <span class="n">email</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_dict</span><span class="p">(</span><span class="n">user</span><span class="p">)[</span><span class="s2">&quot;email&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">email</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;--- WARNING: no email for user [</span><span class="si">%s</span><span class="s2">]! ---&quot;</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="c1"># LOG.debug(&quot;%s: %s&quot;, user, email)</span>
            <span class="n">emails</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">emails</span>
</pre></div>

        </details>

            <div class="docstring"><p>Get a list of user email addresses. WARNING - very slow!</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>users</strong> (list(str), optional):
A list of login names to retrieve the email addresses for, if
omitted addresses for all (or active ones) will be requested.</li>
<li><strong>active</strong> (bool, optional):
Request only addresses of users marked as active in PPMS, by default
False. Will be ignored if a list of usernames is given explicitly.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>list(str)</strong>: Email addresses of the users requested.</li>
</ul>
</div>


                            </div>
                            <div id="PpmsConnection.get_systems" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#PpmsConnection.get_systems">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">get_systems</span><span class="signature">(self, force_refresh=False)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">get_systems</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force_refresh</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get a dict with all systems in PPMS.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict(pyppms.system.PpmsSystem)</span>
<span class="sd">            A dict with `PpmsSystem` objects parsed from the PUMAPI response where</span>
<span class="sd">            the system ID (int) is used as the dict&#39;s key. If parsing a system</span>
<span class="sd">            fails for any reason, the system is skipped entirely.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">systems</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">force_refresh</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Using cached details for </span><span class="si">%s</span><span class="s2"> systems&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">systems</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_systems</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">systems</span>
</pre></div>

        </details>

            <div class="docstring"><p>Get a dict with all systems in PPMS.</p>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>dict(<a href="system.html#PpmsSystem">pyppms.system.PpmsSystem</a>)</strong>: A dict with <code>PpmsSystem</code> objects parsed from the PUMAPI response where
the system ID (int) is used as the dict's key. If parsing a system
fails for any reason, the system is skipped entirely.</li>
</ul>
</div>


                            </div>
                            <div id="PpmsConnection.update_systems" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#PpmsConnection.update_systems">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">update_systems</span><span class="signature">(self)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">update_systems</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update cached details for all bookable systems from PPMS.</span>

<span class="sd">        Get the details on all bookable systems from PPMS and store them in the local</span>
<span class="sd">        cache. If parsing the PUMAPI response for a system fails for any reason, the</span>
<span class="sd">        system is skipped entirely.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Updating list of bookable systems...&quot;</span><span class="p">)</span>
        <span class="n">systems</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">parse_fails</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;getsystems&quot;</span><span class="p">)</span>
        <span class="n">details</span> <span class="o">=</span> <span class="n">parse_multiline_response</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">graceful</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">detail</span> <span class="ow">in</span> <span class="n">details</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">system</span> <span class="o">=</span> <span class="n">PpmsSystem</span><span class="p">(</span><span class="n">detail</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error processing `getsystems` response: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
                <span class="n">parse_fails</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">continue</span>

            <span class="n">systems</span><span class="p">[</span><span class="n">system</span><span class="o">.</span><span class="n">system_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">system</span>

        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;Updated </span><span class="si">%s</span><span class="s2"> bookable systems from PPMS (</span><span class="si">%s</span><span class="s2"> systems failed parsing)&quot;</span><span class="p">,</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">systems</span><span class="p">),</span>
            <span class="n">parse_fails</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">systems</span> <span class="o">=</span> <span class="n">systems</span>
</pre></div>

        </details>

            <div class="docstring"><p>Update cached details for all bookable systems from PPMS.</p>

<p>Get the details on all bookable systems from PPMS and store them in the local
cache. If parsing the PUMAPI response for a system fails for any reason, the
system is skipped entirely.</p>
</div>


                            </div>
                            <div id="PpmsConnection.get_systems_matching" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#PpmsConnection.get_systems_matching">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">get_systems_matching</span><span class="signature">(self, localisation, name_contains)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">get_systems_matching</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">localisation</span><span class="p">,</span> <span class="n">name_contains</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Query PPMS for systems with a specific location and name.</span>

<span class="sd">        This method assembles a list of PPMS system IDs whose &quot;localisation&quot;</span>
<span class="sd">        (room) field matches a given string and where the system name contains</span>
<span class="sd">        at least one of the strings given as the `name_contains` parameter.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        localisation : str</span>
<span class="sd">            A string that the system&#39;s &quot;localisation&quot; (i.e. the &quot;Room&quot; field in</span>
<span class="sd">            the PPMS web interface) has to match.</span>
<span class="sd">        name_contains : list(str)</span>
<span class="sd">            A list of valid names (categories) of which the system&#39;s name has to</span>
<span class="sd">            match at least one for being included. Supply an empty list for</span>
<span class="sd">            skipping this filter.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list(int)</span>
<span class="sd">            A list with PPMS system IDs matching all of the given criteria.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">loc</span> <span class="o">=</span> <span class="n">localisation</span>
        <span class="n">loc_desc</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;with location matching [</span><span class="si">{</span><span class="n">localisation</span><span class="si">}</span><span class="s2">]&quot;</span>
        <span class="k">if</span> <span class="n">localisation</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">loc_desc</span> <span class="o">=</span> <span class="s2">&quot;(no location filter given)&quot;</span>

        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Querying PPMS for systems </span><span class="si">%s</span><span class="s2">, name matching any of </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">loc_desc</span><span class="p">,</span>
            <span class="n">name_contains</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">system_ids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">systems</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_systems</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">sys_id</span><span class="p">,</span> <span class="n">system</span> <span class="ow">in</span> <span class="n">systems</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">loc</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">system</span><span class="o">.</span><span class="n">localisation</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s2">&quot;System [</span><span class="si">%s</span><span class="s2">] location (</span><span class="si">%s</span><span class="s2">) is NOT matching (</span><span class="si">%s</span><span class="s2">), ignoring&quot;</span><span class="p">,</span>
                    <span class="n">system</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">system</span><span class="o">.</span><span class="n">localisation</span><span class="p">,</span>
                    <span class="n">loc</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># LOG.debug(&#39;System [%s] is matching location [%s], checking if &#39;</span>
            <span class="c1">#           &#39;the name is matching any of the valid pattern %s&#39;,</span>
            <span class="c1">#           system.name, loc, name_contains)</span>
            <span class="k">for</span> <span class="n">valid_name</span> <span class="ow">in</span> <span class="n">name_contains</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">valid_name</span> <span class="ow">in</span> <span class="n">system</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;System [</span><span class="si">%s</span><span class="s2">] matches all criteria&quot;</span><span class="p">,</span> <span class="n">system</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                    <span class="n">system_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sys_id</span><span class="p">)</span>
                    <span class="k">break</span>

            <span class="c1"># if sys_id not in system_ids:</span>
            <span class="c1">#     LOG.debug(&#39;System [%s] does NOT match a valid name: %s&#39;,</span>
            <span class="c1">#               system.name, name_contains)</span>

        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Found </span><span class="si">%s</span><span class="s2"> bookable systems </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">system_ids</span><span class="p">),</span> <span class="n">loc_desc</span><span class="p">)</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;IDs of matching bookable systems </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">loc_desc</span><span class="p">,</span> <span class="n">system_ids</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">system_ids</span>
</pre></div>

        </details>

            <div class="docstring"><p>Query PPMS for systems with a specific location and name.</p>

<p>This method assembles a list of PPMS system IDs whose "localisation"
(room) field matches a given string and where the system name contains
at least one of the strings given as the <code>name_contains</code> parameter.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>localisation</strong> (str):
A string that the system's "localisation" (i.e. the "Room" field in
the PPMS web interface) has to match.</li>
<li><strong>name_contains</strong> (list(str)):
A list of valid names (categories) of which the system's name has to
match at least one for being included. Supply an empty list for
skipping this filter.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>list(int)</strong>: A list with PPMS system IDs matching all of the given criteria.</li>
</ul>
</div>


                            </div>
                            <div id="PpmsConnection.get_users_with_access_to_system" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#PpmsConnection.get_users_with_access_to_system">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">get_users_with_access_to_system</span><span class="signature">(self, system_id)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">get_users_with_access_to_system</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">system_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get a list of usernames allowed to book the system with the given ID.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        system_id : int or int-like</span>
<span class="sd">            The ID of the system to query permitted users for.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list(str)</span>
<span class="sd">            A list of usernames (&#39;login&#39;) with permissions to book the system</span>
<span class="sd">            with the given ID in PPMS.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            Raised in case parsing the response failes for any reason.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">users</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;getsysrights&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">system_id</span><span class="p">})</span>
        <span class="c1"># this response has a unique format, so parse it directly here:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
                <span class="n">permission</span><span class="p">,</span> <span class="n">username</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">permission</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;D&quot;</span><span class="p">:</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="s2">&quot;User [</span><span class="si">%s</span><span class="s2">] is deactivated for booking system [</span><span class="si">%s</span><span class="s2">], skipping&quot;</span><span class="p">,</span>
                        <span class="n">username</span><span class="p">,</span>
                        <span class="n">system_id</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="k">continue</span>

                <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s2">&quot;User [</span><span class="si">%s</span><span class="s2">] has permission to book system [</span><span class="si">%s</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">system_id</span>
                <span class="p">)</span>
                <span class="n">users</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Unable to parse data returned by PUMAPI: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2"> - &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;ERROR: </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">err</span>

        <span class="k">return</span> <span class="n">users</span>
</pre></div>

        </details>

            <div class="docstring"><p>Get a list of usernames allowed to book the system with the given ID.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>system_id</strong> (int or int-like):
The ID of the system to query permitted users for.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>list(str)</strong>: A list of usernames ('login') with permissions to book the system
with the given ID in PPMS.</li>
</ul>

<h6 id="raises">Raises</h6>

<ul>
<li><strong>ValueError</strong>: Raised in case parsing the response failes for any reason.</li>
</ul>
</div>


                            </div>
                            <div id="PpmsConnection.set_system_booking_permissions" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#PpmsConnection.set_system_booking_permissions">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">set_system_booking_permissions</span><span class="signature">(self, login, system_id, permission)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">set_system_booking_permissions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">login</span><span class="p">,</span> <span class="n">system_id</span><span class="p">,</span> <span class="n">permission</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set permissions for a user on a given system in PPMS.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        username : str</span>
<span class="sd">            The username (&#39;login&#39;) to allow for booking the system.</span>
<span class="sd">        system_id : int or int-like</span>
<span class="sd">            The ID of the system to add the permission for.</span>
<span class="sd">        permission : {&#39;D&#39;, &#39;A&#39;, &#39;N&#39;, &#39;S&#39;}</span>
<span class="sd">            The permission level to set for the user, one of:</span>
<span class="sd">              - ``D`` : deactivated</span>
<span class="sd">              - ``A`` : autonomous</span>
<span class="sd">              - ``N`` : novice</span>
<span class="sd">              - ``S`` : superuser</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            True in case setting permissions for the given username on the</span>
<span class="sd">            system with the specified ID succeeded (or if the user already had</span>
<span class="sd">            those permissions before), False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">permission_name</span><span class="p">(</span><span class="n">shortname</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Closure to validate a permission level and return its long name.</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            shortname : str</span>
<span class="sd">                A single character defining the permission level.</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            str</span>
<span class="sd">                The long (human-readable) name of the permission level.</span>

<span class="sd">            Raises</span>
<span class="sd">            ------</span>
<span class="sd">            KeyError</span>
<span class="sd">                Raised in case an invalid permission level was given.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">mapping</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;D&quot;</span><span class="p">:</span> <span class="s2">&quot;deactivated&quot;</span><span class="p">,</span>
                <span class="s2">&quot;A&quot;</span><span class="p">:</span> <span class="s2">&quot;autonomous&quot;</span><span class="p">,</span>
                <span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="s2">&quot;novice&quot;</span><span class="p">,</span>
                <span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="s2">&quot;superuser&quot;</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">mapping</span><span class="p">[</span><span class="n">shortname</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid permission [</span><span class="si">{</span><span class="n">shortname</span><span class="si">}</span><span class="s2">] given&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">err</span>

        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;Setting permission level [</span><span class="si">%s</span><span class="s2">] for user [</span><span class="si">%s</span><span class="s2">] on system [</span><span class="si">%s</span><span class="s2">]&quot;</span><span class="p">,</span>
            <span class="n">permission_name</span><span class="p">(</span><span class="n">permission</span><span class="p">),</span>
            <span class="n">login</span><span class="p">,</span>
            <span class="n">system_id</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">parameters</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">system_id</span><span class="p">,</span> <span class="s2">&quot;login&quot;</span><span class="p">:</span> <span class="n">login</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">permission</span><span class="p">}</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;setright&quot;</span><span class="p">,</span> <span class="n">parameters</span><span class="p">)</span>

        <span class="c1"># NOTE: the &#39;setright&#39; action will accept ANY permission type and return &#39;done&#39;</span>
        <span class="c1"># on the request, so there is no way to check from the response if setting the</span>
        <span class="c1"># permission really worked!!</span>
        <span class="c1"># LOG.debug(&#39;Request returned text: %s&#39;, response.text)</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;done&quot;</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;User [</span><span class="si">%s</span><span class="s2">] now has permission level [</span><span class="si">%s</span><span class="s2">] on system [</span><span class="si">%s</span><span class="s2">]&quot;</span><span class="p">,</span>
                <span class="n">login</span><span class="p">,</span>
                <span class="n">permission_name</span><span class="p">(</span><span class="n">permission</span><span class="p">),</span>
                <span class="n">system_id</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="s2">&quot;invalid user&quot;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;User [</span><span class="si">%s</span><span class="s2">] doesn&#39;t seem to exist in PPMS&quot;</span><span class="p">,</span> <span class="n">login</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s2">&quot;system right not authorized&quot;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;Unable to set permissions for system </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">system_id</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Unexpected response, assuming request failed: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">False</span>
</pre></div>

        </details>

            <div class="docstring"><p>Set permissions for a user on a given system in PPMS.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>username</strong> (str):
The username ('login') to allow for booking the system.</li>
<li><strong>system_id</strong> (int or int-like):
The ID of the system to add the permission for.</li>
<li><strong>permission</strong> ({'D', 'A', 'N', 'S'}):
The permission level to set for the user, one of:
<ul>
<li><code>D</code> : deactivated</li>
<li><code>A</code> : autonomous</li>
<li><code>N</code> : novice</li>
<li><code>S</code> : superuser</li>
</ul></li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>bool</strong>: True in case setting permissions for the given username on the
system with the specified ID succeeded (or if the user already had
those permissions before), False otherwise.</li>
</ul>
</div>


                            </div>
                            <div id="PpmsConnection.give_user_access_to_system" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#PpmsConnection.give_user_access_to_system">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">give_user_access_to_system</span><span class="signature">(self, username, system_id)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">give_user_access_to_system</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">system_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add permissions for a user to book a given system in PPMS.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        username : str</span>
<span class="sd">            The username (&#39;login&#39;) to allow for booking the system.</span>
<span class="sd">        system_id : int or int-like</span>
<span class="sd">            The ID of the system to add the permission for.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            True in case the given username now has the permissions to book the</span>
<span class="sd">            system with the specified ID (or if the user already had them</span>
<span class="sd">            before), False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_system_booking_permissions</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">system_id</span><span class="p">,</span> <span class="s2">&quot;A&quot;</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>Add permissions for a user to book a given system in PPMS.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>username</strong> (str):
The username ('login') to allow for booking the system.</li>
<li><strong>system_id</strong> (int or int-like):
The ID of the system to add the permission for.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>bool</strong>: True in case the given username now has the permissions to book the
system with the specified ID (or if the user already had them
before), False otherwise.</li>
</ul>
</div>


                            </div>
                            <div id="PpmsConnection.remove_user_access_from_system" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#PpmsConnection.remove_user_access_from_system">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">remove_user_access_from_system</span><span class="signature">(self, username, system_id)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">remove_user_access_from_system</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">system_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove permissions for a user to book a given system in PPMS.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        username : str</span>
<span class="sd">            The username (&#39;login&#39;) to remove booking permissions on the system.</span>
<span class="sd">        system_id : int or int-like</span>
<span class="sd">            The ID of the system to modify the permission for.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            True in case the given username now has the permissions to book the</span>
<span class="sd">            system with the specified ID (or if the user already had them</span>
<span class="sd">            before), False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_system_booking_permissions</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">system_id</span><span class="p">,</span> <span class="s2">&quot;D&quot;</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>Remove permissions for a user to book a given system in PPMS.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>username</strong> (str):
The username ('login') to remove booking permissions on the system.</li>
<li><strong>system_id</strong> (int or int-like):
The ID of the system to modify the permission for.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>bool</strong>: True in case the given username now has the permissions to book the
system with the specified ID (or if the user already had them
before), False otherwise.</li>
</ul>
</div>


                            </div>
                            <div id="PpmsConnection.get_booking" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#PpmsConnection.get_booking">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">get_booking</span><span class="signature">(self, system_id, booking_type=&#39;get&#39;)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">get_booking</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">system_id</span><span class="p">,</span> <span class="n">booking_type</span><span class="o">=</span><span class="s2">&quot;get&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the current or next booking of a system.</span>

<span class="sd">        WARNING: if the next booking is requested but it is too far in the future,</span>
<span class="sd">        PUMAPI silently ignores it - the response is identical to a system that has no</span>
<span class="sd">        future bookings and there is no error reported either. Currently it is unclear</span>
<span class="sd">        where the cutoff is (e.g. lookups for a booking that is two years from now still</span>
<span class="sd">        work fine, but a booking in about 10 years is silently skipped).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        system_id : int or int-like</span>
<span class="sd">            The ID of the system in PPMS.</span>
<span class="sd">        booking_type : {&#39;get&#39;, &#39;next&#39;}, optional</span>
<span class="sd">            The type of booking to request, one of `get` (requesting the</span>
<span class="sd">            currently running booking) and `next` (requesting the next upcoming</span>
<span class="sd">            booking), by default `get`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        PpmsBooking or None</span>
<span class="sd">            The booking object, or None if there is no booking for the system or the</span>
<span class="sd">            request is refused by PUMAPI (e.g. &quot;not authorized&quot;).</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            Raised if the specified `booking_type` is invalid.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">valid</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;get&quot;</span><span class="p">,</span> <span class="s2">&quot;next&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">booking_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Value for &#39;booking_type&#39; (</span><span class="si">{</span><span class="n">booking_type</span><span class="si">}</span><span class="s2">) not in </span><span class="si">{</span><span class="n">valid</span><span class="si">}</span><span class="s2">!&quot;</span>
            <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">booking_type</span> <span class="o">+</span> <span class="s2">&quot;booking&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">system_id</span><span class="p">})</span>
        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ConnectionError</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Requesting booking status for system </span><span class="si">%s</span><span class="s2"> failed!&quot;</span><span class="p">,</span> <span class="n">system_id</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">desc</span> <span class="o">=</span> <span class="s2">&quot;any future bookings&quot;</span>
        <span class="k">if</span> <span class="n">booking_type</span> <span class="o">==</span> <span class="s2">&quot;get&quot;</span><span class="p">:</span>
            <span class="n">desc</span> <span class="o">=</span> <span class="s2">&quot;a currently active booking&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;System [</span><span class="si">%s</span><span class="s2">] doesn&#39;t have </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">system_id</span><span class="p">,</span> <span class="n">desc</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">PpmsBooking</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">booking_type</span><span class="p">,</span> <span class="n">system_id</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>Get the current or next booking of a system.</p>

<p>WARNING: if the next booking is requested but it is too far in the future,
PUMAPI silently ignores it - the response is identical to a system that has no
future bookings and there is no error reported either. Currently it is unclear
where the cutoff is (e.g. lookups for a booking that is two years from now still
work fine, but a booking in about 10 years is silently skipped).</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>system_id</strong> (int or int-like):
The ID of the system in PPMS.</li>
<li><strong>booking_type</strong> ({'get', 'next'}, optional):
The type of booking to request, one of <code>get</code> (requesting the
currently running booking) and <code>next</code> (requesting the next upcoming
booking), by default <code>get</code>.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>PpmsBooking or None</strong>: The booking object, or None if there is no booking for the system or the
request is refused by PUMAPI (e.g. "not authorized").</li>
</ul>

<h6 id="raises">Raises</h6>

<ul>
<li><strong>ValueError</strong>: Raised if the specified <code>booking_type</code> is invalid.</li>
</ul>
</div>


                            </div>
                            <div id="PpmsConnection.get_current_booking" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#PpmsConnection.get_current_booking">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">get_current_booking</span><span class="signature">(self, system_id)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">get_current_booking</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">system_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Wrapper for `get_booking()` with &#39;booking_type&#39; set to &#39;get&#39;.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_booking</span><span class="p">(</span><span class="n">system_id</span><span class="p">,</span> <span class="s2">&quot;get&quot;</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>Wrapper for <code><a href="#PpmsConnection.get_booking">get_booking()</a></code> with 'booking_type' set to 'get'.</p>
</div>


                            </div>
                            <div id="PpmsConnection.get_next_booking" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#PpmsConnection.get_next_booking">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">get_next_booking</span><span class="signature">(self, system_id)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">get_next_booking</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">system_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Wrapper for `get_booking()` with &#39;booking_type&#39; set to &#39;next&#39;.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_booking</span><span class="p">(</span><span class="n">system_id</span><span class="p">,</span> <span class="s2">&quot;next&quot;</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>Wrapper for <code><a href="#PpmsConnection.get_booking">get_booking()</a></code> with 'booking_type' set to 'next'.</p>
</div>


                            </div>
                            <div id="PpmsConnection.get_running_sheet" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#PpmsConnection.get_running_sheet">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">get_running_sheet</span><span class="signature">(self, core_facility_ref, date)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">get_running_sheet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">core_facility_ref</span><span class="p">,</span> <span class="n">date</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the running sheet for a specific day on the given facility.</span>

<span class="sd">        The so-called &quot;running-sheet&quot; consists of all bookings / reservations of</span>
<span class="sd">        a facility on a specifc day.</span>

<span class="sd">        WARNING: PUMAPI doesn&#39;t return a proper unique user identifier with the</span>
<span class="sd">        &#39;getrunningsheet&#39; request, instead the so called &quot;full name&quot; is given to</span>
<span class="sd">        identify the user - unfortunately this can lead to ambiguities as</span>
<span class="sd">        multiple different accounts can have the same full name.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        core_facility_ref : int or int-like</span>
<span class="sd">            The core facility ID for PPMS.</span>
<span class="sd">        date : datetime.datetime</span>
<span class="sd">            The date to request the running sheet for, e.g. ``datetime.now()`` or</span>
<span class="sd">            similar. Note that only the date part is relevant, time will be ignored.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list(pyppms.booking.PpmsBooking)</span>
<span class="sd">            A list with `PpmsBooking` objects for the given day. Empty in case</span>
<span class="sd">            there are no bookings or parsing the response failed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">bookings</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;plateformid&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">core_facility_ref</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;day&quot;</span><span class="p">:</span> <span class="n">date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Requesting runningsheet for </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;day&quot;</span><span class="p">])</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;getrunningsheet&quot;</span><span class="p">,</span> <span class="n">parameters</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">entries</span> <span class="o">=</span> <span class="n">parse_multiline_response</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">graceful</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>  <span class="c1"># pylint: disable-msg=broad-except</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Parsing runningsheet details failed: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
            <span class="c1"># NOTE: in case no future bookings exist the response will be empty!</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Possibly the runningsheet is empty as no bookings exist?&quot;</span><span class="p">)</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Runningsheet PUMPAI response was: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">bookings</span>

        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
            <span class="n">full</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;User&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">full</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fullname_mapping</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Booking for an uncached user (</span><span class="si">%s</span><span class="s2">) found!&quot;</span><span class="p">,</span> <span class="n">full</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">update_users</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">full</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fullname_mapping</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;PPMS doesn&#39;t seem to know user [</span><span class="si">%s</span><span class="s2">], skipping&quot;</span><span class="p">,</span> <span class="n">full</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Booking for user &#39;</span><span class="si">%s</span><span class="s2">&#39; (</span><span class="si">%s</span><span class="s2">) found&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fullname_mapping</span><span class="p">[</span><span class="n">full</span><span class="p">],</span> <span class="n">full</span>
            <span class="p">)</span>
            <span class="n">booking</span> <span class="o">=</span> <span class="n">PpmsBooking</span><span class="o">.</span><span class="n">from_runningsheet</span><span class="p">(</span>
                <span class="n">entry</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_get_system_with_name</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="s2">&quot;Object&quot;</span><span class="p">]),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fullname_mapping</span><span class="p">[</span><span class="n">full</span><span class="p">],</span>
                <span class="n">date</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">bookings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">booking</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">bookings</span>
</pre></div>

        </details>

            <div class="docstring"><p>Get the running sheet for a specific day on the given facility.</p>

<p>The so-called "running-sheet" consists of all bookings / reservations of
a facility on a specifc day.</p>

<p>WARNING: PUMAPI doesn't return a proper unique user identifier with the
'getrunningsheet' request, instead the so called "full name" is given to
identify the user - unfortunately this can lead to ambiguities as
multiple different accounts can have the same full name.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>core_facility_ref</strong> (int or int-like):
The core facility ID for PPMS.</li>
<li><strong>date</strong> (datetime.datetime):
The date to request the running sheet for, e.g. <code>datetime.now()</code> or
similar. Note that only the date part is relevant, time will be ignored.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>list(<a href="booking.html#PpmsBooking">pyppms.booking.PpmsBooking</a>)</strong>: A list with <code>PpmsBooking</code> objects for the given day. Empty in case
there are no bookings or parsing the response failed.</li>
</ul>
</div>


                            </div>
                            <div id="PpmsConnection.get_bookable_ids" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#PpmsConnection.get_bookable_ids">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">get_bookable_ids</span><span class="signature">(self, localisation, name_contains)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">get_bookable_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">localisation</span><span class="p">,</span> <span class="n">name_contains</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Legacy method for getting IDs of specific systems (name + location).</span>

<span class="sd">        This method is not implemented any more, use `get_systems_matching()` with</span>
<span class="sd">        appropriate parameters to select the desired systems instead.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        NotImplementedError</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Use get_systems_matching() instead!&quot;</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>Legacy method for getting IDs of specific systems (name + location).</p>

<p>This method is not implemented any more, use <code><a href="#PpmsConnection.get_systems_matching">get_systems_matching()</a></code> with
appropriate parameters to select the desired systems instead.</p>

<h6 id="raises">Raises</h6>

<ul>
<li><strong>NotImplementedError</strong></li>
</ul>
</div>


                            </div>
                            <div id="PpmsConnection.get_system" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#PpmsConnection.get_system">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">get_system</span><span class="signature">(self, system_id)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">get_system</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">system_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Legacy method for getting details of a specific system.</span>

<span class="sd">        This method is not implemented any more, use `get_systems()` instead and access</span>
<span class="sd">        the desired system by using the respective system ID as the key on the returned</span>
<span class="sd">        dict, e.g. `get_systems()[42]`.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        NotImplementedError</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Use get_systems()[system_id] instead!&quot;</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>Legacy method for getting details of a specific system.</p>

<p>This method is not implemented any more, use <code><a href="#PpmsConnection.get_systems">get_systems()</a></code> instead and access
the desired system by using the respective system ID as the key on the returned
dict, e.g. <code>get_systems()[42]</code>.</p>

<h6 id="raises">Raises</h6>

<ul>
<li><strong>NotImplementedError</strong></li>
</ul>
</div>


                            </div>
                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.type) {
                    case "function":
                        heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span><span class="signature">${doc.signature}:</span>`;
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value">${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.type}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>